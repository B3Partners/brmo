version: "{build}-{branch}"
clone_folder: c:\projects\brmo
clone_script: echo skip
skip_tags: true
max_jobs: 2

init:
  - git config --global core.autocrlf input
  - git config --global core.safecrlf true
  - cmd: net start %SQL%

environment:
  BGT_ONLY_ITESTS : false
  # Microsoft SQL Server 2016 Service Pack 2 heeft een EOL (einde basisondersteuning) van 13-7-2021
  # Microsoft SQL Server 2017 is de jongst-beschikbare release op AppVeyor, maar testen we (ook) op Travis-CI (veel sneller)
  matrix:
    - SQL: MSSQL$SQL2016
      INSTANCENAME: SQL2016
      JAVA_HOME: C:\Program Files\Java\jdk1.8.0
    - SQL: MSSQL$SQL2017
      INSTANCENAME: SQL2017
      JAVA_HOME: C:\Program Files\Java\jdk11
    - SQL: MSSQL$SQL2017
      INSTANCENAME: SQL2017
      JAVA_HOME: C:\Program Files\Java\jdk11
      BGT_ONLY_ITESTS : true
    - SQL: MSSQL$SQL2016
      INSTANCENAME: SQL2016
      JAVA_HOME: C:\Program Files\Java\jdk1.8.0
      BGT_ONLY_ITESTS : true
  # Microsoft SQL Server 2014 Service Pack 2 heeft een EOL van 9-7-2019
  # https://support.microsoft.com/en-us/lifecycle/search/17645
  #  - SQL: MSSQL$SQL2014
  #    INSTANCENAME: SQL2014
  #    JAVA_HOME: C:\Program Files\Java\jdk1.8.0

matrix:
  fast_finish: false

install:
  - choco install codecov
  - ps: |
        Add-Type -AssemblyName System.IO.Compression.FileSystem
        if (!(Test-Path("C:\Users\appveyor\downloads\maven-bin.zip"))) {
            (new-object System.Net.WebClient).DownloadFile('https://archive.apache.org/dist/maven/maven-3/3.6.2/binaries/apache-maven-3.6.2-bin.zip', 'C:\Users\appveyor\downloads\maven-bin.zip')
        }
        [System.IO.Compression.ZipFile]::ExtractToDirectory("C:\Users\appveyor\downloads\maven-bin.zip", "C:\maven")
  - cmd: SET PATH=C:\maven\apache-maven-3.6.2\bin;%PATH%
  - cmd: echo %PATH%
  - cmd: java -version
  - cmd: mvn -v
  - cd C:\projects\brmo
  - git init %APPVEYOR_BUILD_FOLDER%
  - cd %APPVEYOR_BUILD_FOLDER%
  - git remote add origin https://github.com/%APPVEYOR_REPO_NAME%.git
  - ps: |
        if ($Env:APPVEYOR_PULL_REQUEST_NUMBER -eq $null) {
           git fetch -qfup --depth=5 origin +$Env:APPVEYOR_REPO_BRANCH +refs/tags/*:refs/tags/*
           git checkout -qf $Env:APPVEYOR_REPO_COMMIT
        } else {
           git fetch -q origin +refs/pull/$Env:APPVEYOR_PULL_REQUEST_NUMBER/merge:
           git checkout -qf FETCH_HEAD
        }
  - git lfs pull
  - ps: iex ((new-object net.webclient).DownloadString('https://raw.githubusercontent.com/appveyor/ci/master/scripts/enable-http-proxy.ps1'))
  - ps: .\.appveyor\set-maven-proxy.ps1

# initial build/code generation, no testing
build_script:
  - mvn install -Dmaven.test.skip=true -B -V -fae -q -Pmssql -pl "!brmo-dist"

# services worden na install gestart en we hebben gegenereerde sql nodig
after_build:
  - cmd: echo "aanmaken en opzetten STAGING DB"
  - sqlcmd -S (local)\%INSTANCENAME% -U sa -P Password12! -Q "CREATE DATABASE staging" -d "master"
  - dir -w .\brmo-persistence\db\
  - sqlcmd -S (local)\%INSTANCENAME% -U sa -P Password12! -d "staging" -i .\brmo-persistence\db\create-brmo-persistence-sqlserver.sql
  - sqlcmd -S (local)\%INSTANCENAME% -U sa -P Password12! -d "staging" -i .\brmo-persistence\db\01_create_indexes.sql
  - sqlcmd -S (local)\%INSTANCENAME% -U sa -P Password12! -d "staging" -i .\brmo-persistence\db\02_insert_default_user.sql
  - ps: ([xml]$pom=Get-Content .\pom.xml)
  - ps: (Get-Content .\brmo-persistence\db\05_create_brmo_metadata_sqlserver.sql) -replace '\${project.version}', $pom.project.version | Set-Content .\brmo-persistence\db\05_create_brmo_metadata_sqlserver.sql
  - sqlcmd -S (local)\%INSTANCENAME% -U sa -P Password12! -d "staging" -i .\brmo-persistence\db\05_create_brmo_metadata_sqlserver.sql
#
  - cmd: echo "aanmaken en opzetten RSGB DB"
  - cmd: SET SQLCMDINI=.\.appveyor\init.sql
  - sqlcmd -S (local)\%INSTANCENAME% -U sa -P Password12! -Q "CREATE DATABASE rsgb" -d "master"
  - dir -w .\datamodel\generated_scripts\
  - sqlcmd -r0 -x -b -S (local)\%INSTANCENAME% -U sa -P Password12! -d "rsgb" -I -i .\datamodel\generated_scripts\datamodel_sqlserver.sql
# duurt lang en gemeente/wijk geom hebben we niet echt nodig voor de tests
#  - sqlcmd -r0 -x -b -S (local)\%INSTANCENAME% -U sa -P Password12! -d "rsgb" -I -i .\datamodel\utility_scripts\sqlserver\111a_update_gemeente_geom.sql
# mislukt op AppVeyor: There is insufficient system memory in resource pool 'internal' to run this query.
#  - sqlcmd -r0 -x -b -S (local)\%INSTANCENAME% -U sa -P Password12! -d "rsgb" -I -i .\datamodel\utility_scripts\sqlserver\113a_update_wijk_geom.sql
#
  - cmd: echo "aanmaken en opzetten RSGBBGT DB"
  - sqlcmd -S (local)\%INSTANCENAME% -U sa -P Password12! -Q "CREATE DATABASE bgttest" -d "master"
  - dir -w .\bgt-gml-loader\target\generated-resources\ddl\sqlserver\
  - sqlcmd -r0 -b -S (local)\%INSTANCENAME% -I -U sa -P Password12! -d "bgttest" -i .\bgt-gml-loader\target\generated-resources\ddl\sqlserver\create_rsgb_bgt.sql
#
  - cmd: echo "aanmaken en opzetten TOPNL DB"
  - sqlcmd -S (local)\%INSTANCENAME% -U sa -P Password12! -Q "CREATE DATABASE topnl" -d "master"
  - dir -w .\topparser\src\main\resources\nl\b3p\topnl\database
  - sqlcmd -r0 -b -S (local)\%INSTANCENAME% -I -U sa -P Password12! -d "topnl" -i .\topparser\src\main\resources\nl\b3p\topnl\database\sqlserver.sql
#
  - cmd: echo "computer name:" %COMPUTERNAME%
  - cmd: echo "instance name:" %INSTANCENAME%
  - ps: .\.appveyor\setting-tcp-ip-ports.ps1


test_script:
  # unit tests
  - mvn -e test -fae -B -Pmssql -pl "!brmo-dist"
  # integratie tests
  # run integratie tests voor bgt-gml-loader module (30min)
  - if "%BGT_ONLY_ITESTS%"=="true" mvn -e verify -B -Pmssql -Dtest.onlyITs=true -pl "bgt-gml-loader" -Dmssql.instancename=%INSTANCENAME%
  # run integratie tests voor brmo-loader module
  - if "%BGT_ONLY_ITESTS%"=="false" mvn -e verify -B -Pmssql -Dtest.onlyITs=true -pl "brmo-loader" -Dmssql.instancename=%INSTANCENAME%
  # run integratie tests voor brmo-service module
  - if "%BGT_ONLY_ITESTS%"=="false" mvn -e verify -B -Pmssql -Dtest.onlyITs=true -pl "brmo-service" -Dmssql.instancename=%INSTANCENAME%
  # run integratie tests voor brmo-soap module
  - if "%BGT_ONLY_ITESTS%"=="false" mvn -e verify -B -Pmssql -Dtest.onlyITs=true -pl "brmo-soap" -Dmssql.instancename=%INSTANCENAME%
  # run integratie tests voor brmo-stufbg204 module
  - if "%BGT_ONLY_ITESTS%"=="false" mvn -e verify -B -Pmssql -Dtest.onlyITs=true -pl "brmo-stufbg204" -Dmssql.instancename=%INSTANCENAME%
  # run integratie tests voor brmo-commandline module
  - if "%BGT_ONLY_ITESTS%"=="false" mvn -e verify -B -Pmssql -Dtest.onlyITs=true -pl "brmo-commandline" -Dmssql.instancename=%INSTANCENAME%
  - codecov -v -f target/site/jacoco-it/jacoco.xml target/site/jacoco/jacoco.xml

cache:
  - C:\Users\appveyor\.m2\repository -> pom.xml
  - C:\Users\appveyor\downloads -> appveyor.yml
  - '.git\lfs'
