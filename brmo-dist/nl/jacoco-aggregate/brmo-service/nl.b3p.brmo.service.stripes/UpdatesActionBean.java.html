<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="nl"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>UpdatesActionBean.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">BRMO distributie</a> &gt; <a href="../index.html" class="el_bundle">brmo-service</a> &gt; <a href="index.source.html" class="el_package">nl.b3p.brmo.service.stripes</a> &gt; <span class="el_source">UpdatesActionBean.java</span></div><h1>UpdatesActionBean.java</h1><pre class="source lang-java linenums">package nl.b3p.brmo.service.stripes;

import net.sourceforge.stripes.action.*;
import net.sourceforge.stripes.controller.LifecycleStage;
import net.sourceforge.stripes.validation.Validate;

import nl.b3p.brmo.loader.BrmoFramework;
import nl.b3p.brmo.loader.ProgressUpdateListener;
import nl.b3p.brmo.loader.updates.UpdateProcess;
import nl.b3p.brmo.service.util.ConfigUtil;

import org.apache.commons.lang3.exception.ExceptionUtils;
import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import org.stripesstuff.plugin.waitpage.WaitPage;

import java.io.PrintWriter;
import java.io.StringWriter;
import java.util.Arrays;
import java.util.Date;
import java.util.List;

import javax.sql.DataSource;

/** @author Matthijs Laan */
@StrictBinding
<span class="nc" id="L27">public class UpdatesActionBean implements ActionBean, ProgressUpdateListener {</span>
<span class="nc" id="L28">    private static final Log log = LogFactory.getLog(UpdatesActionBean.class);</span>

    private static final String JSP = &quot;/WEB-INF/jsp/transform/updates.jsp&quot;;
    private static final String JSP_PROGRESS = &quot;/WEB-INF/jsp/transform/updateprogress.jsp&quot;;

    private ActionBeanContext context;

    private List&lt;UpdateProcess&gt; updateProcesses;

    @Validate(required = true, on = &quot;update&quot;)
    private String updateProcessName;

    private double progress;
    private long total;
    private long processed;
    private boolean complete;
    private Date start;
    private Date update;
    private String exceptionStacktrace;

    // &lt;editor-fold defaultstate=&quot;collapsed&quot; desc=&quot;getters en setters&quot;&gt;
    @Override
    public ActionBeanContext getContext() {
<span class="nc" id="L51">        return context;</span>
    }

    @Override
    public void setContext(ActionBeanContext context) {
<span class="nc" id="L56">        this.context = context;</span>
<span class="nc" id="L57">    }</span>

    public double getProgress() {
<span class="nc" id="L60">        return progress;</span>
    }

    public void setProgress(double progress) {
<span class="nc" id="L64">        this.progress = progress;</span>
<span class="nc" id="L65">    }</span>

    public long getTotal() {
<span class="nc" id="L68">        return total;</span>
    }

    public void setTotal(long total) {
<span class="nc" id="L72">        this.total = total;</span>
<span class="nc" id="L73">    }</span>

    public long getProcessed() {
<span class="nc" id="L76">        return processed;</span>
    }

    public void setProcessed(long processed) {
<span class="nc" id="L80">        this.processed = processed;</span>
<span class="nc" id="L81">    }</span>

    public boolean isComplete() {
<span class="nc" id="L84">        return complete;</span>
    }

    public void setComplete(boolean complete) {
<span class="nc" id="L88">        this.complete = complete;</span>
<span class="nc" id="L89">    }</span>

    public Date getStart() {
<span class="nc" id="L92">        return start;</span>
    }

    public void setStart(Date start) {
<span class="nc" id="L96">        this.start = start;</span>
<span class="nc" id="L97">    }</span>

    public Date getUpdate() {
<span class="nc" id="L100">        return update;</span>
    }

    public void setUpdate(Date update) {
<span class="nc" id="L104">        this.update = update;</span>
<span class="nc" id="L105">    }</span>

    public String getExceptionStacktrace() {
<span class="nc" id="L108">        return exceptionStacktrace;</span>
    }

    public void setExceptionStacktrace(String exceptionStacktrace) {
<span class="nc" id="L112">        this.exceptionStacktrace = exceptionStacktrace;</span>
<span class="nc" id="L113">    }</span>

    @Override
    public void total(long total) {
<span class="nc" id="L117">        this.total = total;</span>
<span class="nc" id="L118">    }</span>

    @Override
    public void progress(long progress) {
<span class="nc" id="L122">        this.processed = progress;</span>
<span class="nc bnc" id="L123" title="All 2 branches missed.">        if (this.total != 0) {</span>
<span class="nc" id="L124">            this.progress = (100.0 / this.total) * this.processed;</span>
        }
<span class="nc" id="L126">        this.update = new Date();</span>
<span class="nc" id="L127">    }</span>

    @Override
    public void exception(Throwable t) {
<span class="nc" id="L131">        StringWriter sw = new StringWriter();</span>
<span class="nc" id="L132">        t.printStackTrace(new PrintWriter(sw));</span>
<span class="nc" id="L133">        this.exceptionStacktrace = sw.toString();</span>
<span class="nc" id="L134">    }</span>

    public List&lt;UpdateProcess&gt; getUpdateProcesses() {
<span class="nc" id="L137">        return updateProcesses;</span>
    }

    public void setUpdateProcesses(List&lt;UpdateProcess&gt; updateProcesses) {
<span class="nc" id="L141">        this.updateProcesses = updateProcesses;</span>
<span class="nc" id="L142">    }</span>

    public String getUpdateProcessName() {
<span class="nc" id="L145">        return updateProcessName;</span>
    }

    public void setUpdateProcessName(String updateProcessName) {
<span class="nc" id="L149">        this.updateProcessName = updateProcessName;</span>
<span class="nc" id="L150">    }</span>
    // &lt;/editor-fold&gt;

    @Before(stages = LifecycleStage.BindingAndValidation)
    public void populateUpdateProcesses() {

        // XXX move to configuration file

<span class="nc" id="L158">        updateProcesses =</span>
<span class="nc" id="L159">                Arrays.asList(</span>
                        new UpdateProcess[] {
                            // bij een nieuw proces ook de wiki bijwerken:
                            // https://github.com/B3Partners/brmo/wiki/Snelle-updates
                            new UpdateProcess(
                                    &quot;Toevoegen BSN aan ingeschreven natuurlijk persoon&quot;,
                                    BrmoFramework.BR_BRK,
                                    &quot;/xsl/update-bsn.xsl&quot;),
                            new UpdateProcess(
                                    &quot;Toevoegen RSIN aan ingeschreven niet-natuurlijk persoon&quot;,
                                    BrmoFramework.BR_BRK,
                                    &quot;/xsl/update-rsin.xsl&quot;),
                            new UpdateProcess(
                                    &quot;Bijwerken van omschrijving, datum en ref_id in brondocument&quot;,
                                    BrmoFramework.BR_BRK,
                                    &quot;/xsl/update-brondocument.xsl&quot;),
                            new UpdateProcess(
                                    &quot;Bijwerken van onvolledig adres&quot;,
                                    BrmoFramework.BR_BRK,
                                    &quot;/xsl/update-incompleetadres.xsl&quot;),
                            new UpdateProcess(
                                    &quot;Bijwerken van rechthebbende VVE op zakelijk recht&quot;,
                                    BrmoFramework.BR_BRK,
                                    &quot;/xsl/update-zak_recht-vve.xsl&quot;),
                            new UpdateProcess(
                                    &quot;Bijwerken van GBA Niet Ingezetene 'clazz' in personen tabellen&quot;,
                                    BrmoFramework.BR_BRK,
                                    &quot;/xsl/update-niet_ingezetene-clazz.xsl&quot;),
                            new UpdateProcess(
                                    &quot;Bijwerken subject adres comfort data&quot;,
                                    BrmoFramework.BR_BRK,
                                    &quot;/xsl/update-comfort-adres.xsl&quot;),
                            new UpdateProcess(
                                    &quot;Bijwerken ingangsdatum_recht zakelijk recht&quot;,
                                    BrmoFramework.BR_BRK,
                                    &quot;/xsl/update-zak_recht-begindatum.xsl&quot;,
                                    true),
                            new UpdateProcess(
                                    &quot;Bijwerken vestiging activiteit&quot;,
                                    BrmoFramework.BR_NHR,
                                    &quot;/xsl/update-vestg-activiteit.xsl&quot;),
                            new UpdateProcess(
                                    &quot;Bijwerken non-mailing attribuut maatschappelijke activiteit&quot;,
                                    BrmoFramework.BR_NHR,
                                    &quot;/xsl/update-nonmailing.xsl&quot;),
                            new UpdateProcess(
                                    &quot;Bijwerking fk_4pes_sc_identif op maatschappelijke activiteit&quot;,
                                    BrmoFramework.BR_NHR,
                                    &quot;/xsl/update-kvk-koppeling.xsl&quot;)
                        });
<span class="nc" id="L209">    }</span>

    @DefaultHandler
    public Resolution form() {
<span class="nc bnc" id="L213" title="All 2 branches missed.">        return new ForwardResolution(complete ? JSP_PROGRESS : JSP);</span>
    }

    @WaitPage(path = JSP_PROGRESS, delay = 1000, refresh = 1000)
    public Resolution update() {
<span class="nc" id="L218">        UpdateProcess process = null;</span>

<span class="nc bnc" id="L220" title="All 2 branches missed.">        for (UpdateProcess p : updateProcesses) {</span>
<span class="nc bnc" id="L221" title="All 2 branches missed.">            if (p.getName().equals(updateProcessName)) {</span>
<span class="nc" id="L222">                process = p;</span>
<span class="nc" id="L223">                break;</span>
            }
<span class="nc" id="L225">        }</span>
<span class="nc bnc" id="L226" title="All 2 branches missed.">        if (process == null) {</span>
<span class="nc" id="L227">            getContext().getMessages().add(new SimpleMessage(&quot;Ongeldig proces&quot;));</span>
<span class="nc" id="L228">            return new ForwardResolution(JSP);</span>
        }

<span class="nc" id="L231">        start = new Date();</span>
<span class="nc" id="L232">        log.info(&quot;Start update process: &quot; + process.getName());</span>

        // Get berichten
<span class="nc" id="L235">        BrmoFramework brmo = null;</span>
        try {
<span class="nc" id="L237">            DataSource dataSourceStaging = ConfigUtil.getDataSourceStaging();</span>
<span class="nc" id="L238">            DataSource dataSourceRsgb = ConfigUtil.getDataSourceRsgb();</span>
<span class="nc" id="L239">            DataSource dataSourceRsgbBrk = ConfigUtil.getDataSourceRsgbBrk();</span>
<span class="nc" id="L240">            brmo = new BrmoFramework(dataSourceStaging, dataSourceRsgb, dataSourceRsgbBrk);</span>

<span class="nc" id="L242">            boolean enableTransformPipeline =</span>
                    &quot;true&quot;
<span class="nc" id="L244">                            .equals(</span>
<span class="nc" id="L245">                                    getContext()</span>
<span class="nc" id="L246">                                            .getServletContext()</span>
<span class="nc" id="L247">                                            .getInitParameter(&quot;pipelining.enabled&quot;));</span>
<span class="nc" id="L248">            brmo.setEnablePipeline(enableTransformPipeline);</span>
<span class="nc bnc" id="L249" title="All 2 branches missed.">            if (enableTransformPipeline) {</span>
<span class="nc" id="L250">                String capacityString =</span>
<span class="nc" id="L251">                        getContext().getServletContext().getInitParameter(&quot;pipelining.capacity&quot;);</span>
<span class="nc bnc" id="L252" title="All 2 branches missed.">                if (capacityString != null) {</span>
<span class="nc" id="L253">                    brmo.setTransformPipelineCapacity(Integer.parseInt(capacityString));</span>
                }
            }
<span class="nc" id="L256">            String batchString =</span>
<span class="nc" id="L257">                    getContext().getServletContext().getInitParameter(&quot;batch.capacity&quot;);</span>
<span class="nc bnc" id="L258" title="All 2 branches missed.">            if (batchString != null) {</span>
<span class="nc" id="L259">                brmo.setBatchCapacity(Integer.parseInt(batchString));</span>
            }
<span class="nc" id="L261">            String errorState = getContext().getServletContext().getInitParameter(&quot;error.state&quot;);</span>
<span class="nc bnc" id="L262" title="All 2 branches missed.">            if (errorState != null) {</span>
<span class="nc" id="L263">                brmo.setErrorState(errorState);</span>
            }

<span class="nc" id="L266">            Thread t = brmo.toRsgb(process, this);</span>
<span class="nc" id="L267">            t.join();</span>

<span class="nc bnc" id="L269" title="All 2 branches missed.">            if (this.exceptionStacktrace == null) {</span>
<span class="nc" id="L270">                getContext()</span>
<span class="nc" id="L271">                        .getMessages()</span>
<span class="nc" id="L272">                        .add(</span>
                                new SimpleMessage(
                                        &quot;Transformatie afgerond, controleer berichtenstatus.&quot;));
            }
<span class="nc" id="L276">        } catch (Throwable t) {</span>
<span class="nc" id="L277">            log.error(&quot;Fout bij updaten&quot;, t);</span>
<span class="nc" id="L278">            String m = &quot;Fout bij updaten: &quot; + ExceptionUtils.getMessage(t);</span>
<span class="nc bnc" id="L279" title="All 2 branches missed.">            if (t.getCause() != null) {</span>
<span class="nc" id="L280">                m += &quot;, oorzaak: &quot; + ExceptionUtils.getRootCauseMessage(t);</span>
            }
<span class="nc" id="L282">            getContext().getMessages().add(new SimpleMessage(m));</span>
        } finally {
<span class="nc bnc" id="L284" title="All 2 branches missed.">            if (brmo != null) {</span>
<span class="nc" id="L285">                brmo.closeBrmoFramework();</span>
            }
<span class="nc" id="L287">            complete = true;</span>
        }
<span class="nc" id="L289">        return new ForwardResolution(JSP_PROGRESS);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>