<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="nl"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>BasisregistratieFileUploadActionBean.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">BRMO distributie</a> &gt; <a href="../index.html" class="el_bundle">brmo-service</a> &gt; <a href="index.source.html" class="el_package">nl.b3p.brmo.service.stripes</a> &gt; <span class="el_source">BasisregistratieFileUploadActionBean.java</span></div><h1>BasisregistratieFileUploadActionBean.java</h1><pre class="source lang-java linenums">package nl.b3p.brmo.service.stripes;

import java.io.BufferedInputStream;
import java.io.DataInputStream;
import java.io.IOException;
import java.io.InputStream;
import java.util.ArrayList;
import java.util.List;
import java.util.zip.ZipEntry;
import java.util.zip.ZipInputStream;
import javax.sql.DataSource;
import net.sourceforge.stripes.action.ActionBean;
import net.sourceforge.stripes.action.ActionBeanContext;
import net.sourceforge.stripes.action.DefaultHandler;
import net.sourceforge.stripes.action.DontValidate;
import net.sourceforge.stripes.action.FileBean;
import net.sourceforge.stripes.action.ForwardResolution;
import net.sourceforge.stripes.action.Resolution;
import net.sourceforge.stripes.action.SimpleMessage;
import net.sourceforge.stripes.action.StrictBinding;
import net.sourceforge.stripes.validation.Validate;
import nl.b3p.brmo.loader.BrmoFramework;
import nl.b3p.brmo.loader.ProgressUpdateListener;
import nl.b3p.brmo.loader.util.BrmoDuplicaatLaadprocesException;
import nl.b3p.brmo.loader.util.BrmoException;
import nl.b3p.brmo.loader.util.BrmoLeegBestandException;
import nl.b3p.brmo.service.util.ConfigUtil;
import org.apache.commons.io.input.CloseShieldInputStream;
import org.apache.commons.lang3.exception.ExceptionUtils;
import org.apache.commons.lang3.mutable.MutableLong;
import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;

/**
 * Action voor het handmatig uploaden van bestanden met basisregistratiegegevens
 * via een formulier.
 */
@StrictBinding
<span class="nc" id="L39">public class BasisregistratieFileUploadActionBean implements ActionBean {</span>
    private static final int ZIP_HEADER = 0x504b0304;

<span class="nc" id="L42">    private static final Log log = LogFactory.getLog(BasisregistratieFileUploadActionBean.class);</span>

    private ActionBeanContext context;

    @Validate(required=true)
    private String basisregistratie;

    @Validate(required=true)
    private FileBean bestand;

    @DefaultHandler
    @DontValidate
    public Resolution form() {
<span class="nc" id="L55">        return new ForwardResolution(&quot;/WEB-INF/jsp/bestand/form.jsp&quot;);</span>
    }

    public Resolution upload() throws BrmoException {
<span class="nc" id="L59">        DataSource ds = ConfigUtil.getDataSourceStaging();</span>
<span class="nc" id="L60">        BrmoFramework brmo = new BrmoFramework(ds, null);</span>
<span class="nc" id="L61">        ZipInputStream zip = null;</span>
<span class="nc" id="L62">        ZipEntry entry = null;</span>
<span class="nc" id="L63">        int errors = 0;</span>
<span class="nc" id="L64">        int empty = 0;</span>
<span class="nc" id="L65">        int duplicate = 0;</span>
<span class="nc" id="L66">        final int ERROR_LIMIT = 5;</span>
        try {
<span class="nc" id="L68">            final MutableLong theTotal = new MutableLong(0);</span>
<span class="nc" id="L69">            int extractedFiles = 0;</span>
<span class="nc" id="L70">            final ProgressUpdateListener totalAdder = new ProgressUpdateListener() {</span>

                @Override
                public void total(long total) {
<span class="nc" id="L74">                    theTotal.setValue(theTotal.getValue() + total);</span>
<span class="nc" id="L75">                }</span>

                @Override
                public void progress(long progress) {
<span class="nc" id="L79">                }</span>

                @Override
                public void exception(Throwable t) {
<span class="nc" id="L83">                }</span>
            };

            // Check of bestand begint met ZIP header
<span class="nc" id="L87">            InputStream in = new BufferedInputStream(bestand.getInputStream());</span>
<span class="nc" id="L88">            in.mark(4);</span>
<span class="nc" id="L89">            int header = new DataInputStream(in).readInt();</span>
<span class="nc" id="L90">            in.reset();</span>

<span class="nc bnc" id="L92" title="All 2 branches missed.">            if(header == ZIP_HEADER) {</span>
                // Pak .xml bestanden in ZIP uit en verwerk deze

<span class="nc" id="L95">                zip = new ZipInputStream(in);</span>
                try {
<span class="nc" id="L97">                    entry = zip.getNextEntry();</span>
<span class="nc bnc" id="L98" title="All 2 branches missed.">                    while(entry != null) {</span>
<span class="nc bnc" id="L99" title="All 2 branches missed.">                        if(!entry.getName().toLowerCase().endsWith(&quot;.xml&quot;)) {</span>
<span class="nc" id="L100">                            log.warn(&quot;Overslaan zip entry geen XML: &quot; + entry.getName());</span>
                        } else {
<span class="nc" id="L102">                            log.debug(&quot;Lezen XML bestand uit zip: &quot; + entry.getName());</span>
                            try {
<span class="nc" id="L104">                                brmo.loadFromStream(basisregistratie, CloseShieldInputStream.wrap(zip), bestand.getFileName() + &quot;/&quot; + entry.getName(), totalAdder, null);</span>
<span class="nc" id="L105">                            } catch(BrmoLeegBestandException e) {</span>
<span class="nc" id="L106">                                log.info(&quot;Negeer ZIP entry &quot; + entry.getName() + &quot;: &quot; + e.getMessage());</span>
<span class="nc" id="L107">                                empty++;</span>
<span class="nc" id="L108">                            } catch(BrmoDuplicaatLaadprocesException e) {</span>
<span class="nc" id="L109">                                log.info(&quot;Negeer ZIP entry &quot; + entry.getName() + &quot;: duplicaat laadproces&quot;);</span>
<span class="nc" id="L110">                                duplicate++;</span>
<span class="nc" id="L111">                            } catch(BrmoException e) {</span>
<span class="nc" id="L112">                                errors++;</span>
<span class="nc bnc" id="L113" title="All 2 branches missed.">                                log.error(&quot;BrmoException bij laden ZIP entry &quot; + entry.getName() + (errors &gt; ERROR_LIMIT ? &quot;; afbreken&quot; : &quot;; doorgaan met volgende&quot;), e);</span>
<span class="nc bnc" id="L114" title="All 2 branches missed.">                                if(errors &gt; ERROR_LIMIT) {</span>
<span class="nc" id="L115">                                    throw new BrmoException(&quot;Maximum aantal fouten (&quot; + ERROR_LIMIT + &quot;) bereikt bij inladen ZIP bestanden, inladen afgebroken. Controleer brmo-service.log&quot;, e);</span>
                                }
<span class="nc" id="L117">                            }</span>
<span class="nc" id="L118">                            extractedFiles++;</span>
                        }
<span class="nc" id="L120">                        entry = zip.getNextEntry();</span>
                    }
                } finally {
<span class="nc" id="L123">                    zip.close();</span>
<span class="nc" id="L124">                }</span>
            } else {
                // Geen ZIP, direct BR XML laden
<span class="nc" id="L127">                brmo.loadFromStream(basisregistratie, in, bestand.getFileName(), totalAdder, null);</span>
            }

<span class="nc" id="L130">            List&lt;String&gt; warnings = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L131" title="All 2 branches missed.">            if(errors &gt; 0) {</span>
<span class="nc bnc" id="L132" title="All 2 branches missed.">                warnings.add(&quot;let op: &quot; + errors + &quot; bericht&quot; + (errors &gt; 1 ? &quot;en&quot; : &quot;&quot;) + &quot; niet ingeladen wegens fouten&quot;);</span>
            }
<span class="nc bnc" id="L134" title="All 2 branches missed.">            if(empty &gt; 0) {</span>
<span class="nc bnc" id="L135" title="All 2 branches missed.">                warnings.add(&quot;let op: &quot; + empty + (empty &gt; 1 ? &quot; lege berichten&quot; : &quot; leeg bericht&quot;) + &quot; overgeslagen&quot;);</span>
            }
<span class="nc bnc" id="L137" title="All 2 branches missed.">            if(duplicate &gt; 0) {</span>
<span class="nc bnc" id="L138" title="All 2 branches missed.">                warnings.add(&quot;let op: &quot; + duplicate + (duplicate &gt; 1 ? &quot; duplicate berichten&quot; : &quot; duplicaat bericht&quot;) + &quot; overgeslagen&quot;);</span>
            }

<span class="nc bnc" id="L141" title="All 2 branches missed.">            String warning = warnings.isEmpty() ? &quot;&quot; : &quot;, &quot; + String.join(&quot;, &quot;, warnings.toArray(new String[] {})) + &quot;, zie log voor bestandsnamen uit ZIP en details!&quot;;</span>

<span class="nc bnc" id="L143" title="All 2 branches missed.">            getContext().getMessages().add(new SimpleMessage(&quot;Bestand &quot; + bestand.getFileName() + &quot; is ingelezen, &quot; + theTotal.getValue() + &quot; berichten&quot; + (extractedFiles &gt; 0 ? &quot; (uit &quot; + extractedFiles + &quot; uitgepakte XML bestanden)&quot; : &quot;&quot;) + warning));</span>
<span class="nc" id="L144">            log.info(String.format(&quot;Stored %s data from file \&quot;%s\&quot; uploaded via form&quot;, basisregistratie, bestand.getFileName()));</span>
<span class="nc" id="L145">        } catch(Exception ex) {</span>
<span class="nc bnc" id="L146" title="All 4 branches missed.">            String msg = &quot;Fout bij inlezen bestand &quot; + (zip != null &amp;&amp; entry != null ? entry.getName() + &quot; uit ZIP bestand &quot; + bestand.getFileName() : bestand.getFileName());</span>
<span class="nc" id="L147">            log.error(msg, ex);</span>

<span class="nc" id="L149">            getContext().getMessages().add(new SimpleMessage(msg + &quot;: &quot; + ExceptionUtils.getRootCauseMessage(ex)));</span>
        } finally {
            try {
<span class="nc" id="L152">                bestand.delete();</span>
<span class="nc" id="L153">            } catch(IOException e) {</span>
                // ignore
<span class="nc" id="L155">            }</span>
<span class="nc" id="L156">            brmo.closeBrmoFramework();</span>
        }

<span class="nc" id="L159">        return new ForwardResolution(&quot;/WEB-INF/jsp/bestand/form.jsp&quot;);</span>
    }

    // &lt;editor-fold defaultstate=&quot;collapsed&quot; desc=&quot;getters en setters&quot;&gt;
    public ActionBeanContext getContext() {
<span class="nc" id="L164">        return context;</span>
    }

    public void setContext(ActionBeanContext context) {
<span class="nc" id="L168">        this.context = context;</span>
<span class="nc" id="L169">    }</span>

    public String getBasisregistratie() {
<span class="nc" id="L172">        return basisregistratie;</span>
    }

    public void setBasisregistratie(String basisregistratie) {
<span class="nc" id="L176">        this.basisregistratie = basisregistratie;</span>
<span class="nc" id="L177">    }</span>

    public FileBean getBestand() {
<span class="nc" id="L180">        return bestand;</span>
    }

    public void setBestand(FileBean bestand) {
<span class="nc" id="L184">        this.bestand = bestand;</span>
<span class="nc" id="L185">    }</span>
    // &lt;/editor-fold&gt;
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>