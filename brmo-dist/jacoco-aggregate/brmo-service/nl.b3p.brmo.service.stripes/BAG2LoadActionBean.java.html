<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>BAG2LoadActionBean.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">BRMO distributie</a> &gt; <a href="../index.html" class="el_bundle">brmo-service</a> &gt; <a href="index.source.html" class="el_package">nl.b3p.brmo.service.stripes</a> &gt; <span class="el_source">BAG2LoadActionBean.java</span></div><h1>BAG2LoadActionBean.java</h1><pre class="source lang-java linenums">/*
 * Copyright (C) 2021 B3Partners B.V.
 *
 * SPDX-License-Identifier: MIT
 *
 */

package nl.b3p.brmo.service.stripes;

import java.sql.Connection;
import java.sql.SQLException;
import java.text.SimpleDateFormat;
import java.util.Arrays;
import java.util.Date;
import javax.sql.DataSource;
import net.sourceforge.stripes.action.ActionBean;
import net.sourceforge.stripes.action.ActionBeanContext;
import net.sourceforge.stripes.action.Before;
import net.sourceforge.stripes.action.DefaultHandler;
import net.sourceforge.stripes.action.ForwardResolution;
import net.sourceforge.stripes.action.Resolution;
import nl.b3p.brmo.bag2.loader.BAG2Database;
import nl.b3p.brmo.bag2.loader.BAG2ProgressReporter;
import nl.b3p.brmo.bag2.loader.cli.BAG2DatabaseOptions;
import nl.b3p.brmo.bag2.loader.cli.BAG2LoadOptions;
import nl.b3p.brmo.bag2.loader.cli.BAG2LoaderMain;
import nl.b3p.brmo.bag2.schema.BAG2SchemaMapper;
import nl.b3p.brmo.loader.util.BrmoException;
import nl.b3p.brmo.service.util.ConfigUtil;
import nl.b3p.brmo.sql.dialect.OracleDialect;
import nl.b3p.brmo.sql.dialect.PostGISDialect;
import nl.b3p.jdbc.util.converter.PGConnectionUnwrapper;
import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import org.stripesstuff.plugin.waitpage.WaitPage;

<span class="nc" id="L37">public class BAG2LoadActionBean implements ActionBean {</span>
<span class="nc" id="L38">  private static final Log LOG = LogFactory.getLog(BAG2LoadActionBean.class);</span>

  private ActionBeanContext context;

  private static final String JSP = &quot;/WEB-INF/jsp/bestand/bag2.jsp&quot;;
  private static final String JSP_LOAD = &quot;/WEB-INF/jsp/bestand/bag2load.jsp&quot;;

<span class="nc" id="L45">  private String files =</span>
      &quot;https://service.pdok.nl/kadaster/adressen/atom/v1_0/downloads/lvbag-extract-nl.zip&quot;;

  private DataSource rsgbbag;
  private Throwable namingException;
<span class="nc" id="L50">  private boolean connectionOk = false;</span>
  private String connectionString;
  private String databaseName;
  private String databaseUserName;
  private String databaseDialect;
  private Exception connectionException;

  private Date standLoadTechnischeDatum;
  private Date currentTechnischeDatum;
  private Date standLoadTime;

  private boolean loading;
  private Date loadStart;
  private boolean loadResult;
  private Exception loadException;
  private String loadingLog;

  // &lt;editor-fold desc=&quot;getters en setters&quot;&gt;
  @Override
  public ActionBeanContext getContext() {
<span class="nc" id="L70">    return context;</span>
  }

  @Override
  public void setContext(ActionBeanContext context) {
<span class="nc" id="L75">    this.context = context;</span>
<span class="nc" id="L76">  }</span>

  public DataSource getRsgbbag() {
<span class="nc" id="L79">    return rsgbbag;</span>
  }

  public void setRsgbbag(DataSource rsgbbag) {
<span class="nc" id="L83">    this.rsgbbag = rsgbbag;</span>
<span class="nc" id="L84">  }</span>

  public Throwable getNamingException() {
<span class="nc" id="L87">    return namingException;</span>
  }

  public void setNamingException(Throwable namingException) {
<span class="nc" id="L91">    this.namingException = namingException;</span>
<span class="nc" id="L92">  }</span>

  public boolean isConnectionOk() {
<span class="nc" id="L95">    return connectionOk;</span>
  }

  public void setConnectionOk(boolean connectionOk) {
<span class="nc" id="L99">    this.connectionOk = connectionOk;</span>
<span class="nc" id="L100">  }</span>

  public String getConnectionString() {
<span class="nc" id="L103">    return connectionString;</span>
  }

  public void setConnectionString(String connectionString) {
<span class="nc" id="L107">    this.connectionString = connectionString;</span>
<span class="nc" id="L108">  }</span>

  public String getDatabaseName() {
<span class="nc" id="L111">    return databaseName;</span>
  }

  public void setDatabaseName(String databaseName) {
<span class="nc" id="L115">    this.databaseName = databaseName;</span>
<span class="nc" id="L116">  }</span>

  public String getDatabaseUserName() {
<span class="nc" id="L119">    return databaseUserName;</span>
  }

  public void setDatabaseUserName(String databaseUserName) {
<span class="nc" id="L123">    this.databaseUserName = databaseUserName;</span>
<span class="nc" id="L124">  }</span>

  public String getDatabaseDialect() {
<span class="nc" id="L127">    return databaseDialect;</span>
  }

  public void setDatabaseDialect(String databaseDialect) {
<span class="nc" id="L131">    this.databaseDialect = databaseDialect;</span>
<span class="nc" id="L132">  }</span>

  public Exception getConnectionException() {
<span class="nc" id="L135">    return connectionException;</span>
  }

  public void setConnectionException(Exception connectionException) {
<span class="nc" id="L139">    this.connectionException = connectionException;</span>
<span class="nc" id="L140">  }</span>

  public Date getStandLoadTechnischeDatum() {
<span class="nc" id="L143">    return standLoadTechnischeDatum;</span>
  }

  public void setStandLoadTechnischeDatum(Date standLoadTechnischeDatum) {
<span class="nc" id="L147">    this.standLoadTechnischeDatum = standLoadTechnischeDatum;</span>
<span class="nc" id="L148">  }</span>

  public Date getCurrentTechnischeDatum() {
<span class="nc" id="L151">    return currentTechnischeDatum;</span>
  }

  public void setCurrentTechnischeDatum(Date currentTechnischeDatum) {
<span class="nc" id="L155">    this.currentTechnischeDatum = currentTechnischeDatum;</span>
<span class="nc" id="L156">  }</span>

  public Date getStandLoadTime() {
<span class="nc" id="L159">    return standLoadTime;</span>
  }

  public void setStandLoadTime(Date standLoadTime) {
<span class="nc" id="L163">    this.standLoadTime = standLoadTime;</span>
<span class="nc" id="L164">  }</span>

  public String getFiles() {
<span class="nc" id="L167">    return files;</span>
  }

  public void setFiles(String files) {
<span class="nc" id="L171">    this.files = files;</span>
<span class="nc" id="L172">  }</span>

  public boolean isLoading() {
<span class="nc" id="L175">    return loading;</span>
  }

  public void setLoading(boolean loading) {
<span class="nc" id="L179">    this.loading = loading;</span>
<span class="nc" id="L180">  }</span>

  public boolean isLoadResult() {
<span class="nc" id="L183">    return loadResult;</span>
  }

  public void setLoadResult(boolean loadResult) {
<span class="nc" id="L187">    this.loadResult = loadResult;</span>
<span class="nc" id="L188">  }</span>

  public String getLoadingLog() {
<span class="nc" id="L191">    return loadingLog;</span>
  }

  public void setLoadingLog(String loadingLog) {
<span class="nc" id="L195">    this.loadingLog = loadingLog;</span>
<span class="nc" id="L196">  }</span>

  public Date getLoadStart() {
<span class="nc" id="L199">    return loadStart;</span>
  }

  public void setLoadStart(Date loadStart) {
<span class="nc" id="L203">    this.loadStart = loadStart;</span>
<span class="nc" id="L204">  }</span>

  public Date getUpdateTime() {
<span class="nc" id="L207">    return new Date();</span>
  }

<span class="nc" id="L210">  public void setUpdateTime(Date updateTime) {}</span>

  public Exception getLoadException() {
<span class="nc" id="L213">    return loadException;</span>
  }

  public void setLoadException(Exception loadException) {
<span class="nc" id="L217">    this.loadException = loadException;</span>
<span class="nc" id="L218">  }</span>

  // &lt;/editor-fold&gt;

  @Before(on = &quot;form&quot;)
  public void checkDatabase() {
    try {
<span class="nc" id="L225">      rsgbbag = ConfigUtil.getDataSourceRsgbBag(false);</span>
<span class="nc" id="L226">    } catch (Exception e) {</span>
<span class="nc bnc" id="L227" title="All 2 branches missed.">      if (e instanceof BrmoException) {</span>
<span class="nc" id="L228">        namingException = e.getCause();</span>
      } else {
<span class="nc" id="L230">        namingException = e;</span>
      }
<span class="nc" id="L232">    }</span>

<span class="nc bnc" id="L234" title="All 2 branches missed.">    if (rsgbbag != null) {</span>
<span class="nc" id="L235">      try (Connection c = rsgbbag.getConnection()) {</span>
<span class="nc" id="L236">        connectionOk = true;</span>
<span class="nc" id="L237">        connectionString = c.getMetaData().getURL();</span>
<span class="nc" id="L238">        databaseName = c.getMetaData().getDatabaseProductVersion();</span>
<span class="nc bnc" id="L239" title="All 2 branches missed.">        if (!databaseName.contains(c.getMetaData().getDatabaseProductName())) {</span>
<span class="nc" id="L240">          databaseName = c.getMetaData().getDatabaseProductName() + &quot; &quot; + databaseName;</span>
        }
<span class="nc" id="L242">        databaseUserName = c.getMetaData().getUserName();</span>
<span class="nc" id="L243">        BAG2Database bag2Database = new BAG2Database(new BAG2DatabaseOptions(), c);</span>

<span class="nc bnc" id="L245" title="All 2 branches missed.">        if (bag2Database.getDialect() instanceof PostGISDialect) {</span>
<span class="nc" id="L246">          databaseDialect = &quot;postgis&quot;;</span>
<span class="nc bnc" id="L247" title="All 2 branches missed.">        } else if (bag2Database.getDialect() instanceof OracleDialect) {</span>
<span class="nc" id="L248">          databaseDialect = &quot;oracle&quot;;</span>
        } else {
<span class="nc" id="L250">          throw new IllegalArgumentException(&quot;Unknown database dialect&quot;);</span>
        }

        try {
<span class="nc" id="L254">          String s =</span>
<span class="nc" id="L255">              bag2Database.getMetadata(BAG2SchemaMapper.Metadata.STAND_LOAD_TECHNISCHE_DATUM);</span>
<span class="nc bnc" id="L256" title="All 2 branches missed.">          if (s != null) {</span>
<span class="nc" id="L257">            SimpleDateFormat df = new SimpleDateFormat(&quot;yyyy-MM-dd&quot;);</span>
<span class="nc" id="L258">            currentTechnischeDatum =</span>
<span class="nc" id="L259">                df.parse(</span>
<span class="nc" id="L260">                    bag2Database.getMetadata(BAG2SchemaMapper.Metadata.CURRENT_TECHNISCHE_DATUM));</span>
<span class="nc" id="L261">            standLoadTechnischeDatum = df.parse(s);</span>
<span class="nc" id="L262">            standLoadTime =</span>
                new SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss&quot;)
<span class="nc" id="L264">                    .parse(bag2Database.getMetadata(BAG2SchemaMapper.Metadata.STAND_LOAD_TIME));</span>
          }
<span class="nc" id="L266">        } catch (SQLException e) {</span>
          // Metadata table does not exist
<span class="nc" id="L268">        }</span>

<span class="nc" id="L270">      } catch (Exception e) {</span>
<span class="nc" id="L271">        connectionOk = false;</span>
<span class="nc" id="L272">        connectionException = e;</span>
<span class="nc" id="L273">      }</span>
    }
<span class="nc" id="L275">  }</span>

  @DefaultHandler
  public Resolution form() {
<span class="nc" id="L279">    return new ForwardResolution(JSP);</span>
  }

  @WaitPage(path = JSP_LOAD, delay = 1000, refresh = 5000)
  public Resolution load() throws Exception {
<span class="nc" id="L284">    loading = true;</span>
<span class="nc" id="L285">    loadStart = new Date();</span>
<span class="nc" id="L286">    try (Connection rsgbBagConnection = ConfigUtil.getDataSourceRsgbBag(true).getConnection()) {</span>
<span class="nc" id="L287">      BAG2DatabaseOptions databaseOptions = new BAG2DatabaseOptions();</span>
      // Niet nodig (rsgbbagConnection wordt gebruikt), maar voor de duidelijkheid
<span class="nc" id="L289">      databaseOptions.setConnectionString(rsgbBagConnection.getMetaData().getURL());</span>
<span class="nc" id="L290">      Connection connection = rsgbBagConnection;</span>
<span class="nc bnc" id="L291" title="All 2 branches missed.">      if (databaseOptions.getConnectionString().startsWith(&quot;jdbc:postgresql:&quot;)) {</span>
        // Voor gebruik van pgCopy is unwrappen van de connectie nodig.
        // Ook al doet PostGISCopyInsertBatch zelf ook een unwrap, de PGConnectionUnwrapper
        // kan ook Tomcat JNDI
        // connection pool unwrapping aan welke niet met een normale Connection.unwrap()
        // werkt.
<span class="nc" id="L297">        connection = (Connection) PGConnectionUnwrapper.unwrap(rsgbBagConnection);</span>
<span class="nc" id="L298">        databaseOptions.setUsePgCopy(true);</span>
      }
<span class="nc" id="L300">      BAG2Database bag2Database =</span>
<span class="nc" id="L301">          new BAG2Database(databaseOptions, connection) {</span>
            /** connectie niet sluiten; dat doen we later als we helemaal klaar zijn */
            @Override
            public void close() {
<span class="nc" id="L305">              LOG.debug(&quot;Had de BAG database connectie kunnen sluiten... maar niet gedaan.&quot;);</span>
<span class="nc" id="L306">            }</span>
          };
<span class="nc" id="L308">      BAG2LoaderMain.configureLogging(false);</span>
<span class="nc" id="L309">      BAG2LoaderMain main = new BAG2LoaderMain();</span>
<span class="nc" id="L310">      BAG2LoadOptions loadOptions = new BAG2LoadOptions();</span>
<span class="nc" id="L311">      main.loadFiles(</span>
          bag2Database,
          databaseOptions,
          loadOptions,
          new BAG2ProgressReporter(),
<span class="nc" id="L316">          Arrays.stream(files.split(&quot;\n&quot;)).map(String::trim).toArray(String[]::new),</span>
          null);
<span class="nc" id="L318">      this.loadResult = true;</span>
<span class="nc" id="L319">    } catch (Exception e) {</span>
<span class="nc" id="L320">      this.loadResult = false;</span>
<span class="nc" id="L321">      this.loadException = e;</span>
<span class="nc" id="L322">      LOG.error(&quot;Error loading BAG 2.0&quot;, e);</span>
    } finally {
<span class="nc" id="L324">      this.loading = false;</span>
    }
<span class="nc" id="L326">    return new ForwardResolution(JSP_LOAD);</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>