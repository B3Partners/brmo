<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="nl"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>MailRapportage.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">BRMO distributie</a> &gt; <a href="../index.html" class="el_bundle">brmo-service</a> &gt; <a href="index.source.html" class="el_package">nl.b3p.brmo.service.scanner</a> &gt; <span class="el_source">MailRapportage.java</span></div><h1>MailRapportage.java</h1><pre class="source lang-java linenums">/*
 * Copyright (C) 2015 B3Partners B.V.
 */
package nl.b3p.brmo.service.scanner;

import java.util.ArrayList;
import java.util.Calendar;
import java.util.Date;
import java.util.List;
import java.util.regex.Matcher;
import java.util.regex.Pattern;
import javax.mail.Message;
import javax.mail.MessagingException;
import javax.mail.Session;
import javax.mail.Transport;
import javax.mail.internet.InternetAddress;
import javax.mail.internet.MimeMessage;
import javax.naming.Context;
import javax.naming.InitialContext;
import javax.naming.NamingException;
import nl.b3p.brmo.loader.util.BrmoException;
import nl.b3p.brmo.persistence.staging.MailRapportageProces;
import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import javax.persistence.EntityManager;
import javax.persistence.criteria.CriteriaBuilder;
import javax.persistence.criteria.CriteriaQuery;
import javax.persistence.criteria.Predicate;
import javax.persistence.criteria.Root;
import nl.b3p.brmo.persistence.staging.AutomatischProces;
import static nl.b3p.brmo.persistence.staging.AutomatischProces.LOG_NEWLINE;
import static nl.b3p.brmo.persistence.staging.AutomatischProces.ProcessingStatus.ERROR;
import static nl.b3p.brmo.persistence.staging.AutomatischProces.ProcessingStatus.PROCESSING;
import static nl.b3p.brmo.persistence.staging.AutomatischProces.ProcessingStatus.WAITING;
import nl.b3p.brmo.persistence.staging.ClobElement;
import org.stripesstuff.stripersist.Stripersist;

/**
 * Mailt rapporten.
 *
 * @author mprins
 */
public class MailRapportage extends AbstractExecutableProces {

<span class="nc" id="L45">    private static final Log log = LogFactory.getLog(MailRapportage.class);</span>
    private MailRapportageProces config;

<span class="nc" id="L48">    public MailRapportage(MailRapportageProces config) {</span>
<span class="nc" id="L49">        this.config = config;</span>
<span class="nc" id="L50">    }</span>

    /**
     * De inhoud van dit bericht bestaat uit de samenvattingen en de status van
     * de geselecteerde processen, indien niets geselecteerd rapportage van
     * alles behalve het eigen proces.
     *
     * @throws BrmoException als er een fout optreed in het opzoeken van de
     * mailserver (indi) of het versturen van de mail
     */
    @Override
    public void execute() throws BrmoException {
<span class="nc" id="L62">        this.active = true;</span>
<span class="nc" id="L63">        StringBuilder sb = new StringBuilder();</span>
<span class="nc" id="L64">        config.setStatus(PROCESSING);</span>
<span class="nc" id="L65">        String logMsg = String.format(&quot;De mail rapportage met ID %d is gestart op %tc.&quot;, config.getId(), Calendar.getInstance());</span>
<span class="nc" id="L66">        log.info(logMsg);</span>
<span class="nc" id="L67">        sb.append(logMsg).append(LOG_NEWLINE);</span>

        try {
<span class="nc" id="L70">            Context init = new InitialContext();</span>
<span class="nc" id="L71">            Context env = (Context) init.lookup(&quot;java:comp/env&quot;);</span>
<span class="nc" id="L72">            Session session = (Session) env.lookup(&quot;mail/session&quot;);</span>
<span class="nc" id="L73">            Message msg = new MimeMessage(session);</span>
<span class="nc" id="L74">            msg.setFrom(/* 'mail.from' property uit jndi session object */);</span>
<span class="nc" id="L75">            msg.setSentDate(new Date());</span>
            // subject
<span class="nc bnc" id="L77" title="All 2 branches missed.">            String sForStatus = (config.getForStatus() == null ? &quot;alle&quot; : config.getForStatus().toString());</span>
<span class="nc bnc" id="L78" title="All 2 branches missed.">            String sPIDS = (config.getConfig().get(MailRapportageProces.PIDS) == null ? &quot;alle&quot; : config.getConfig().get(MailRapportageProces.PIDS).getValue());</span>
<span class="nc bnc" id="L79" title="All 2 branches missed.">            String label = (ClobElement.nullSafeGet(config.getConfig().get(&quot;label&quot;)) == null ? &quot;&quot; : config.getConfig().get(&quot;label&quot;).getValue());</span>
<span class="nc" id="L80">            String subject = String.format(&quot;BRMO rapport: %d (%s) voor status: %s (taken: %s)&quot;, config.getId(), label, sForStatus, sPIDS);</span>
<span class="nc" id="L81">            msg.setSubject(subject);</span>

            // ontvangers
<span class="nc" id="L84">            String[] adressen = this.config.getMailAdressenArray();</span>
<span class="nc" id="L85">            InternetAddress[] aanAdr = new InternetAddress[adressen.length];</span>
<span class="nc bnc" id="L86" title="All 2 branches missed.">            for (int i = 0; i &lt; adressen.length; i++) {</span>
<span class="nc" id="L87">                aanAdr[i] = new InternetAddress(adressen[i]);</span>
            }
<span class="nc" id="L89">            msg.setRecipients(Message.RecipientType.TO, aanAdr);</span>

<span class="nc" id="L91">            StringBuilder mailText = new StringBuilder();</span>
<span class="nc" id="L92">            List&lt;AutomatischProces&gt; processen = this.getProcessen();</span>
            // bericht mailText samenstellen
<span class="nc bnc" id="L94" title="All 2 branches missed.">            for (AutomatischProces p : processen) {</span>
<span class="nc" id="L95">                logMsg = String.format(&quot;Rapportage van taak %d met status: %s&quot;, p.getId(), p.getStatus());</span>
<span class="nc" id="L96">                log.info(logMsg);</span>
<span class="nc" id="L97">                sb.append(logMsg).append(LOG_NEWLINE);</span>

<span class="nc" id="L99">                mailText.append(&quot;Rapport van taak: &quot;).append(p.getId()).append(&quot; &quot;).append(label)</span>
<span class="nc" id="L100">                        .append(&quot;, type: &quot;).append(p.getClass().getSimpleName()).append(LOG_NEWLINE);</span>
<span class="nc" id="L101">                mailText.append(&quot;Status van de taak: &quot;).append(p.getStatus()).append(LOG_NEWLINE);</span>
<span class="nc" id="L102">                mailText.append(&quot;Samenvatting: &quot;).append(LOG_NEWLINE);</span>
<span class="nc" id="L103">                mailText.append(p.getSamenvatting()).append(LOG_NEWLINE);</span>
<span class="nc" id="L104">                mailText.append(&quot;---------------------------------&quot;).append(LOG_NEWLINE);</span>
<span class="nc" id="L105">            }</span>
<span class="nc bnc" id="L106" title="All 2 branches missed.">            if (processen.isEmpty()) {</span>
<span class="nc" id="L107">                mailText.append(&quot;Er waren geen automatische processen die voldeden aan de opgegeven voorwaarden: &quot;).append(LOG_NEWLINE);</span>
<span class="nc" id="L108">                mailText.append(&quot; - Status: &quot;).append(sForStatus).append(LOG_NEWLINE);</span>
<span class="nc" id="L109">                mailText.append(&quot; - Taken: &quot;).append(sPIDS).append(LOG_NEWLINE);</span>
            }
<span class="nc" id="L111">            log.debug(mailText.toString());</span>
<span class="nc" id="L112">            msg.setText(mailText.toString());</span>
<span class="nc" id="L113">            Transport.send(msg);</span>

<span class="nc" id="L115">            logMsg = String.format(&quot;Klaar met taak %d op %tc&quot;, config.getId(), Calendar.getInstance());</span>
<span class="nc" id="L116">            log.info(logMsg);</span>
<span class="nc" id="L117">            sb.append(logMsg).append(LOG_NEWLINE);</span>
<span class="nc" id="L118">            config.setStatus(WAITING);</span>
<span class="nc" id="L119">            config.updateSamenvattingEnLogfile(sb.toString());</span>
<span class="nc" id="L120">            config.setLastrun(new Date());</span>
<span class="nc" id="L121">        } catch (MessagingException ex) {</span>
<span class="nc" id="L122">            log.error(ex);</span>
<span class="nc" id="L123">            config.setStatus(ERROR);</span>
<span class="nc" id="L124">            throw new BrmoException(ex);</span>
<span class="nc" id="L125">        } catch (NamingException ex) {</span>
<span class="nc" id="L126">            log.error(ex);</span>
<span class="nc" id="L127">            config.setStatus(ERROR);</span>
<span class="nc" id="L128">            throw new BrmoException(ex);</span>
        } finally {
<span class="nc" id="L130">            this.active = false;</span>
        }
<span class="nc" id="L132">    }</span>

    /**
     * Haalt de lijst met processen op uit de database.
     *
     * @return lijst met te rapporten processen
     * @todo Eventueel andere mail rapportage processen ook uitsluiten?
     */
    private List&lt;AutomatischProces&gt; getProcessen() {
        // unit test in nl.b3p.brmo.persistence.staging.MailRapportageProcesTest#testRapportageLijst()
<span class="nc" id="L142">        List&lt;Predicate&gt; predicates = new ArrayList&lt;Predicate&gt;();</span>

<span class="nc" id="L144">        final EntityManager em = Stripersist.getEntityManager();</span>
<span class="nc" id="L145">        CriteriaBuilder cb = em.getCriteriaBuilder();</span>
<span class="nc" id="L146">        CriteriaQuery&lt;AutomatischProces&gt; cq = cb.createQuery(AutomatischProces.class);</span>
<span class="nc" id="L147">        Root&lt;AutomatischProces&gt; from = cq.from(AutomatischProces.class);</span>

        // where status=... filter
<span class="nc bnc" id="L150" title="All 2 branches missed.">        if (this.config.getForStatus() != null) {</span>
<span class="nc" id="L151">            Predicate where = cb.equal(from.get(&quot;status&quot;), this.config.getForStatus());</span>
<span class="nc" id="L152">            predicates.add(where);</span>
        }
        // processen in... filter
<span class="nc" id="L155">        String pids = ClobElement.nullSafeGet(this.config.getConfig().get(MailRapportageProces.PIDS));</span>
<span class="nc bnc" id="L156" title="All 2 branches missed.">        if (pids != null) {</span>
<span class="nc" id="L157">            List&lt;Long&gt; pidLijst = new ArrayList&lt;Long&gt;();</span>
<span class="nc" id="L158">            Matcher match = (Pattern.compile(&quot;[0-9]+&quot;)).matcher(pids);</span>
<span class="nc bnc" id="L159" title="All 2 branches missed.">            while (match.find()) {</span>
<span class="nc" id="L160">                pidLijst.add(Long.valueOf(match.group()));</span>
            }
<span class="nc" id="L162">            Predicate in = from.get(&quot;id&quot;).in(pidLijst);</span>
<span class="nc" id="L163">            predicates.add(in);</span>
        }
        // TODO eventueel filter op dtype
        // niet het eigen proces rapporteren
<span class="nc" id="L167">        Predicate notIn = from.get(&quot;id&quot;).in(this.config.getId()).not();</span>
<span class="nc" id="L168">        predicates.add(notIn);</span>

<span class="nc" id="L170">        cq.where(cb.and(predicates.toArray(new Predicate[predicates.size()])));</span>
        // sorteer op status, daarna op datum zodat errors bovenaan staan
<span class="nc" id="L172">        cq.orderBy(cb.asc(from.get(&quot;status&quot;)));</span>
<span class="nc" id="L173">        cq.orderBy(cb.asc(from.get(&quot;lastrun&quot;)));</span>

<span class="nc" id="L175">        return em.createQuery(cq).getResultList();</span>
    }

    @Override
    public void execute(ProgressUpdateListener listener) {
        try {
<span class="nc" id="L181">            this.execute();</span>
<span class="nc" id="L182">        } catch (BrmoException ex) {</span>
<span class="nc" id="L183">            log.error(ex);</span>
<span class="nc" id="L184">        }</span>
<span class="nc" id="L185">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>