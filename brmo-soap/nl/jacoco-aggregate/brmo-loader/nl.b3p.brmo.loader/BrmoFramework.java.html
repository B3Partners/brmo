<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="nl"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>BrmoFramework.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">BRMO SOAP bevragingsservice</a> &gt; <a href="../index.html" class="el_bundle">brmo-loader</a> &gt; <a href="index.source.html" class="el_package">nl.b3p.brmo.loader</a> &gt; <span class="el_source">BrmoFramework.java</span></div><h1>BrmoFramework.java</h1><pre class="source lang-java linenums">package nl.b3p.brmo.loader;

import nl.b3p.brmo.loader.checks.AfgifteChecker;
import nl.b3p.brmo.loader.entity.Bericht;
import nl.b3p.brmo.loader.entity.LaadProces;
import nl.b3p.brmo.loader.updates.UpdateProcess;
import nl.b3p.brmo.loader.util.BrmoDuplicaatLaadprocesException;
import nl.b3p.brmo.loader.util.BrmoException;
import nl.b3p.brmo.loader.util.BrmoLeegBestandException;
import nl.b3p.brmo.loader.util.TopNLRsgbTransformer;
import nl.b3p.jdbc.util.converter.GeometryJdbcConverter;
import nl.b3p.jdbc.util.converter.GeometryJdbcConverterFactory;
import nl.b3p.topnl.TopNLType;

import org.apache.commons.dbutils.DbUtils;
import org.apache.commons.dbutils.QueryRunner;
import org.apache.commons.dbutils.handlers.ScalarHandler;
import org.apache.commons.io.input.CloseShieldInputStream;
import org.apache.commons.io.input.CountingInputStream;
import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;

import java.io.File;
import java.io.FileInputStream;
import java.io.IOException;
import java.io.InputStream;
import java.math.BigInteger;
import java.sql.Connection;
import java.sql.SQLException;
import java.util.Date;
import java.util.List;
import java.util.zip.ZipEntry;
import java.util.zip.ZipInputStream;

import javax.sql.DataSource;
import javax.xml.bind.JAXBException;

/**
 * BRMO framework.
 *
 * @author Matthijs Laan
 */
public class BrmoFramework {

<span class="nc" id="L45">    private static final Log log = LogFactory.getLog(BrmoFramework.class);</span>

    public static final String BR_BAG = &quot;bag&quot;;
    public static final String BR_BRK = &quot;brk&quot;;
    public static final String BR_BRK2 = &quot;brk2&quot;;
    public static final String BR_NHR = &quot;nhr&quot;;
    public static final String BR_TOPNL = &quot;topnl&quot;;
    public static final String BR_BRP = &quot;brp&quot;;
    public static final String BR_GBAV = &quot;gbav&quot;;
    public static final String BR_WOZ = &quot;woz&quot;;

    public static final String XSL_BRK = &quot;/xsl/brk-snapshot-to-rsgb-xml.xsl&quot;;
    public static final String XSL_BRK2 = &quot;/xsl/brk2-snapshot-to-rsgb-xml.xsl&quot;;
    public static final String XSL_BAG = &quot;/xsl/bag-mutatie-to-rsgb-xml.xsl&quot;;
    public static final String XSL_NHR = &quot;/xsl/nhr-to-rsgb-xml-3.0.xsl&quot;;
    public static final String XSL_BRP = &quot;/xsl/brp-to-rsgb-xml.xsl&quot;;
    public static final String XSL_GBAV = &quot;/xsl/gbav-to-rsgb-xml.xsl&quot;;
    public static final String XSL_WOZ = &quot;/xsl/woz-to-rsgb.xsl&quot;;

    public static final String LAADPROCES_TABEL = &quot;laadproces&quot;;
    public static final String BERICHT_TABLE = &quot;bericht&quot;;
    public static final String JOB_TABLE = &quot;job&quot;;
    public static final String BRMO_METADATA_TABEL = &quot;brmo_metadata&quot;;

<span class="nc" id="L69">    private StagingProxy stagingProxy = null;</span>
    private DataSource dataSourceRsgb;
    private DataSource dataSourceRsgbBrk;
<span class="nc" id="L72">    private DataSource dataSourceRsgbBgt = null;</span>
    private DataSource dataSourceStaging;
<span class="nc" id="L74">    private DataSource dataSourceTopNL = null;</span>
<span class="nc" id="L75">    private boolean enablePipeline = false;</span>
    private Integer pipelineCapacity;
<span class="nc" id="L77">    private boolean renewConnectionAfterCommit = false;</span>
<span class="nc" id="L78">    private boolean orderBerichten = true;</span>
<span class="nc" id="L79">    private String errorState = null;</span>

    public BrmoFramework(
            DataSource dataSourceStaging, DataSource dataSourceRsgb, DataSource dataSourceRsgbBrk)
<span class="nc" id="L83">            throws BrmoException {</span>
<span class="nc bnc" id="L84" title="All 2 branches missed.">        if (dataSourceStaging != null) {</span>
            try {
<span class="nc" id="L86">                stagingProxy = new StagingProxy(dataSourceStaging);</span>
<span class="nc" id="L87">            } catch (SQLException ex) {</span>
<span class="nc" id="L88">                throw new BrmoException(ex);</span>
<span class="nc" id="L89">            }</span>
        }
<span class="nc" id="L91">        this.dataSourceStaging = dataSourceStaging;</span>
<span class="nc" id="L92">        this.dataSourceRsgb = dataSourceRsgb;</span>
<span class="nc" id="L93">        this.dataSourceRsgbBrk = dataSourceRsgbBrk;</span>
<span class="nc" id="L94">    }</span>

    public BrmoFramework(
            DataSource dataSourceStaging,
            DataSource dataSourceRsgb,
            DataSource dataSourceRsgbBgt,
            DataSource dataSourceTopNL,
            DataSource dataSourceRsgbBrk)
<span class="nc" id="L102">            throws BrmoException {</span>
<span class="nc bnc" id="L103" title="All 2 branches missed.">        if (dataSourceStaging != null) {</span>
            try {
<span class="nc" id="L105">                stagingProxy = new StagingProxy(dataSourceStaging);</span>
<span class="nc" id="L106">            } catch (SQLException ex) {</span>
<span class="nc" id="L107">                throw new BrmoException(ex);</span>
<span class="nc" id="L108">            }</span>
        }
<span class="nc" id="L110">        this.dataSourceRsgb = dataSourceRsgb;</span>
<span class="nc" id="L111">        this.dataSourceRsgbBgt = dataSourceRsgbBgt;</span>
<span class="nc" id="L112">        this.dataSourceStaging = dataSourceStaging;</span>
<span class="nc" id="L113">        this.dataSourceTopNL = dataSourceTopNL;</span>
<span class="nc" id="L114">        this.dataSourceRsgbBrk = dataSourceRsgbBrk;</span>
<span class="nc" id="L115">    }</span>

    public void setDataSourceRsgbBgt(DataSource dataSourceRsgbBgt) {
<span class="nc" id="L118">        this.dataSourceRsgbBgt = dataSourceRsgbBgt;</span>
<span class="nc" id="L119">    }</span>

    public void setDataSourceTopNL(DataSource dataSourceTopNL) {
<span class="nc" id="L122">        this.dataSourceTopNL = dataSourceTopNL;</span>
<span class="nc" id="L123">    }</span>

    public String getStagingVersion() {
        try {
<span class="nc" id="L127">            return getVersion(dataSourceStaging);</span>
<span class="nc" id="L128">        } catch (SQLException ex) {</span>
<span class="nc" id="L129">            log.error(&quot;Versienummer kon niet uit de STAGING database worden gelezen.&quot;, ex);</span>
<span class="nc" id="L130">            return &quot;&quot;;</span>
        }
    }

    public String getRsgbVersion() {
        try {
<span class="nc" id="L136">            return getVersion(dataSourceRsgb);</span>
<span class="nc" id="L137">        } catch (SQLException ex) {</span>
<span class="nc" id="L138">            log.error(&quot;Versienummer kon niet uit de RSGB database worden gelezen.&quot;, ex);</span>
<span class="nc" id="L139">            return &quot;&quot;;</span>
        }
    }

    public String getRsgbBgtVersion() {
        try {
<span class="nc" id="L145">            return getVersion(dataSourceRsgbBgt);</span>
<span class="nc" id="L146">        } catch (SQLException ex) {</span>
<span class="nc" id="L147">            log.error(&quot;Versienummer kon niet uit de RSGBBGT database worden gelezen.&quot;, ex);</span>
<span class="nc" id="L148">            return &quot;&quot;;</span>
        }
    }

    public String getRsgbBrkVersion() {
        try {
<span class="nc" id="L154">            return getVersion(dataSourceRsgbBrk);</span>
<span class="nc" id="L155">        } catch (SQLException ex) {</span>
<span class="nc" id="L156">            log.error(&quot;Versienummer kon niet uit de RSGB BRK database worden gelezen.&quot;, ex);</span>
<span class="nc" id="L157">            return &quot;&quot;;</span>
        }
    }

    private String getVersion(DataSource dataSource) throws SQLException {
<span class="nc" id="L162">        String sql =</span>
                &quot;SELECT waarde FROM &quot;
                        + BrmoFramework.BRMO_METADATA_TABEL
                        + &quot; WHERE naam = 'brmoversie'&quot;;
<span class="nc" id="L166">        final Connection c = dataSource.getConnection();</span>
<span class="nc" id="L167">        GeometryJdbcConverter geomToJdbc = GeometryJdbcConverterFactory.getGeometryJdbcConverter(c);</span>
<span class="nc" id="L168">        String o =</span>
<span class="nc" id="L169">                new QueryRunner(geomToJdbc.isPmdKnownBroken()).query(c, sql, new ScalarHandler&lt;&gt;());</span>
<span class="nc" id="L170">        DbUtils.closeQuietly(c);</span>
<span class="nc" id="L171">        return o;</span>
    }

    public void setEnablePipeline(boolean enablePipeline) {
<span class="nc" id="L175">        this.enablePipeline = enablePipeline;</span>
<span class="nc" id="L176">    }</span>

    public void setRenewConnectionAfterCommit(boolean renewConnectionAfterCommit) {
<span class="nc" id="L179">        this.renewConnectionAfterCommit = renewConnectionAfterCommit;</span>
<span class="nc" id="L180">    }</span>

    public void setTransformPipelineCapacity(int pipelineCapacity) {
<span class="nc" id="L183">        this.pipelineCapacity = pipelineCapacity;</span>
<span class="nc" id="L184">    }</span>

    public void setBatchCapacity(int batchCapacity) {
<span class="nc bnc" id="L187" title="All 2 branches missed.">        if (stagingProxy != null) {</span>
<span class="nc" id="L188">            stagingProxy.setBatchCapacity(batchCapacity);</span>
        }
<span class="nc" id="L190">    }</span>

    public void setLimitStandBerichtenToTransform(Integer limitStandBerichtenToTransform) {
<span class="nc bnc" id="L193" title="All 2 branches missed.">        if (stagingProxy != null) {</span>
<span class="nc" id="L194">            stagingProxy.setLimitStandBerichtenToTransform(limitStandBerichtenToTransform);</span>
        }
<span class="nc" id="L196">    }</span>

    /**
     * stel bericht sortering van berichten in.
     *
     * @param orderBerichten {@code false} voor stand, {@code true} voor mutaties
     */
    public void setOrderBerichten(boolean orderBerichten) {
<span class="nc" id="L204">        this.orderBerichten = orderBerichten;</span>
<span class="nc" id="L205">    }</span>

    public boolean isOrderBerichten() {
<span class="nc" id="L208">        return this.orderBerichten;</span>
    }

    public void setErrorState(String errorState) {
<span class="nc" id="L212">        this.errorState = errorState;</span>
<span class="nc" id="L213">    }</span>

    public void closeBrmoFramework() {
<span class="nc bnc" id="L216" title="All 2 branches missed.">        if (stagingProxy != null) {</span>
<span class="nc" id="L217">            stagingProxy.closeStagingProxy();</span>
        }
        // rsgbProxy is thread and will be closed in thread
<span class="nc" id="L220">    }</span>

    public Thread toRsgb() throws BrmoException {
<span class="nc" id="L223">        return toRsgb((ProgressUpdateListener) null);</span>
    }

    public Thread toRsgb(ProgressUpdateListener listener) throws BrmoException {
<span class="nc" id="L227">        return toRsgb(Bericht.STATUS.STAGING_OK, listener);</span>
    }

    public Thread toRsgb(Bericht.STATUS status, ProgressUpdateListener listener)
            throws BrmoException {
<span class="nc" id="L232">        RsgbProxy rsgbProxy =</span>
                new RsgbProxy(dataSourceRsgb, dataSourceRsgbBrk, stagingProxy, status, listener);
<span class="nc" id="L234">        rsgbProxy.setEnablePipeline(enablePipeline);</span>
<span class="nc bnc" id="L235" title="All 2 branches missed.">        if (pipelineCapacity != null) {</span>
<span class="nc" id="L236">            rsgbProxy.setPipelineCapacity(pipelineCapacity);</span>
        }
<span class="nc" id="L238">        rsgbProxy.setRenewConnectionAfterCommit(renewConnectionAfterCommit);</span>
<span class="nc" id="L239">        rsgbProxy.setOrderBerichten(orderBerichten);</span>
<span class="nc" id="L240">        rsgbProxy.setErrorState(errorState);</span>
<span class="nc" id="L241">        Thread t = new Thread(rsgbProxy);</span>
<span class="nc" id="L242">        t.start();</span>
<span class="nc" id="L243">        return t;</span>
    }

    /**
     * @param mode geeft aan wat ids zijn (laadprocessen of berichten)
     * @param ids array van ids
     * @param listener voortgangs listener
     * @return running transformatie thread
     * @throws BrmoException if any
     */
    public Thread toRsgb(
            RsgbProxy.BerichtSelectMode mode, long[] ids, ProgressUpdateListener listener)
            throws BrmoException {
<span class="nc" id="L256">        String soort = &quot;&quot;;</span>
<span class="nc bnc" id="L257" title="All 2 branches missed.">        if (mode == RsgbProxy.BerichtSelectMode.BY_LAADPROCES) {</span>
            try {
<span class="nc" id="L259">                soort = stagingProxy.getLaadProcesById(ids[0]).getSoort();</span>
<span class="nc" id="L260">            } catch (SQLException ex) {</span>
<span class="nc" id="L261">                throw new BrmoException(ex);</span>
<span class="nc" id="L262">            }</span>
        }

        Runnable worker;
<span class="nc bnc" id="L266" title="All 2 branches missed.">        if (TopNLType.isTopNLType(soort)) {</span>
            try {
<span class="nc" id="L268">                worker = new TopNLRsgbTransformer(dataSourceTopNL, stagingProxy, ids, listener);</span>
<span class="nc" id="L269">            } catch (JAXBException | SQLException ex) {</span>
<span class="nc" id="L270">                throw new BrmoException(&quot;Probleem met TopNL parser initialiseren: &quot;, ex);</span>
<span class="nc" id="L271">            }</span>
        } else {
<span class="nc" id="L273">            worker =</span>
                    new RsgbProxy(
                            dataSourceRsgb, dataSourceRsgbBrk, stagingProxy, mode, ids, listener);
<span class="nc" id="L276">            ((RsgbProxy) worker).setEnablePipeline(enablePipeline);</span>
<span class="nc bnc" id="L277" title="All 2 branches missed.">            if (pipelineCapacity != null) {</span>
<span class="nc" id="L278">                ((RsgbProxy) worker).setPipelineCapacity(pipelineCapacity);</span>
            }
<span class="nc" id="L280">            ((RsgbProxy) worker).setRenewConnectionAfterCommit(renewConnectionAfterCommit);</span>
<span class="nc" id="L281">            ((RsgbProxy) worker).setOrderBerichten(orderBerichten);</span>
<span class="nc" id="L282">            ((RsgbProxy) worker).setErrorState(errorState);</span>
        }
<span class="nc" id="L284">        Thread t = new Thread(worker);</span>
<span class="nc" id="L285">        t.start();</span>
<span class="nc" id="L286">        return t;</span>
    }

    public Thread toRsgb(UpdateProcess updateProcess, ProgressUpdateListener listener)
            throws BrmoException {
<span class="nc" id="L291">        RsgbProxy rsgbProxy =</span>
                new RsgbProxy(
                        dataSourceRsgb, dataSourceRsgbBrk, stagingProxy, updateProcess, listener);
<span class="nc" id="L294">        rsgbProxy.setEnablePipeline(enablePipeline);</span>
<span class="nc bnc" id="L295" title="All 2 branches missed.">        if (pipelineCapacity != null) {</span>
<span class="nc" id="L296">            rsgbProxy.setPipelineCapacity(pipelineCapacity);</span>
        }
<span class="nc" id="L298">        rsgbProxy.setRenewConnectionAfterCommit(renewConnectionAfterCommit);</span>
<span class="nc" id="L299">        rsgbProxy.setOrderBerichten(orderBerichten);</span>
<span class="nc" id="L300">        rsgbProxy.setErrorState(errorState);</span>
<span class="nc" id="L301">        Thread t = new Thread(rsgbProxy);</span>
<span class="nc" id="L302">        t.start();</span>
<span class="nc" id="L303">        return t;</span>
    }

    public void delete(Long id) throws BrmoException {
<span class="nc bnc" id="L307" title="All 2 branches missed.">        if (id != null) {</span>
            try {
<span class="nc" id="L309">                stagingProxy.deleteByLaadProcesId(id);</span>
<span class="nc" id="L310">            } catch (SQLException ex) {</span>
<span class="nc" id="L311">                throw new BrmoException(ex);</span>
<span class="nc" id="L312">            }</span>
        }
<span class="nc" id="L314">    }</span>

    public List&lt;LaadProces&gt; listLaadProcessen() throws BrmoException {
        try {
<span class="nc" id="L318">            return stagingProxy.getLaadProcessen();</span>
<span class="nc" id="L319">        } catch (SQLException ex) {</span>
<span class="nc" id="L320">            throw new BrmoException(ex);</span>
        }
    }

    public List&lt;Bericht&gt; listBerichten() throws BrmoException {
        try {
<span class="nc" id="L326">            return stagingProxy.getBerichten();</span>
<span class="nc" id="L327">        } catch (SQLException ex) {</span>
<span class="nc" id="L328">            throw new BrmoException(ex);</span>
        }
    }

    /**
     * @param type basis registratie type
     * @param fileName bestand
     * @throws BrmoException als er een fout optreed tijdens verwerking
     * @deprecated gebruik van de variant met automatischProces ID heeft de voorkeur
     * @see #loadFromFile(java.lang.String, java.lang.String, java.lang.Long)
     */
    @Deprecated
    public void loadFromFile(String type, String fileName) throws BrmoException {
<span class="nc" id="L341">        loadFromFile(type, fileName, null);</span>
<span class="nc" id="L342">    }</span>

    /**
     * @see #loadFromFile(java.lang.String, java.lang.String,
     *     nl.b3p.brmo.loader.ProgressUpdateListener, Long)
     * @param type basis registratie type
     * @param fileName bestand
     * @param automatischProces id van automatisch proces dat deze functie aanroept
     * @throws BrmoException als er een fout optreed tijdens verwerking
     */
    public void loadFromFile(String type, String fileName, Long automatischProces)
            throws BrmoException {
        try {
<span class="nc" id="L355">            loadFromFile(type, fileName, null, automatischProces);</span>
<span class="nc" id="L356">        } catch (Exception e) {</span>
<span class="nc bnc" id="L357" title="All 2 branches missed.">            if (e instanceof BrmoException) {</span>
<span class="nc" id="L358">                throw (BrmoException) e;</span>
            } else {
<span class="nc" id="L360">                throw new BrmoException(&quot;Fout bij loaden basisregistratie gegevens&quot;, e);</span>
            }
<span class="nc" id="L362">        }</span>
<span class="nc" id="L363">    }</span>

    /**
     * laden van BR data uit een bestand. &lt;br&gt;
     * NB na gebruik zelf de database verbinding sluiten / opruimen met {@link
     * #closeBrmoFramework()}.
     *
     * @param type basis registratie type
     * @param fileName bestand
     * @param listener voortgangsmonitor
     * @param automatischProces id van automatisch proces dat deze functie aanroept
     * @throws BrmoException als er een fout optreed tijdens verwerking
     */
    public void loadFromFile(
            String type,
            String fileName,
            final ProgressUpdateListener listener,
            Long automatischProces)
            throws BrmoException {
        try {
<span class="nc bnc" id="L383" title="All 2 branches missed.">            if (fileName.toLowerCase().endsWith(&quot;.zip&quot;)) {</span>
<span class="nc" id="L384">                log.info(&quot;Openen ZIP bestand &quot; + fileName);</span>
<span class="nc" id="L385">                ZipInputStream zip = null;</span>
                try {
<span class="nc" id="L387">                    File f = new File(fileName);</span>
<span class="nc bnc" id="L388" title="All 2 branches missed.">                    if (listener != null) {</span>
<span class="nc" id="L389">                        listener.total(f.length());</span>
                    }
<span class="nc" id="L391">                    CountingInputStream zipCis =</span>
<span class="nc" id="L392">                            new CountingInputStream(new FileInputStream(f)) {</span>
                                @Override
                                protected void afterRead(int n) {
<span class="nc" id="L395">                                    super.afterRead(n);</span>
<span class="nc bnc" id="L396" title="All 2 branches missed.">                                    if (listener != null) {</span>
<span class="nc" id="L397">                                        listener.progress(getByteCount());</span>
                                    }
<span class="nc" id="L399">                                }</span>
                            };
<span class="nc" id="L401">                    zip = new ZipInputStream(zipCis);</span>
<span class="nc" id="L402">                    ZipEntry entry = zip.getNextEntry();</span>
<span class="nc bnc" id="L403" title="All 2 branches missed.">                    while (entry != null) {</span>
<span class="nc bnc" id="L404" title="All 2 branches missed.">                        if (!entry.getName().toLowerCase().endsWith(&quot;.xml&quot;)) {</span>
<span class="nc" id="L405">                            log.warn(&quot;Overslaan zip entry geen XML: &quot; + entry.getName());</span>
                        } else {
<span class="nc" id="L407">                            log.info(&quot;Lezen XML bestand uit zip: &quot; + entry.getName());</span>
<span class="nc" id="L408">                            stagingProxy.loadBr(</span>
<span class="nc" id="L409">                                    CloseShieldInputStream.wrap(zip),</span>
                                    type,
<span class="nc" id="L411">                                    fileName + &quot;/&quot; + entry.getName(),</span>
                                    null,
                                    null,
                                    automatischProces);
                        }
<span class="nc" id="L416">                        entry = zip.getNextEntry();</span>
                    }
                } finally {
<span class="nc bnc" id="L419" title="All 2 branches missed.">                    if (zip != null) {</span>
<span class="nc" id="L420">                        zip.close();</span>
                    }
                }
<span class="nc" id="L423">                log.info(&quot;Klaar met ZIP bestand &quot; + fileName);</span>
<span class="nc" id="L424">            } else {</span>
<span class="nc" id="L425">                File f = new File(fileName);</span>
<span class="nc bnc" id="L426" title="All 2 branches missed.">                if (listener != null) {</span>
<span class="nc" id="L427">                    listener.total(f.length());</span>
                }

<span class="nc" id="L430">                try (FileInputStream fis = new FileInputStream(fileName)) {</span>
<span class="nc" id="L431">                    stagingProxy.loadBr(fis, type, fileName, null, listener, automatischProces);</span>
                }
            }
<span class="nc" id="L434">        } catch (Exception e) {</span>
<span class="nc bnc" id="L435" title="All 2 branches missed.">            if (e instanceof BrmoException) {</span>
<span class="nc" id="L436">                throw (BrmoException) e;</span>
            } else {
<span class="nc" id="L438">                throw new BrmoException(&quot;Fout bij loaden basisregistratie gegevens&quot;, e);</span>
            }
<span class="nc" id="L440">        }</span>
<span class="nc" id="L441">    }</span>

    /**
     * laden van BR data uit een stream.
     *
     * @param type type registratie, bijv. {@value BrmoFramework#BR_BRK}
     * @param stream datastream
     * @param fileName te gebruiken bestandsnaam om laadproces te identificeren
     * @throws BrmoException als er een algemene fout optreed
     * @throws BrmoDuplicaatLaadprocesException als het &quot;bestand&quot; {@code fileName} al geladen is
     * @throws BrmoLeegBestandException als het &quot;bestand&quot; {@code fileName} leeg is
     * @deprecated probeer de variant met automatischProces argument te gebruiken
     * @see #loadFromStream(String, InputStream, String, Long)
     */
    @Deprecated
    public void loadFromStream(String type, InputStream stream, String fileName)
            throws BrmoException, BrmoDuplicaatLaadprocesException, BrmoLeegBestandException {
<span class="nc" id="L458">        this.loadFromStream(type, stream, fileName, (Long) null);</span>
<span class="nc" id="L459">    }</span>

    /**
     * laden van BR data uit een stream.
     *
     * @param type type registratie, bijv. {@value BrmoFramework#BR_BRK}
     * @param stream datastream
     * @param fileName te gebruiken bestandsnaam om laadproces te identificeren
     * @param automatischProces id van automatisch proces dat deze functie aanroept
     * @throws BrmoException als er een algemene fout optreed
     * @throws BrmoDuplicaatLaadprocesException als het &quot;bestand&quot; {@code fileName} al geladen is
     * @throws BrmoLeegBestandException als het &quot;bestand&quot; {@code fileName} leeg is
     */
    public void loadFromStream(
            String type, InputStream stream, String fileName, Long automatischProces)
            throws BrmoException, BrmoDuplicaatLaadprocesException, BrmoLeegBestandException {
        try {
<span class="nc" id="L476">            stagingProxy.loadBr(stream, type, fileName, null, null, automatischProces);</span>
<span class="nc" id="L477">        } catch (Exception e) {</span>
<span class="nc bnc" id="L478" title="All 2 branches missed.">            if (e instanceof BrmoDuplicaatLaadprocesException) {</span>
<span class="nc" id="L479">                throw (BrmoDuplicaatLaadprocesException) e;</span>
            }
<span class="nc bnc" id="L481" title="All 2 branches missed.">            if (e instanceof BrmoLeegBestandException) {</span>
<span class="nc" id="L482">                throw (BrmoLeegBestandException) e;</span>
            }
<span class="nc" id="L484">            throw new BrmoException(</span>
                    &quot;Fout bij laden &quot; + type + &quot; berichten uit bestand &quot; + fileName, e);
<span class="nc" id="L486">        }</span>
<span class="nc" id="L487">    }</span>

    /**
     * laden van BR data uit een stream.
     *
     * @param type type registratie, bijv. {@value BrmoFramework#BR_BRK}
     * @param stream datastream
     * @param fileName te gebruiken bestandsnaam om laadproces te identificeren
     * @param d bestandsdatum
     * @throws BrmoException als er een algemene fout optreed
     * @throws BrmoDuplicaatLaadprocesException als het &quot;bestand&quot; {@code fileName} al geladen is
     * @throws BrmoLeegBestandException als het &quot;bestand&quot; {@code fileName} leeg is
     * @deprecated Gebruik {@link #loadFromStream(String, InputStream, String, Date, Long)}
     */
    @Deprecated
    public void loadFromStream(String type, InputStream stream, String fileName, Date d)
            throws BrmoException, BrmoDuplicaatLaadprocesException, BrmoLeegBestandException {
<span class="nc" id="L504">        loadFromStream(type, stream, fileName, d, null);</span>
<span class="nc" id="L505">    }</span>

    /**
     * laden van BR data uit een stream.
     *
     * @param type type registratie, bijv. {@value BrmoFramework#BR_BRK}
     * @param stream datastream
     * @param fileName te gebruiken bestandsnaam om laadproces te identificeren
     * @param d bestandsdatum
     * @param automatischProces id van automatisch proces dat deze functie aanroept
     * @throws BrmoException als er een algemene fout optreed
     * @throws BrmoDuplicaatLaadprocesException als het &quot;bestand&quot; {@code fileName} al geladen is
     * @throws BrmoLeegBestandException als het &quot;bestand&quot; {@code fileName} leeg is
     */
    public void loadFromStream(
            String type, InputStream stream, String fileName, Date d, Long automatischProces)
            throws BrmoException, BrmoDuplicaatLaadprocesException, BrmoLeegBestandException {
        try {
<span class="nc" id="L523">            stagingProxy.loadBr(stream, type, fileName, d, null, automatischProces);</span>
<span class="nc" id="L524">        } catch (Exception e) {</span>
<span class="nc bnc" id="L525" title="All 2 branches missed.">            if (e instanceof BrmoDuplicaatLaadprocesException) {</span>
<span class="nc" id="L526">                throw (BrmoDuplicaatLaadprocesException) e;</span>
            }
<span class="nc bnc" id="L528" title="All 2 branches missed.">            if (e instanceof BrmoLeegBestandException) {</span>
<span class="nc" id="L529">                throw (BrmoLeegBestandException) e;</span>
            }
<span class="nc" id="L531">            throw new BrmoException(</span>
                    &quot;Fout bij laden &quot; + type + &quot; berichten uit bestand &quot; + fileName, e);
<span class="nc" id="L533">        }</span>
<span class="nc" id="L534">    }</span>

    /**
     * laden van BR data uit een stream.
     *
     * @param type type registratie, bijv. {@value BrmoFramework#BR_BRK}
     * @param stream datastream
     * @param fileName te gebruiken bestandsnaam om laadproces te identificeren
     * @param listener mag {@code null} zijn
     * @param automatischProces id van automatisch proces dat deze functie aanroept
     * @throws BrmoException als er een algemene fout optreed
     * @throws BrmoDuplicaatLaadprocesException als het &quot;bestand&quot; {@code fileName} al geladen is
     * @throws BrmoLeegBestandException als het &quot;bestand&quot; {@code fileName} leeg is
     */
    public void loadFromStream(
            String type,
            InputStream stream,
            String fileName,
            ProgressUpdateListener listener,
            Long automatischProces)
            throws BrmoException, BrmoDuplicaatLaadprocesException, BrmoLeegBestandException {
        try {
<span class="nc" id="L556">            stagingProxy.loadBr(stream, type, fileName, null, listener, automatischProces);</span>
<span class="nc" id="L557">        } catch (Exception e) {</span>
<span class="nc bnc" id="L558" title="All 2 branches missed.">            if (e instanceof BrmoDuplicaatLaadprocesException) {</span>
<span class="nc" id="L559">                throw (BrmoDuplicaatLaadprocesException) e;</span>
            }
<span class="nc bnc" id="L561" title="All 2 branches missed.">            if (e instanceof BrmoLeegBestandException) {</span>
<span class="nc" id="L562">                throw (BrmoLeegBestandException) e;</span>
            }
<span class="nc" id="L564">            throw new BrmoException(</span>
                    &quot;Fout bij laden &quot; + type + &quot; berichten uit bestand &quot; + fileName, e);
<span class="nc" id="L566">        }</span>
<span class="nc" id="L567">    }</span>

    public void emptyStagingDb() throws BrmoException {
        try {
<span class="nc" id="L571">            stagingProxy.emptyStagingDb();</span>
<span class="nc" id="L572">        } catch (SQLException ex) {</span>
<span class="nc" id="L573">            throw new BrmoException(ex);</span>
<span class="nc" id="L574">        }</span>
<span class="nc" id="L575">    }</span>

    public Long getLaadProcesIdByFileName(String name) throws BrmoException {
<span class="nc" id="L578">        Long id = null;</span>
        LaadProces lp;
        try {
<span class="nc" id="L581">            lp = stagingProxy.getLaadProcesByFileName(name);</span>
<span class="nc" id="L582">        } catch (SQLException ex) {</span>
<span class="nc" id="L583">            throw new BrmoException(ex);</span>
<span class="nc" id="L584">        }</span>

<span class="nc bnc" id="L586" title="All 2 branches missed.">        if (lp != null) {</span>
<span class="nc" id="L587">            id = lp.getId();</span>
        }

<span class="nc" id="L590">        return id;</span>
    }

    public Bericht getBerichtById(long id) throws BrmoException {
        try {
<span class="nc" id="L595">            return stagingProxy.getBerichtById(id);</span>
<span class="nc" id="L596">        } catch (SQLException ex) {</span>
<span class="nc" id="L597">            throw new BrmoException(ex);</span>
        }
    }

    public LaadProces getLaadProcesById(long id) throws BrmoException {
        try {
<span class="nc" id="L603">            return stagingProxy.getLaadProcesById(id);</span>
<span class="nc" id="L604">        } catch (SQLException ex) {</span>
<span class="nc" id="L605">            throw new BrmoException(ex);</span>
        }
    }

    public List&lt;Bericht&gt; getBerichten(
            int page,
            int start,
            int limit,
            String sort,
            String dir,
            String filterSoort,
            String filterStatus)
            throws BrmoException {

        try {
<span class="nc" id="L620">            return stagingProxy.getBerichten(</span>
                    page, start, limit, sort, dir, filterSoort, filterStatus);
<span class="nc" id="L622">        } catch (SQLException ex) {</span>
<span class="nc" id="L623">            throw new BrmoException(ex);</span>
        }
    }

    public List&lt;LaadProces&gt; getLaadprocessen(
            int page,
            int start,
            int limit,
            String sort,
            String dir,
            String filterSoort,
            String filterStatus)
            throws BrmoException {

        try {
<span class="nc" id="L638">            return stagingProxy.getLaadprocessen(</span>
                    page, start, limit, sort, dir, filterSoort, filterStatus);
<span class="nc" id="L640">        } catch (SQLException ex) {</span>
<span class="nc" id="L641">            throw new BrmoException(ex);</span>
        }
    }

    public Long[] getLaadProcessenIds(
            String sort, String dir, String filterSoort, String filterStatus) throws BrmoException {
        try {
<span class="nc" id="L648">            return stagingProxy.getLaadProcessenIds(sort, dir, filterSoort, filterStatus);</span>
<span class="nc" id="L649">        } catch (SQLException ex) {</span>
<span class="nc" id="L650">            throw new BrmoException(ex);</span>
        }
    }

    public long getCountBerichten(String filterSoort, String filterStatus) throws BrmoException {
        try {
<span class="nc" id="L656">            return stagingProxy.getCountBerichten(filterSoort, filterStatus);</span>
<span class="nc" id="L657">        } catch (SQLException ex) {</span>
<span class="nc" id="L658">            throw new BrmoException(ex);</span>
        }
    }

    public long getCountLaadProcessen(String filterSoort, String filterStatus)
            throws BrmoException {
        try {
<span class="nc" id="L665">            return stagingProxy.getCountLaadProces(filterSoort, filterStatus);</span>
<span class="nc" id="L666">        } catch (SQLException ex) {</span>
<span class="nc" id="L667">            throw new BrmoException(ex);</span>
        }
    }

    public long getCountJob() throws BrmoException {
        try {
<span class="nc" id="L673">            return stagingProxy.getCountJob();</span>
<span class="nc" id="L674">        } catch (SQLException ex) {</span>
<span class="nc" id="L675">            throw new BrmoException(ex);</span>
        }
    }
    /**
     * update laadproces (GDS2 afgifte) metadata.
     *
     * @param lpId laadproces id
     * @param klantafgiftenummer klantafgiftenummer
     * @param contractafgiftenummer contractafgiftenummer
     * @param artikelnummer artikelnummer
     * @param contractnummer contractnummer
     * @param afgifteid afgifteid
     * @param afgiftereferentie afgiftereferentie
     * @param bestandsreferentie bestandsreferentie
     * @param beschikbaar_tot beschikbaar_tot
     * @throws BrmoException if any
     */
    public void updateLaadProcesMeta(
            Long lpId,
            BigInteger klantafgiftenummer,
            BigInteger contractafgiftenummer,
            String artikelnummer,
            String contractnummer,
            String afgifteid,
            String afgiftereferentie,
            String bestandsreferentie,
            Date beschikbaar_tot)
            throws BrmoException {
        try {
<span class="nc" id="L704">            stagingProxy.updateLaadProcesMeta(</span>
                    lpId,
                    klantafgiftenummer,
                    contractafgiftenummer,
                    artikelnummer,
                    contractnummer,
                    afgifteid,
                    afgiftereferentie,
                    bestandsreferentie,
                    beschikbaar_tot);
<span class="nc" id="L714">        } catch (SQLException ex) {</span>
<span class="nc" id="L715">            throw new BrmoException(ex);</span>
<span class="nc" id="L716">        }</span>
<span class="nc" id="L717">    }</span>

    public File checkAfgiftelijst(String bestandsnaam, String output) throws IOException {
<span class="nc" id="L720">        File f = new File(bestandsnaam);</span>
<span class="nc" id="L721">        return checkAfgiftelijst(bestandsnaam, new FileInputStream(f), new File(output));</span>
    }

    public File checkAfgiftelijst(String bestandsnaam, InputStream is, File output)
            throws IOException {
<span class="nc" id="L726">        AfgifteChecker checker = new AfgifteChecker();</span>
<span class="nc" id="L727">        checker.init(is, stagingProxy);</span>
<span class="nc" id="L728">        checker.check();</span>
<span class="nc" id="L729">        return checker.getResults(bestandsnaam, output);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>