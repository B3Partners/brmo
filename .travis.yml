dist: trusty
sudo: required
language: java

env:
  global:
    - secure: "mmLyX+VjQpLA7LQ79iIrBPjw/vnJC4Loda7BOyIy+H2seQJAwqDczG09aToTOkM/mmENAb08xv6JJ2PbsZqSZ3tTMXNxTOh4dGtR9DnTjtDzD4O6IHEDVOSbFndIsSEsQw4LXJWbbJwRJwF5Q+UPl+VLV+HyXbYOAmPAD96hXTA="
    - secure: "NynQI56H74dDi6sK4wxPawnLoLsrzADKmD8Jl7w3yQnYTfVU7zP07KeJKoIWhFaYB3GCKyG2qdeM1I5DOeim183c0h51WcQTVvHX3o1D3DyrdfuhqKTBXmAUXJObp/jUoABD2KKejSKZj+mkzqutITMUUbHDiMu5PD6WXEuCYT8="
    - PG_VERSION="9.6"
    - PROFILE="postgresql"
    - MVN_VERSION="3.6.0"
    - MVN_ARGS="-Dit.test=!TopNLIntegrationTest"
    - PGPORT=5432
    - MAVEN_OPTS=-Djava.awt.headless=true -Xms8G -Xmx12G

addons:
  postgresql: 9.6
  apt:
    packages:
      - postgresql-9.6-postgis-2.3
      - graphviz
      - xmlstarlet
  hostname: travis-brmo
  hosts: travis-brmo

jdk:
  - oraclejdk8
  - oraclejdk11
  - openjdk8
  - openjdk11

matrix:
  fast_finish: true
  allow_failures:
    # vanwege build timeout (soms)
    #- name: "MS SQL server 2017"
    # - name: "PostgreSQL 11"
  include:
  - name: "Oudste supported PostgreSQL"
    dist: trusty
    jdk: openjdk8
    sudo: required
    # final release van 9.4 (==EOL): Feb 13, 2020
    # https://www.postgresql.org/support/versioning/
    env: PG_VERSION="9.4"
    addons:
      postgresql: 9.4
      apt:
        packages:
          - postgresql-9.4-postgis-2.3
          - xmlstarlet
  - name: "PostgreSQL 11"
    group: edge
    dist: xenial
    jdk: openjdk8
    sudo: required
    env: PG_VERSION="11"
    addons:
      postgresql: 11
      apt:
        packages:
          - postgresql-11
          - postgresql-client-11
          - postgresql-11-postgis-2.5
          - postgresql-11-postgis-2.5-scripts
          - xmlstarlet
  - name: "PostgreSQL 10"
    group: edge
    dist: xenial
    jdk: openjdk8
    env: PG_VERSION="10"
    addons:
      postgresql: 10
      apt:
        packages:
          - postgresql-10
          - postgresql-client-10
          - postgresql-10-postgis-2.4
          - xmlstarlet
  - name: "MS SQL server 2017"
    jdk: openjdk8
    group: edge
    dist: xenial
    sudo: required
    env:
      - PG_VERSION=""
      - PROFILE="mssql"
      - MVN_ARGS="-Dmssql.instancename='' -Dit.test=!TopNLIntegrationTest"
  - name: "database upgrades"
    jdk: openjdk8
    sudo: required
    env:
      - PROFILE="postgresql"
      - MVN_ARGS="-Ddatabase.upgrade=true -Dit.test=!TopNLIntegrationTest"
    addons:
      postgresql: 9.6
      apt:
        packages:
          - xmlstarlet
          - postgresql-9.6-postgis-2.3
  - name: "TopNL tests"
    group: edge
    dist: xenial
    jdk: openjdk8
    sudo: required
    addons:
      postgresql: 10
      apt:
        packages:
          - postgresql-10
          - postgresql-client-10
          - postgresql-10-postgis-2.4
          - xmlstarlet
    env:
      - PG_VERSION="10"
      - MVN_ARGS="-Dit.test=TopNLIntegrationTest"

cache:
  directories:
  - $HOME/.m2
  - $HOME/downloads
  - .git/lfs

git:
  lfs_skip_smudge: true

# before_cache:

before_install:
  - git lfs pull
  # hack voor travis xenial images, zie: https://github.com/travis-ci/travis-ci/issues/10290
  - if [ "$PG_VERSION" == "" ] || [ "$PG_VERSION" == "10" ] || [ "$PG_VERSION" == "11" ]; then
       PATH=$(echo "$PATH" | sed -e 's/:\/usr\/local\/lib\/jvm\/openjdk11\/bin//');
       JAVA_HOME=/usr/lib/jvm/java-1.8.0-openjdk-amd64;
    fi
  # installeer een up-2-date Maven versie
  - wget -nc https://www-eu.apache.org/dist/maven/maven-3/$MVN_VERSION/binaries/apache-maven-$MVN_VERSION-bin.zip -P $HOME/downloads/
  - unzip -qq $HOME/downloads/apache-maven-$MVN_VERSION-bin.zip
  - export M2_HOME=$PWD/apache-maven-$MVN_VERSION
  - export PATH=$M2_HOME/bin:$PATH
  - mvn -v
  - export PAGER=cat
  - if [ "$PG_VERSION" == "11" ]; then
       sudo sed -i 's/port = 5433/port = 5432/' /etc/postgresql/11/main/postgresql.conf;
       sudo cp /etc/postgresql/{10,11}/main/pg_hba.conf;
    fi
  - if [ "$PROFILE" == "postgresql" ]; then
       sh ".travis/install-pgsql.sh";
    elif [ "$PROFILE" == "mssql" ]; then
       sudo service postgresql stop;
       sh ".travis/install-mssql.sh";
    fi
  - if  [ "$TRAVIS_JOB_NAME" == "database upgrades" ]; then
       sh ".travis/getlastRelease.sh";
    fi
    # ophalen actuele topnl test data alleen voor postgresql
  - if  [ "$PROFILE" == "postgresql" ] && [ "$TRAVIS_JOB_NAME" != "database upgrades" ]; then
       sh ".jenkins/data-prepare-topnl.sh";
    fi

  - unset _JAVA_OPTIONS
  - ulimit -a
  - free -h

install:
  # installeer dependencies + artifacts en maak DB scripts, zonder testen
  - travis_wait 20 mvn install -Dmaven.test.skip=true -Dtest.onlyITs= -B -V -fae -Pstandard-with-extra-repos,$PROFILE
  - projectversion=$(grep "<version>.*<.version>" -m1 pom.xml | sed -e "s/^.*<version/<version/" | cut -f2 -d">"| cut -f1 -d"<")
  - echo $projectversion
  - export PROJECTVERSION=$projectversion
  - sed -i s/\${project.version}/$projectversion/g ./brmo-persistence/db/05_create_brmo_metadata_postgresql.sql
  - sed -i s/\${project.version}/$projectversion/g ./brmo-persistence/db/05_create_brmo_metadata_sqlserver.sql
  - cat ./brmo-persistence/db/05_create_brmo_metadata_postgresql.sql

before_script:
  # dit dient na afloop van de 'install' gedaan te worden omdat (een deel van) de sql gegenereerd wordt
  - ls -l ./brmo-persistence/db/*.sql
  - ls -l ./datamodel/generated_scripts/*.sql
  - ls -l ./topparser/src/main/resources/nl/b3p/topnl/database/*.sql
  - find ./bgt-gml-loader/target/generated-resources/ddl/ -name '*.sql' -print
  - if [ "$PROFILE" == "postgresql" ] && [ "$TRAVIS_JOB_NAME" != "database upgrades" ]; then
       sh ".travis/setup-pgsql.sh";
    elif [ "$PROFILE" == "postgresql" ] && [ "$TRAVIS_JOB_NAME" == "database upgrades" ]; then
       sh ".travis/setup-old-pgsql.sh";
    elif [ "$PROFILE" == "mssql" ]; then
       sh ".travis/setup-mssql.sh";
    fi

script:
  # run unit tests voor alle modules
  - if [ "$TRAVIS_JOB_NAME" != "database upgrades" ]; then
       travis_wait 20 mvn --settings .travis/settings.xml -e test -B -Pstandard-with-extra-repos,$PROFILE -pl '!brmo-dist' -Dtest.onlyITs=false;
    fi
  # test upgrade script voor postgresql
  - if  [ "$TRAVIS_JOB_NAME" == "database upgrades" ]; then
        .travis/execute-upgrades-pgsql.sh staging;
        .travis/execute-upgrades-pgsql.sh rsgb;
        .travis/execute-upgrades-pgsql.sh rsgbbgt;
        mvn -e -B -P$PROFILE $MVN_ARGS -pl 'datamodel' resources:testResources compiler:testCompile surefire:test;
    fi
  #
  # run integratie tests voor brmo-loader module of alleen topnl, afhankelijk van $MVN_ARGS
  - printf %'s\n\n' 'start integratie tests voor brmo-loader module'
  - travis_wait 40 mvn -e verify -B -P$PROFILE $MVN_ARGS -Dtest.onlyITs=true -pl 'brmo-loader'
  #
  # run integratie tests voor brmo-service module
  - if [ "$TRAVIS_JOB_NAME" != "TopNL tests" ]; then
        printf %'s\n\n'  'start integratie tests voor brmo-service module';
        mvn -e verify -B -P$PROFILE $MVN_ARGS -Dtest.onlyITs=true -pl 'brmo-service';
    fi
  #
  # andere modules alleen tegen pgsql testen want dat kost te veel tijd op dit systeem
  #  er draait ook nog een windows server met mssql versie ergens
  #
  # run integratie tests voor bgt-gml-loader module
  - if [ "$PROFILE" == "postgresql" ] && [ "$TRAVIS_JOB_NAME" != "TopNL tests" ]; then
        printf %'s\n\n' 'start integratie tests voor bgt-gml-loader module';
        mvn -e verify -B -P$PROFILE $MVN_ARGS -Dtest.onlyITs=true -pl 'bgt-gml-loader';
    fi
  # run integratie tests voor brmo-soap module
  - if [ "$PROFILE" == "postgresql" ] && [ "$TRAVIS_JOB_NAME" != "TopNL tests" ]; then
        printf %'s\n\n' 'start integratie tests voor brmo-soap module';
        mvn -e verify -B -P$PROFILE $MVN_ARGS -Dtest.onlyITs=true -pl 'brmo-soap';
    fi
  # run integratie tests voor brmo-stufbg204 module
  - if [ "$PROFILE" == "postgresql" ] && [ "$TRAVIS_JOB_NAME" != "TopNL tests" ]; then
        printf %'s\n\n' 'start integratie tests voor brmo-stufbg204 module';
        mvn -e verify -B -P$PROFILE $MVN_ARGS -Dtest.onlyITs=true -pl 'brmo-stufbg204';
    fi
  # run integratie tests voor brmo-commandline module
  - if [ "$PROFILE" == "postgresql" ] && [ "$TRAVIS_JOB_NAME" != "TopNL tests" ]; then
        printf %'s\n\n' 'start integratie tests voor brmo-commandline module';
        mvn -e verify -B -P$PROFILE $MVN_ARGS -Dtest.onlyITs=true -pl 'brmo-commandline';
    fi
  #
  # Linting
  # test of de javadoc compliant is met java-8 strict checks, noodzakelijk voor succesvolle release
  #
  - if [ "$TRAVIS_JDK_VERSION" == oraclejdk8 ] && [ "$PG_VERSION" == "9.6" ]; then
        printf %'s\n\n' 'Javadoc checks';
        travis_wait 30 mvn javadoc:javadoc;
    fi
  - if [ "$TRAVIS_JDK_VERSION" == oraclejdk8 ] && [ "$PG_VERSION" == "9.6" ]; then
        printf %'s\n\n' 'Test Javadoc checks';
        travis_wait 30 mvn javadoc:test-javadoc;
    fi

# after_failure:
# after_success:

after_script:
  # deploy maven site van master branch als test succes
  - if [ "$TRAVIS_JDK_VERSION" == oraclejdk8 ] && [ "$TRAVIS_PULL_REQUEST" == "false" ] && [ "$TRAVIS_BRANCH" == "master" ] && [ "$TRAVIS_TEST_RESULT" == 0 ] && [ "$PG_VERSION" == "9.6" ]; then
         travis_wait 30 mvn -B -e -T1 site site:stage --settings .travis/settings.xml;
         mvn scm-publish:publish-scm --settings .travis/settings.xml;
    fi

notifications:
  slack:
    secure: C6gBHY3vYCn80KOvZhTeoJWbSy22PWdq8+fQtd32v/9/ZhsIxbeN7tHQE0IE/MKp/bQ0YijTeLr4LFQfOAozxM3qwyP7fTNfu0MZG2J/tvReMoJnylQ8pdFIsHlTTXD8RicfhjP+6pRjorctK11htC+uE+aN0TzdprNeSnsdNvk=
