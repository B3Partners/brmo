<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>BrmoFramework.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">BRMO initialisatie utilities</a> &gt; <a href="../index.html" class="el_bundle">brmo-loader</a> &gt; <a href="index.source.html" class="el_package">nl.b3p.brmo.loader</a> &gt; <span class="el_source">BrmoFramework.java</span></div><h1>BrmoFramework.java</h1><pre class="source lang-java linenums">package nl.b3p.brmo.loader;

import java.io.File;
import java.io.FileInputStream;
import java.io.IOException;
import java.io.InputStream;
import java.math.BigInteger;
import java.sql.Connection;
import java.sql.SQLException;
import java.util.Date;
import java.util.List;
import java.util.zip.ZipEntry;
import java.util.zip.ZipInputStream;
import javax.sql.DataSource;
import javax.xml.bind.JAXBException;
import nl.b3p.brmo.loader.checks.AfgifteChecker;
import nl.b3p.brmo.loader.entity.Bericht;
import nl.b3p.brmo.loader.entity.LaadProces;
import nl.b3p.brmo.loader.updates.UpdateProcess;
import nl.b3p.brmo.loader.util.BrmoDuplicaatLaadprocesException;
import nl.b3p.brmo.loader.util.BrmoException;
import nl.b3p.brmo.loader.util.BrmoLeegBestandException;
import nl.b3p.brmo.loader.util.TopNLRsgbTransformer;
import nl.b3p.jdbc.util.converter.GeometryJdbcConverter;
import nl.b3p.jdbc.util.converter.GeometryJdbcConverterFactory;
import nl.b3p.topnl.TopNLType;
import org.apache.commons.dbutils.DbUtils;
import org.apache.commons.dbutils.QueryRunner;
import org.apache.commons.dbutils.handlers.ScalarHandler;
import org.apache.commons.io.input.CloseShieldInputStream;
import org.apache.commons.io.input.CountingInputStream;
import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;

/**
 * BRMO framework.
 *
 * @author Matthijs Laan
 */
public class BrmoFramework {

<span class="nc" id="L42">  private static final Log log = LogFactory.getLog(BrmoFramework.class);</span>

  public static final String BR_BAG = &quot;bag&quot;;
  public static final String BR_BRK = &quot;brk&quot;;
  public static final String BR_BRK2 = &quot;brk2&quot;;
  public static final String BR_NHR = &quot;nhr&quot;;
  public static final String BR_TOPNL = &quot;topnl&quot;;
  public static final String BR_BRP = &quot;brp&quot;;
  public static final String BR_GBAV = &quot;gbav&quot;;
  public static final String BR_WOZ = &quot;woz&quot;;

  public static final String XSL_BRK = &quot;/xsl/brk-snapshot-to-rsgb-xml.xsl&quot;;
  public static final String XSL_BRK2 = &quot;/xsl/brk2-snapshot-to-rsgb-xml.xsl&quot;;
  public static final String XSL_BAG = &quot;/xsl/bag-mutatie-to-rsgb-xml.xsl&quot;;
  public static final String XSL_NHR = &quot;/xsl/nhr-to-rsgb-xml-3.0.xsl&quot;;
  public static final String XSL_BRP = &quot;/xsl/brp-to-rsgb-xml.xsl&quot;;
  public static final String XSL_GBAV = &quot;/xsl/gbav-to-rsgb-xml.xsl&quot;;
  public static final String XSL_WOZ = &quot;/xsl/woz-to-rsgb.xsl&quot;;

  public static final String LAADPROCES_TABEL = &quot;laadproces&quot;;
  public static final String BERICHT_TABLE = &quot;bericht&quot;;
  public static final String JOB_TABLE = &quot;job&quot;;
  public static final String BRMO_METADATA_TABEL = &quot;brmo_metadata&quot;;

<span class="nc" id="L66">  private StagingProxy stagingProxy = null;</span>
  private final DataSource dataSourceRsgb;
  private final DataSource dataSourceRsgbBrk;
<span class="nc" id="L69">  private DataSource dataSourceRsgbBgt = null;</span>
  private final DataSource dataSourceStaging;
<span class="nc" id="L71">  private DataSource dataSourceTopNL = null;</span>
<span class="nc" id="L72">  private boolean enablePipeline = false;</span>
  private Integer pipelineCapacity;
<span class="nc" id="L74">  private boolean renewConnectionAfterCommit = false;</span>
<span class="nc" id="L75">  private boolean orderBerichten = true;</span>
<span class="nc" id="L76">  private String errorState = null;</span>

  public BrmoFramework(
      DataSource dataSourceStaging, DataSource dataSourceRsgb, DataSource dataSourceRsgbBrk)
<span class="nc" id="L80">      throws BrmoException {</span>
<span class="nc bnc" id="L81" title="All 2 branches missed.">    if (dataSourceStaging != null) {</span>
      try {
<span class="nc" id="L83">        stagingProxy = new StagingProxy(dataSourceStaging);</span>
<span class="nc" id="L84">      } catch (SQLException ex) {</span>
<span class="nc" id="L85">        throw new BrmoException(ex);</span>
<span class="nc" id="L86">      }</span>
    }
<span class="nc" id="L88">    this.dataSourceStaging = dataSourceStaging;</span>
<span class="nc" id="L89">    this.dataSourceRsgb = dataSourceRsgb;</span>
<span class="nc" id="L90">    this.dataSourceRsgbBrk = dataSourceRsgbBrk;</span>
<span class="nc" id="L91">  }</span>

  public BrmoFramework(
      DataSource dataSourceStaging,
      DataSource dataSourceRsgb,
      DataSource dataSourceRsgbBgt,
      DataSource dataSourceTopNL,
      DataSource dataSourceRsgbBrk)
<span class="nc" id="L99">      throws BrmoException {</span>
<span class="nc bnc" id="L100" title="All 2 branches missed.">    if (dataSourceStaging != null) {</span>
      try {
<span class="nc" id="L102">        stagingProxy = new StagingProxy(dataSourceStaging);</span>
<span class="nc" id="L103">      } catch (SQLException ex) {</span>
<span class="nc" id="L104">        throw new BrmoException(ex);</span>
<span class="nc" id="L105">      }</span>
    }
<span class="nc" id="L107">    this.dataSourceRsgb = dataSourceRsgb;</span>
<span class="nc" id="L108">    this.dataSourceRsgbBgt = dataSourceRsgbBgt;</span>
<span class="nc" id="L109">    this.dataSourceStaging = dataSourceStaging;</span>
<span class="nc" id="L110">    this.dataSourceTopNL = dataSourceTopNL;</span>
<span class="nc" id="L111">    this.dataSourceRsgbBrk = dataSourceRsgbBrk;</span>
<span class="nc" id="L112">  }</span>

  public void setDataSourceRsgbBgt(DataSource dataSourceRsgbBgt) {
<span class="nc" id="L115">    this.dataSourceRsgbBgt = dataSourceRsgbBgt;</span>
<span class="nc" id="L116">  }</span>

  public void setDataSourceTopNL(DataSource dataSourceTopNL) {
<span class="nc" id="L119">    this.dataSourceTopNL = dataSourceTopNL;</span>
<span class="nc" id="L120">  }</span>

  public String getStagingVersion() {
    try {
<span class="nc" id="L124">      return getVersion(dataSourceStaging);</span>
<span class="nc" id="L125">    } catch (SQLException ex) {</span>
<span class="nc" id="L126">      log.error(&quot;Versienummer kon niet uit de STAGING database worden gelezen.&quot;, ex);</span>
<span class="nc" id="L127">      return &quot;&quot;;</span>
    }
  }

  public String getRsgbVersion() {
    try {
<span class="nc" id="L133">      return getVersion(dataSourceRsgb);</span>
<span class="nc" id="L134">    } catch (SQLException ex) {</span>
<span class="nc" id="L135">      log.error(&quot;Versienummer kon niet uit de RSGB database worden gelezen.&quot;, ex);</span>
<span class="nc" id="L136">      return &quot;&quot;;</span>
    }
  }

  public String getRsgbBgtVersion() {
    try {
<span class="nc" id="L142">      return getVersion(dataSourceRsgbBgt);</span>
<span class="nc" id="L143">    } catch (SQLException ex) {</span>
<span class="nc" id="L144">      log.error(&quot;Versienummer kon niet uit de RSGBBGT database worden gelezen.&quot;, ex);</span>
<span class="nc" id="L145">      return &quot;&quot;;</span>
    }
  }

  public String getRsgbBrkVersion() {
    try {
<span class="nc" id="L151">      return getVersion(dataSourceRsgbBrk);</span>
<span class="nc" id="L152">    } catch (SQLException ex) {</span>
<span class="nc" id="L153">      log.error(&quot;Versienummer kon niet uit de RSGB BRK database worden gelezen.&quot;, ex);</span>
<span class="nc" id="L154">      return &quot;&quot;;</span>
    }
  }

  private String getVersion(DataSource dataSource) throws SQLException {
<span class="nc" id="L159">    String sql =</span>
        &quot;SELECT waarde FROM &quot; + BrmoFramework.BRMO_METADATA_TABEL + &quot; WHERE naam = 'brmoversie'&quot;;
<span class="nc" id="L161">    final Connection c = dataSource.getConnection();</span>
<span class="nc" id="L162">    GeometryJdbcConverter geomToJdbc = GeometryJdbcConverterFactory.getGeometryJdbcConverter(c);</span>
<span class="nc" id="L163">    String o = new QueryRunner(geomToJdbc.isPmdKnownBroken()).query(c, sql, new ScalarHandler&lt;&gt;());</span>
<span class="nc" id="L164">    DbUtils.closeQuietly(c);</span>
<span class="nc" id="L165">    return o;</span>
  }

  public void setEnablePipeline(boolean enablePipeline) {
<span class="nc" id="L169">    this.enablePipeline = enablePipeline;</span>
<span class="nc" id="L170">  }</span>

  public void setRenewConnectionAfterCommit(boolean renewConnectionAfterCommit) {
<span class="nc" id="L173">    this.renewConnectionAfterCommit = renewConnectionAfterCommit;</span>
<span class="nc" id="L174">  }</span>

  public void setTransformPipelineCapacity(int pipelineCapacity) {
<span class="nc" id="L177">    this.pipelineCapacity = pipelineCapacity;</span>
<span class="nc" id="L178">  }</span>

  public void setBatchCapacity(int batchCapacity) {
<span class="nc bnc" id="L181" title="All 2 branches missed.">    if (stagingProxy != null) {</span>
<span class="nc" id="L182">      stagingProxy.setBatchCapacity(batchCapacity);</span>
    }
<span class="nc" id="L184">  }</span>

  public void setLimitStandBerichtenToTransform(Integer limitStandBerichtenToTransform) {
<span class="nc bnc" id="L187" title="All 2 branches missed.">    if (stagingProxy != null) {</span>
<span class="nc" id="L188">      stagingProxy.setLimitStandBerichtenToTransform(limitStandBerichtenToTransform);</span>
    }
<span class="nc" id="L190">  }</span>

  /**
   * stel bericht sortering van berichten in.
   *
   * @param orderBerichten {@code false} voor stand, {@code true} voor mutaties
   */
  public void setOrderBerichten(boolean orderBerichten) {
<span class="nc" id="L198">    this.orderBerichten = orderBerichten;</span>
<span class="nc" id="L199">  }</span>

  public boolean isOrderBerichten() {
<span class="nc" id="L202">    return this.orderBerichten;</span>
  }

  public void setErrorState(String errorState) {
<span class="nc" id="L206">    this.errorState = errorState;</span>
<span class="nc" id="L207">  }</span>

  public void closeBrmoFramework() {
<span class="nc bnc" id="L210" title="All 2 branches missed.">    if (stagingProxy != null) {</span>
<span class="nc" id="L211">      stagingProxy.closeStagingProxy();</span>
    }
    // rsgbProxy is thread and will be closed in thread
<span class="nc" id="L214">  }</span>

  public Thread toRsgb() throws BrmoException {
<span class="nc" id="L217">    return toRsgb((ProgressUpdateListener) null);</span>
  }

  public Thread toRsgb(ProgressUpdateListener listener) throws BrmoException {
<span class="nc" id="L221">    return toRsgb(Bericht.STATUS.STAGING_OK, listener);</span>
  }

  public Thread toRsgb(Bericht.STATUS status, ProgressUpdateListener listener)
      throws BrmoException {
<span class="nc" id="L226">    RsgbProxy rsgbProxy =</span>
        new RsgbProxy(dataSourceRsgb, dataSourceRsgbBrk, stagingProxy, status, listener);
<span class="nc" id="L228">    rsgbProxy.setEnablePipeline(enablePipeline);</span>
<span class="nc bnc" id="L229" title="All 2 branches missed.">    if (pipelineCapacity != null) {</span>
<span class="nc" id="L230">      rsgbProxy.setPipelineCapacity(pipelineCapacity);</span>
    }
<span class="nc" id="L232">    rsgbProxy.setRenewConnectionAfterCommit(renewConnectionAfterCommit);</span>
<span class="nc" id="L233">    rsgbProxy.setOrderBerichten(orderBerichten);</span>
<span class="nc" id="L234">    rsgbProxy.setErrorState(errorState);</span>
<span class="nc" id="L235">    Thread t = new Thread(rsgbProxy);</span>
<span class="nc" id="L236">    t.start();</span>
<span class="nc" id="L237">    return t;</span>
  }

  /**
   * @param mode geeft aan wat ids zijn (laadprocessen of berichten)
   * @param ids array van ids
   * @param listener voortgangs listener
   * @return running transformatie thread
   * @throws BrmoException if any
   */
  public Thread toRsgb(
      RsgbProxy.BerichtSelectMode mode, long[] ids, ProgressUpdateListener listener)
      throws BrmoException {
<span class="nc" id="L250">    String soort = &quot;&quot;;</span>
<span class="nc bnc" id="L251" title="All 2 branches missed.">    if (mode == RsgbProxy.BerichtSelectMode.BY_LAADPROCES) {</span>
      try {
<span class="nc" id="L253">        soort = stagingProxy.getLaadProcesById(ids[0]).getSoort();</span>
<span class="nc" id="L254">      } catch (SQLException ex) {</span>
<span class="nc" id="L255">        throw new BrmoException(ex);</span>
<span class="nc" id="L256">      }</span>
    }

    Runnable worker;
<span class="nc bnc" id="L260" title="All 2 branches missed.">    if (TopNLType.isTopNLType(soort)) {</span>
      try {
<span class="nc" id="L262">        worker = new TopNLRsgbTransformer(dataSourceTopNL, stagingProxy, ids, listener);</span>
<span class="nc" id="L263">      } catch (JAXBException | SQLException ex) {</span>
<span class="nc" id="L264">        throw new BrmoException(&quot;Probleem met TopNL parser initialiseren: &quot;, ex);</span>
<span class="nc" id="L265">      }</span>
    } else {
<span class="nc" id="L267">      worker = new RsgbProxy(dataSourceRsgb, dataSourceRsgbBrk, stagingProxy, mode, ids, listener);</span>
<span class="nc" id="L268">      ((RsgbProxy) worker).setEnablePipeline(enablePipeline);</span>
<span class="nc bnc" id="L269" title="All 2 branches missed.">      if (pipelineCapacity != null) {</span>
<span class="nc" id="L270">        ((RsgbProxy) worker).setPipelineCapacity(pipelineCapacity);</span>
      }
<span class="nc" id="L272">      ((RsgbProxy) worker).setRenewConnectionAfterCommit(renewConnectionAfterCommit);</span>
<span class="nc" id="L273">      ((RsgbProxy) worker).setOrderBerichten(orderBerichten);</span>
<span class="nc" id="L274">      ((RsgbProxy) worker).setErrorState(errorState);</span>
    }
<span class="nc" id="L276">    Thread t = new Thread(worker);</span>
<span class="nc" id="L277">    t.start();</span>
<span class="nc" id="L278">    return t;</span>
  }

  public Thread toRsgb(UpdateProcess updateProcess, ProgressUpdateListener listener)
      throws BrmoException {
<span class="nc" id="L283">    RsgbProxy rsgbProxy =</span>
        new RsgbProxy(dataSourceRsgb, dataSourceRsgbBrk, stagingProxy, updateProcess, listener);
<span class="nc" id="L285">    rsgbProxy.setEnablePipeline(enablePipeline);</span>
<span class="nc bnc" id="L286" title="All 2 branches missed.">    if (pipelineCapacity != null) {</span>
<span class="nc" id="L287">      rsgbProxy.setPipelineCapacity(pipelineCapacity);</span>
    }
<span class="nc" id="L289">    rsgbProxy.setRenewConnectionAfterCommit(renewConnectionAfterCommit);</span>
<span class="nc" id="L290">    rsgbProxy.setOrderBerichten(orderBerichten);</span>
<span class="nc" id="L291">    rsgbProxy.setErrorState(errorState);</span>
<span class="nc" id="L292">    Thread t = new Thread(rsgbProxy);</span>
<span class="nc" id="L293">    t.start();</span>
<span class="nc" id="L294">    return t;</span>
  }

  public void delete(Long id) throws BrmoException {
<span class="nc bnc" id="L298" title="All 2 branches missed.">    if (id != null) {</span>
      try {
<span class="nc" id="L300">        stagingProxy.deleteByLaadProcesId(id);</span>
<span class="nc" id="L301">      } catch (SQLException ex) {</span>
<span class="nc" id="L302">        throw new BrmoException(ex);</span>
<span class="nc" id="L303">      }</span>
    }
<span class="nc" id="L305">  }</span>

  public List&lt;LaadProces&gt; listLaadProcessen() throws BrmoException {
    try {
<span class="nc" id="L309">      return stagingProxy.getLaadProcessen();</span>
<span class="nc" id="L310">    } catch (SQLException ex) {</span>
<span class="nc" id="L311">      throw new BrmoException(ex);</span>
    }
  }

  public List&lt;Bericht&gt; listBerichten() throws BrmoException {
    try {
<span class="nc" id="L317">      return stagingProxy.getBerichten();</span>
<span class="nc" id="L318">    } catch (SQLException ex) {</span>
<span class="nc" id="L319">      throw new BrmoException(ex);</span>
    }
  }

  /**
   * @param type basis registratie type
   * @param fileName bestand
   * @throws BrmoException als er een fout optreed tijdens verwerking
   * @deprecated gebruik van de variant met automatischProces ID heeft de voorkeur
   * @see #loadFromFile(java.lang.String, java.lang.String, java.lang.Long)
   */
  @Deprecated
  public void loadFromFile(String type, String fileName) throws BrmoException {
<span class="nc" id="L332">    loadFromFile(type, fileName, null);</span>
<span class="nc" id="L333">  }</span>

  /**
   * @see #loadFromFile(java.lang.String, java.lang.String,
   *     nl.b3p.brmo.loader.ProgressUpdateListener, Long)
   * @param type basis registratie type
   * @param fileName bestand
   * @param automatischProces id van automatisch proces dat deze functie aanroept
   * @throws BrmoException als er een fout optreed tijdens verwerking
   */
  public void loadFromFile(String type, String fileName, Long automatischProces)
      throws BrmoException {
    try {
<span class="nc" id="L346">      loadFromFile(type, fileName, null, automatischProces);</span>
<span class="nc" id="L347">    } catch (Exception e) {</span>
<span class="nc bnc" id="L348" title="All 2 branches missed.">      if (e instanceof BrmoException) {</span>
<span class="nc" id="L349">        throw (BrmoException) e;</span>
      } else {
<span class="nc" id="L351">        throw new BrmoException(&quot;Fout bij loaden basisregistratie gegevens&quot;, e);</span>
      }
<span class="nc" id="L353">    }</span>
<span class="nc" id="L354">  }</span>

  /**
   * laden van BR data uit een bestand. &lt;br&gt;
   * NB na gebruik zelf de database verbinding sluiten / opruimen met {@link #closeBrmoFramework()}.
   *
   * @param type basis registratie type
   * @param fileName bestand
   * @param listener voortgangsmonitor
   * @param automatischProces id van automatisch proces dat deze functie aanroept
   * @throws BrmoException als er een fout optreed tijdens verwerking
   */
  public void loadFromFile(
      String type, String fileName, final ProgressUpdateListener listener, Long automatischProces)
      throws BrmoException {
    try {
<span class="nc bnc" id="L370" title="All 2 branches missed.">      if (fileName.toLowerCase().endsWith(&quot;.zip&quot;)) {</span>
<span class="nc" id="L371">        log.info(&quot;Openen ZIP bestand &quot; + fileName);</span>
<span class="nc" id="L372">        ZipInputStream zip = null;</span>
        try {
<span class="nc" id="L374">          File f = new File(fileName);</span>
<span class="nc bnc" id="L375" title="All 2 branches missed.">          if (listener != null) {</span>
<span class="nc" id="L376">            listener.total(f.length());</span>
          }
<span class="nc" id="L378">          CountingInputStream zipCis =</span>
<span class="nc" id="L379">              new CountingInputStream(new FileInputStream(f)) {</span>
                @Override
                protected synchronized void afterRead(int n) {
<span class="nc" id="L382">                  super.afterRead(n);</span>
<span class="nc bnc" id="L383" title="All 2 branches missed.">                  if (listener != null) {</span>
<span class="nc" id="L384">                    listener.progress(getByteCount());</span>
                  }
<span class="nc" id="L386">                }</span>
              };
<span class="nc" id="L388">          zip = new ZipInputStream(zipCis);</span>
<span class="nc" id="L389">          ZipEntry entry = zip.getNextEntry();</span>
<span class="nc bnc" id="L390" title="All 2 branches missed.">          while (entry != null) {</span>
<span class="nc bnc" id="L391" title="All 2 branches missed.">            if (!entry.getName().toLowerCase().endsWith(&quot;.xml&quot;)) {</span>
<span class="nc" id="L392">              log.warn(&quot;Overslaan zip entry geen XML: &quot; + entry.getName());</span>
            } else {
<span class="nc" id="L394">              log.info(&quot;Lezen XML bestand uit zip: &quot; + entry.getName());</span>
<span class="nc" id="L395">              stagingProxy.loadBr(</span>
<span class="nc" id="L396">                  CloseShieldInputStream.wrap(zip),</span>
                  type,
<span class="nc" id="L398">                  fileName + &quot;/&quot; + entry.getName(),</span>
                  null,
                  null,
                  automatischProces);
            }
<span class="nc" id="L403">            entry = zip.getNextEntry();</span>
          }
        } finally {
<span class="nc bnc" id="L406" title="All 2 branches missed.">          if (zip != null) {</span>
<span class="nc" id="L407">            zip.close();</span>
          }
        }
<span class="nc" id="L410">        log.info(&quot;Klaar met ZIP bestand &quot; + fileName);</span>
<span class="nc" id="L411">      } else {</span>
<span class="nc" id="L412">        File f = new File(fileName);</span>
<span class="nc bnc" id="L413" title="All 2 branches missed.">        if (listener != null) {</span>
<span class="nc" id="L414">          listener.total(f.length());</span>
        }

<span class="nc" id="L417">        try (FileInputStream fis = new FileInputStream(fileName)) {</span>
<span class="nc" id="L418">          stagingProxy.loadBr(fis, type, fileName, null, listener, automatischProces);</span>
        }
      }
<span class="nc" id="L421">    } catch (Exception e) {</span>
<span class="nc bnc" id="L422" title="All 2 branches missed.">      if (e instanceof BrmoException) {</span>
<span class="nc" id="L423">        throw (BrmoException) e;</span>
      } else {
<span class="nc" id="L425">        throw new BrmoException(&quot;Fout bij loaden basisregistratie gegevens&quot;, e);</span>
      }
<span class="nc" id="L427">    }</span>
<span class="nc" id="L428">  }</span>

  /**
   * laden van BR data uit een stream.
   *
   * @param type type registratie, bijv. {@value BrmoFramework#BR_BRK}
   * @param stream datastream
   * @param fileName te gebruiken bestandsnaam om laadproces te identificeren
   * @throws BrmoException als er een algemene fout optreed
   * @throws BrmoDuplicaatLaadprocesException als het &quot;bestand&quot; {@code fileName} al geladen is
   * @throws BrmoLeegBestandException als het &quot;bestand&quot; {@code fileName} leeg is
   * @deprecated probeer de variant met automatischProces argument te gebruiken
   * @see #loadFromStream(String, InputStream, String, Long)
   */
  @Deprecated
  public void loadFromStream(String type, InputStream stream, String fileName)
      throws BrmoException, BrmoDuplicaatLaadprocesException, BrmoLeegBestandException {
<span class="nc" id="L445">    this.loadFromStream(type, stream, fileName, (Long) null);</span>
<span class="nc" id="L446">  }</span>

  /**
   * laden van BR data uit een stream.
   *
   * @param type type registratie, bijv. {@value BrmoFramework#BR_BRK}
   * @param stream datastream
   * @param fileName te gebruiken bestandsnaam om laadproces te identificeren
   * @param automatischProces id van automatisch proces dat deze functie aanroept
   * @throws BrmoException als er een algemene fout optreed
   * @throws BrmoDuplicaatLaadprocesException als het &quot;bestand&quot; {@code fileName} al geladen is
   * @throws BrmoLeegBestandException als het &quot;bestand&quot; {@code fileName} leeg is
   */
  public void loadFromStream(
      String type, InputStream stream, String fileName, Long automatischProces)
      throws BrmoException, BrmoDuplicaatLaadprocesException, BrmoLeegBestandException {
    try {
<span class="nc" id="L463">      stagingProxy.loadBr(stream, type, fileName, null, null, automatischProces);</span>
<span class="nc" id="L464">    } catch (Exception e) {</span>
<span class="nc bnc" id="L465" title="All 2 branches missed.">      if (e instanceof BrmoDuplicaatLaadprocesException) {</span>
<span class="nc" id="L466">        throw (BrmoDuplicaatLaadprocesException) e;</span>
      }
<span class="nc bnc" id="L468" title="All 2 branches missed.">      if (e instanceof BrmoLeegBestandException) {</span>
<span class="nc" id="L469">        throw (BrmoLeegBestandException) e;</span>
      }
<span class="nc" id="L471">      throw new BrmoException(&quot;Fout bij laden &quot; + type + &quot; berichten uit bestand &quot; + fileName, e);</span>
<span class="nc" id="L472">    }</span>
<span class="nc" id="L473">  }</span>

  /**
   * laden van BR data uit een stream.
   *
   * @param type type registratie, bijv. {@value BrmoFramework#BR_BRK}
   * @param stream datastream
   * @param fileName te gebruiken bestandsnaam om laadproces te identificeren
   * @param d bestandsdatum
   * @throws BrmoException als er een algemene fout optreed
   * @throws BrmoDuplicaatLaadprocesException als het &quot;bestand&quot; {@code fileName} al geladen is
   * @throws BrmoLeegBestandException als het &quot;bestand&quot; {@code fileName} leeg is
   * @deprecated Gebruik {@link #loadFromStream(String, InputStream, String, Date, Long)}
   */
  @Deprecated
  public void loadFromStream(String type, InputStream stream, String fileName, Date d)
      throws BrmoException, BrmoDuplicaatLaadprocesException, BrmoLeegBestandException {
<span class="nc" id="L490">    loadFromStream(type, stream, fileName, d, null);</span>
<span class="nc" id="L491">  }</span>

  /**
   * laden van BR data uit een stream.
   *
   * @param type type registratie, bijv. {@value BrmoFramework#BR_BRK}
   * @param stream datastream
   * @param fileName te gebruiken bestandsnaam om laadproces te identificeren
   * @param d bestandsdatum
   * @param automatischProces id van automatisch proces dat deze functie aanroept
   * @throws BrmoException als er een algemene fout optreed
   * @throws BrmoDuplicaatLaadprocesException als het &quot;bestand&quot; {@code fileName} al geladen is
   * @throws BrmoLeegBestandException als het &quot;bestand&quot; {@code fileName} leeg is
   */
  public void loadFromStream(
      String type, InputStream stream, String fileName, Date d, Long automatischProces)
      throws BrmoException, BrmoDuplicaatLaadprocesException, BrmoLeegBestandException {
    try {
<span class="nc" id="L509">      stagingProxy.loadBr(stream, type, fileName, d, null, automatischProces);</span>
<span class="nc" id="L510">    } catch (Exception e) {</span>
<span class="nc bnc" id="L511" title="All 2 branches missed.">      if (e instanceof BrmoDuplicaatLaadprocesException) {</span>
<span class="nc" id="L512">        throw (BrmoDuplicaatLaadprocesException) e;</span>
      }
<span class="nc bnc" id="L514" title="All 2 branches missed.">      if (e instanceof BrmoLeegBestandException) {</span>
<span class="nc" id="L515">        throw (BrmoLeegBestandException) e;</span>
      }
<span class="nc" id="L517">      throw new BrmoException(&quot;Fout bij laden &quot; + type + &quot; berichten uit bestand &quot; + fileName, e);</span>
<span class="nc" id="L518">    }</span>
<span class="nc" id="L519">  }</span>

  /**
   * laden van BR data uit een stream.
   *
   * @param type type registratie, bijv. {@value BrmoFramework#BR_BRK}
   * @param stream datastream
   * @param fileName te gebruiken bestandsnaam om laadproces te identificeren
   * @param listener mag {@code null} zijn
   * @param automatischProces id van automatisch proces dat deze functie aanroept
   * @throws BrmoException als er een algemene fout optreed
   * @throws BrmoDuplicaatLaadprocesException als het &quot;bestand&quot; {@code fileName} al geladen is
   * @throws BrmoLeegBestandException als het &quot;bestand&quot; {@code fileName} leeg is
   */
  public void loadFromStream(
      String type,
      InputStream stream,
      String fileName,
      ProgressUpdateListener listener,
      Long automatischProces)
      throws BrmoException, BrmoDuplicaatLaadprocesException, BrmoLeegBestandException {
    try {
<span class="nc" id="L541">      stagingProxy.loadBr(stream, type, fileName, null, listener, automatischProces);</span>
<span class="nc" id="L542">    } catch (Exception e) {</span>
<span class="nc bnc" id="L543" title="All 2 branches missed.">      if (e instanceof BrmoDuplicaatLaadprocesException) {</span>
<span class="nc" id="L544">        throw (BrmoDuplicaatLaadprocesException) e;</span>
      }
<span class="nc bnc" id="L546" title="All 2 branches missed.">      if (e instanceof BrmoLeegBestandException) {</span>
<span class="nc" id="L547">        throw (BrmoLeegBestandException) e;</span>
      }
<span class="nc" id="L549">      throw new BrmoException(&quot;Fout bij laden &quot; + type + &quot; berichten uit bestand &quot; + fileName, e);</span>
<span class="nc" id="L550">    }</span>
<span class="nc" id="L551">  }</span>

  public void emptyStagingDb() throws BrmoException {
    try {
<span class="nc" id="L555">      stagingProxy.emptyStagingDb();</span>
<span class="nc" id="L556">    } catch (SQLException ex) {</span>
<span class="nc" id="L557">      throw new BrmoException(ex);</span>
<span class="nc" id="L558">    }</span>
<span class="nc" id="L559">  }</span>

  public Long getLaadProcesIdByFileName(String name) throws BrmoException {
<span class="nc" id="L562">    Long id = null;</span>
    LaadProces lp;
    try {
<span class="nc" id="L565">      lp = stagingProxy.getLaadProcesByFileName(name);</span>
<span class="nc" id="L566">    } catch (SQLException ex) {</span>
<span class="nc" id="L567">      throw new BrmoException(ex);</span>
<span class="nc" id="L568">    }</span>

<span class="nc bnc" id="L570" title="All 2 branches missed.">    if (lp != null) {</span>
<span class="nc" id="L571">      id = lp.getId();</span>
    }

<span class="nc" id="L574">    return id;</span>
  }

  public Bericht getBerichtById(long id) throws BrmoException {
    try {
<span class="nc" id="L579">      return stagingProxy.getBerichtById(id);</span>
<span class="nc" id="L580">    } catch (SQLException ex) {</span>
<span class="nc" id="L581">      throw new BrmoException(ex);</span>
    }
  }

  public LaadProces getLaadProcesById(long id) throws BrmoException {
    try {
<span class="nc" id="L587">      return stagingProxy.getLaadProcesById(id);</span>
<span class="nc" id="L588">    } catch (SQLException ex) {</span>
<span class="nc" id="L589">      throw new BrmoException(ex);</span>
    }
  }

  public List&lt;Bericht&gt; getBerichten(
      int page,
      int start,
      int limit,
      String sort,
      String dir,
      String filterSoort,
      String filterStatus)
      throws BrmoException {

    try {
<span class="nc" id="L604">      return stagingProxy.getBerichten(page, start, limit, sort, dir, filterSoort, filterStatus);</span>
<span class="nc" id="L605">    } catch (SQLException ex) {</span>
<span class="nc" id="L606">      throw new BrmoException(ex);</span>
    }
  }

  public List&lt;LaadProces&gt; getLaadprocessen(
      int page,
      int start,
      int limit,
      String sort,
      String dir,
      String filterSoort,
      String filterStatus)
      throws BrmoException {

    try {
<span class="nc" id="L621">      return stagingProxy.getLaadprocessen(</span>
          page, start, limit, sort, dir, filterSoort, filterStatus);
<span class="nc" id="L623">    } catch (SQLException ex) {</span>
<span class="nc" id="L624">      throw new BrmoException(ex);</span>
    }
  }

  public Long[] getLaadProcessenIds(
      String sort, String dir, String filterSoort, String filterStatus) throws BrmoException {
    try {
<span class="nc" id="L631">      return stagingProxy.getLaadProcessenIds(sort, dir, filterSoort, filterStatus);</span>
<span class="nc" id="L632">    } catch (SQLException ex) {</span>
<span class="nc" id="L633">      throw new BrmoException(ex);</span>
    }
  }

  public long getCountBerichten(String filterSoort, String filterStatus) throws BrmoException {
    try {
<span class="nc" id="L639">      return stagingProxy.getCountBerichten(filterSoort, filterStatus);</span>
<span class="nc" id="L640">    } catch (SQLException ex) {</span>
<span class="nc" id="L641">      throw new BrmoException(ex);</span>
    }
  }

  public long getCountLaadProcessen(String filterSoort, String filterStatus) throws BrmoException {
    try {
<span class="nc" id="L647">      return stagingProxy.getCountLaadProces(filterSoort, filterStatus);</span>
<span class="nc" id="L648">    } catch (SQLException ex) {</span>
<span class="nc" id="L649">      throw new BrmoException(ex);</span>
    }
  }

  public long getCountJob() throws BrmoException {
    try {
<span class="nc" id="L655">      return stagingProxy.getCountJob();</span>
<span class="nc" id="L656">    } catch (SQLException ex) {</span>
<span class="nc" id="L657">      throw new BrmoException(ex);</span>
    }
  }
  /**
   * update laadproces (GDS2 afgifte) metadata.
   *
   * @param lpId laadproces id
   * @param klantafgiftenummer klantafgiftenummer
   * @param contractafgiftenummer contractafgiftenummer
   * @param artikelnummer artikelnummer
   * @param contractnummer contractnummer
   * @param afgifteid afgifteid
   * @param afgiftereferentie afgiftereferentie
   * @param bestandsreferentie bestandsreferentie
   * @param beschikbaar_tot beschikbaar_tot
   * @throws BrmoException if any
   */
  public void updateLaadProcesMeta(
      Long lpId,
      BigInteger klantafgiftenummer,
      BigInteger contractafgiftenummer,
      String artikelnummer,
      String contractnummer,
      String afgifteid,
      String afgiftereferentie,
      String bestandsreferentie,
      Date beschikbaar_tot)
      throws BrmoException {
    try {
<span class="nc" id="L686">      stagingProxy.updateLaadProcesMeta(</span>
          lpId,
          klantafgiftenummer,
          contractafgiftenummer,
          artikelnummer,
          contractnummer,
          afgifteid,
          afgiftereferentie,
          bestandsreferentie,
          beschikbaar_tot);
<span class="nc" id="L696">    } catch (SQLException ex) {</span>
<span class="nc" id="L697">      throw new BrmoException(ex);</span>
<span class="nc" id="L698">    }</span>
<span class="nc" id="L699">  }</span>

  public File checkAfgiftelijst(String bestandsnaam, String output) throws IOException {
<span class="nc" id="L702">    File f = new File(bestandsnaam);</span>
<span class="nc" id="L703">    return checkAfgiftelijst(bestandsnaam, new FileInputStream(f), new File(output));</span>
  }

  public File checkAfgiftelijst(String bestandsnaam, InputStream is, File output)
      throws IOException {
<span class="nc" id="L708">    AfgifteChecker checker = new AfgifteChecker();</span>
<span class="nc" id="L709">    checker.init(is, stagingProxy);</span>
<span class="nc" id="L710">    checker.check();</span>
<span class="nc" id="L711">    return checker.getResults(bestandsnaam, output);</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.10.202304240956</span></div></body></html>