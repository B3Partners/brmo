<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>NHRLoadUtils.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">BRMO service</a> &gt; <a href="../index.html" class="el_bundle">nhr-loader</a> &gt; <a href="index.source.html" class="el_package">nl.b3p.brmo.nhr.loader.cli</a> &gt; <span class="el_source">NHRLoadUtils.java</span></div><h1>NHRLoadUtils.java</h1><pre class="source lang-java linenums">/*
 * Copyright (C) 2022 B3Partners B.V.
 *
 * SPDX-License-Identifier: MIT
 *
 */

package nl.b3p.brmo.nhr.loader.cli;

import java.io.FileInputStream;
import java.security.KeyStore;
import java.util.HashMap;
import java.util.Map;
import java.util.Properties;
import javax.net.ssl.KeyManagerFactory;
import javax.net.ssl.SSLContext;
import javax.net.ssl.TrustManagerFactory;
import javax.security.auth.callback.Callback;
import javax.security.auth.callback.CallbackHandler;
import javax.xml.parsers.DocumentBuilderFactory;
import javax.xml.ws.BindingProvider;
import nl.b3p.brmo.loader.BrmoFramework;
import nl.b3p.brmo.loader.util.BrmoException;
import nl.b3p.brmo.nhr.loader.NHRCertificateOptions;
import nl.b3p.brmo.nhr.loader.NHRDatabaseOptions;
import nl.kvk.schemas.schemas.hrip.dataservice._2015._02.Dataservice;
import nl.kvk.schemas.schemas.hrip.dataservice._2015._02.DataserviceService;
import org.apache.commons.dbcp2.BasicDataSource;
import org.apache.cxf.configuration.jsse.TLSClientParameters;
import org.apache.cxf.endpoint.Client;
import org.apache.cxf.endpoint.Endpoint;
import org.apache.cxf.frontend.ClientProxy;
import org.apache.cxf.transport.http.HTTPConduit;
import org.apache.cxf.ws.addressing.AddressingProperties;
import org.apache.cxf.ws.addressing.AttributedURIType;
import org.apache.cxf.ws.addressing.EndpointReferenceType;
import org.apache.cxf.ws.addressing.JAXWSAConstants;
import org.apache.cxf.ws.security.wss4j.WSS4JOutInterceptor;
import org.apache.wss4j.common.ext.WSPasswordCallback;
import org.apache.wss4j.dom.handler.WSHandlerConstants;

<span class="nc" id="L42">public class NHRLoadUtils {</span>
  public static BrmoFramework getFramework(NHRDatabaseOptions databaseOptions)
      throws BrmoException {
<span class="nc" id="L45">    BasicDataSource dsStaging = new BasicDataSource();</span>

<span class="nc" id="L47">    dsStaging.setUrl(databaseOptions.getConnectionString());</span>
<span class="nc" id="L48">    dsStaging.setUsername(databaseOptions.getUser());</span>
<span class="nc" id="L49">    dsStaging.setPassword(databaseOptions.getPassword());</span>

<span class="nc" id="L51">    BrmoFramework fw = new BrmoFramework(dsStaging, null, null);</span>
<span class="nc" id="L52">    fw.setOrderBerichten(true);</span>
<span class="nc" id="L53">    return fw;</span>
  }

  private static Properties getCryptoProperties(
      NHRCertificateOptions certificateOptions, String alias) {
<span class="nc" id="L58">    Properties props = new Properties();</span>

<span class="nc" id="L60">    props.setProperty(</span>
        &quot;org.apache.ws.security.crypto.provider&quot;,
        &quot;org.apache.ws.security.components.crypto.Merlin&quot;);
<span class="nc" id="L63">    props.setProperty(</span>
<span class="nc" id="L64">        &quot;org.apache.ws.security.crypto.merlin.keystore.file&quot;, certificateOptions.getKeystore());</span>
<span class="nc" id="L65">    props.setProperty(</span>
        &quot;org.apache.ws.security.crypto.merlin.keystore.password&quot;,
<span class="nc" id="L67">        certificateOptions.getKeystorePassword());</span>
<span class="nc" id="L68">    props.setProperty(&quot;org.apache.ws.security.crypto.merlin.keystore.type&quot;, &quot;PKCS12&quot;);</span>
<span class="nc" id="L69">    props.setProperty(&quot;org.apache.ws.security.crypto.merlin.keystore.alias&quot;, alias);</span>

<span class="nc" id="L71">    return props;</span>
  }

  public static Dataservice getDataservice(
      String targetLocation, boolean preprod, NHRCertificateOptions certificateOptions)
      throws Exception {
<span class="nc" id="L77">    DocumentBuilderFactory documentBuilderFactory = DocumentBuilderFactory.newInstance();</span>
<span class="nc" id="L78">    documentBuilderFactory.setNamespaceAware(true);</span>

<span class="nc" id="L80">    DataserviceService dataServiceService = new DataserviceService();</span>
<span class="nc" id="L81">    Dataservice dataService = dataServiceService.getDataserviceSoap11();</span>
<span class="nc" id="L82">    Client client = ClientProxy.getClient(dataService);</span>
<span class="nc" id="L83">    Endpoint endpoint = client.getEndpoint();</span>
<span class="nc" id="L84">    HTTPConduit http = (HTTPConduit) client.getConduit();</span>

    // Set up TLS certificates/keys
<span class="nc" id="L87">    TrustManagerFactory trustManagerFactory = TrustManagerFactory.getInstance(&quot;SunX509&quot;);</span>
<span class="nc" id="L88">    KeyStore trustStore = KeyStore.getInstance(&quot;PKCS12&quot;);</span>

<span class="nc" id="L90">    try (FileInputStream trustStoreFile = new FileInputStream(certificateOptions.getTruststore())) {</span>
<span class="nc" id="L91">      trustStore.load(trustStoreFile, certificateOptions.getTruststorePassword().toCharArray());</span>
    }
<span class="nc" id="L93">    trustManagerFactory.init(trustStore);</span>

<span class="nc" id="L95">    KeyManagerFactory keyManagerFactory = KeyManagerFactory.getInstance(&quot;SunX509&quot;);</span>
<span class="nc" id="L96">    KeyStore keyStore = KeyStore.getInstance(&quot;PKCS12&quot;);</span>

<span class="nc" id="L98">    try (FileInputStream keyStoreFile = new FileInputStream(certificateOptions.getKeystore())) {</span>
<span class="nc" id="L99">      keyStore.load(keyStoreFile, certificateOptions.getKeystorePassword().toCharArray());</span>
    }
<span class="nc" id="L101">    String alias = certificateOptions.getKeystoreAlias();</span>
<span class="nc bnc" id="L102" title="All 4 branches missed.">    if (alias == null || alias.isBlank()) {</span>
<span class="nc" id="L103">      alias = keyStore.aliases().nextElement();</span>
    }
<span class="nc" id="L105">    keyManagerFactory.init(keyStore, certificateOptions.getKeystorePassword().toCharArray());</span>

<span class="nc" id="L107">    SSLContext context = SSLContext.getInstance(&quot;TLSv1.2&quot;);</span>
<span class="nc" id="L108">    context.init(keyManagerFactory.getKeyManagers(), trustManagerFactory.getTrustManagers(), null);</span>

<span class="nc" id="L110">    TLSClientParameters tlsClientParameters = new TLSClientParameters();</span>
<span class="nc" id="L111">    tlsClientParameters.setSSLSocketFactory(context.getSocketFactory());</span>
<span class="nc" id="L112">    http.setTlsClientParameters(tlsClientParameters);</span>

<span class="nc" id="L114">    Map&lt;String, Object&gt; props = new HashMap&lt;&gt;();</span>

<span class="nc" id="L116">    props.put(</span>
        WSHandlerConstants.ACTION,
        WSHandlerConstants.TIMESTAMP + &quot; &quot; + WSHandlerConstants.SIGNATURE);
<span class="nc" id="L119">    props.put(WSHandlerConstants.INCLUDE_SIGNATURE_TOKEN, &quot;true&quot;);</span>
<span class="nc" id="L120">    props.put(WSHandlerConstants.SIG_KEY_ID, &quot;DirectReference&quot;);</span>
<span class="nc" id="L121">    props.put(WSHandlerConstants.USE_SINGLE_CERTIFICATE, &quot;false&quot;);</span>

<span class="nc" id="L123">    props.put(WSHandlerConstants.SIG_PROP_REF_ID, &quot;signatureProperties&quot;);</span>
<span class="nc" id="L124">    props.put(&quot;signatureProperties&quot;, getCryptoProperties(certificateOptions, alias));</span>

<span class="nc" id="L126">    props.put(</span>
        WSHandlerConstants.SIGNATURE_PARTS,
        &quot;{}{http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-utility-1.0.xsd}Timestamp;&quot;
            + &quot;{}{http://schemas.xmlsoap.org/soap/envelope/}Body;&quot;
            + &quot;{}{http://www.w3.org/2005/08/addressing}To;&quot;
            + &quot;{}{http://www.w3.org/2005/08/addressing}ReplyTo;&quot;
            + &quot;{}{http://www.w3.org/2005/08/addressing}MessageID;&quot;
            + &quot;{}{http://www.w3.org/2005/08/addressing}Action&quot;);

<span class="nc" id="L135">    props.put(WSHandlerConstants.USER, alias);</span>
<span class="nc" id="L136">    props.put(</span>
        WSHandlerConstants.PW_CALLBACK_REF,
        (CallbackHandler)
            callbacks -&gt; {
<span class="nc bnc" id="L140" title="All 2 branches missed.">              for (Callback callback : callbacks) {</span>
<span class="nc" id="L141">                ((WSPasswordCallback) callback)</span>
<span class="nc" id="L142">                    .setPassword(certificateOptions.getKeystorePassword());</span>
<span class="nc" id="L143">                return;</span>
              }
<span class="nc" id="L145">            });</span>

<span class="nc" id="L147">    WSS4JOutInterceptor wssOut = new WSS4JOutInterceptor(props);</span>
<span class="nc" id="L148">    endpoint.getOutInterceptors().add(wssOut);</span>

    // Set up necessary WS-Addressing fields.
<span class="nc" id="L151">    AddressingProperties maps = new AddressingProperties();</span>
<span class="nc" id="L152">    EndpointReferenceType anonref = new EndpointReferenceType();</span>
<span class="nc" id="L153">    AttributedURIType anonymous = new AttributedURIType();</span>
<span class="nc" id="L154">    anonymous.setValue(&quot;http://www.w3.org/2005/08/addressing/anonymous&quot;);</span>
<span class="nc" id="L155">    anonref.setAddress(anonymous);</span>
<span class="nc" id="L156">    maps.setReplyTo(anonref);</span>
<span class="nc" id="L157">    maps.setFaultTo(anonref);</span>

    // &lt;wsa:To&gt; needs to point at a predefined value.
<span class="nc" id="L160">    EndpointReferenceType toval = new EndpointReferenceType();</span>
<span class="nc" id="L161">    AttributedURIType target = new AttributedURIType();</span>
<span class="nc" id="L162">    target.setValue(</span>
<span class="nc bnc" id="L163" title="All 2 branches missed.">        preprod</span>
<span class="nc" id="L164">            ? &quot;http://es.kvk.nl/kvk-DataservicePP/2015/02&quot;</span>
<span class="nc" id="L165">            : &quot;http://es.kvk.nl/kvk-Dataservice/2015/02&quot;);</span>
<span class="nc" id="L166">    toval.setAddress(target);</span>
<span class="nc" id="L167">    maps.setTo(toval);</span>

<span class="nc" id="L169">    BindingProvider bindingProvider = (BindingProvider) dataService;</span>
<span class="nc" id="L170">    bindingProvider</span>
<span class="nc" id="L171">        .getRequestContext()</span>
<span class="nc" id="L172">        .put(BindingProvider.ENDPOINT_ADDRESS_PROPERTY, targetLocation);</span>
<span class="nc" id="L173">    bindingProvider.getRequestContext().put(JAXWSAConstants.CLIENT_ADDRESSING_PROPERTIES, maps);</span>

<span class="nc" id="L175">    return dataService;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>