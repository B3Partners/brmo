<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>BAG2Database.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">BRMO service</a> &gt; <a href="../index.html" class="el_bundle">bag2-loader</a> &gt; <a href="index.source.html" class="el_package">nl.b3p.brmo.bag2.loader</a> &gt; <span class="el_source">BAG2Database.java</span></div><h1>BAG2Database.java</h1><pre class="source lang-java linenums">/*
 * Copyright (C) 2021 B3Partners B.V.
 *
 * SPDX-License-Identifier: MIT
 *
 */

package nl.b3p.brmo.bag2.loader;

import static nl.b3p.brmo.bag2.loader.BAG2LoaderUtils.getBundleString;
import static nl.b3p.brmo.bag2.loader.BAG2LoaderUtils.getMessageFormattedString;
import static nl.b3p.brmo.bag2.schema.BAG2SchemaMapper.METADATA_TABLE_NAME;

import java.sql.Clob;
import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.SQLException;
import java.time.LocalDate;
import java.time.format.DateTimeFormatter;
import java.util.Arrays;
import java.util.Set;
import java.util.stream.Collectors;
import nl.b3p.brmo.bag2.loader.cli.BAG2DatabaseOptions;
import nl.b3p.brmo.bag2.loader.cli.BAG2LoadOptions;
import nl.b3p.brmo.bag2.schema.BAG2ObjectTableWriter;
import nl.b3p.brmo.bag2.schema.BAG2SchemaMapper;
import nl.b3p.brmo.sql.LoggingQueryRunner;
import nl.b3p.brmo.sql.dialect.OracleDialect;
import nl.b3p.brmo.sql.dialect.PostGISDialect;
import nl.b3p.brmo.sql.dialect.SQLDialect;
import org.apache.commons.dbutils.QueryRunner;
import org.apache.commons.dbutils.handlers.ScalarHandler;
import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;

/* TODO: reduce redundancy with BGTDatabase, remove dependency on dialect CLI enum */
public class BAG2Database implements AutoCloseable {
<span class="fc" id="L38">  private static final Log LOG = LogFactory.getLog(BAG2Database.class);</span>

<span class="fc" id="L40">  public enum SQLDialectEnum {</span>
<span class="fc" id="L41">    postgis,</span>
<span class="fc" id="L42">    oracle</span>
  }

  private SQLDialect dialect;
  private final BAG2DatabaseOptions dbOptions;
  private Connection connection;
  private final boolean allowConnectionCreation;

<span class="fc" id="L50">  public BAG2Database(BAG2DatabaseOptions dbOptions) throws ClassNotFoundException {</span>
<span class="fc" id="L51">    this.dbOptions = dbOptions;</span>
<span class="fc" id="L52">    dialect = createDialect(dbOptions.getConnectionString());</span>
<span class="fc" id="L53">    dialect.loadDriver();</span>
<span class="fc" id="L54">    this.allowConnectionCreation = true;</span>
<span class="fc" id="L55">  }</span>

<span class="nc" id="L57">  public BAG2Database(BAG2DatabaseOptions dbOptions, Connection connection) throws SQLException {</span>
<span class="nc" id="L58">    this.dbOptions = dbOptions;</span>
<span class="nc" id="L59">    this.connection = connection;</span>
<span class="nc" id="L60">    dialect = createDialect(connection.getMetaData().getURL());</span>
<span class="nc" id="L61">    this.allowConnectionCreation = false;</span>
<span class="nc" id="L62">  }</span>

  public SQLDialect getDialect() {
<span class="fc" id="L65">    return dialect;</span>
  }

  public void setDialect(SQLDialect dialect) {
<span class="nc" id="L69">    this.dialect = dialect;</span>
<span class="nc" id="L70">  }</span>

  public Connection getConnection() throws SQLException {
<span class="pc bpc" id="L73" title="1 of 4 branches missed.">    if (this.connection == null || this.connection.isClosed()) {</span>
<span class="fc" id="L74">      this.connection = createConnection();</span>
    }
<span class="pc bpc" id="L76" title="1 of 2 branches missed.">    if (dialect instanceof PostGISDialect) {</span>
<span class="fc" id="L77">      new QueryRunner().update(this.connection, &quot;create schema if not exists bag&quot;);</span>
<span class="fc" id="L78">      new QueryRunner().update(this.connection, &quot;set search_path=bag,public&quot;);</span>
    }
<span class="fc" id="L80">    return this.connection;</span>
  }

  public void setConnection(Connection connection) {
<span class="nc" id="L84">    this.connection = connection;</span>
<span class="nc" id="L85">  }</span>

  @Override
  public void close() throws SQLException {
<span class="nc bnc" id="L89" title="All 4 branches missed.">    if (this.connection != null &amp;&amp; !this.connection.isClosed()) {</span>
<span class="nc" id="L90">      this.connection.close();</span>
    }
<span class="nc" id="L92">  }</span>

  private Connection createConnection() {
<span class="pc bpc" id="L95" title="1 of 2 branches missed.">    if (!allowConnectionCreation) {</span>
<span class="nc" id="L96">      throw new RuntimeException(</span>
          &quot;New connection required but supplied connection is null or closed&quot;);
    }
    try {
<span class="fc" id="L100">      return DriverManager.getConnection(</span>
<span class="fc" id="L101">          dbOptions.getConnectionString(), dbOptions.getUser(), dbOptions.getPassword());</span>
<span class="nc" id="L102">    } catch (SQLException e) {</span>
<span class="nc" id="L103">      throw new RuntimeException(</span>
<span class="nc" id="L104">          getMessageFormattedString(&quot;db.connection_error&quot;, dbOptions.getConnectionString()), e);</span>
    }
  }

  public BAG2ObjectTableWriter createObjectTableWriter(
      BAG2LoadOptions loadOptions, BAG2DatabaseOptions dbOptions) throws SQLException {
<span class="fc" id="L110">    BAG2ObjectTableWriter writer =</span>
        new BAG2ObjectTableWriter(
<span class="fc" id="L112">            getConnection(), this.getDialect(), BAG2SchemaMapper.getInstance());</span>

<span class="pc bpc" id="L114" title="1 of 2 branches missed.">    if (loadOptions == null) {</span>
<span class="nc" id="L115">      loadOptions = new BAG2LoadOptions();</span>
    }
<span class="fc" id="L117">    writer.setBatchSize(</span>
<span class="pc bpc" id="L118" title="1 of 2 branches missed.">        dbOptions.getBatchSize() != null</span>
<span class="nc" id="L119">            ? dbOptions.getBatchSize()</span>
<span class="fc" id="L120">            : this.getDialect().getDefaultOptimalBatchSize());</span>
<span class="fc" id="L121">    writer.setMultithreading(loadOptions.isMultithreading());</span>
<span class="fc" id="L122">    writer.setUsePgCopy(dbOptions.isUsePgCopy());</span>
<span class="fc" id="L123">    writer.setObjectLimit(loadOptions.getMaxObjects());</span>
<span class="fc" id="L124">    writer.setIgnoreDuplicates(loadOptions.isIgnoreDuplicates());</span>
<span class="fc" id="L125">    writer.setDropIfExists(loadOptions.isDropIfExists());</span>

<span class="fc" id="L127">    return writer;</span>
  }

  public static SQLDialect createDialect(String connectionString) {
    BAG2Database.SQLDialectEnum sqlDialectEnum;
<span class="pc bpc" id="L132" title="1 of 2 branches missed.">    if (connectionString.startsWith(&quot;jdbc:postgresql:&quot;)) {</span>
<span class="fc" id="L133">      sqlDialectEnum = BAG2Database.SQLDialectEnum.postgis;</span>
<span class="nc bnc" id="L134" title="All 2 branches missed.">    } else if (connectionString.startsWith(&quot;jdbc:oracle:thin:&quot;)) {</span>
<span class="nc" id="L135">      sqlDialectEnum = BAG2Database.SQLDialectEnum.oracle;</span>
    } else {
<span class="nc" id="L137">      throw new IllegalArgumentException(</span>
<span class="nc" id="L138">          getMessageFormattedString(&quot;db.unknown_connection_string_dialect&quot;, connectionString));</span>
    }
<span class="fc" id="L140">    return createDialect(sqlDialectEnum);</span>
  }

  public static SQLDialect createDialect(BAG2Database.SQLDialectEnum dialectEnum) {
<span class="pc bpc" id="L144" title="2 of 3 branches missed.">    switch (dialectEnum) {</span>
      case postgis:
<span class="fc" id="L146">        return new PostGISDialect();</span>
      case oracle:
<span class="nc" id="L148">        return new OracleDialect();</span>
    }
<span class="nc" id="L150">    throw new IllegalArgumentException(</span>
<span class="nc" id="L151">        getMessageFormattedString(&quot;db.dialect_invalid&quot;, dialectEnum));</span>
  }

  public void createMetadataTable(BAG2LoadOptions loadOptions) throws SQLException {
<span class="nc" id="L155">    LOG.info(getBundleString(&quot;db.create_metadata&quot;));</span>
    for (String sql :
<span class="nc bnc" id="L157" title="All 2 branches missed.">        BAG2SchemaMapper.getInstance()</span>
<span class="nc" id="L158">            .getCreateMetadataTableStatements(getDialect(), &quot;&quot;, loadOptions.isDropIfExists())) {</span>
<span class="nc" id="L159">      new LoggingQueryRunner().update(getConnection(), sql);</span>
<span class="nc" id="L160">    }</span>
<span class="nc" id="L161">  }</span>

  public String getMetadata(BAG2SchemaMapper.Metadata key) throws SQLException {
<span class="fc" id="L164">    Object value =</span>
        new LoggingQueryRunner()
<span class="fc" id="L166">            .query(</span>
<span class="fc" id="L167">                getConnection(),</span>
                &quot;select waarde from &quot; + METADATA_TABLE_NAME + &quot; where naam = ?&quot;,
                new ScalarHandler&lt;&gt;(),
<span class="fc" id="L170">                key.getDbKey());</span>
<span class="fc bfc" id="L171" title="All 2 branches covered.">    if (value == null) {</span>
<span class="fc" id="L172">      return null;</span>
    }
<span class="pc bpc" id="L174" title="1 of 2 branches missed.">    if (value instanceof Clob) {</span>
<span class="nc" id="L175">      Clob clob = (Clob) value;</span>
<span class="nc" id="L176">      return clob.getSubString(1, (int) clob.length());</span>
    }
<span class="fc" id="L178">    return value.toString();</span>
  }

  public void setMetadataValue(BAG2SchemaMapper.Metadata key, String value) throws Exception {
    try {
<span class="fc" id="L183">      int updated =</span>
          new LoggingQueryRunner()
<span class="fc" id="L185">              .update(</span>
<span class="fc" id="L186">                  getConnection(),</span>
                  &quot;update &quot; + METADATA_TABLE_NAME + &quot; set waarde = ? where naam = ?&quot;,
                  value,
<span class="fc" id="L189">                  key.getDbKey());</span>
<span class="fc bfc" id="L190" title="All 2 branches covered.">      if (updated == 0) {</span>
<span class="fc" id="L191">        new LoggingQueryRunner()</span>
<span class="fc" id="L192">            .update(</span>
<span class="fc" id="L193">                getConnection(),</span>
                &quot;insert into &quot; + METADATA_TABLE_NAME + &quot;(naam, waarde) values(?,?)&quot;,
<span class="fc" id="L195">                key.getDbKey(),</span>
                value);
      }
<span class="nc" id="L198">    } catch (SQLException e) {</span>
<span class="nc" id="L199">      throw new Exception(</span>
<span class="nc" id="L200">          getMessageFormattedString(&quot;db.metadata_error&quot;, key.getDbKey(), value, e.getMessage()), e);</span>
<span class="fc" id="L201">    }</span>
<span class="fc" id="L202">  }</span>

  public LocalDate getCurrentTechnischeDatum() throws SQLException {
<span class="fc" id="L205">    String s = getMetadata(BAG2SchemaMapper.Metadata.CURRENT_TECHNISCHE_DATUM);</span>
<span class="pc bpc" id="L206" title="1 of 2 branches missed.">    if (s == null) {</span>
<span class="nc" id="L207">      throw new IllegalStateException(&quot;Geen huidige BAG2 stand ingeladen&quot;);</span>
    }
<span class="fc" id="L209">    return LocalDate.parse(s, DateTimeFormatter.ISO_LOCAL_DATE);</span>
  }

  public Set&lt;String&gt; getGemeenteCodes() throws SQLException {
<span class="nc" id="L213">    String s = getMetadata(BAG2SchemaMapper.Metadata.GEMEENTE_CODES);</span>
<span class="nc bnc" id="L214" title="All 2 branches missed.">    if (s == null) {</span>
<span class="nc" id="L215">      throw new IllegalStateException(&quot;Geen huidige BAG2 stand voor gemeentes ingeladen&quot;);</span>
    }
<span class="nc" id="L217">    return Arrays.stream(s.split(&quot;,&quot;)).collect(Collectors.toSet());</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>