<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="nl"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>BAG2LoaderMain.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">BRMO service</a> &gt; <a href="../index.html" class="el_bundle">bag2-loader</a> &gt; <a href="index.source.html" class="el_package">nl.b3p.brmo.bag2.loader.cli</a> &gt; <span class="el_source">BAG2LoaderMain.java</span></div><h1>BAG2LoaderMain.java</h1><pre class="source lang-java linenums">/*
 * Copyright (C) 2021 B3Partners B.V.
 *
 * SPDX-License-Identifier: MIT
 *
 */

package nl.b3p.brmo.bag2.loader.cli;

import static nl.b3p.brmo.bag2.schema.BAG2SchemaMapper.METADATA_TABLE_NAME;
import static nl.b3p.brmo.bag2.schema.BAG2SchemaMapper.Metadata.CURRENT_TECHNISCHE_DATUM;
import static nl.b3p.brmo.bag2.schema.BAG2SchemaMapper.Metadata.FILTER_MUTATIES_WOONPLAATS;
import static nl.b3p.brmo.bag2.schema.BAG2SchemaMapper.Metadata.GEMEENTE_CODES;
import static nl.b3p.brmo.bag2.schema.BAG2SchemaMapper.Metadata.STAND_LOAD_TECHNISCHE_DATUM;
import static nl.b3p.brmo.bag2.schema.BAG2SchemaMapper.Metadata.STAND_LOAD_TIME;
import static nl.b3p.brmo.bgt.loader.Utils.getMessageFormattedString;

import nl.b3p.brmo.bag2.loader.BAG2Database;
import nl.b3p.brmo.bag2.loader.BAG2GMLMutatieGroepStream;
import nl.b3p.brmo.bag2.loader.BAG2LoaderUtils;
import nl.b3p.brmo.bag2.loader.BAG2ProgressReporter;
import nl.b3p.brmo.bag2.schema.BAG2ObjectTableWriter;
import nl.b3p.brmo.bag2.schema.BAG2ObjectType;
import nl.b3p.brmo.bag2.schema.BAG2Schema;
import nl.b3p.brmo.bag2.schema.BAG2SchemaMapper;
import nl.b3p.brmo.sql.LoggingQueryRunner;
import nl.b3p.brmo.util.ResumingInputStream;
import nl.b3p.brmo.util.http.HttpClientWrapper;
import nl.b3p.brmo.util.http.HttpStartRangeInputStreamProvider;
import nl.b3p.brmo.util.http.wrapper.Java11HttpClientWrapper;

import org.apache.commons.compress.archivers.zip.ZipArchiveEntry;
import org.apache.commons.compress.archivers.zip.ZipArchiveInputStream;
import org.apache.commons.io.input.CloseShieldInputStream;
import org.apache.commons.lang3.tuple.Pair;
import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import org.apache.log4j.PropertyConfigurator;
import org.geotools.util.logging.Logging;

import picocli.CommandLine;
import picocli.CommandLine.Command;
import picocli.CommandLine.ExitCode;
import picocli.CommandLine.IVersionProvider;
import picocli.CommandLine.Mixin;
import picocli.CommandLine.Option;
import picocli.CommandLine.Parameters;

import java.io.FileInputStream;
import java.io.IOException;
import java.io.InputStream;
import java.net.CookieManager;
import java.net.URI;
import java.net.http.HttpClient;
import java.net.http.HttpRequest;
import java.net.http.HttpResponse;
import java.nio.file.Files;
import java.nio.file.Path;
import java.text.SimpleDateFormat;
import java.time.LocalDate;
import java.util.Date;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Map;
import java.util.Set;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

@Command(
        name = &quot;bag2-loader&quot;,
        mixinStandardHelpOptions = true,
        versionProvider = BAG2LoaderMain.class,
        resourceBundle = BAG2LoaderUtils.BUNDLE_NAME,
        subcommands = {BAG2MutatiesCommand.class})
<span class="nc" id="L75">public class BAG2LoaderMain implements IVersionProvider {</span>
    private static Log log;

    /* zodat we een JNDI database kunnen gebruiken */
<span class="nc" id="L79">    private BAG2Database bag2Database = null;</span>

<span class="nc" id="L81">    private Set&lt;BAG2ObjectType&gt; objectTypesWithSchemaCreated = new HashSet&lt;&gt;();</span>

<span class="nc" id="L83">    private Map&lt;BAG2ObjectType, Set&lt;Pair&lt;Object, Object&gt;&gt;&gt; keysPerObjectType = new HashMap&lt;&gt;();</span>

    /**
     * init logging.
     *
     * @param standAlone set to {@code false} when using in a preconfigured environment, eg. calling
     *     methods from a servlet, use {@code true} for commandline usage.
     */
    public static void configureLogging(boolean standAlone) {
<span class="nc bnc" id="L92" title="All 2 branches missed.">        if (standAlone) {</span>
<span class="nc" id="L93">            PropertyConfigurator.configure(</span>
<span class="nc" id="L94">                    BAG2LoaderMain.class.getResourceAsStream(&quot;/bag2-loader-cli-log4j.properties&quot;));</span>
<span class="nc" id="L95">            log = LogFactory.getLog(BAG2LoaderMain.class);</span>
            try {
<span class="nc" id="L97">                Logging.ALL.setLoggerFactory(&quot;org.geotools.util.logging.Log4JLoggerFactory&quot;);</span>
<span class="nc" id="L98">            } catch (ClassNotFoundException ignored) {</span>
<span class="nc" id="L99">            }</span>
        } else {
<span class="nc" id="L101">            log = LogFactory.getLog(BAG2LoaderMain.class);</span>
        }
<span class="nc" id="L103">    }</span>

    public static void main(String... args) {
<span class="nc" id="L106">        configureLogging(true);</span>

<span class="nc" id="L108">        CommandLine cmd = new CommandLine(new BAG2LoaderMain()).setUsageHelpAutoWidth(true);</span>
<span class="nc" id="L109">        System.exit(cmd.execute(args));</span>
<span class="nc" id="L110">    }</span>

    @Override
    public String[] getVersion() {
<span class="nc" id="L114">        return new String[] {BAG2LoaderUtils.getLoaderVersion(), BAG2LoaderUtils.getUserAgent()};</span>
    }

    @Command(name = &quot;load&quot;, sortOptions = false)
    public int load(
            @Mixin BAG2DatabaseOptions dbOptions,
            @Mixin BAG2LoadOptions loadOptions,
            @Mixin BAG2ProgressOptions progressOptions,
            @Parameters(paramLabel = &quot;&lt;file&gt;&quot;) String[] filenames,
            @Option(
                            names = {&quot;-h&quot;, &quot;--help&quot;},
                            usageHelp = true)
                    boolean showHelp)
            throws Exception {

<span class="nc" id="L129">        log.info(BAG2LoaderUtils.getUserAgent());</span>

<span class="nc" id="L131">        try (BAG2Database db = getBAG2Database(dbOptions)) {</span>
            BAG2ProgressReporter progressReporter =
<span class="nc bnc" id="L133" title="All 2 branches missed.">                    progressOptions.isConsoleProgressEnabled()</span>
<span class="nc" id="L134">                            ? new BAG2ConsoleProgressReporter()</span>
<span class="nc" id="L135">                            : new BAG2ProgressReporter();</span>

<span class="nc" id="L137">            loadFiles(db, dbOptions, loadOptions, progressReporter, filenames, null);</span>
<span class="nc" id="L138">            return ExitCode.OK;</span>
        }
    }

    public BAG2Database getBAG2Database(BAG2DatabaseOptions dbOptions)
            throws ClassNotFoundException {
<span class="nc bnc" id="L144" title="All 2 branches missed.">        if (bag2Database == null) {</span>
<span class="nc" id="L145">            bag2Database = new BAG2Database(dbOptions);</span>
        }
<span class="nc" id="L147">        return bag2Database;</span>
    }

    public void setBag2Database(BAG2Database bag2Database) {
<span class="nc" id="L151">        this.bag2Database = bag2Database;</span>
<span class="nc" id="L152">    }</span>

    public void loadFiles(
            BAG2Database db,
            BAG2DatabaseOptions dbOptions,
            BAG2LoadOptions loadOptions,
            BAG2ProgressReporter progressReporter,
            String[] filenames,
            CookieManager cookieManager)
            throws Exception {

<span class="nc bnc" id="L163" title="All 4 branches missed.">        if (filenames.length == 1 &amp;&amp; Files.isDirectory(Path.of(filenames[0]))) {</span>
<span class="nc" id="L164">            log.info(&quot;Directory opgegeven, kijken naar toepasbare mutaties...&quot;);</span>
<span class="nc" id="L165">            filenames =</span>
<span class="nc" id="L166">                    Files.list(Path.of(filenames[0]))</span>
<span class="nc" id="L167">                            .filter(</span>
                                    p -&gt;
<span class="nc bnc" id="L169" title="All 2 branches missed.">                                            !Files.isDirectory(p)</span>
<span class="nc bnc" id="L170" title="All 2 branches missed.">                                                    &amp;&amp; p.getFileName().toString().endsWith(&quot;.zip&quot;))</span>
<span class="nc" id="L171">                            .map(p -&gt; p.toAbsolutePath().toString())</span>
<span class="nc" id="L172">                            .toArray(String[]::new);</span>
<span class="nc bnc" id="L173" title="All 2 branches missed.">            if (filenames.length == 0) {</span>
<span class="nc" id="L174">                log.info(&quot;Geen ZIP bestanden gevonden, niets te doen&quot;);</span>
            } else {
<span class="nc" id="L176">                applyMutaties(db, dbOptions, loadOptions, progressReporter, filenames, null);</span>
            }
<span class="nc" id="L178">            return;</span>
        }

<span class="nc" id="L181">        BAG2LoaderUtils.BAGExtractSelectie bagExtractLevering =</span>
<span class="nc" id="L182">                BAG2LoaderUtils.getBAGExtractSelectieFromZip(filenames[0]);</span>

<span class="nc bnc" id="L184" title="All 2 branches missed.">        if (bagExtractLevering.isStand()) {</span>
<span class="nc bnc" id="L185" title="All 2 branches missed.">            if (bagExtractLevering.isGebiedNLD()) {</span>
<span class="nc bnc" id="L186" title="All 2 branches missed.">                if (filenames.length &gt; 1) {</span>
<span class="nc" id="L187">                    throw new IllegalArgumentException(</span>
                            &quot;Inladen stand heel Nederland: teveel bestanden opgegeven&quot;);
                }
            } else {
                // Verify all filenames are gemeentestanden
<span class="nc" id="L192">                Set&lt;String&gt; gemeenteCodes = new HashSet&lt;&gt;();</span>
<span class="nc bnc" id="L193" title="All 2 branches missed.">                for (int i = 1; i &lt; filenames.length; i++) {</span>
<span class="nc" id="L194">                    BAG2LoaderUtils.BAGExtractSelectie nextBagExtractLevering =</span>
<span class="nc" id="L195">                            BAG2LoaderUtils.getBAGExtractSelectieFromZip(filenames[i]);</span>

<span class="nc bnc" id="L197" title="All 4 branches missed.">                    if (!nextBagExtractLevering.isStand() || nextBagExtractLevering.isGebiedNLD()) {</span>
<span class="nc" id="L198">                        throw new IllegalArgumentException(</span>
                                &quot;Inladen stand gemeentes, ongeldig bestand opgegeven (geen gemeentestand): &quot;
                                        + filenames[i]);
                    }
<span class="nc" id="L202">                    Set&lt;String&gt; nextBagExtractLeveringGemeenteCodes =</span>
<span class="nc" id="L203">                            nextBagExtractLevering.getGemeenteCodes();</span>
<span class="nc" id="L204">                    if (gemeenteCodes.stream()</span>
<span class="nc bnc" id="L205" title="All 2 branches missed.">                            .anyMatch(nextBagExtractLeveringGemeenteCodes::contains)) {</span>
<span class="nc" id="L206">                        throw new IllegalArgumentException(</span>
                                &quot;Inladen stand gemeentes, dubbele gemeentecode in bestand: &quot;
                                        + filenames[i]);
                    }
<span class="nc" id="L210">                    gemeenteCodes.addAll(nextBagExtractLeveringGemeenteCodes);</span>
                }
            }

<span class="nc" id="L214">            new LoggingQueryRunner().update(db.getConnection(), &quot;create sequence objectid_seq&quot;);</span>

<span class="nc" id="L216">            loadStandFiles(db, dbOptions, loadOptions, progressReporter, filenames, cookieManager);</span>
        } else {
            // Process mutaties while ignoring files not applicable
<span class="nc" id="L219">            applyMutaties(db, dbOptions, loadOptions, progressReporter, filenames, null);</span>
        }
<span class="nc" id="L221">    }</span>

    /**
     * Only called after list of files have been checked to only have been entire NL stand or unique
     * gemeente standen.
     */
    private void loadStandFiles(
            BAG2Database db,
            BAG2DatabaseOptions dbOptions,
            BAG2LoadOptions loadOptions,
            BAG2ProgressReporter progressReporter,
            String[] filenames,
            CookieManager cookieManager)
            throws Exception {
        try {
            // When loading multiple standen (for gemeentes), set ignore duplicates so the seen
            // object keys are kept in
            // memory so duplicates can be ignored. Don't keep keys in memory for entire NL stand.
<span class="nc bnc" id="L239" title="All 2 branches missed.">            loadOptions.setIgnoreDuplicates(filenames.length &gt; 1);</span>

            // Multiple gemeentes can also be provided in a single ZIP file, check the
            // Leveringsdocument whether that is
            // the case
<span class="nc bnc" id="L244" title="All 2 branches missed.">            if (filenames.length == 1) {</span>
<span class="nc" id="L245">                BAG2LoaderUtils.BAGExtractSelectie levering =</span>
<span class="nc" id="L246">                        BAG2LoaderUtils.getBAGExtractSelectieFromZip(filenames[0]);</span>
<span class="nc bnc" id="L247" title="All 2 branches missed.">                if (!levering.isGebiedNLD()) {</span>
<span class="nc bnc" id="L248" title="All 2 branches missed.">                    loadOptions.setIgnoreDuplicates(levering.getGemeenteCodes().size() &gt; 1);</span>
                }
            }

<span class="nc" id="L252">            BAG2GMLMutatieGroepStream.BagInfo bagInfo = null;</span>
<span class="nc" id="L253">            String lastFilename = null;</span>

            // Keep track of which gemeentes are loaded so the correct mutations can be processed
            // later
<span class="nc" id="L257">            Set&lt;String&gt; gemeenteIdentificaties = new HashSet&lt;&gt;();</span>

<span class="nc bnc" id="L259" title="All 2 branches missed.">            for (String filename : filenames) {</span>
<span class="nc" id="L260">                BAG2GMLMutatieGroepStream.BagInfo latestBagInfo =</span>
<span class="nc" id="L261">                        loadBAG2ExtractFromURLorFile(</span>
                                db, loadOptions, dbOptions, progressReporter, filename);
<span class="nc bnc" id="L263" title="All 2 branches missed.">                if (bagInfo != null) {</span>
                    // For gemeentes the BagInfo must be the same so the standen are of the same
                    // date
<span class="nc bnc" id="L266" title="All 2 branches missed.">                    if (!latestBagInfo.equalsExceptGemeenteIdentificaties(bagInfo)) {</span>
<span class="nc" id="L267">                        throw new IllegalArgumentException(</span>
<span class="nc" id="L268">                                String.format(</span>
                                        &quot;Incompatible BagInfo for file \&quot;%s\&quot; (%s) compared to last file \&quot;%s\&quot; (%s)&quot;,
                                        filename, latestBagInfo, lastFilename, bagInfo));
                    }
                }
<span class="nc" id="L273">                bagInfo = latestBagInfo;</span>

                // For NL stand this will be &quot;9999&quot;
<span class="nc" id="L276">                gemeenteIdentificaties.addAll(bagInfo.getGemeenteIdentificaties());</span>
<span class="nc" id="L277">                lastFilename = filename;</span>
            }
<span class="nc bnc" id="L279" title="All 2 branches missed.">            if (bagInfo != null) {</span>
                // TODO: when loading gemeente without rare objects such as
                // ligplaatsen/standplaatsen, table will not be created
                // and a future change with such an object will fail. Should create entire schema
                // up-front instead of when first
                // encountering object type
<span class="nc" id="L285">                createKeysAndIndexes(db, loadOptions, dbOptions, progressReporter);</span>

<span class="nc" id="L287">                updateMetadata(</span>
                        db,
                        loadOptions,
                        true,
                        gemeenteIdentificaties,
<span class="nc" id="L292">                        bagInfo.getStandTechnischeDatum());</span>
            }

<span class="nc" id="L295">            db.getConnection().commit();</span>
        } finally {
<span class="nc" id="L297">            progressReporter.reportTotalSummary();</span>
        }
<span class="nc" id="L299">    }</span>

    public void applyMutaties(
            BAG2Database db,
            BAG2DatabaseOptions dbOptions,
            BAG2LoadOptions loadOptions,
            BAG2ProgressReporter progressReporter,
            String[] urls,
            CookieManager cookieManager)
            throws Exception {
<span class="nc bnc" id="L309" title="All 2 branches missed.">        if (urls.length == 0) {</span>
<span class="nc" id="L310">            return;</span>
        }
<span class="nc" id="L312">        BAG2LoaderUtils.BAGExtractSelectie bagExtractLevering =</span>
<span class="nc" id="L313">                BAG2LoaderUtils.getBAGExtractSelectieFromZip(urls[0]);</span>
<span class="nc bnc" id="L314" title="All 2 branches missed.">        if (bagExtractLevering.isGebiedNLD()) {</span>
<span class="nc" id="L315">            applyNLMutaties(db, dbOptions, loadOptions, progressReporter, urls, cookieManager);</span>
        } else {
<span class="nc" id="L317">            applyGemeenteMutaties(</span>
                    db, dbOptions, loadOptions, progressReporter, urls, cookieManager);
        }
<span class="nc" id="L320">    }</span>

    private void applyGemeenteMutaties(
            BAG2Database db,
            BAG2DatabaseOptions dbOptions,
            BAG2LoadOptions loadOptions,
            BAG2ProgressReporter progressReporter,
            String[] urls,
            CookieManager cookieManager)
            throws Exception {
<span class="nc" id="L330">        LocalDate currentTechnischeDatum = db.getCurrentTechnischeDatum();</span>
<span class="nc" id="L331">        Set&lt;String&gt; gemeenteCodes = db.getGemeenteCodes();</span>

        Set&lt;Integer&gt; applicableMutatieIndexes;
        do {
<span class="nc" id="L335">            applicableMutatieIndexes = new HashSet&lt;&gt;();</span>

<span class="nc" id="L337">            Set&lt;String&gt; missingGemeentes = new HashSet&lt;&gt;(gemeenteCodes);</span>
<span class="nc bnc" id="L338" title="All 2 branches missed.">            for (int i = 0; i &lt; urls.length; i++) {</span>
<span class="nc" id="L339">                BAG2LoaderUtils.BAGExtractSelectie bagExtractLevering =</span>
<span class="nc" id="L340">                        BAG2LoaderUtils.getBAGExtractSelectieFromZip(urls[i]);</span>

<span class="nc bnc" id="L342" title="All 2 branches missed.">                if (!bagExtractLevering.isGebiedNLD()</span>
<span class="nc bnc" id="L343" title="All 2 branches missed.">                        &amp;&amp; !bagExtractLevering.isStand()</span>
<span class="nc bnc" id="L344" title="All 2 branches missed.">                        &amp;&amp; bagExtractLevering.getMutatiesFrom().equals(currentTechnischeDatum)) {</span>

<span class="nc bnc" id="L346" title="All 2 branches missed.">                    for (String gemeenteCode : bagExtractLevering.getGemeenteCodes()) {</span>
<span class="nc bnc" id="L347" title="All 2 branches missed.">                        if (gemeenteCodes.contains(gemeenteCode)) {</span>
<span class="nc" id="L348">                            applicableMutatieIndexes.add(i);</span>
<span class="nc" id="L349">                            missingGemeentes.remove(gemeenteCode);</span>
                        }
<span class="nc" id="L351">                    }</span>
                }
            }

<span class="nc bnc" id="L355" title="All 2 branches missed.">            if (applicableMutatieIndexes.isEmpty()) {</span>
<span class="nc" id="L356">                log.info(</span>
<span class="nc" id="L357">                        String.format(</span>
                                &quot;Geen nieuw toe te passen gemeentemutatiebestanden gevonden voor huidige stand technische datum %s, klaar&quot;,
                                currentTechnischeDatum));
<span class="nc" id="L360">                break;</span>
            }

            // Check whether applicable mutaties are available for all gemeentecodes because they
            // need to be processed
            // at the same time to ignore duplicates
<span class="nc bnc" id="L366" title="All 2 branches missed.">            if (!missingGemeentes.isEmpty()) {</span>
<span class="nc" id="L367">                throw new IllegalArgumentException(</span>
<span class="nc" id="L368">                        String.format(</span>
                                &quot;Kan geen gemeente mutaties toepassen voor gemeentes %s vanaf stand technische datum %s, in opgegeven mutatiebestanden ontbreken gemeentecodes %s&quot;,
                                gemeenteCodes, currentTechnischeDatum, missingGemeentes));
            }

<span class="nc" id="L373">            log.info(</span>
<span class="nc" id="L374">                    String.format(</span>
                            &quot;Toepassen gemeentemutaties voor %d gemeentes vanaf stand technische datum %s...&quot;,
<span class="nc" id="L376">                            gemeenteCodes.size(), currentTechnischeDatum));</span>

<span class="nc" id="L378">            BAG2GMLMutatieGroepStream.BagInfo bagInfo = null;</span>

<span class="nc bnc" id="L380" title="All 2 branches missed.">            loadOptions.setIgnoreDuplicates(gemeenteCodes.size() &gt; 1);</span>
<span class="nc bnc" id="L381" title="All 2 branches missed.">            for (int index : applicableMutatieIndexes) {</span>
<span class="nc" id="L382">                bagInfo =</span>
<span class="nc" id="L383">                        loadBAG2ExtractFromURLorFile(</span>
                                db,
                                loadOptions,
                                dbOptions,
                                progressReporter,
                                urls[index],
                                cookieManager);
<span class="nc" id="L390">            }</span>
<span class="nc" id="L391">            currentTechnischeDatum =</span>
<span class="nc" id="L392">                    new java.sql.Date(bagInfo.getStandTechnischeDatum().getTime()).toLocalDate();</span>
<span class="nc" id="L393">            updateMetadata(db, loadOptions, false, null, bagInfo.getStandTechnischeDatum());</span>
<span class="nc" id="L394">            db.getConnection().commit();</span>
            // Duplicates need only be checked for mutaties for a single from date, clear cache to
            // reduce memory usage
<span class="nc" id="L397">            clearDuplicatesCache();</span>
<span class="nc" id="L398">            log.info(</span>
                    &quot;Mutaties verwerkt, huidige stand technische datum: &quot; + currentTechnischeDatum);

<span class="nc" id="L401">        } while (true);</span>
<span class="nc" id="L402">    }</span>

    private void applyNLMutaties(
            BAG2Database db,
            BAG2DatabaseOptions dbOptions,
            BAG2LoadOptions loadOptions,
            BAG2ProgressReporter progressReporter,
            String[] urls,
            CookieManager cookieManager)
            throws Exception {
<span class="nc" id="L412">        LocalDate currentTechnischeDatum = db.getCurrentTechnischeDatum();</span>
        do {
<span class="nc" id="L414">            String applicatieMutatieURL = null;</span>

<span class="nc bnc" id="L416" title="All 2 branches missed.">            for (String url : urls) {</span>
<span class="nc" id="L417">                BAG2LoaderUtils.BAGExtractSelectie bagExtractSelectie =</span>
<span class="nc" id="L418">                        BAG2LoaderUtils.getBAGExtractSelectieFromZip(url);</span>

<span class="nc bnc" id="L420" title="All 2 branches missed.">                if (bagExtractSelectie.isGebiedNLD()</span>
<span class="nc bnc" id="L421" title="All 2 branches missed.">                        &amp;&amp; !bagExtractSelectie.isStand()</span>
<span class="nc bnc" id="L422" title="All 2 branches missed.">                        &amp;&amp; bagExtractSelectie.getMutatiesFrom().equals(currentTechnischeDatum)) {</span>
<span class="nc" id="L423">                    applicatieMutatieURL = url;</span>
                }
            }

<span class="nc bnc" id="L427" title="All 2 branches missed.">            if (applicatieMutatieURL == null) {</span>
<span class="nc" id="L428">                log.info(</span>
<span class="nc" id="L429">                        String.format(</span>
                                &quot;Geen nieuw toe te passen mutatiebestanden gevonden voor huidige stand technische datum %s, klaar&quot;,
                                currentTechnischeDatum));
<span class="nc" id="L432">                break;</span>
            }

<span class="nc" id="L435">            log.info(</span>
<span class="nc" id="L436">                    String.format(</span>
                            &quot;Toepassen mutaties vanaf stand technische datum %s...&quot;,
                            currentTechnischeDatum));

<span class="nc" id="L440">            BAG2GMLMutatieGroepStream.BagInfo bagInfo =</span>
<span class="nc" id="L441">                    loadBAG2ExtractFromURLorFile(</span>
                            db,
                            loadOptions,
                            dbOptions,
                            progressReporter,
                            applicatieMutatieURL,
                            cookieManager);
<span class="nc" id="L448">            currentTechnischeDatum =</span>
<span class="nc" id="L449">                    new java.sql.Date(bagInfo.getStandTechnischeDatum().getTime()).toLocalDate();</span>
<span class="nc" id="L450">            updateMetadata(db, loadOptions, false, null, bagInfo.getStandTechnischeDatum());</span>
<span class="nc" id="L451">            db.getConnection().commit();</span>
<span class="nc" id="L452">            log.info(</span>
                    &quot;Mutaties verwerkt, huidige stand technische datum: &quot; + currentTechnischeDatum);
<span class="nc" id="L454">        } while (true);</span>
<span class="nc" id="L455">    }</span>

    private void createKeysAndIndexes(
            BAG2Database db,
            BAG2LoadOptions loadOptions,
            BAG2DatabaseOptions databaseOptions,
            BAG2ProgressReporter progressReporter)
            throws Exception {
<span class="nc" id="L463">        BAG2ObjectTableWriter writer = db.createObjectTableWriter(loadOptions, databaseOptions);</span>
<span class="nc" id="L464">        writer.setProgressUpdater(progressReporter);</span>
<span class="nc bnc" id="L465" title="All 2 branches missed.">        for (BAG2ObjectType objectType : objectTypesWithSchemaCreated) {</span>
<span class="nc" id="L466">            writer.createKeys(objectType); // BAG2 writer is always a single ObjectType unlike BGT</span>
<span class="nc" id="L467">            writer.createIndexes(objectType);</span>
<span class="nc" id="L468">        }</span>
<span class="nc" id="L469">    }</span>

    private BAG2GMLMutatieGroepStream.BagInfo loadBAG2ExtractFromURLorFile(
            BAG2Database db,
            BAG2LoadOptions loadOptions,
            BAG2DatabaseOptions dbOptions,
            BAG2ProgressReporter progressReporter,
            String url)
            throws Exception {
<span class="nc" id="L478">        return loadBAG2ExtractFromURLorFile(</span>
                db, loadOptions, dbOptions, progressReporter, url, null);
    }

    private BAG2GMLMutatieGroepStream.BagInfo loadBAG2ExtractFromURLorFile(
            BAG2Database db,
            BAG2LoadOptions loadOptions,
            BAG2DatabaseOptions dbOptions,
            BAG2ProgressReporter progressReporter,
            String url,
            CookieManager cookieManager)
            throws Exception {
        HttpClientWrapper&lt;HttpRequest.Builder, HttpResponse&lt;InputStream&gt;&gt; httpClientWrapper =
<span class="nc bnc" id="L491" title="All 2 branches missed.">                cookieManager == null</span>
<span class="nc" id="L492">                        ? new Java11HttpClientWrapper()</span>
<span class="nc" id="L493">                        : new Java11HttpClientWrapper(</span>
<span class="nc" id="L494">                                HttpClient.newBuilder().cookieHandler(cookieManager));</span>

<span class="nc bnc" id="L496" title="All 4 branches missed.">        if (url.startsWith(&quot;http://&quot;) || url.startsWith(&quot;https://&quot;)) {</span>
<span class="nc" id="L497">            try (InputStream in =</span>
                    new ResumingInputStream(
                            new HttpStartRangeInputStreamProvider(
<span class="nc" id="L500">                                    URI.create(url), httpClientWrapper))) {</span>
<span class="nc" id="L501">                return loadBAG2ExtractFromStream(</span>
                        db, loadOptions, dbOptions, progressReporter, url, in);
            }
        }
<span class="nc bnc" id="L505" title="All 2 branches missed.">        if (url.endsWith(&quot;.zip&quot;)) {</span>
<span class="nc" id="L506">            try (InputStream in = new FileInputStream(url)) {</span>
<span class="nc" id="L507">                return loadBAG2ExtractFromStream(</span>
                        db, loadOptions, dbOptions, progressReporter, url, in);
            }
        }

<span class="nc" id="L512">        throw new IllegalArgumentException(getMessageFormattedString(&quot;load.invalid_file&quot;, url));</span>
    }

    private BAG2GMLMutatieGroepStream.BagInfo loadBAG2ExtractFromStream(
            BAG2Database db,
            BAG2LoadOptions loadOptions,
            BAG2DatabaseOptions dbOptions,
            BAG2ProgressReporter progressReporter,
            String name,
            InputStream input)
            throws Exception {
<span class="nc" id="L523">        BAG2GMLMutatieGroepStream.BagInfo bagInfo = null;</span>
<span class="nc" id="L524">        Set&lt;String&gt; gemeenteIdentificaties = new HashSet&lt;&gt;();</span>
<span class="nc" id="L525">        try (ZipArchiveInputStream zip = new ZipArchiveInputStream(input)) {</span>
<span class="nc" id="L526">            ZipArchiveEntry entry = zip.getNextZipEntry();</span>
<span class="nc bnc" id="L527" title="All 2 branches missed.">            while (entry != null) {</span>
<span class="nc bnc" id="L528" title="All 2 branches missed.">                if (entry.getName().matches(&quot;[0-9]{4}(STA|VBO|OPR|NUM|LIG|PND|WPL).*\\.xml&quot;)) {</span>
                    // Load extracted zipfile
<span class="nc" id="L530">                    bagInfo =</span>
<span class="nc" id="L531">                            loadXmlEntriesFromZipFile(</span>
                                    db, loadOptions, dbOptions, progressReporter, name, zip, entry);
<span class="nc" id="L533">                    break;</span>
                }

<span class="nc bnc" id="L536" title="All 2 branches missed.">                if (entry.getName().matches(&quot;[0-9]{4}GEM[0-9]{8}\\.zip&quot;)) {</span>
<span class="nc" id="L537">                    bagInfo =</span>
<span class="nc" id="L538">                            loadBAG2ExtractFromStream(</span>
                                    db,
                                    loadOptions,
                                    dbOptions,
                                    progressReporter,
                                    name,
<span class="nc" id="L544">                                    CloseShieldInputStream.wrap(zip));</span>
                }

                // Process single and double-nested ZIP files

<span class="nc bnc" id="L549" title="All 2 branches missed.">                if (entry.getName().matches(&quot;[0-9]{4}(STA|VBO|OPR|NUM|LIG|PND|WPL).*\\.zip&quot;)</span>
<span class="nc bnc" id="L550" title="All 2 branches missed.">                        || entry.getName().matches(&quot;[0-9]{4}MUT[0-9]{8}-[0-9]{8}\\.zip&quot;)) {</span>
<span class="nc" id="L551">                    ZipArchiveInputStream nestedZip = new ZipArchiveInputStream(zip);</span>
<span class="nc" id="L552">                    bagInfo =</span>
<span class="nc" id="L553">                            loadXmlEntriesFromZipFile(</span>
                                    db,
                                    loadOptions,
                                    dbOptions,
                                    progressReporter,
<span class="nc" id="L558">                                    entry.getName(),</span>
                                    nestedZip,
<span class="nc" id="L560">                                    nestedZip.getNextZipEntry());</span>
                }

<span class="nc bnc" id="L563" title="All 2 branches missed.">                if (entry.getName().matches(&quot;[0-9]{4}Inactief.*\\.zip&quot;)) {</span>
<span class="nc" id="L564">                    ZipArchiveInputStream nestedZip = new ZipArchiveInputStream(zip);</span>
<span class="nc" id="L565">                    ZipArchiveEntry nestedEntry = nestedZip.getNextZipEntry();</span>
<span class="nc bnc" id="L566" title="All 2 branches missed.">                    while (nestedEntry != null) {</span>
<span class="nc bnc" id="L567" title="All 2 branches missed.">                        if (nestedEntry.getName().matches(&quot;[0-9]{4}IA.*\\.zip&quot;)) {</span>
<span class="nc" id="L568">                            ZipArchiveInputStream moreNestedZip =</span>
                                    new ZipArchiveInputStream(nestedZip);
<span class="nc" id="L570">                            bagInfo =</span>
<span class="nc" id="L571">                                    loadXmlEntriesFromZipFile(</span>
                                            db,
                                            loadOptions,
                                            dbOptions,
                                            progressReporter,
<span class="nc" id="L576">                                            nestedEntry.getName(),</span>
                                            moreNestedZip,
<span class="nc" id="L578">                                            moreNestedZip.getNextZipEntry());</span>
                        }
<span class="nc" id="L580">                        nestedEntry = nestedZip.getNextZipEntry();</span>
                    }
                }

<span class="nc bnc" id="L584" title="All 2 branches missed.">                if (bagInfo != null) {</span>
<span class="nc" id="L585">                    gemeenteIdentificaties.addAll(bagInfo.getGemeenteIdentificaties());</span>
                }

                try {
<span class="nc" id="L589">                    entry = zip.getNextZipEntry();</span>
<span class="nc" id="L590">                } catch (IOException e) {</span>
                    // Reading the ZIP from HTTP may give this error, but it is a normal end...
<span class="nc bnc" id="L592" title="All 2 branches missed.">                    if (&quot;Truncated ZIP file&quot;.equals(e.getMessage())) {</span>
<span class="nc" id="L593">                        break;</span>
                    }
<span class="nc" id="L595">                }</span>
            }
        }
<span class="nc bnc" id="L598" title="All 2 branches missed.">        if (bagInfo != null) {</span>
            // Update BagInfo with all seen gemeenteIdentificaties in case we processed a ZIP with
            // multiple gemeentestanden
<span class="nc" id="L601">            bagInfo.setGemeenteIdentificaties(gemeenteIdentificaties);</span>
        }
<span class="nc" id="L603">        return bagInfo;</span>
    }

    private static BAG2ObjectType getObjectTypeFromFilename(String filename) {
<span class="nc" id="L607">        Matcher m =</span>
<span class="nc" id="L608">                Pattern.compile(&quot;.*[0-9]{4}(IA)?(MUT|STA|VBO|OPR|NUM|LIG|PND|WPL).*\\.(xml|zip)&quot;)</span>
<span class="nc" id="L609">                        .matcher(filename);</span>
<span class="nc bnc" id="L610" title="All 2 branches missed.">        if (!m.matches()) {</span>
<span class="nc" id="L611">            throw new IllegalArgumentException(&quot;Invalid BAG2 filename: &quot; + filename);</span>
        }
<span class="nc" id="L613">        String objectTypeName = null;</span>
<span class="nc bnc" id="L614" title="All 9 branches missed.">        switch (m.group(2)) {</span>
            case &quot;MUT&quot;:
<span class="nc" id="L616">                break;</span>
            case &quot;STA&quot;:
<span class="nc" id="L618">                objectTypeName = &quot;Standplaats&quot;;</span>
<span class="nc" id="L619">                break;</span>
            case &quot;OPR&quot;:
<span class="nc" id="L621">                objectTypeName = &quot;OpenbareRuimte&quot;;</span>
<span class="nc" id="L622">                break;</span>
            case &quot;VBO&quot;:
<span class="nc" id="L624">                objectTypeName = &quot;Verblijfsobject&quot;;</span>
<span class="nc" id="L625">                break;</span>
            case &quot;NUM&quot;:
<span class="nc" id="L627">                objectTypeName = &quot;Nummeraanduiding&quot;;</span>
<span class="nc" id="L628">                break;</span>
            case &quot;LIG&quot;:
<span class="nc" id="L630">                objectTypeName = &quot;Ligplaats&quot;;</span>
<span class="nc" id="L631">                break;</span>
            case &quot;PND&quot;:
<span class="nc" id="L633">                objectTypeName = &quot;Pand&quot;;</span>
<span class="nc" id="L634">                break;</span>
            case &quot;WPL&quot;:
<span class="nc" id="L636">                objectTypeName = &quot;Woonplaats&quot;;</span>
                break;
        }
<span class="nc bnc" id="L639" title="All 2 branches missed.">        if (objectTypeName == null) {</span>
<span class="nc" id="L640">            return null;</span>
        } else {
<span class="nc" id="L642">            return BAG2Schema.getInstance().getObjectTypeByName(objectTypeName);</span>
        }
    }

    private void updateMetadata(
            BAG2Database db,
            BAG2LoadOptions loadOptions,
            boolean stand,
            Set&lt;String&gt; gemeenteIdentificaties,
            Date standTechnischeDatum)
            throws Exception {
        // Check if metadata table already exists. For PostgreSQL we can use the metadata table in
        // the public schema
<span class="nc bnc" id="L655" title="All 2 branches missed.">        if (!db.getDialect().tableExists(db.getConnection(), METADATA_TABLE_NAME)) {</span>
            // Create a new metadata table, for Oracle as BAG is in separate schema, for PostgreSQL
            // if loading BAG
            // into a non-brmo RSGB database
<span class="nc" id="L659">            db.createMetadataTable(loadOptions);</span>
        }

<span class="nc" id="L662">        db.setMetadataValue(</span>
<span class="nc" id="L663">                BAG2SchemaMapper.Metadata.LOADER_VERSION, BAG2LoaderUtils.getLoaderVersion());</span>
<span class="nc" id="L664">        SimpleDateFormat df = new SimpleDateFormat(&quot;yyyy-MM-dd&quot;);</span>
<span class="nc bnc" id="L665" title="All 2 branches missed.">        if (stand) {</span>
<span class="nc" id="L666">            db.setMetadataValue(</span>
                    STAND_LOAD_TIME,
<span class="nc" id="L668">                    new SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss&quot;).format(new Date()));</span>
<span class="nc" id="L669">            db.setMetadataValue(STAND_LOAD_TECHNISCHE_DATUM, df.format(standTechnischeDatum));</span>
<span class="nc" id="L670">            db.setMetadataValue(GEMEENTE_CODES, String.join(&quot;,&quot;, gemeenteIdentificaties));</span>
<span class="nc" id="L671">            db.setMetadataValue(FILTER_MUTATIES_WOONPLAATS, &quot;false&quot;);</span>
        }
<span class="nc" id="L673">        db.setMetadataValue(CURRENT_TECHNISCHE_DATUM, df.format(standTechnischeDatum));</span>
<span class="nc" id="L674">    }</span>

    private void clearDuplicatesCache() {
<span class="nc" id="L677">        keysPerObjectType = new HashMap&lt;&gt;();</span>
<span class="nc" id="L678">    }</span>

    private BAG2GMLMutatieGroepStream.BagInfo loadXmlEntriesFromZipFile(
            BAG2Database db,
            BAG2LoadOptions loadOptions,
            BAG2DatabaseOptions databaseOptions,
            BAG2ProgressReporter progressReporter,
            String name,
            ZipArchiveInputStream zip,
            ZipArchiveEntry entry)
            throws Exception {
<span class="nc" id="L689">        BAG2ObjectType objectType = getObjectTypeFromFilename(name);</span>
        // objectType is null for mutaties, which contain mixed object types instead of a single
        // object type with stand
<span class="nc bnc" id="L692" title="All 2 branches missed.">        boolean schemaCreated =</span>
<span class="nc bnc" id="L693" title="All 2 branches missed.">                objectType == null || objectTypesWithSchemaCreated.contains(objectType);</span>
<span class="nc" id="L694">        BAG2ObjectTableWriter writer = db.createObjectTableWriter(loadOptions, databaseOptions);</span>
<span class="nc" id="L695">        writer.setProgressUpdater(progressReporter);</span>
<span class="nc bnc" id="L696" title="All 2 branches missed.">        writer.setCreateSchema(!schemaCreated);</span>
<span class="nc" id="L697">        writer.setCreateKeysAndIndexes(false);</span>
<span class="nc" id="L698">        writer.setKeysPerObjectType(keysPerObjectType);</span>
<span class="nc" id="L699">        writer.start(); // sets InitialLoad to true</span>
<span class="nc bnc" id="L700" title="All 2 branches missed.">        writer.getProgress()</span>
<span class="nc" id="L701">                .setInitialLoad(</span>
                        !schemaCreated); // For a COPY in transaction, table must be created or
        // truncated in it
<span class="nc bnc" id="L704" title="All 2 branches missed.">        if (objectType == null) {</span>
            // When processing mutaties, set batch size to 1 so all mutaties are processed
            // sequentially and can not
            // conflict with deleting and inserting of old/new versions
<span class="nc" id="L708">            writer.setBatchSize(1);</span>
            // Disable multithreading so deletion of previous versions and new inserts are processed
            // sequentially
<span class="nc" id="L711">            writer.setMultithreading(false);</span>
        }
<span class="nc" id="L713">        progressReporter.startNewFile(name);</span>
        try {
<span class="nc bnc" id="L715" title="All 2 branches missed.">            while (entry != null) {</span>
<span class="nc" id="L716">                progressReporter.startNextSplitFile(entry.getName());</span>
<span class="nc" id="L717">                writer.write(CloseShieldInputStream.wrap(zip));</span>
<span class="nc bnc" id="L718" title="All 2 branches missed.">                if (loadOptions.getMaxObjects() != null</span>
<span class="nc bnc" id="L719" title="All 2 branches missed.">                        &amp;&amp; writer.getProgress().getObjectCount() == loadOptions.getMaxObjects()) {</span>
<span class="nc" id="L720">                    break;</span>
                }
<span class="nc" id="L722">                entry = zip.getNextZipEntry();</span>
            }
<span class="nc" id="L724">            writer.complete();</span>

<span class="nc bnc" id="L726" title="All 4 branches missed.">            if (writer.getProgress().getObjectCount() &gt; 0 &amp;&amp; objectType != null) {</span>
<span class="nc" id="L727">                objectTypesWithSchemaCreated.add(objectType);</span>
            }

<span class="nc" id="L730">            return writer.getProgress().getMutatieInfo();</span>
<span class="nc" id="L731">        } catch (Exception e) {</span>
<span class="nc" id="L732">            writer.abortWorkerThread();</span>
<span class="nc" id="L733">            throw e;</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>