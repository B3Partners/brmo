<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="nl"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MaterializedViewRefreshUitvoeren.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">BRMO service</a> &gt; <a href="index.source.html" class="el_package">nl.b3p.brmo.service.scanner</a> &gt; <span class="el_source">MaterializedViewRefreshUitvoeren.java</span></div><h1>MaterializedViewRefreshUitvoeren.java</h1><pre class="source lang-java linenums">/*
 * Copyright (C) 2016 B3Partners B.V.
 */
package nl.b3p.brmo.service.scanner;

import static nl.b3p.brmo.persistence.staging.AutomatischProces.ProcessingStatus.ERROR;
import static nl.b3p.brmo.persistence.staging.AutomatischProces.ProcessingStatus.PROCESSING;
import static nl.b3p.brmo.persistence.staging.AutomatischProces.ProcessingStatus.WAITING;

import nl.b3p.brmo.loader.util.BrmoException;
import nl.b3p.brmo.persistence.staging.MaterializedViewRefresh;
import nl.b3p.brmo.service.util.ConfigUtil;
import nl.b3p.jdbc.util.converter.GeometryJdbcConverter;
import nl.b3p.jdbc.util.converter.GeometryJdbcConverterFactory;

import org.apache.commons.dbutils.DbUtils;
import org.apache.commons.dbutils.QueryRunner;
import org.apache.commons.dbutils.handlers.ColumnListHandler;
import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import org.stripesstuff.stripersist.Stripersist;

import java.sql.Connection;
import java.sql.SQLException;
import java.util.Calendar;
import java.util.Collections;
import java.util.Date;
import java.util.List;

import javax.persistence.Transient;
import javax.sql.DataSource;

/**
 * Proces om materilzed views te verversen.
 *
 * @author mprins
 */
public class MaterializedViewRefreshUitvoeren extends AbstractExecutableProces {

<span class="nc" id="L40">    private static final Log LOG = LogFactory.getLog(MaterializedViewRefreshUitvoeren.class);</span>

    private final MaterializedViewRefresh config;

    @Transient private ProgressUpdateListener listener;

<span class="nc" id="L46">    public MaterializedViewRefreshUitvoeren(MaterializedViewRefresh config) {</span>
<span class="nc" id="L47">        this.config = config;</span>
<span class="nc" id="L48">    }</span>

    @Override
    public void execute() throws BrmoException {
<span class="nc" id="L52">        this.execute(</span>
<span class="nc" id="L53">                new ProgressUpdateListener() {</span>
                    @Override
<span class="nc" id="L55">                    public void total(long total) {}</span>

                    @Override
<span class="nc" id="L58">                    public void progress(long progress) {}</span>

                    @Override
                    public void exception(Throwable t) {
<span class="nc" id="L62">                        LOG.error(t);</span>
<span class="nc" id="L63">                    }</span>

                    @Override
<span class="nc" id="L66">                    public void updateStatus(String status) {}</span>

                    @Override
                    public void addLog(String log) {
<span class="nc" id="L70">                        MaterializedViewRefreshUitvoeren.LOG.info(log);</span>
<span class="nc" id="L71">                    }</span>
                });
<span class="nc" id="L73">    }</span>

    @Override
    public void execute(ProgressUpdateListener listener) {
<span class="nc" id="L77">        this.listener = listener;</span>
<span class="nc" id="L78">        listener.updateStatus(&quot;Initialiseren...&quot;);</span>
<span class="nc" id="L79">        config.setStatus(PROCESSING);</span>
<span class="nc" id="L80">        config.setLastrun(new Date());</span>
<span class="nc" id="L81">        String msg =</span>
<span class="nc" id="L82">                String.format(</span>
                        &quot;De materialized view ververser met ID %d is gestart op %tc.&quot;,
<span class="nc" id="L84">                        config.getId(), Calendar.getInstance());</span>
<span class="nc" id="L85">        this.config.updateSamenvattingEnLogfile(msg);</span>
<span class="nc" id="L86">        listener.updateStatus(msg);</span>
<span class="nc" id="L87">        listener.addLog(msg);</span>
<span class="nc" id="L88">        Stripersist.getEntityManager().merge(config);</span>
<span class="nc" id="L89">        Stripersist.getEntityManager().flush();</span>

<span class="nc" id="L91">        String mview = &quot;onbekend&quot;;</span>
        try {
<span class="nc" id="L93">            mview = this.config.getMView();</span>
<span class="nc" id="L94">            final DataSource ds = ConfigUtil.getDataSourceRsgb();</span>
<span class="nc" id="L95">            final Connection conn = ds.getConnection();</span>
<span class="nc" id="L96">            conn.setAutoCommit(true);</span>
<span class="nc" id="L97">            final GeometryJdbcConverter geomToJdbc =</span>
<span class="nc" id="L98">                    GeometryJdbcConverterFactory.getGeometryJdbcConverter(conn);</span>
            // &quot;update&quot; gebruiken omdat we een oracle stored procedure benaderen
<span class="nc" id="L100">            Object o =</span>
<span class="nc" id="L101">                    new QueryRunner(geomToJdbc.isPmdKnownBroken())</span>
<span class="nc" id="L102">                            .update(conn, geomToJdbc.getMViewRefreshSQL(mview));</span>
<span class="nc" id="L103">            LOG.debug(&quot;mview update resultaat: &quot; + o);</span>
<span class="nc" id="L104">            String resultaat = null;</span>
            // oracle geeft 1 terug als resultaat, postgresql geeft 0 terug...
<span class="nc bnc" id="L106" title="All 2 branches missed.">            if (geomToJdbc.getGeotoolsDBTypeName().equalsIgnoreCase(&quot;oracle&quot;)) {</span>
<span class="nc bnc" id="L107" title="All 2 branches missed.">                resultaat = (o.toString().equals(&quot;1&quot;) ? &quot;OK&quot; : &quot;NOT OK&quot;);</span>
            } else {
<span class="nc bnc" id="L109" title="All 2 branches missed.">                resultaat = (o.toString().equals(&quot;0&quot;) ? &quot;OK&quot; : &quot;NOT OK&quot;);</span>
            }
<span class="nc" id="L111">            DbUtils.closeQuietly(conn);</span>

<span class="nc" id="L113">            msg =</span>
<span class="nc" id="L114">                    String.format(</span>
                            &quot;De materialized view %s is ververst met resultaat %s op %tc&quot;,
<span class="nc" id="L116">                            mview, resultaat, Calendar.getInstance());</span>
<span class="nc" id="L117">            listener.updateStatus(msg);</span>
<span class="nc" id="L118">            listener.addLog(msg);</span>

<span class="nc" id="L120">            config.updateSamenvattingEnLogfile(msg);</span>
<span class="nc" id="L121">            config.setStatus(WAITING);</span>
<span class="nc" id="L122">            config.setLastrun(new Date());</span>
<span class="nc" id="L123">        } catch (BrmoException | SQLException e) {</span>
<span class="nc" id="L124">            config.setStatus(ERROR);</span>
<span class="nc" id="L125">            config.setLastrun(new Date());</span>
<span class="nc" id="L126">            config.setSamenvatting(&quot;Er is een fout opgetreden, details staan in de logs&quot;);</span>
<span class="nc" id="L127">            LOG.error(&quot;Fout tijdens verversen materialized view: &quot; + mview, e);</span>
<span class="nc" id="L128">            listener.exception(e);</span>
        } finally {
<span class="nc" id="L130">            Stripersist.getEntityManager().merge(config);</span>
        }
<span class="nc" id="L132">    }</span>

    /**
     * Zoek materialized views in rsgb schema.
     *
     * @return lijst met materialized views, de lijst kan leeg zijn
     */
    public static List&lt;String&gt; mviews() {
        try {
<span class="nc" id="L141">            final DataSource ds = ConfigUtil.getDataSourceRsgb();</span>
<span class="nc" id="L142">            final Connection conn = ds.getConnection();</span>
<span class="nc" id="L143">            final GeometryJdbcConverter geomToJdbc =</span>
<span class="nc" id="L144">                    GeometryJdbcConverterFactory.getGeometryJdbcConverter(conn);</span>
<span class="nc" id="L145">            List&lt;String&gt; mviews =</span>
<span class="nc" id="L146">                    new QueryRunner(geomToJdbc.isPmdKnownBroken())</span>
<span class="nc" id="L147">                            .query(</span>
                                    conn,
<span class="nc" id="L149">                                    geomToJdbc.getMViewsSQL(),</span>
                                    new ColumnListHandler&lt;String&gt;());
<span class="nc" id="L151">            mviews.sort(String::compareToIgnoreCase);</span>
<span class="nc" id="L152">            DbUtils.closeQuietly(conn);</span>
<span class="nc" id="L153">            return Collections.unmodifiableList(mviews);</span>
<span class="nc" id="L154">        } catch (BrmoException</span>
                | SQLException
                | ClassCastException
                | UnsupportedOperationException
                | IllegalArgumentException ex) {
<span class="nc" id="L159">            LOG.error(&quot;Ophalen materialized views is mislukt.&quot;, ex);</span>
<span class="nc" id="L160">            return Collections.emptyList();</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>