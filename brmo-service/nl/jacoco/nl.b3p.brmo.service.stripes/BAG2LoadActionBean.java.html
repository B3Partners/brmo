<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="nl"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BAG2LoadActionBean.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">BRMO service</a> &gt; <a href="index.source.html" class="el_package">nl.b3p.brmo.service.stripes</a> &gt; <span class="el_source">BAG2LoadActionBean.java</span></div><h1>BAG2LoadActionBean.java</h1><pre class="source lang-java linenums">/*
 * Copyright (C) 2021 B3Partners B.V.
 *
 * SPDX-License-Identifier: MIT
 *
 */

package nl.b3p.brmo.service.stripes;

import net.sourceforge.stripes.action.ActionBean;
import net.sourceforge.stripes.action.ActionBeanContext;
import net.sourceforge.stripes.action.Before;
import net.sourceforge.stripes.action.DefaultHandler;
import net.sourceforge.stripes.action.ForwardResolution;
import net.sourceforge.stripes.action.Resolution;

import nl.b3p.brmo.bag2.loader.BAG2Database;
import nl.b3p.brmo.bag2.loader.BAG2ProgressReporter;
import nl.b3p.brmo.bag2.loader.cli.BAG2DatabaseOptions;
import nl.b3p.brmo.bag2.loader.cli.BAG2LoadOptions;
import nl.b3p.brmo.bag2.loader.cli.BAG2LoaderMain;
import nl.b3p.brmo.bag2.schema.BAG2SchemaMapper;
import nl.b3p.brmo.loader.util.BrmoException;
import nl.b3p.brmo.service.util.ConfigUtil;
import nl.b3p.brmo.sql.dialect.OracleDialect;
import nl.b3p.brmo.sql.dialect.PostGISDialect;
import nl.b3p.jdbc.util.converter.PGConnectionUnwrapper;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import org.stripesstuff.plugin.waitpage.WaitPage;

import java.sql.Connection;
import java.sql.SQLException;
import java.text.SimpleDateFormat;
import java.util.Arrays;
import java.util.Date;

import javax.sql.DataSource;

<span class="nc" id="L41">public class BAG2LoadActionBean implements ActionBean {</span>
<span class="nc" id="L42">    private static final Log LOG = LogFactory.getLog(BAG2LoadActionBean.class);</span>

    private ActionBeanContext context;

    private static final String JSP = &quot;/WEB-INF/jsp/bestand/bag2.jsp&quot;;
    private static final String JSP_LOAD = &quot;/WEB-INF/jsp/bestand/bag2load.jsp&quot;;

<span class="nc" id="L49">    private String files =</span>
            &quot;https://service.pdok.nl/kadaster/adressen/atom/v1_0/downloads/lvbag-extract-nl.zip&quot;;

    private DataSource rsgbbag;
    private Throwable namingException;
<span class="nc" id="L54">    private boolean connectionOk = false;</span>
    private String connectionString;
    private String databaseName;
    private String databaseUserName;
    private String databaseDialect;
    private Exception connectionException;

    private Date standLoadTechnischeDatum;
    private Date currentTechnischeDatum;
    private Date standLoadTime;

    private boolean loading;
    private Date loadStart;
    private boolean loadResult;
    private Exception loadException;
    private String loadingLog;

    // &lt;editor-fold desc=&quot;getters en setters&quot;&gt;
    @Override
    public ActionBeanContext getContext() {
<span class="nc" id="L74">        return context;</span>
    }

    @Override
    public void setContext(ActionBeanContext context) {
<span class="nc" id="L79">        this.context = context;</span>
<span class="nc" id="L80">    }</span>

    public DataSource getRsgbbag() {
<span class="nc" id="L83">        return rsgbbag;</span>
    }

    public void setRsgbbag(DataSource rsgbbag) {
<span class="nc" id="L87">        this.rsgbbag = rsgbbag;</span>
<span class="nc" id="L88">    }</span>

    public Throwable getNamingException() {
<span class="nc" id="L91">        return namingException;</span>
    }

    public void setNamingException(Throwable namingException) {
<span class="nc" id="L95">        this.namingException = namingException;</span>
<span class="nc" id="L96">    }</span>

    public boolean isConnectionOk() {
<span class="nc" id="L99">        return connectionOk;</span>
    }

    public void setConnectionOk(boolean connectionOk) {
<span class="nc" id="L103">        this.connectionOk = connectionOk;</span>
<span class="nc" id="L104">    }</span>

    public String getConnectionString() {
<span class="nc" id="L107">        return connectionString;</span>
    }

    public void setConnectionString(String connectionString) {
<span class="nc" id="L111">        this.connectionString = connectionString;</span>
<span class="nc" id="L112">    }</span>

    public String getDatabaseName() {
<span class="nc" id="L115">        return databaseName;</span>
    }

    public void setDatabaseName(String databaseName) {
<span class="nc" id="L119">        this.databaseName = databaseName;</span>
<span class="nc" id="L120">    }</span>

    public String getDatabaseUserName() {
<span class="nc" id="L123">        return databaseUserName;</span>
    }

    public void setDatabaseUserName(String databaseUserName) {
<span class="nc" id="L127">        this.databaseUserName = databaseUserName;</span>
<span class="nc" id="L128">    }</span>

    public String getDatabaseDialect() {
<span class="nc" id="L131">        return databaseDialect;</span>
    }

    public void setDatabaseDialect(String databaseDialect) {
<span class="nc" id="L135">        this.databaseDialect = databaseDialect;</span>
<span class="nc" id="L136">    }</span>

    public Exception getConnectionException() {
<span class="nc" id="L139">        return connectionException;</span>
    }

    public void setConnectionException(Exception connectionException) {
<span class="nc" id="L143">        this.connectionException = connectionException;</span>
<span class="nc" id="L144">    }</span>

    public Date getStandLoadTechnischeDatum() {
<span class="nc" id="L147">        return standLoadTechnischeDatum;</span>
    }

    public void setStandLoadTechnischeDatum(Date standLoadTechnischeDatum) {
<span class="nc" id="L151">        this.standLoadTechnischeDatum = standLoadTechnischeDatum;</span>
<span class="nc" id="L152">    }</span>

    public Date getCurrentTechnischeDatum() {
<span class="nc" id="L155">        return currentTechnischeDatum;</span>
    }

    public void setCurrentTechnischeDatum(Date currentTechnischeDatum) {
<span class="nc" id="L159">        this.currentTechnischeDatum = currentTechnischeDatum;</span>
<span class="nc" id="L160">    }</span>

    public Date getStandLoadTime() {
<span class="nc" id="L163">        return standLoadTime;</span>
    }

    public void setStandLoadTime(Date standLoadTime) {
<span class="nc" id="L167">        this.standLoadTime = standLoadTime;</span>
<span class="nc" id="L168">    }</span>

    public String getFiles() {
<span class="nc" id="L171">        return files;</span>
    }

    public void setFiles(String files) {
<span class="nc" id="L175">        this.files = files;</span>
<span class="nc" id="L176">    }</span>

    public boolean isLoading() {
<span class="nc" id="L179">        return loading;</span>
    }

    public void setLoading(boolean loading) {
<span class="nc" id="L183">        this.loading = loading;</span>
<span class="nc" id="L184">    }</span>

    public boolean isLoadResult() {
<span class="nc" id="L187">        return loadResult;</span>
    }

    public void setLoadResult(boolean loadResult) {
<span class="nc" id="L191">        this.loadResult = loadResult;</span>
<span class="nc" id="L192">    }</span>

    public String getLoadingLog() {
<span class="nc" id="L195">        return loadingLog;</span>
    }

    public void setLoadingLog(String loadingLog) {
<span class="nc" id="L199">        this.loadingLog = loadingLog;</span>
<span class="nc" id="L200">    }</span>

    public Date getLoadStart() {
<span class="nc" id="L203">        return loadStart;</span>
    }

    public void setLoadStart(Date loadStart) {
<span class="nc" id="L207">        this.loadStart = loadStart;</span>
<span class="nc" id="L208">    }</span>

    public Date getUpdateTime() {
<span class="nc" id="L211">        return new Date();</span>
    }

<span class="nc" id="L214">    public void setUpdateTime(Date updateTime) {}</span>

    public Exception getLoadException() {
<span class="nc" id="L217">        return loadException;</span>
    }

    public void setLoadException(Exception loadException) {
<span class="nc" id="L221">        this.loadException = loadException;</span>
<span class="nc" id="L222">    }</span>
    // &lt;/editor-fold&gt;

    @Before(on = &quot;form&quot;)
    public void checkDatabase() {
        try {
<span class="nc" id="L228">            rsgbbag = ConfigUtil.getDataSourceRsgbBag(false);</span>
<span class="nc" id="L229">        } catch (Exception e) {</span>
<span class="nc bnc" id="L230" title="All 2 branches missed.">            if (e instanceof BrmoException) {</span>
<span class="nc" id="L231">                namingException = e.getCause();</span>
            } else {
<span class="nc" id="L233">                namingException = e;</span>
            }
<span class="nc" id="L235">        }</span>

<span class="nc bnc" id="L237" title="All 2 branches missed.">        if (rsgbbag != null) {</span>
<span class="nc" id="L238">            try (Connection c = rsgbbag.getConnection()) {</span>
<span class="nc" id="L239">                connectionOk = true;</span>
<span class="nc" id="L240">                connectionString = c.getMetaData().getURL();</span>
<span class="nc" id="L241">                databaseName = c.getMetaData().getDatabaseProductVersion();</span>
<span class="nc bnc" id="L242" title="All 2 branches missed.">                if (!databaseName.contains(c.getMetaData().getDatabaseProductName())) {</span>
<span class="nc" id="L243">                    databaseName = c.getMetaData().getDatabaseProductName() + &quot; &quot; + databaseName;</span>
                }
<span class="nc" id="L245">                databaseUserName = c.getMetaData().getUserName();</span>
<span class="nc" id="L246">                BAG2Database bag2Database = new BAG2Database(new BAG2DatabaseOptions(), c);</span>

<span class="nc bnc" id="L248" title="All 2 branches missed.">                if (bag2Database.getDialect() instanceof PostGISDialect) {</span>
<span class="nc" id="L249">                    databaseDialect = &quot;postgis&quot;;</span>
<span class="nc bnc" id="L250" title="All 2 branches missed.">                } else if (bag2Database.getDialect() instanceof OracleDialect) {</span>
<span class="nc" id="L251">                    databaseDialect = &quot;oracle&quot;;</span>
                } else {
<span class="nc" id="L253">                    throw new IllegalArgumentException(&quot;Unknown database dialect&quot;);</span>
                }

                try {
<span class="nc" id="L257">                    String s =</span>
<span class="nc" id="L258">                            bag2Database.getMetadata(</span>
                                    BAG2SchemaMapper.Metadata.STAND_LOAD_TECHNISCHE_DATUM);
<span class="nc bnc" id="L260" title="All 2 branches missed.">                    if (s != null) {</span>
<span class="nc" id="L261">                        SimpleDateFormat df = new SimpleDateFormat(&quot;yyyy-MM-dd&quot;);</span>
<span class="nc" id="L262">                        currentTechnischeDatum =</span>
<span class="nc" id="L263">                                df.parse(</span>
<span class="nc" id="L264">                                        bag2Database.getMetadata(</span>
                                                BAG2SchemaMapper.Metadata
                                                        .CURRENT_TECHNISCHE_DATUM));
<span class="nc" id="L267">                        standLoadTechnischeDatum = df.parse(s);</span>
<span class="nc" id="L268">                        standLoadTime =</span>
                                new SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss&quot;)
<span class="nc" id="L270">                                        .parse(</span>
<span class="nc" id="L271">                                                bag2Database.getMetadata(</span>
                                                        BAG2SchemaMapper.Metadata.STAND_LOAD_TIME));
                    }
<span class="nc" id="L274">                } catch (SQLException e) {</span>
                    // Metadata table does not exist
<span class="nc" id="L276">                }</span>

<span class="nc" id="L278">            } catch (Exception e) {</span>
<span class="nc" id="L279">                connectionOk = false;</span>
<span class="nc" id="L280">                connectionException = e;</span>
<span class="nc" id="L281">            }</span>
        }
<span class="nc" id="L283">    }</span>

    @DefaultHandler
    public Resolution form() {
<span class="nc" id="L287">        return new ForwardResolution(JSP);</span>
    }

    @WaitPage(path = JSP_LOAD, delay = 1000, refresh = 5000)
    public Resolution load() throws Exception {
<span class="nc" id="L292">        loading = true;</span>
<span class="nc" id="L293">        loadStart = new Date();</span>
<span class="nc" id="L294">        try (Connection rsgbBagConnection = ConfigUtil.getDataSourceRsgbBag(true).getConnection()) {</span>
<span class="nc" id="L295">            BAG2DatabaseOptions databaseOptions = new BAG2DatabaseOptions();</span>
            // Niet nodig (rsgbbagConnection wordt gebruikt), maar voor de duidelijkheid
<span class="nc" id="L297">            databaseOptions.setConnectionString(rsgbBagConnection.getMetaData().getURL());</span>
<span class="nc" id="L298">            Connection connection = rsgbBagConnection;</span>
<span class="nc bnc" id="L299" title="All 2 branches missed.">            if (databaseOptions.getConnectionString().startsWith(&quot;jdbc:postgresql:&quot;)) {</span>
                // Voor gebruik van pgCopy is unwrappen van de connectie nodig.
                // Ook al doet PostGISCopyInsertBatch zelf ook een unwrap, de PGConnectionUnwrapper
                // kan ook Tomcat JNDI
                // connection pool unwrapping aan welke niet met een normale Connection.unwrap()
                // werkt.
<span class="nc" id="L305">                connection = (Connection) PGConnectionUnwrapper.unwrap(rsgbBagConnection);</span>
<span class="nc" id="L306">                databaseOptions.setUsePgCopy(true);</span>
            }
<span class="nc" id="L308">            BAG2Database bag2Database =</span>
<span class="nc" id="L309">                    new BAG2Database(databaseOptions, connection) {</span>
                        /** connectie niet sluiten; dat doen we later als we helemaal klaar zijn */
                        @Override
                        public void close() {
<span class="nc" id="L313">                            LOG.debug(</span>
                                    &quot;Had de BAG database connectie kunnen sluiten... maar niet gedaan.&quot;);
<span class="nc" id="L315">                        }</span>
                    };
<span class="nc" id="L317">            BAG2LoaderMain.configureLogging(false);</span>
<span class="nc" id="L318">            BAG2LoaderMain main = new BAG2LoaderMain();</span>
<span class="nc" id="L319">            BAG2LoadOptions loadOptions = new BAG2LoadOptions();</span>
<span class="nc" id="L320">            main.loadFiles(</span>
                    bag2Database,
                    databaseOptions,
                    loadOptions,
                    new BAG2ProgressReporter(),
<span class="nc" id="L325">                    Arrays.stream(files.split(&quot;\n&quot;)).map(String::trim).toArray(String[]::new),</span>
                    null);
<span class="nc" id="L327">            this.loadResult = true;</span>
<span class="nc" id="L328">        } catch (Exception e) {</span>
<span class="nc" id="L329">            this.loadResult = false;</span>
<span class="nc" id="L330">            this.loadException = e;</span>
<span class="nc" id="L331">            LOG.error(&quot;Error loading BAG 2.0&quot;, e);</span>
        } finally {
<span class="nc" id="L333">            this.loading = false;</span>
        }
<span class="nc" id="L335">        return new ForwardResolution(JSP_LOAD);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>