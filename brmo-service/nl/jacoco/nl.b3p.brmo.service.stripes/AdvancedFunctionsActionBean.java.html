<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="nl"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AdvancedFunctionsActionBean.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">BRMO service</a> &gt; <a href="index.source.html" class="el_package">nl.b3p.brmo.service.stripes</a> &gt; <span class="el_source">AdvancedFunctionsActionBean.java</span></div><h1>AdvancedFunctionsActionBean.java</h1><pre class="source lang-java linenums">package nl.b3p.brmo.service.stripes;

import static org.apache.commons.dbutils.DbUtils.closeQuietly;

import net.sourceforge.stripes.action.ActionBean;
import net.sourceforge.stripes.action.ActionBeanContext;
import net.sourceforge.stripes.action.Before;
import net.sourceforge.stripes.action.DefaultHandler;
import net.sourceforge.stripes.action.ForwardResolution;
import net.sourceforge.stripes.action.Resolution;
import net.sourceforge.stripes.action.SimpleMessage;
import net.sourceforge.stripes.action.StrictBinding;
import net.sourceforge.stripes.controller.LifecycleStage;
import net.sourceforge.stripes.validation.Validate;

import nl.b3p.brmo.loader.BrmoFramework;
import nl.b3p.brmo.loader.ProgressUpdateListener;
import nl.b3p.brmo.loader.RsgbProxy;
import nl.b3p.brmo.loader.StagingProxy;
import nl.b3p.brmo.loader.advancedfunctions.AdvancedFunctionProcess;
import nl.b3p.brmo.loader.entity.Bericht;
import nl.b3p.brmo.loader.entity.BrkBericht;
import nl.b3p.brmo.loader.util.BrmoException;
import nl.b3p.brmo.loader.util.StagingRowHandler;
import nl.b3p.brmo.loader.xml.BagXMLReader;
import nl.b3p.brmo.loader.xml.BrkSnapshotXMLReader;
import nl.b3p.brmo.loader.xml.WozXMLReader;
import nl.b3p.brmo.service.util.ConfigUtil;
import nl.b3p.jdbc.util.converter.GeometryJdbcConverter;
import nl.b3p.jdbc.util.converter.GeometryJdbcConverterFactory;

import org.apache.commons.dbutils.QueryRunner;
import org.apache.commons.dbutils.ResultSetHandler;
import org.apache.commons.dbutils.RowProcessor;
import org.apache.commons.dbutils.handlers.ScalarHandler;
import org.apache.commons.io.FileUtils;
import org.apache.commons.lang3.exception.ExceptionUtils;
import org.apache.commons.lang3.mutable.MutableInt;
import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import org.stripesstuff.plugin.waitpage.WaitPage;

import java.io.ByteArrayInputStream;
import java.io.File;
import java.io.FileOutputStream;
import java.io.InputStream;
import java.io.PrintWriter;
import java.io.StringWriter;
import java.math.BigDecimal;
import java.nio.charset.StandardCharsets;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Timestamp;
import java.text.SimpleDateFormat;
import java.util.Arrays;
import java.util.Calendar;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.zip.ZipEntry;
import java.util.zip.ZipException;
import java.util.zip.ZipOutputStream;

import javax.sql.DataSource;

/**
 * @author Chris van Lith
 * @author mprins
 */
@StrictBinding
<span class="nc" id="L74">public class AdvancedFunctionsActionBean implements ActionBean, ProgressUpdateListener {</span>

<span class="nc" id="L76">    private static final Log LOG = LogFactory.getLog(AdvancedFunctionsActionBean.class);</span>

    private static final String JSP = &quot;/WEB-INF/jsp/transform/advancedfunctions.jsp&quot;;
    private static final String JSP_PROGRESS =
            &quot;/WEB-INF/jsp/transform/advancedfunctionsprogress.jsp&quot;;

    private static final String MUTOPEN =
            &quot;&lt;?xml version=\&quot;1.0\&quot;?&gt;&lt;Mutatie:Mutatie &quot;
                    + &quot;xmlns:Mutatie=\&quot;http://www.kadaster.nl/schemas/brk-levering/product-mutatie/v20120901\&quot; &quot;
                    + &quot;xmlns:KadastraalObjectRef=\&quot;http://www.kadaster.nl/schemas/brk-levering/snapshot/imkad-kadastraalobject-ref/v20120201\&quot; &quot;
                    + &quot;xmlns:xlink=\&quot;http://www.w3.org/1999/xlink\&quot;&gt;&quot;
                    + &quot;&lt;Mutatie:BRKDatum&gt;%s&lt;/Mutatie:BRKDatum&gt;&quot;
                    + &quot;&lt;Mutatie:volgnummerKadastraalObjectDatum&gt;%s&lt;/Mutatie:volgnummerKadastraalObjectDatum&gt;&quot;
                    + &quot;&lt;Mutatie:kadastraalObject&gt;&lt;Mutatie:AanduidingKadastraalObject&gt;&lt;Mutatie:kadastraalObject&gt;&quot;
                    + &quot;&lt;KadastraalObjectRef:PerceelRef xlink:href=\&quot;%s\&quot;/&gt;&quot;
                    + &quot;&lt;/Mutatie:kadastraalObject&gt;&lt;/Mutatie:AanduidingKadastraalObject&gt;&lt;/Mutatie:kadastraalObject&gt;&quot;
                    + &quot;&lt;Mutatie:wordt&gt;&quot;;
    private static final String MUTCLOSE = &quot;&lt;/Mutatie:wordt&gt;&lt;/Mutatie:Mutatie&gt;&quot;;

    private ActionBeanContext context;

    private List&lt;AdvancedFunctionProcess&gt; advancedFunctionProcesses;

    @Validate(required = true, on = &quot;perform&quot;)
    private String advancedFunctionProcessName;

    private double progress;
    private long total;
    private long processed;
    private boolean complete;
    private Date start;
    private Date update;
    private String exceptionStacktrace;

<span class="nc" id="L110">    private final String BRK_VERWIJDEREN_NOGMAALS_UITVOEREN =</span>
            &quot;Herhaal transformatie BRK verwijderberichten, oplossen achtergebleven 'kad_onrrnd_zk' records&quot;;
<span class="nc" id="L112">    private final String NHR_FIX_TYPERING = &quot;Fix 'typering' en 'clazz' van nHR persoon&quot;;</span>
<span class="nc" id="L113">    private final String NHR_ARCHIVING =</span>
            &quot;Opschonen en archiveren van nHR berichten met status RSGB_OK, ouder dan 3 maanden&quot;;
<span class="nc" id="L115">    private final String NHR_REMOVAL = &quot;Verwijderen van nHR berichten met status ARCHIVE&quot;;</span>
<span class="nc" id="L116">    private final String NHR_OPNIEUW_VERWERKEN = &quot;Opnieuw verwerken van nHR berichten&quot;;</span>
<span class="nc" id="L117">    private final String BRK_HERSTEL_BESTANDSNAAM =</span>
            &quot;Vul de 'herstelde bestandsnaam' van BRK laadprocessen&quot;;
<span class="nc" id="L119">    private final String WOZ_OPNIEUW_VERWERKING = &quot;Originele WOZ berichten opnieuw verwerken&quot;;</span>

    // &lt;editor-fold defaultstate=&quot;collapsed&quot; desc=&quot;getters en setters&quot;&gt;
    @Override
    public ActionBeanContext getContext() {
<span class="nc" id="L124">        return context;</span>
    }

    @Override
    public void setContext(ActionBeanContext context) {
<span class="nc" id="L129">        this.context = context;</span>
<span class="nc" id="L130">    }</span>

    public double getProgress() {
<span class="nc" id="L133">        return progress;</span>
    }

    public void setProgress(double progress) {
<span class="nc" id="L137">        this.progress = progress;</span>
<span class="nc" id="L138">    }</span>

    public long getTotal() {
<span class="nc" id="L141">        return total;</span>
    }

    public void setTotal(long total) {
<span class="nc" id="L145">        this.total = total;</span>
<span class="nc" id="L146">    }</span>

    public long getProcessed() {
<span class="nc" id="L149">        return processed;</span>
    }

    public void setProcessed(long processed) {
<span class="nc" id="L153">        this.processed = processed;</span>
<span class="nc" id="L154">    }</span>

    public boolean isComplete() {
<span class="nc" id="L157">        return complete;</span>
    }

    public void setComplete(boolean complete) {
<span class="nc" id="L161">        this.complete = complete;</span>
<span class="nc" id="L162">    }</span>

    public Date getStart() {
<span class="nc" id="L165">        return start;</span>
    }

    public void setStart(Date start) {
<span class="nc" id="L169">        this.start = start;</span>
<span class="nc" id="L170">    }</span>

    public Date getUpdate() {
<span class="nc" id="L173">        return update;</span>
    }

    public void setUpdate(Date update) {
<span class="nc" id="L177">        this.update = update;</span>
<span class="nc" id="L178">    }</span>

    public String getExceptionStacktrace() {
<span class="nc" id="L181">        return exceptionStacktrace;</span>
    }

    public void setExceptionStacktrace(String exceptionStacktrace) {
<span class="nc" id="L185">        this.exceptionStacktrace = exceptionStacktrace;</span>
<span class="nc" id="L186">    }</span>

    @Override
    public void total(long total) {
<span class="nc" id="L190">        this.total = total;</span>
<span class="nc" id="L191">    }</span>

    @Override
    public void progress(long progress) {
<span class="nc" id="L195">        this.processed = progress;</span>
<span class="nc bnc" id="L196" title="All 2 branches missed.">        if (this.total != 0) {</span>
<span class="nc" id="L197">            this.progress = (100.0 / this.total) * this.processed;</span>
        }
<span class="nc" id="L199">        this.update = new Date();</span>
<span class="nc" id="L200">    }</span>

    @Override
    public void exception(Throwable t) {
<span class="nc" id="L204">        StringWriter sw = new StringWriter();</span>
<span class="nc" id="L205">        t.printStackTrace(new PrintWriter(sw));</span>
<span class="nc" id="L206">        this.exceptionStacktrace = sw.toString();</span>
<span class="nc" id="L207">    }</span>

    public List&lt;AdvancedFunctionProcess&gt; getAdvancedFunctionProcesses() {
<span class="nc" id="L210">        return advancedFunctionProcesses;</span>
    }

    public void setAdvancedFunctionProcesses(
            List&lt;AdvancedFunctionProcess&gt; advancedFunctionProcesses) {
<span class="nc" id="L215">        this.advancedFunctionProcesses = advancedFunctionProcesses;</span>
<span class="nc" id="L216">    }</span>

    public String getAdvancedFunctionProcessName() {
<span class="nc" id="L219">        return advancedFunctionProcessName;</span>
    }

    public void setAdvancedFunctionProcessName(String advancedFunctionProcessName) {
<span class="nc" id="L223">        this.advancedFunctionProcessName = advancedFunctionProcessName;</span>
<span class="nc" id="L224">    }</span>
    // &lt;/editor-fold&gt;

    @Before(stages = LifecycleStage.BindingAndValidation)
    public void populateAdvancedFunctionProcesses() {
<span class="nc" id="L229">        String brkExportDir =</span>
<span class="nc" id="L230">                this.getContext().getServletContext().getInitParameter(&quot;exportDir.brk&quot;);</span>
<span class="nc" id="L231">        LOG.warn(&quot;Instellen BRK export directory op niet-default waarde: &quot; + brkExportDir);</span>

        // XXX move to configuration file
        // bij een nieuw proces ook de wiki bijwerken:
        // https://github.com/B3Partners/brmo/wiki/Geavanceerde-functies
<span class="nc" id="L236">        advancedFunctionProcesses =</span>
<span class="nc" id="L237">                Arrays.asList(</span>
                        new AdvancedFunctionProcess(
                                &quot;Exporteren BRK mutaties&quot;,
                                BrmoFramework.BR_BRK,
<span class="nc bnc" id="L241" title="All 2 branches missed.">                                brkExportDir == null ? &quot;/tmp/brkmutaties&quot; : brkExportDir),</span>
                        new AdvancedFunctionProcess(
                                &quot;Repareren BRK mutaties met status STAGING_NOK&quot;,
                                BrmoFramework.BR_BRK,
<span class="nc" id="L245">                                Bericht.STATUS.STAGING_NOK.toString()),</span>
                        new AdvancedFunctionProcess(
                                &quot;Repareren BAG mutaties met status STAGING_NOK&quot;,
                                BrmoFramework.BR_BAG,
<span class="nc" id="L249">                                Bericht.STATUS.STAGING_NOK.toString()),</span>
                        new AdvancedFunctionProcess(
                                &quot;Opschonen en archiveren van BRK berichten met status RSGB_OK, ouder dan 3 maanden&quot;,
                                BrmoFramework.BR_BRK,
<span class="nc" id="L253">                                Bericht.STATUS.RSGB_OK.toString()),</span>
                        new AdvancedFunctionProcess(
                                &quot;Opschonen en archiveren van BAG berichten met status RSGB_OK, ouder dan 3 maanden&quot;,
                                BrmoFramework.BR_BAG,
<span class="nc" id="L257">                                Bericht.STATUS.RSGB_OK.toString()),</span>
                        new AdvancedFunctionProcess(
                                NHR_ARCHIVING,
                                BrmoFramework.BR_NHR,
<span class="nc" id="L261">                                Bericht.STATUS.RSGB_OK.toString()),</span>
                        new AdvancedFunctionProcess(
                                &quot;Verwijderen van BRK berichten met status ARCHIVE&quot;,
                                BrmoFramework.BR_BRK,
<span class="nc" id="L265">                                Bericht.STATUS.ARCHIVE.toString()),</span>
                        new AdvancedFunctionProcess(
                                &quot;Verwijderen van BAG berichten met status ARCHIVE&quot;,
                                BrmoFramework.BR_BAG,
<span class="nc" id="L269">                                Bericht.STATUS.ARCHIVE.toString()),</span>
                        new AdvancedFunctionProcess(
                                NHR_REMOVAL,
                                BrmoFramework.BR_NHR,
<span class="nc" id="L273">                                Bericht.STATUS.ARCHIVE.toString()),</span>
                        new AdvancedFunctionProcess(
                                BRK_VERWIJDEREN_NOGMAALS_UITVOEREN,
                                BrmoFramework.BR_BRK,
<span class="nc" id="L277">                                Bericht.STATUS.RSGB_OK.toString()),</span>
                        new AdvancedFunctionProcess(NHR_FIX_TYPERING, BrmoFramework.BR_NHR, null),
                        new AdvancedFunctionProcess(
                                BRK_HERSTEL_BESTANDSNAAM, BrmoFramework.BR_BRK, &quot;0&quot;),
                        new AdvancedFunctionProcess(
                                NHR_OPNIEUW_VERWERKEN, BrmoFramework.BR_NHR, null),
                        new AdvancedFunctionProcess(
                                WOZ_OPNIEUW_VERWERKING, BrmoFramework.BR_WOZ, null));
<span class="nc" id="L285">    }</span>

    @DefaultHandler
    public Resolution form() {
<span class="nc bnc" id="L289" title="All 2 branches missed.">        return new ForwardResolution(complete ? JSP_PROGRESS : JSP);</span>
    }

    @WaitPage(path = JSP_PROGRESS, delay = 1000, refresh = 1000)
    public Resolution perform() {
<span class="nc" id="L294">        AdvancedFunctionProcess process = null;</span>

<span class="nc bnc" id="L296" title="All 2 branches missed.">        for (AdvancedFunctionProcess p : advancedFunctionProcesses) {</span>
<span class="nc bnc" id="L297" title="All 2 branches missed.">            if (p.getName().equals(advancedFunctionProcessName)) {</span>
<span class="nc" id="L298">                process = p;</span>
<span class="nc" id="L299">                break;</span>
            }
<span class="nc" id="L301">        }</span>
<span class="nc bnc" id="L302" title="All 2 branches missed.">        if (process == null) {</span>
<span class="nc" id="L303">            getContext().getMessages().add(new SimpleMessage(&quot;Ongeldig proces&quot;));</span>
<span class="nc" id="L304">            return new ForwardResolution(JSP);</span>
        }

<span class="nc" id="L307">        start = new Date();</span>
<span class="nc" id="L308">        LOG.info(&quot;Start process: &quot; + process.getName());</span>
<span class="nc" id="L309">        processed = 0;</span>

        // Get berichten
        try {
<span class="nc bnc" id="L313" title="All 15 branches missed.">            switch (process.getName()) {</span>
                case &quot;Exporteren BRK mutaties&quot;:
<span class="nc" id="L315">                    exportBRKMutatieBerichten(process.getConfig());</span>
<span class="nc" id="L316">                    break;</span>
                case &quot;Repareren BRK mutaties met status STAGING_NOK&quot;:
<span class="nc" id="L318">                    repairBRKMutatieBerichten(process.getConfig());</span>
<span class="nc" id="L319">                    break;</span>
                case &quot;Repareren BAG mutaties met status STAGING_NOK&quot;:
<span class="nc" id="L321">                    repairBAGMutatieBerichten(process.getConfig());</span>
<span class="nc" id="L322">                    break;</span>
                case &quot;Opschonen en archiveren van BRK berichten met status RSGB_OK, ouder dan 3 maanden&quot;:
<span class="nc" id="L324">                    cleanupBerichten(process.getConfig(), &quot;brk&quot;);</span>
<span class="nc" id="L325">                    break;</span>
                case &quot;Opschonen en archiveren van BAG berichten met status RSGB_OK, ouder dan 3 maanden&quot;:
<span class="nc" id="L327">                    cleanupBerichten(process.getConfig(), &quot;bag&quot;);</span>
<span class="nc" id="L328">                    break;</span>
                case NHR_ARCHIVING:
<span class="nc" id="L330">                    cleanupBerichten(process.getConfig(), BrmoFramework.BR_NHR);</span>
<span class="nc" id="L331">                    break;</span>
                case &quot;Verwijderen van BRK berichten met status ARCHIVE&quot;:
<span class="nc" id="L333">                    deleteBerichten(process.getConfig(), &quot;brk&quot;);</span>
<span class="nc" id="L334">                    break;</span>
                case &quot;Verwijderen van BAG berichten met status ARCHIVE&quot;:
<span class="nc" id="L336">                    deleteBerichten(process.getConfig(), &quot;bag&quot;);</span>
<span class="nc" id="L337">                    break;</span>
                case NHR_REMOVAL:
<span class="nc" id="L339">                    deleteBerichten(process.getConfig(), BrmoFramework.BR_NHR);</span>
<span class="nc" id="L340">                    break;</span>
                case BRK_VERWIJDEREN_NOGMAALS_UITVOEREN:
<span class="nc" id="L342">                    replayBRKVerwijderBerichten(process.getSoort(), process.getConfig());</span>
<span class="nc" id="L343">                    break;</span>
                case NHR_OPNIEUW_VERWERKEN:
<span class="nc" id="L345">                    replayNHRVerwerking(process.getSoort(), process.getConfig());</span>
<span class="nc" id="L346">                    break;</span>
                case NHR_FIX_TYPERING:
<span class="nc" id="L348">                    fixNHRTypering(process.getSoort(), process.getConfig());</span>
<span class="nc" id="L349">                    break;</span>
                case BRK_HERSTEL_BESTANDSNAAM:
<span class="nc" id="L351">                    fillbestandsNaamHersteld(process.getSoort(), process.getConfig());</span>
<span class="nc" id="L352">                    break;</span>
                case WOZ_OPNIEUW_VERWERKING:
<span class="nc" id="L354">                    replayWOZVerwerking();</span>
                    break;
            }

<span class="nc bnc" id="L358" title="All 2 branches missed.">            if (this.exceptionStacktrace == null) {</span>
<span class="nc" id="L359">                getContext().getMessages().add(new SimpleMessage(&quot;Geavanceerde functie afgerond.&quot;));</span>
            }
<span class="nc" id="L361">        } catch (Throwable t) {</span>
<span class="nc" id="L362">            LOG.error(&quot;Fout bij uitvoeren geavanceerde functie&quot;, t);</span>
<span class="nc" id="L363">            String m = &quot;Fout bij uitvoeren geavanceerde functie: &quot; + ExceptionUtils.getMessage(t);</span>
<span class="nc bnc" id="L364" title="All 2 branches missed.">            if (t.getCause() != null) {</span>
<span class="nc" id="L365">                m += &quot;, oorzaak: &quot; + ExceptionUtils.getRootCauseMessage(t);</span>
            }
<span class="nc" id="L367">            getContext().getMessages().add(new SimpleMessage(m));</span>
        } finally {
<span class="nc" id="L369">            complete = true;</span>
        }
<span class="nc" id="L371">        return new ForwardResolution(JSP_PROGRESS);</span>
    }

    private void replayWOZVerwerking() throws Exception {
<span class="nc" id="L375">        final DataSource dataSourceStaging = ConfigUtil.getDataSourceStaging();</span>
<span class="nc" id="L376">        StagingProxy stagingProxy = new StagingProxy(dataSourceStaging);</span>

<span class="nc" id="L378">        try (Connection conn = dataSourceStaging.getConnection()) {</span>
<span class="nc" id="L379">            final GeometryJdbcConverter geomToJdbc =</span>
<span class="nc" id="L380">                    GeometryJdbcConverterFactory.getGeometryJdbcConverter(conn);</span>

<span class="nc" id="L382">            Number o =</span>
<span class="nc" id="L383">                    new QueryRunner(geomToJdbc.isPmdKnownBroken())</span>
<span class="nc" id="L384">                            .query(</span>
                                    conn,
                                    &quot;SELECT count(*) FROM eerder_geladen_woz&quot;,
                                    new ScalarHandler&lt;&gt;());
<span class="nc" id="L388">            long count = o.longValue();</span>

<span class="nc" id="L390">            this.total(count);</span>
<span class="nc" id="L391">            LOG.info(&quot;Aantal te verwerken WOZ berichten: &quot; + count);</span>

<span class="nc" id="L393">            int offset = 0;</span>
<span class="nc" id="L394">            int batch = 10000;</span>
<span class="nc" id="L395">            final String selectSql =</span>
                    &quot;SELECT id, br_orgineel_xml, laadprocesid, datum FROM eerder_geladen_woz&quot;;
            Bericht b;
<span class="nc bnc" id="L398" title="All 2 branches missed.">            while (offset &lt; count) {</span>
<span class="nc" id="L399">                LOG.info(</span>
                        &quot;Ophalen WOZ berichten vanaf offset: &quot;
                                + offset
                                + &quot; tot: &quot;
                                + (offset + batch)
                                + &quot; van: &quot;
                                + count);
<span class="nc" id="L406">                PreparedStatement ps =</span>
<span class="nc" id="L407">                        conn.prepareStatement(</span>
<span class="nc" id="L408">                                geomToJdbc.buildPaginationSql(selectSql, offset, batch));</span>
<span class="nc" id="L409">                ResultSet rs = ps.executeQuery();</span>
<span class="nc bnc" id="L410" title="All 2 branches missed.">                while (rs.next()) {</span>
<span class="nc" id="L411">                    LOG.trace(</span>
                            &quot;Verwerken WOZ bericht voor laadprocesid: &quot;
<span class="nc" id="L413">                                    + rs.getLong(&quot;laadprocesid&quot;)</span>
                                    + &quot; met id: &quot;
<span class="nc" id="L415">                                    + rs.getLong(&quot;id&quot;));</span>
<span class="nc" id="L416">                    InputStream origineelXMLInputStream =</span>
                            new ByteArrayInputStream(
<span class="nc" id="L418">                                    rs.getString(&quot;br_orgineel_xml&quot;)</span>
<span class="nc" id="L419">                                            .getBytes(StandardCharsets.UTF_8));</span>
<span class="nc" id="L420">                    WozXMLReader reader =</span>
                            new WozXMLReader(
                                    origineelXMLInputStream, /*rs.getDate(&quot;datum&quot;)*/
                                    null,
                                    stagingProxy);

<span class="nc bnc" id="L426" title="All 2 branches missed.">                    while (reader.hasNext()) {</span>
<span class="nc" id="L427">                        b = reader.next();</span>
<span class="nc" id="L428">                        b.setLaadProcesId(rs.getLong(&quot;laadprocesid&quot;));</span>
<span class="nc" id="L429">                        b.setStatus(Bericht.STATUS.STAGING_OK);</span>
<span class="nc" id="L430">                        b.setStatusDatum(new Date());</span>
<span class="nc" id="L431">                        b.setSoort(BrmoFramework.BR_WOZ);</span>
<span class="nc" id="L432">                        b.setOpmerking(&quot;Herstel van eerder geladen WOZ bericht&quot;);</span>
<span class="nc bnc" id="L433" title="All 2 branches missed.">                        if (null == b.getObjectRef()) {</span>
<span class="nc" id="L434">                            b.setStatus(Bericht.STATUS.STAGING_NOK);</span>
<span class="nc" id="L435">                            b.setOpmerking(Bericht.GEEN_OBJECT_REF_MSG);</span>
                        }

                        Bericht existingBericht;
<span class="nc bnc" id="L439" title="All 2 branches missed.">                        if (b.getVolgordeNummer() == 1) {</span>
<span class="nc" id="L440">                            existingBericht = stagingProxy.getBerichtById(rs.getLong(&quot;id&quot;));</span>
                        } else {
<span class="nc" id="L442">                            existingBericht = stagingProxy.getExistingBericht(b);</span>
                        }

<span class="nc bnc" id="L445" title="All 2 branches missed.">                        if (existingBericht == null) {</span>
<span class="nc" id="L446">                            stagingProxy.writeBericht(b);</span>
                        } else {
<span class="nc" id="L448">                            b.setId(existingBericht.getId());</span>
<span class="nc" id="L449">                            stagingProxy.updateBericht(b);</span>
                        }
<span class="nc" id="L451">                    }</span>
<span class="nc" id="L452">                    processed++;</span>
<span class="nc" id="L453">                }</span>
<span class="nc" id="L454">                closeQuietly(rs);</span>
<span class="nc" id="L455">                closeQuietly(ps);</span>
<span class="nc" id="L456">                offset += batch;</span>
<span class="nc" id="L457">                progress(processed);</span>
<span class="nc" id="L458">            }</span>
        } finally {
<span class="nc" id="L460">            stagingProxy.closeStagingProxy();</span>
<span class="nc" id="L461">            LOG.info(&quot;Originele WOZ berichten opnieuw verwerken afgerond.&quot;);</span>
        }
<span class="nc" id="L463">    }</span>

    public void repairBRKMutatieBerichten(String config) throws Exception {
<span class="nc" id="L466">        int offset = 0;</span>
<span class="nc" id="L467">        int batch = 1000;</span>
<span class="nc" id="L468">        final MutableInt processed = new MutableInt(0);</span>
<span class="nc" id="L469">        final DataSource dataSourceStaging = ConfigUtil.getDataSourceStaging();</span>
<span class="nc" id="L470">        final Connection conn = dataSourceStaging.getConnection();</span>
<span class="nc" id="L471">        final GeometryJdbcConverter geomToJdbc =</span>
<span class="nc" id="L472">                GeometryJdbcConverterFactory.getGeometryJdbcConverter(conn);</span>
<span class="nc" id="L473">        final RowProcessor processor = new StagingRowHandler();</span>

        do {
<span class="nc" id="L476">            LOG.debug(</span>
<span class="nc" id="L477">                    String.format(</span>
                            &quot;Ophalen mutatieberichten batch met offset %d, limit %d&quot;,
<span class="nc" id="L479">                            offset, batch));</span>
<span class="nc" id="L480">            String sql =</span>
                    &quot;select * from &quot;
                            + BrmoFramework.BERICHT_TABLE
                            + &quot; where volgordenummer &gt;= 0 &quot;
                            + &quot; and soort='brk' &quot;
                            + &quot; and status='&quot;
                            + config
                            + &quot;'&quot;
                            + &quot; order by id &quot;;
<span class="nc" id="L489">            sql = geomToJdbc.buildPaginationSql(sql, offset, batch);</span>
<span class="nc" id="L490">            LOG.debug(&quot;SQL voor ophalen berichten batch: &quot; + sql);</span>

<span class="nc" id="L492">            processed.setValue(0);</span>
<span class="nc" id="L493">            Exception e =</span>
<span class="nc" id="L494">                    new QueryRunner(geomToJdbc.isPmdKnownBroken())</span>
<span class="nc" id="L495">                            .query(</span>
                                    conn,
                                    sql,
                                    rs -&gt; {
<span class="nc bnc" id="L499" title="All 2 branches missed.">                                        while (rs.next()) {</span>
                                            try {
<span class="nc" id="L501">                                                Bericht bericht =</span>
<span class="nc" id="L502">                                                        processor.toBean(rs, Bericht.class);</span>
<span class="nc" id="L503">                                                StringBuilder message = new StringBuilder();</span>
<span class="nc bnc" id="L504" title="All 2 branches missed.">                                                if (bericht.getBrOrgineelXml() != null</span>
<span class="nc bnc" id="L505" title="All 2 branches missed.">                                                        &amp;&amp; !bericht.getBrOrgineelXml().isEmpty()) {</span>
<span class="nc" id="L506">                                                    message.append(bericht.getBrOrgineelXml());</span>
                                                } else {
<span class="nc" id="L508">                                                    SimpleDateFormat dateFormat =</span>
                                                            new SimpleDateFormat(&quot;yyyy-MM-dd&quot;);
<span class="nc" id="L510">                                                    message.append(</span>
<span class="nc" id="L511">                                                            String.format(</span>
                                                                    MUTOPEN,
<span class="nc" id="L513">                                                                    dateFormat.format(</span>
<span class="nc" id="L514">                                                                            bericht.getDatum()),</span>
<span class="nc" id="L515">                                                                    bericht.getVolgordeNummer(),</span>
<span class="nc" id="L516">                                                                    bericht.getObjectRef()));</span>
<span class="nc" id="L517">                                                    if (bericht.getBrXml()</span>
<span class="nc bnc" id="L518" title="All 2 branches missed.">                                                            .startsWith(&quot;&lt;?xml version=\&quot;1.0\&quot;&quot;)) {</span>
                                                        // strip &lt;?xml version=&quot;1.0&quot;?&gt;
<span class="nc" id="L520">                                                        message.append(</span>
<span class="nc" id="L521">                                                                bericht.getBrXml().substring(21));</span>
                                                    } else {
<span class="nc" id="L523">                                                        message.append(bericht.getBrXml());</span>
                                                    }
<span class="nc" id="L525">                                                    message.append(MUTCLOSE);</span>
                                                }

<span class="nc" id="L528">                                                BrkSnapshotXMLReader reader =</span>
                                                        new BrkSnapshotXMLReader(
                                                                new ByteArrayInputStream(
<span class="nc" id="L531">                                                                        message.toString()</span>
<span class="nc" id="L532">                                                                                .getBytes(</span>
                                                                                        StandardCharsets
                                                                                                .UTF_8)));
<span class="nc" id="L535">                                                Bericht brk = reader.next();</span>
<span class="nc bnc" id="L536" title="All 2 branches missed.">                                                if (brk != null</span>
<span class="nc bnc" id="L537" title="All 2 branches missed.">                                                        &amp;&amp; brk.getDatum() != null</span>
<span class="nc bnc" id="L538" title="All 2 branches missed.">                                                        &amp;&amp; brk.getObjectRef() != null</span>
<span class="nc bnc" id="L539" title="All 2 branches missed.">                                                        &amp;&amp; brk.getVolgordeNummer() != null) {</span>
<span class="nc" id="L540">                                                    bericht.setDatum(brk.getDatum());</span>
<span class="nc" id="L541">                                                    bericht.setObjectRef(brk.getObjectRef());</span>
<span class="nc" id="L542">                                                    bericht.setVolgordeNummer(</span>
<span class="nc" id="L543">                                                            brk.getVolgordeNummer());</span>
                                                }
<span class="nc bnc" id="L545" title="All 2 branches missed.">                                                if (brk != null</span>
<span class="nc bnc" id="L546" title="All 2 branches missed.">                                                        &amp;&amp; brk.getDatum() != null</span>
<span class="nc bnc" id="L547" title="All 2 branches missed.">                                                        &amp;&amp; brk.getObjectRef() != null</span>
<span class="nc bnc" id="L548" title="All 2 branches missed.">                                                        &amp;&amp; brk.getVolgordeNummer() != null) {</span>
<span class="nc bnc" id="L549" title="All 2 branches missed.">                                                    if (bericht.getBrOrgineelXml() != null</span>
<span class="nc" id="L550">                                                            &amp;&amp; !bericht.getBrOrgineelXml()</span>
<span class="nc bnc" id="L551" title="All 2 branches missed.">                                                                    .isEmpty()) {</span>
<span class="nc" id="L552">                                                        new QueryRunner(</span>
                                                                        geomToJdbc
<span class="nc" id="L554">                                                                                .isPmdKnownBroken())</span>
<span class="nc" id="L555">                                                                .update(</span>
                                                                        conn,
                                                                        &quot;update &quot;
                                                                                + BrmoFramework
                                                                                        .BERICHT_TABLE
                                                                                + &quot; set object_ref = ?, datum = ?, volgordenummer = ? where id = ?&quot;,
<span class="nc" id="L561">                                                                        bericht.getObjectRef(),</span>
                                                                        new Timestamp(
<span class="nc" id="L563">                                                                                bericht.getDatum()</span>
<span class="nc" id="L564">                                                                                        .getTime()),</span>
<span class="nc" id="L565">                                                                        bericht.getVolgordeNummer(),</span>
<span class="nc" id="L566">                                                                        bericht.getId());</span>
                                                    } else {
<span class="nc" id="L568">                                                        new QueryRunner(</span>
                                                                        geomToJdbc
<span class="nc" id="L570">                                                                                .isPmdKnownBroken())</span>
<span class="nc" id="L571">                                                                .update(</span>
                                                                        conn,
                                                                        &quot;update &quot;
                                                                                + BrmoFramework
                                                                                        .BERICHT_TABLE
                                                                                + &quot; set object_ref = ?, datum = ?, volgordenummer = ?, br_orgineel_xml = ? where id = ?&quot;,
<span class="nc" id="L577">                                                                        bericht.getObjectRef(),</span>
                                                                        new Timestamp(
<span class="nc" id="L579">                                                                                bericht.getDatum()</span>
<span class="nc" id="L580">                                                                                        .getTime()),</span>
<span class="nc" id="L581">                                                                        bericht.getVolgordeNummer(),</span>
<span class="nc" id="L582">                                                                        message.toString(),</span>
<span class="nc" id="L583">                                                                        bericht.getId());</span>
                                                    }
                                                }

<span class="nc" id="L587">                                            } catch (Exception e1) {</span>
<span class="nc" id="L588">                                                return e1;</span>
<span class="nc" id="L589">                                            }</span>
<span class="nc" id="L590">                                            processed.increment();</span>
                                        }
<span class="nc" id="L592">                                        return null;</span>
                                    });
<span class="nc" id="L594">            offset += processed.intValue();</span>

<span class="nc" id="L596">            progress(offset);</span>

            // If handler threw exception processing row, rethrow it
<span class="nc bnc" id="L599" title="All 2 branches missed.">            if (e != null) {</span>
<span class="nc" id="L600">                closeQuietly(conn);</span>
<span class="nc" id="L601">                throw e;</span>
            }
<span class="nc bnc" id="L603" title="All 2 branches missed.">        } while (processed.intValue() &gt; 0);</span>
<span class="nc" id="L604">        closeQuietly(conn);</span>
<span class="nc" id="L605">    }</span>

    public void repairBAGMutatieBerichten(String config) throws Exception {
<span class="nc" id="L608">        int offset = 0;</span>
<span class="nc" id="L609">        int batch = 1000;</span>
<span class="nc" id="L610">        final MutableInt processed = new MutableInt(0);</span>
<span class="nc" id="L611">        final DataSource dataSourceStaging = ConfigUtil.getDataSourceStaging();</span>
<span class="nc" id="L612">        final Connection conn = dataSourceStaging.getConnection();</span>
<span class="nc" id="L613">        final GeometryJdbcConverter geomToJdbc =</span>
<span class="nc" id="L614">                GeometryJdbcConverterFactory.getGeometryJdbcConverter(conn);</span>
<span class="nc" id="L615">        final RowProcessor processor = new StagingRowHandler();</span>

        do {
<span class="nc" id="L618">            LOG.debug(</span>
<span class="nc" id="L619">                    String.format(</span>
                            &quot;Ophalen BAG mutatieberichten batch met offset %d, limit %d&quot;,
<span class="nc" id="L621">                            offset, batch));</span>
<span class="nc" id="L622">            String sql =</span>
                    &quot;select * from &quot;
                            + BrmoFramework.BERICHT_TABLE
                            + &quot; where volgordenummer &gt;= 0 &quot;
                            + &quot; and soort='bag' &quot;
                            + &quot; and status='&quot;
                            + config
                            + &quot;'&quot;
                            + &quot; order by id &quot;;
<span class="nc" id="L631">            sql = geomToJdbc.buildPaginationSql(sql, offset, batch);</span>
<span class="nc" id="L632">            LOG.debug(&quot;SQL voor ophalen berichten batch: &quot; + sql);</span>

<span class="nc" id="L634">            processed.setValue(0);</span>
<span class="nc" id="L635">            Exception e =</span>
<span class="nc" id="L636">                    new QueryRunner(geomToJdbc.isPmdKnownBroken())</span>
<span class="nc" id="L637">                            .query(</span>
                                    conn,
                                    sql,
                                    rs -&gt; {
<span class="nc bnc" id="L641" title="All 2 branches missed.">                                        while (rs.next()) {</span>
                                            try {
<span class="nc" id="L643">                                                Bericht bericht =</span>
<span class="nc" id="L644">                                                        processor.toBean(rs, Bericht.class);</span>

<span class="nc" id="L646">                                                StringBuilder message = new StringBuilder();</span>
<span class="nc bnc" id="L647" title="All 2 branches missed.">                                                if (bericht.getBrOrgineelXml() != null</span>
<span class="nc bnc" id="L648" title="All 2 branches missed.">                                                        &amp;&amp; !bericht.getBrOrgineelXml().isEmpty()) {</span>
<span class="nc" id="L649">                                                    message.append(bericht.getBrOrgineelXml());</span>
                                                } else {
<span class="nc" id="L651">                                                    if (bericht.getBrXml()</span>
<span class="nc bnc" id="L652" title="All 2 branches missed.">                                                            .startsWith(&quot;&lt;?xml version=\&quot;1.0\&quot;&quot;)) {</span>
                                                        // strip &lt;?xml version=&quot;1.0&quot;?&gt;
<span class="nc" id="L654">                                                        message.append(</span>
<span class="nc" id="L655">                                                                bericht.getBrXml().substring(21));</span>
                                                    } else {
<span class="nc" id="L657">                                                        message.append(bericht.getBrXml());</span>
                                                    }
                                                }

<span class="nc" id="L661">                                                BagXMLReader reader =</span>
                                                        new BagXMLReader(
                                                                new ByteArrayInputStream(
<span class="nc" id="L664">                                                                        message.toString()</span>
<span class="nc" id="L665">                                                                                .getBytes(</span>
                                                                                        StandardCharsets
                                                                                                .UTF_8)));
<span class="nc" id="L668">                                                reader.hasNext();</span>
<span class="nc" id="L669">                                                Bericht bag = reader.next();</span>
<span class="nc bnc" id="L670" title="All 2 branches missed.">                                                if (bag != null</span>
<span class="nc bnc" id="L671" title="All 2 branches missed.">                                                        &amp;&amp; bag.getDatum() != null</span>
<span class="nc bnc" id="L672" title="All 2 branches missed.">                                                        &amp;&amp; bag.getObjectRef() != null</span>
<span class="nc bnc" id="L673" title="All 2 branches missed.">                                                        &amp;&amp; bag.getVolgordeNummer() != null) {</span>
<span class="nc" id="L674">                                                    bericht.setDatum(bag.getDatum());</span>
<span class="nc" id="L675">                                                    bericht.setObjectRef(bag.getObjectRef());</span>
<span class="nc" id="L676">                                                    bericht.setVolgordeNummer(</span>
<span class="nc" id="L677">                                                            bag.getVolgordeNummer());</span>
                                                }
<span class="nc bnc" id="L679" title="All 2 branches missed.">                                                if (bag != null</span>
<span class="nc bnc" id="L680" title="All 2 branches missed.">                                                        &amp;&amp; bag.getDatum() != null</span>
<span class="nc bnc" id="L681" title="All 2 branches missed.">                                                        &amp;&amp; bag.getObjectRef() != null</span>
<span class="nc bnc" id="L682" title="All 2 branches missed.">                                                        &amp;&amp; bag.getVolgordeNummer() != null) {</span>
<span class="nc bnc" id="L683" title="All 2 branches missed.">                                                    if (bericht.getBrOrgineelXml() != null</span>
<span class="nc" id="L684">                                                            &amp;&amp; !bericht.getBrOrgineelXml()</span>
<span class="nc bnc" id="L685" title="All 2 branches missed.">                                                                    .isEmpty()) {</span>
<span class="nc" id="L686">                                                        new QueryRunner(</span>
                                                                        geomToJdbc
<span class="nc" id="L688">                                                                                .isPmdKnownBroken())</span>
<span class="nc" id="L689">                                                                .update(</span>
                                                                        conn,
                                                                        &quot;update &quot;
                                                                                + BrmoFramework
                                                                                        .BERICHT_TABLE
                                                                                + &quot; set object_ref = ?, datum = ?, volgordenummer = ? where id = ?&quot;,
<span class="nc" id="L695">                                                                        bericht.getObjectRef(),</span>
                                                                        new Timestamp(
<span class="nc" id="L697">                                                                                bericht.getDatum()</span>
<span class="nc" id="L698">                                                                                        .getTime()),</span>
<span class="nc" id="L699">                                                                        bericht.getVolgordeNummer(),</span>
<span class="nc" id="L700">                                                                        bericht.getId());</span>
                                                    } else {
<span class="nc" id="L702">                                                        new QueryRunner(</span>
                                                                        geomToJdbc
<span class="nc" id="L704">                                                                                .isPmdKnownBroken())</span>
<span class="nc" id="L705">                                                                .update(</span>
                                                                        conn,
                                                                        &quot;update &quot;
                                                                                + BrmoFramework
                                                                                        .BERICHT_TABLE
                                                                                + &quot; set object_ref = ?, datum = ?, volgordenummer = ?, br_orgineel_xml = ? where id = ?&quot;,
<span class="nc" id="L711">                                                                        bericht.getObjectRef(),</span>
                                                                        new Timestamp(
<span class="nc" id="L713">                                                                                bericht.getDatum()</span>
<span class="nc" id="L714">                                                                                        .getTime()),</span>
<span class="nc" id="L715">                                                                        bericht.getVolgordeNummer(),</span>
<span class="nc" id="L716">                                                                        message.toString(),</span>
<span class="nc" id="L717">                                                                        bericht.getId());</span>
                                                    }
                                                }
<span class="nc" id="L720">                                            } catch (Exception e1) {</span>
<span class="nc" id="L721">                                                return e1;</span>
<span class="nc" id="L722">                                            }</span>
<span class="nc" id="L723">                                            processed.increment();</span>
                                        }
<span class="nc" id="L725">                                        return null;</span>
                                    });
<span class="nc" id="L727">            offset += processed.intValue();</span>

<span class="nc" id="L729">            progress(offset);</span>

            // If handler threw exception processing row, rethrow it
<span class="nc bnc" id="L732" title="All 2 branches missed.">            if (e != null) {</span>
<span class="nc" id="L733">                closeQuietly(conn);</span>
<span class="nc" id="L734">                throw e;</span>
            }
<span class="nc bnc" id="L736" title="All 2 branches missed.">        } while (processed.intValue() &gt; 0);</span>
<span class="nc" id="L737">        closeQuietly(conn);</span>
<span class="nc" id="L738">    }</span>

    public void exportBRKMutatieBerichten(String locatie) throws Exception {

<span class="nc" id="L742">        boolean repairFirst = false;</span>
<span class="nc bnc" id="L743" title="All 2 branches missed.">        if (repairFirst) {</span>
<span class="nc" id="L744">            repairBRKMutatieBerichten(null);</span>
        }

<span class="nc" id="L747">        int offset = 0;</span>
<span class="nc" id="L748">        int batch = 5000;</span>
<span class="nc" id="L749">        final MutableInt processed = new MutableInt(0);</span>
<span class="nc" id="L750">        final DataSource dataSourceStaging = ConfigUtil.getDataSourceStaging();</span>
<span class="nc" id="L751">        final Connection conn = dataSourceStaging.getConnection();</span>
<span class="nc" id="L752">        final GeometryJdbcConverter geomToJdbc =</span>
<span class="nc" id="L753">                GeometryJdbcConverterFactory.getGeometryJdbcConverter(conn);</span>
<span class="nc" id="L754">        final RowProcessor processor = new StagingRowHandler();</span>

<span class="nc" id="L756">        final File exportDir = new File(locatie);</span>
<span class="nc" id="L757">        FileUtils.forceMkdir(exportDir);</span>

        do {
<span class="nc" id="L760">            LOG.info(</span>
<span class="nc" id="L761">                    String.format(</span>
                            &quot;Ophalen mutatieberichten export batch met offset %d, limit %d&quot;,
<span class="nc" id="L763">                            offset, batch));</span>
<span class="nc" id="L764">            String sql =</span>
                    &quot;select * from &quot;
                            + BrmoFramework.BERICHT_TABLE
                            + &quot; where volgordenummer &gt;= 0 &quot;
                            + &quot; and soort='brk' &quot;
                            + &quot; order by object_ref, datum, volgordenummer &quot;;
<span class="nc" id="L770">            sql = geomToJdbc.buildPaginationSql(sql, offset, batch);</span>
<span class="nc" id="L771">            LOG.debug(&quot;SQL voor ophalen berichten batch: &quot; + sql);</span>

<span class="nc" id="L773">            final File f = new File(exportDir, &quot;batch&quot; + offset + &quot;.zip&quot;);</span>
<span class="nc" id="L774">            final ZipOutputStream out = new ZipOutputStream(new FileOutputStream(f));</span>

<span class="nc" id="L776">            processed.setValue(0);</span>
<span class="nc" id="L777">            Exception e =</span>
<span class="nc" id="L778">                    new QueryRunner(geomToJdbc.isPmdKnownBroken())</span>
<span class="nc" id="L779">                            .query(</span>
                                    conn,
                                    sql,
                                    rs -&gt; {
<span class="nc bnc" id="L783" title="All 2 branches missed.">                                        while (rs.next()) {</span>
                                            try {
<span class="nc" id="L785">                                                Bericht bericht =</span>
<span class="nc" id="L786">                                                        processor.toBean(rs, Bericht.class);</span>

<span class="nc" id="L788">                                                boolean infoOK = true;</span>
<span class="nc bnc" id="L789" title="All 2 branches missed.">                                                if (bericht.getBrOrgineelXml() != null) {</span>
<span class="nc" id="L790">                                                    BrkSnapshotXMLReader reader =</span>
                                                            new BrkSnapshotXMLReader(
                                                                    new ByteArrayInputStream(
<span class="nc" id="L793">                                                                            bericht.getBrOrgineelXml()</span>
<span class="nc" id="L794">                                                                                    .getBytes(</span>
                                                                                            StandardCharsets
                                                                                                    .UTF_8)));
<span class="nc" id="L797">                                                    Bericht brk = reader.next();</span>
<span class="nc bnc" id="L798" title="All 2 branches missed.">                                                    if (brk.getDatum() != null</span>
<span class="nc bnc" id="L799" title="All 2 branches missed.">                                                            &amp;&amp; brk.getObjectRef() != null</span>
<span class="nc bnc" id="L800" title="All 2 branches missed.">                                                            &amp;&amp; brk.getVolgordeNummer() != null) {</span>
<span class="nc" id="L801">                                                        bericht.setDatum(brk.getDatum());</span>
<span class="nc" id="L802">                                                        bericht.setObjectRef(brk.getObjectRef());</span>
<span class="nc" id="L803">                                                        bericht.setVolgordeNummer(</span>
<span class="nc" id="L804">                                                                brk.getVolgordeNummer());</span>
                                                    } else {
<span class="nc" id="L806">                                                        infoOK = false;</span>
                                                    }
<span class="nc" id="L808">                                                } else {</span>
<span class="nc" id="L809">                                                    infoOK = false;</span>
                                                }
<span class="nc" id="L811">                                                StringBuilder sb = new StringBuilder();</span>
<span class="nc bnc" id="L812" title="All 2 branches missed.">                                                if (!infoOK) {</span>
<span class="nc" id="L813">                                                    sb.append(&quot;I&quot;);</span>
                                                }
<span class="nc bnc" id="L815" title="All 2 branches missed.">                                                if (bericht.getObjectRef() != null) {</span>
                                                    // substring om NL.KAD.OnroerendeZaak: eraf te
                                                    // strippen
<span class="nc" id="L818">                                                    sb.append(bericht.getObjectRef().substring(22));</span>
                                                } else {
<span class="nc" id="L820">                                                    sb.append((new Date()).getTime());</span>
                                                }
<span class="nc" id="L822">                                                sb.append(&quot;_&quot;);</span>
<span class="nc bnc" id="L823" title="All 2 branches missed.">                                                if (bericht.getDatum() != null) {</span>
<span class="nc" id="L824">                                                    sb.append(bericht.getDatum().getTime());</span>
                                                } else {
<span class="nc" id="L826">                                                    sb.append(&quot;O&quot;);</span>
<span class="nc" id="L827">                                                    sb.append((new Date()).getTime());</span>
                                                }
<span class="nc" id="L829">                                                sb.append(&quot;_&quot;);</span>
<span class="nc" id="L830">                                                sb.append(bericht.getVolgordeNummer());</span>
<span class="nc" id="L831">                                                sb.append(&quot;.xml&quot;);</span>

<span class="nc" id="L833">                                                ZipEntry e1 = new ZipEntry(sb.toString());</span>
                                                try {
<span class="nc" id="L835">                                                    out.putNextEntry(e1);</span>
<span class="nc" id="L836">                                                    byte[] data = null;</span>
<span class="nc bnc" id="L837" title="All 2 branches missed.">                                                    if (infoOK) {</span>
<span class="nc" id="L838">                                                        data =</span>
<span class="nc" id="L839">                                                                bericht.getBrOrgineelXml()</span>
<span class="nc" id="L840">                                                                        .getBytes(</span>
                                                                                StandardCharsets
                                                                                        .UTF_8);
                                                    } else {
<span class="nc" id="L844">                                                        data =</span>
                                                                &quot;ERROR&quot;
<span class="nc" id="L846">                                                                        .getBytes(</span>
                                                                                StandardCharsets
                                                                                        .UTF_8);
                                                    }
<span class="nc" id="L850">                                                    out.write(data, 0, data.length);</span>
<span class="nc" id="L851">                                                } catch (ZipException ze) {</span>
<span class="nc" id="L852">                                                    LOG.info(ze.getLocalizedMessage());</span>
                                                } finally {
<span class="nc" id="L854">                                                    out.closeEntry();</span>
                                                }
<span class="nc" id="L856">                                            } catch (Exception e1) {</span>
<span class="nc" id="L857">                                                return e1;</span>
<span class="nc" id="L858">                                            }</span>
<span class="nc" id="L859">                                            processed.increment();</span>
                                        }
<span class="nc" id="L861">                                        return null;</span>
                                    });
<span class="nc bnc" id="L863" title="All 2 branches missed.">            if (out != null) {</span>
<span class="nc" id="L864">                out.close();</span>
            }
<span class="nc" id="L866">            LOG.info(&quot;Klaar met schrijven naar export bestand &quot; + f);</span>
<span class="nc" id="L867">            offset += processed.intValue();</span>

<span class="nc" id="L869">            progress(offset);</span>

            // If handler threw exception processing row, rethrow it
<span class="nc bnc" id="L872" title="All 2 branches missed.">            if (e != null) {</span>
<span class="nc" id="L873">                closeQuietly(conn);</span>
<span class="nc" id="L874">                throw e;</span>
            }
<span class="nc bnc" id="L876" title="All 2 branches missed.">        } while (processed.intValue() &gt; 0);</span>
<span class="nc" id="L877">        closeQuietly(conn);</span>
<span class="nc" id="L878">    }</span>

    public void cleanupBerichten(String config, String soort) throws Exception {
<span class="nc" id="L881">        final int offset = 0;</span>
<span class="nc" id="L882">        int progress = 0;</span>
<span class="nc" id="L883">        int batch = 1000;</span>
<span class="nc" id="L884">        final MutableInt processed = new MutableInt(0);</span>
<span class="nc" id="L885">        final DataSource dataSourceStaging = ConfigUtil.getDataSourceStaging();</span>
<span class="nc" id="L886">        final Connection conn = dataSourceStaging.getConnection();</span>
<span class="nc" id="L887">        final GeometryJdbcConverter geomToJdbc =</span>
<span class="nc" id="L888">                GeometryJdbcConverterFactory.getGeometryJdbcConverter(conn);</span>
<span class="nc" id="L889">        final RowProcessor processor = new StagingRowHandler();</span>

<span class="nc" id="L891">        Calendar c = Calendar.getInstance();</span>
<span class="nc" id="L892">        c.setTime(new Date());</span>
<span class="nc" id="L893">        c.add(Calendar.MONTH, -3);</span>

<span class="nc" id="L895">        String countsql =</span>
                &quot;select count(*) from &quot;
                        + BrmoFramework.BERICHT_TABLE
                        + &quot; where soort='&quot;
                        + soort
                        + &quot;' &quot;
                        + &quot; and status='&quot;
                        + config
                        + &quot;'&quot;
                        + &quot; and status_datum &lt; ? &quot;;
<span class="nc" id="L905">        Number o =</span>
<span class="nc" id="L906">                new QueryRunner(geomToJdbc.isPmdKnownBroken())</span>
<span class="nc" id="L907">                        .query(</span>
                                conn,
                                countsql,
                                new ScalarHandler&lt;&gt;(),
<span class="nc" id="L911">                                new Timestamp(c.getTimeInMillis()));</span>
<span class="nc bnc" id="L912" title="All 2 branches missed.">        if (o instanceof BigDecimal) {</span>
<span class="nc" id="L913">            total(o.longValue());</span>
<span class="nc bnc" id="L914" title="All 2 branches missed.">        } else if (o instanceof Integer) {</span>
<span class="nc" id="L915">            total(o.longValue());</span>
        } else {
<span class="nc" id="L917">            total((Long) o);</span>
        }

        do {
<span class="nc" id="L921">            LOG.debug(</span>
<span class="nc" id="L922">                    String.format(</span>
                            &quot;Ophalen berichten batch met offset %d, limit %d, tot datum %tc, voortgang %d&quot;,
<span class="nc" id="L924">                            offset, batch, c, progress));</span>
<span class="nc" id="L925">            String sql =</span>
                    &quot;select * from &quot;
                            + BrmoFramework.BERICHT_TABLE
                            + &quot; where soort='&quot;
                            + soort
                            + &quot;' &quot;
                            + &quot; and status='&quot;
                            + config
                            + &quot;'&quot;
                            + &quot; and status_datum &lt; ? &quot;
                            + &quot; order by id &quot;;
<span class="nc" id="L936">            sql = geomToJdbc.buildPaginationSql(sql, offset, batch);</span>
<span class="nc" id="L937">            LOG.debug(&quot;SQL voor ophalen berichten batch: &quot; + sql);</span>

<span class="nc" id="L939">            processed.setValue(0);</span>
<span class="nc" id="L940">            Exception e =</span>
<span class="nc" id="L941">                    new QueryRunner(geomToJdbc.isPmdKnownBroken())</span>
<span class="nc" id="L942">                            .query(</span>
                                    conn,
                                    sql,
                                    rs -&gt; {
<span class="nc bnc" id="L946" title="All 2 branches missed.">                                        while (rs.next()) {</span>
                                            try {
<span class="nc" id="L948">                                                Bericht bericht =</span>
<span class="nc" id="L949">                                                        processor.toBean(rs, Bericht.class);</span>

<span class="nc" id="L951">                                                bericht.setBrOrgineelXml(&quot;opgeschoond&quot;);</span>
<span class="nc" id="L952">                                                bericht.setBrXml(&quot;opgeschoond&quot;);</span>
<span class="nc" id="L953">                                                bericht.setOpmerking(</span>
                                                        &quot;opgeschoond, status was: &quot;
<span class="nc" id="L955">                                                                + bericht.getStatus().toString());</span>
<span class="nc" id="L956">                                                bericht.setStatus(Bericht.STATUS.ARCHIVE);</span>
<span class="nc" id="L957">                                                bericht.setStatusDatum(new Date());</span>

<span class="nc" id="L959">                                                new QueryRunner(geomToJdbc.isPmdKnownBroken())</span>
<span class="nc" id="L960">                                                        .update(</span>
                                                                conn,
                                                                &quot;update &quot;
                                                                        + BrmoFramework
                                                                                .BERICHT_TABLE
                                                                        + &quot; set status_datum = ?, status = ?, opmerking = ?, br_xml = ?, br_orgineel_xml = ? where id = ?&quot;,
                                                                new Timestamp(
<span class="nc" id="L967">                                                                        bericht.getStatusDatum()</span>
<span class="nc" id="L968">                                                                                .getTime()),</span>
<span class="nc" id="L969">                                                                bericht.getStatus().toString(),</span>
<span class="nc" id="L970">                                                                bericht.getOpmerking(),</span>
<span class="nc" id="L971">                                                                bericht.getBrXml(),</span>
<span class="nc" id="L972">                                                                bericht.getBrOrgineelXml(),</span>
<span class="nc" id="L973">                                                                bericht.getId());</span>

<span class="nc" id="L975">                                            } catch (Exception e1) {</span>
<span class="nc" id="L976">                                                return e1;</span>
<span class="nc" id="L977">                                            }</span>
<span class="nc" id="L978">                                            processed.increment();</span>
                                        }
<span class="nc" id="L980">                                        return null;</span>
                                    },
<span class="nc" id="L982">                                    new Timestamp(c.getTimeInMillis()));</span>
<span class="nc" id="L983">            progress += processed.intValue();</span>

<span class="nc" id="L985">            progress(progress);</span>

            // If handler threw exception processing row, rethrow it
<span class="nc bnc" id="L988" title="All 2 branches missed.">            if (e != null) {</span>
<span class="nc" id="L989">                closeQuietly(conn);</span>
<span class="nc" id="L990">                throw e;</span>
            }
<span class="nc bnc" id="L992" title="All 2 branches missed.">        } while (processed.intValue() &gt; 0);</span>
<span class="nc" id="L993">        closeQuietly(conn);</span>
<span class="nc" id="L994">    }</span>

    public void deleteBerichten(String config, String soort) throws Exception {
<span class="nc" id="L997">        final MutableInt processed = new MutableInt(0);</span>
<span class="nc" id="L998">        final DataSource dataSourceStaging = ConfigUtil.getDataSourceStaging();</span>
<span class="nc" id="L999">        final Connection conn = dataSourceStaging.getConnection();</span>
<span class="nc" id="L1000">        final GeometryJdbcConverter geomToJdbc =</span>
<span class="nc" id="L1001">                GeometryJdbcConverterFactory.getGeometryJdbcConverter(conn);</span>

<span class="nc" id="L1003">        String countsql =</span>
                &quot;select count(*) from &quot;
                        + BrmoFramework.BERICHT_TABLE
                        + &quot; WHERE soort='&quot;
                        + soort
                        + &quot;' &quot;
                        + &quot; AND status='&quot;
                        + config
                        + &quot;'&quot;;
<span class="nc" id="L1012">        Number o =</span>
<span class="nc" id="L1013">                new QueryRunner(geomToJdbc.isPmdKnownBroken())</span>
<span class="nc" id="L1014">                        .query(conn, countsql, new ScalarHandler&lt;&gt;());</span>
<span class="nc bnc" id="L1015" title="All 2 branches missed.">        if (o instanceof BigDecimal) {</span>
<span class="nc" id="L1016">            total(o.longValue());</span>
<span class="nc bnc" id="L1017" title="All 2 branches missed.">        } else if (o instanceof Integer) {</span>
<span class="nc" id="L1018">            total(o.longValue());</span>
        } else {
<span class="nc" id="L1020">            total((Long) o);</span>
        }
<span class="nc" id="L1022">        LOG.debug(&quot;Totaal te verwijderen &quot; + config + &quot; berichten: &quot; + o);</span>

<span class="nc" id="L1024">        o =</span>
<span class="nc" id="L1025">                new QueryRunner(geomToJdbc.isPmdKnownBroken())</span>
<span class="nc" id="L1026">                        .update(</span>
                                conn,
                                &quot;DELETE FROM &quot;
                                        + BrmoFramework.BERICHT_TABLE
                                        + &quot; WHERE soort='&quot;
                                        + soort
                                        + &quot;' &quot;
                                        + &quot; AND status='&quot;
                                        + config
                                        + &quot;'&quot;);

<span class="nc bnc" id="L1037" title="All 2 branches missed.">        if (o instanceof BigDecimal) {</span>
<span class="nc" id="L1038">            progress(o.longValue());</span>
<span class="nc bnc" id="L1039" title="All 2 branches missed.">        } else if (o instanceof Integer) {</span>
<span class="nc" id="L1040">            progress(o.longValue());</span>
        } else {
<span class="nc" id="L1042">            progress((Long) o);</span>
        }
<span class="nc" id="L1044">        closeQuietly(conn);</span>
<span class="nc" id="L1045">    }</span>

    /**
     * Deze actie verwerkt alle NHR berichten met status RSGB_NOK opnieuw.
     *
     * @param status bericht status
     * @param soort soort bericht
     * @throws SQLException if any
     * @throws BrmoException if any
     * @throws Exception if any
     */
    public void replayNHRVerwerking(String soort, String status)
            throws SQLException, BrmoException, Exception {
<span class="nc" id="L1058">        int offset = 0;</span>
<span class="nc" id="L1059">        int batch = 1000;</span>
<span class="nc" id="L1060">        final MutableInt processed = new MutableInt(0);</span>
<span class="nc" id="L1061">        final DataSource dataSourceStaging = ConfigUtil.getDataSourceStaging();</span>
<span class="nc" id="L1062">        final DataSource dataSourceRsgb = ConfigUtil.getDataSourceRsgb();</span>
<span class="nc" id="L1063">        final Connection conn = dataSourceStaging.getConnection();</span>
<span class="nc" id="L1064">        final GeometryJdbcConverter geomToJdbc =</span>
<span class="nc" id="L1065">                GeometryJdbcConverterFactory.getGeometryJdbcConverter(conn);</span>
<span class="nc" id="L1066">        final RowProcessor processor = new StagingRowHandler();</span>

<span class="nc" id="L1068">        LOG.debug(&quot;staging datasource: &quot; + dataSourceStaging);</span>
<span class="nc" id="L1069">        LOG.debug(&quot;rsgb datasource: &quot; + dataSourceRsgb);</span>

<span class="nc" id="L1071">        String countsql =</span>
                &quot;select count(id) from &quot;
                        + BrmoFramework.BERICHT_TABLE
                        + &quot; where soort='&quot;
                        + soort
                        + &quot;'&quot;
                        + &quot; and status='&quot;
                        + status
                        + &quot;'&quot;;
<span class="nc" id="L1080">        LOG.debug(&quot;SQL voor tellen van berichten batch: &quot; + countsql);</span>
<span class="nc" id="L1081">        Number o =</span>
<span class="nc" id="L1082">                new QueryRunner(geomToJdbc.isPmdKnownBroken())</span>
<span class="nc" id="L1083">                        .query(conn, countsql, new ScalarHandler&lt;&gt;());</span>
<span class="nc" id="L1084">        LOG.debug(&quot;Totaal te verwerken verwijder berichten: &quot; + o);</span>

<span class="nc bnc" id="L1086" title="All 2 branches missed.">        if (o instanceof BigDecimal) {</span>
<span class="nc" id="L1087">            total(o.longValue());</span>
<span class="nc bnc" id="L1088" title="All 2 branches missed.">        } else if (o instanceof Integer) {</span>
<span class="nc" id="L1089">            total(o.longValue());</span>
        } else {
<span class="nc" id="L1091">            total((Long) o);</span>
        }

<span class="nc" id="L1094">        StagingProxy staging = new StagingProxy(dataSourceStaging);</span>
<span class="nc" id="L1095">        RsgbProxy rsgb =</span>
                new RsgbProxy(dataSourceRsgb, null, staging, Bericht.STATUS.RSGB_NOK, this);
<span class="nc" id="L1097">        rsgb.setErrorState(getContext().getServletContext().getInitParameter(&quot;error.state&quot;));</span>
<span class="nc" id="L1098">        rsgb.setOrderBerichten(true);</span>
<span class="nc" id="L1099">        rsgb.init();</span>

        do {
<span class="nc" id="L1102">            LOG.debug(</span>
<span class="nc" id="L1103">                    String.format(</span>
<span class="nc" id="L1104">                            &quot;Ophalen berichten batch met offset %d, limit %d&quot;, offset, batch));</span>
<span class="nc" id="L1105">            String sql =</span>
                    &quot;select * from &quot;
                            + BrmoFramework.BERICHT_TABLE
                            + &quot; where soort='&quot;
                            + soort
                            + &quot;'&quot;
                            + &quot; and status='&quot;
                            + status
                            + &quot;'&quot;
                            + &quot; order by id&quot;;
<span class="nc" id="L1115">            sql = geomToJdbc.buildPaginationSql(sql, offset, batch);</span>
<span class="nc" id="L1116">            LOG.debug(&quot;SQL voor ophalen berichten batch: &quot; + sql);</span>

<span class="nc" id="L1118">            processed.setValue(0);</span>
<span class="nc" id="L1119">            Exception e =</span>
<span class="nc" id="L1120">                    new QueryRunner(geomToJdbc.isPmdKnownBroken())</span>
<span class="nc" id="L1121">                            .query(</span>
                                    conn,
                                    sql,
                                    rs -&gt; {
<span class="nc bnc" id="L1125" title="All 2 branches missed.">                                        while (rs.next()) {</span>
                                            try {
<span class="nc" id="L1127">                                                Bericht bericht =</span>
<span class="nc" id="L1128">                                                        processor.toBean(rs, Bericht.class);</span>
<span class="nc" id="L1129">                                                LOG.debug(</span>
                                                        &quot;Opnieuw verwerken van bericht: &quot;
                                                                + bericht);
                                                // bewaar oude log
<span class="nc" id="L1133">                                                String oudeOpmerkingen = bericht.getOpmerking();</span>
                                                // forceer verwerking door bericht op STAGING_OK te
                                                // zetten en dan opnieuw te verwerken
<span class="nc" id="L1136">                                                bericht.setStatus(Bericht.STATUS.STAGING_OK);</span>
<span class="nc" id="L1137">                                                new QueryRunner(geomToJdbc.isPmdKnownBroken())</span>
<span class="nc" id="L1138">                                                        .update(</span>
                                                                conn,
                                                                &quot;update &quot;
                                                                        + BrmoFramework
                                                                                .BERICHT_TABLE
                                                                        + &quot; set status_datum = ?, status = ? where id = ?&quot;,
                                                                new Timestamp(
<span class="nc" id="L1145">                                                                        bericht.getStatusDatum()</span>
<span class="nc" id="L1146">                                                                                .getTime()),</span>
<span class="nc" id="L1147">                                                                bericht.getStatus().toString(),</span>
<span class="nc" id="L1148">                                                                bericht.getId());</span>

<span class="nc" id="L1150">                                                rsgb.handle(</span>
                                                        bericht,
<span class="nc" id="L1152">                                                        rsgb.transformToTableData(bericht),</span>
                                                        true);

<span class="nc" id="L1155">                                                bericht.setOpmerking(</span>
                                                        &quot;Opnieuw verwerkt met geavanceerde functies optie.\nNieuwe verwerkingslog (oude log daaronder)\n&quot;
<span class="nc" id="L1157">                                                                + bericht.getOpmerking()</span>
                                                                + &quot;\n\nOude verwerkingslog\n\n&quot;
                                                                + oudeOpmerkingen);
<span class="nc" id="L1160">                                                bericht.setStatusDatum(new Date());</span>
<span class="nc" id="L1161">                                                new QueryRunner(geomToJdbc.isPmdKnownBroken())</span>
<span class="nc" id="L1162">                                                        .update(</span>
                                                                conn,
                                                                &quot;update &quot;
                                                                        + BrmoFramework
                                                                                .BERICHT_TABLE
                                                                        + &quot; set opmerking = ? where id = ?&quot;,
<span class="nc" id="L1168">                                                                bericht.getOpmerking(),</span>
<span class="nc" id="L1169">                                                                bericht.getId());</span>
<span class="nc" id="L1170">                                            } catch (Exception e1) {</span>
<span class="nc" id="L1171">                                                return e1;</span>
<span class="nc" id="L1172">                                            }</span>
<span class="nc" id="L1173">                                            processed.increment();</span>
                                        }
<span class="nc" id="L1175">                                        return null;</span>
                                    });
<span class="nc" id="L1177">            offset += processed.intValue();</span>

<span class="nc" id="L1179">            progress(offset);</span>

            // If handler threw exception processing row, rethrow it
<span class="nc bnc" id="L1182" title="All 2 branches missed.">            if (e != null) {</span>
<span class="nc" id="L1183">                closeQuietly(conn);</span>
<span class="nc" id="L1184">                throw e;</span>
            }
<span class="nc bnc" id="L1186" title="All 2 branches missed.">        } while (processed.intValue() &gt; 0);</span>
<span class="nc" id="L1187">        closeQuietly(conn);</span>
<span class="nc" id="L1188">        rsgb.close();</span>
<span class="nc" id="L1189">    }</span>

    /**
     * Deze actie loopt door de lijst brk verwijderberichten (={@code &lt;empty/&gt;} br_xml) met status
     * RSGB_OK om ze nogmaals naar de rsgb te transformeren.
     *
     * @param status bericht status
     * @param soort soort bericht
     * @throws SQLException if any
     * @throws BrmoException if any
     * @throws Exception if any
     */
    public void replayBRKVerwijderBerichten(String soort, String status)
            throws SQLException, BrmoException, Exception {
<span class="nc" id="L1203">        int offset = 0;</span>
<span class="nc" id="L1204">        int batch = 1000;</span>
<span class="nc" id="L1205">        final MutableInt processed = new MutableInt(0);</span>
<span class="nc" id="L1206">        final DataSource dataSourceStaging = ConfigUtil.getDataSourceStaging();</span>
<span class="nc" id="L1207">        final DataSource dataSourceRsgb = ConfigUtil.getDataSourceRsgb();</span>
<span class="nc" id="L1208">        final Connection conn = dataSourceStaging.getConnection();</span>
<span class="nc" id="L1209">        final GeometryJdbcConverter geomToJdbc =</span>
<span class="nc" id="L1210">                GeometryJdbcConverterFactory.getGeometryJdbcConverter(conn);</span>
<span class="nc" id="L1211">        final RowProcessor processor = new StagingRowHandler();</span>

<span class="nc" id="L1213">        LOG.debug(&quot;staging datasource: &quot; + dataSourceStaging);</span>
<span class="nc" id="L1214">        LOG.debug(&quot;rsgb datasource: &quot; + dataSourceRsgb);</span>

<span class="nc" id="L1216">        String countsql =</span>
                &quot;select count(id) from &quot;
                        + BrmoFramework.BERICHT_TABLE
                        + &quot; where soort='&quot;
                        + soort
                        + &quot;'&quot;
                        + &quot; and status='&quot;
                        + status
                        + &quot;'&quot;
                        // gebruik like (en niet =) omdat anders ORA-00932 want br_xml is clob
                        + &quot; and br_xml like '&lt;empty/&gt;'&quot;;
<span class="nc" id="L1227">        LOG.debug(&quot;SQL voor tellen van berichten batch: &quot; + countsql);</span>
<span class="nc" id="L1228">        Number o =</span>
<span class="nc" id="L1229">                new QueryRunner(geomToJdbc.isPmdKnownBroken())</span>
<span class="nc" id="L1230">                        .query(conn, countsql, new ScalarHandler&lt;&gt;());</span>
<span class="nc" id="L1231">        LOG.debug(&quot;Totaal te verwerken verwijder berichten: &quot; + o);</span>

<span class="nc bnc" id="L1233" title="All 2 branches missed.">        if (o instanceof BigDecimal) {</span>
<span class="nc" id="L1234">            total(o.longValue());</span>
<span class="nc bnc" id="L1235" title="All 2 branches missed.">        } else if (o instanceof Integer) {</span>
<span class="nc" id="L1236">            total(o.longValue());</span>
        } else {
<span class="nc" id="L1238">            total((Long) o);</span>
        }

<span class="nc" id="L1241">        StagingProxy staging = new StagingProxy(dataSourceStaging);</span>
<span class="nc" id="L1242">        RsgbProxy rsgb = new RsgbProxy(dataSourceRsgb, null, staging, Bericht.STATUS.RSGB_OK, this);</span>
<span class="nc" id="L1243">        rsgb.setOrderBerichten(true);</span>
<span class="nc" id="L1244">        rsgb.init();</span>

        do {
<span class="nc" id="L1247">            LOG.debug(</span>
<span class="nc" id="L1248">                    String.format(</span>
<span class="nc" id="L1249">                            &quot;Ophalen berichten batch met offset %d, limit %d&quot;, offset, batch));</span>
<span class="nc" id="L1250">            String sql =</span>
                    &quot;select * from &quot;
                            + BrmoFramework.BERICHT_TABLE
                            + &quot; where soort='&quot;
                            + soort
                            + &quot;'&quot;
                            + &quot; and status='&quot;
                            + status
                            + &quot;'&quot;
                            + &quot; and br_xml like '&lt;empty/&gt;'&quot;
                            + &quot; order by id&quot;;
<span class="nc" id="L1261">            sql = geomToJdbc.buildPaginationSql(sql, offset, batch);</span>
<span class="nc" id="L1262">            LOG.debug(&quot;SQL voor ophalen berichten batch: &quot; + sql);</span>

<span class="nc" id="L1264">            processed.setValue(0);</span>
<span class="nc" id="L1265">            Exception e =</span>
<span class="nc" id="L1266">                    new QueryRunner(geomToJdbc.isPmdKnownBroken())</span>
<span class="nc" id="L1267">                            .query(</span>
                                    conn,
                                    sql,
                                    rs -&gt; {
<span class="nc bnc" id="L1271" title="All 2 branches missed.">                                        while (rs.next()) {</span>
                                            try {
<span class="nc" id="L1273">                                                Bericht bericht =</span>
<span class="nc" id="L1274">                                                        processor.toBean(rs, Bericht.class);</span>
<span class="nc" id="L1275">                                                LOG.debug(</span>
                                                        &quot;Opnieuw verwerken van bericht: &quot;
                                                                + bericht);
                                                // bewaar oude log
<span class="nc" id="L1279">                                                String oudeOpmerkingen = bericht.getOpmerking();</span>
                                                // forceer verwerking door bericht op STAGING_OK te
                                                // zetten en dan opnieuw te verwerken
<span class="nc" id="L1282">                                                bericht.setStatus(Bericht.STATUS.STAGING_OK);</span>
<span class="nc" id="L1283">                                                new QueryRunner(geomToJdbc.isPmdKnownBroken())</span>
<span class="nc" id="L1284">                                                        .update(</span>
                                                                conn,
                                                                &quot;update &quot;
                                                                        + BrmoFramework
                                                                                .BERICHT_TABLE
                                                                        + &quot; set status_datum = ?, status = ? where id = ?&quot;,
                                                                new Timestamp(
<span class="nc" id="L1291">                                                                        bericht.getStatusDatum()</span>
<span class="nc" id="L1292">                                                                                .getTime()),</span>
<span class="nc" id="L1293">                                                                bericht.getStatus().toString(),</span>
<span class="nc" id="L1294">                                                                bericht.getId());</span>

<span class="nc" id="L1296">                                                rsgb.handle(</span>
                                                        bericht,
<span class="nc" id="L1298">                                                        rsgb.transformToTableData(bericht),</span>
                                                        true);

<span class="nc" id="L1301">                                                bericht.setOpmerking(</span>
                                                        &quot;Opnieuw verwerkt met geavanceerde functies optie.\nNieuwe verwerkingslog (oude log daaronder)\n&quot;
<span class="nc" id="L1303">                                                                + bericht.getOpmerking()</span>
                                                                + &quot;\n\nOude verwerkingslog\n\n&quot;
                                                                + oudeOpmerkingen);
<span class="nc" id="L1306">                                                bericht.setStatusDatum(new Date());</span>
<span class="nc" id="L1307">                                                new QueryRunner(geomToJdbc.isPmdKnownBroken())</span>
<span class="nc" id="L1308">                                                        .update(</span>
                                                                conn,
                                                                &quot;update &quot;
                                                                        + BrmoFramework
                                                                                .BERICHT_TABLE
                                                                        + &quot; set opmerking = ? where id = ?&quot;,
<span class="nc" id="L1314">                                                                bericht.getOpmerking(),</span>
<span class="nc" id="L1315">                                                                bericht.getId());</span>
<span class="nc" id="L1316">                                            } catch (Exception e1) {</span>
<span class="nc" id="L1317">                                                return e1;</span>
<span class="nc" id="L1318">                                            }</span>
<span class="nc" id="L1319">                                            processed.increment();</span>
                                        }
<span class="nc" id="L1321">                                        return null;</span>
                                    });
<span class="nc" id="L1323">            offset += processed.intValue();</span>

<span class="nc" id="L1325">            progress(offset);</span>

            // If handler threw exception processing row, rethrow it
<span class="nc bnc" id="L1328" title="All 2 branches missed.">            if (e != null) {</span>
<span class="nc" id="L1329">                closeQuietly(conn);</span>
<span class="nc" id="L1330">                throw e;</span>
            }
<span class="nc bnc" id="L1332" title="All 2 branches missed.">        } while (processed.intValue() &gt; 0);</span>
<span class="nc" id="L1333">        closeQuietly(conn);</span>
<span class="nc" id="L1334">        rsgb.close();</span>
<span class="nc" id="L1335">    }</span>

    /**
     * Verwijderen van enkele aanhalingstekens van typering en clazz van sommige nHR persoon records
     * dmv SQL update. fix voor issue #527, {@code 'INGESCHREVEN NIET-NATUURLIJK PERSOON'} moet
     * worden {@code INGESCHREVEN NIET-NATUURLIJK PERSOON} (evt. afgekort op 35 char voor de
     * 'ingeschr_niet_nat_prs' tabel/'typering' kolom)
     *
     * @param soort soort bericht
     * @param status bericht status
     * @throws SQLException if any
     * @throws BrmoException if any
     * @throws Exception if any
     */
    public void fixNHRTypering(String soort, String status)
            throws SQLException, BrmoException, Exception {

<span class="nc" id="L1352">        final MutableInt _processed = new MutableInt(0);</span>
<span class="nc" id="L1353">        final DataSource dataSourceRsgb = ConfigUtil.getDataSourceRsgb();</span>
<span class="nc" id="L1354">        final Connection conn = dataSourceRsgb.getConnection();</span>
<span class="nc" id="L1355">        final GeometryJdbcConverter geomToJdbc =</span>
<span class="nc" id="L1356">                GeometryJdbcConverterFactory.getGeometryJdbcConverter(conn);</span>

<span class="nc" id="L1358">        final String was = &quot;'INGESCHREVEN NIET-NATUURLIJK PERSOON'&quot;;</span>
<span class="nc" id="L1359">        final String wordt = was.replace(&quot;'&quot;, &quot;&quot;);</span>
        // typering kolom is smaller dan clazz kolom
<span class="nc" id="L1361">        final int typeringColWidth = 35;</span>

        // betroffen tabel + kolom
<span class="nc" id="L1364">        final Map&lt;String, String&gt; tables =</span>
<span class="nc" id="L1365">                new HashMap&lt;&gt;() {</span>
                    {
<span class="nc" id="L1367">                        put(&quot;subject&quot;, &quot;clazz&quot;);</span>
<span class="nc" id="L1368">                        put(&quot;prs&quot;, &quot;clazz&quot;);</span>
<span class="nc" id="L1369">                        put(&quot;niet_nat_prs&quot;, &quot;clazz&quot;);</span>
<span class="nc" id="L1370">                        put(&quot;ingeschr_niet_nat_prs&quot;, &quot;typering&quot;);</span>
<span class="nc" id="L1371">                    }</span>
                };

<span class="nc bnc" id="L1374" title="All 2 branches missed.">        for (Map.Entry&lt;String, String&gt; table : tables.entrySet()) {</span>
<span class="nc" id="L1375">            int offset = 0;</span>
<span class="nc" id="L1376">            int batch = 1000;</span>

            final String _was =
<span class="nc bnc" id="L1379" title="All 2 branches missed.">                    (table.getValue().equalsIgnoreCase(&quot;typering&quot;)</span>
<span class="nc" id="L1380">                            ? &quot;'&quot; + was.substring(0, typeringColWidth)</span>
<span class="nc" id="L1381">                            : &quot;'&quot; + was + &quot;'&quot;);</span>
            final String _wordt =
<span class="nc bnc" id="L1383" title="All 2 branches missed.">                    (table.getValue().equalsIgnoreCase(&quot;typering&quot;)</span>
<span class="nc" id="L1384">                            ? wordt.substring(0, typeringColWidth)</span>
<span class="nc" id="L1385">                            : wordt);</span>

<span class="nc" id="L1387">            String countsql =</span>
                    &quot;select count(*) from &quot;
<span class="nc" id="L1389">                            + table.getKey()</span>
                            + &quot; where &quot;
<span class="nc" id="L1391">                            + table.getValue()</span>
                            + &quot; = '&quot;
                            + _was
                            + &quot;'&quot;;
<span class="nc" id="L1395">            LOG.debug(&quot;SQL voor tellen van berichten batch: &quot; + countsql);</span>

<span class="nc" id="L1397">            Number o =</span>
<span class="nc" id="L1398">                    new QueryRunner(geomToJdbc.isPmdKnownBroken())</span>
<span class="nc" id="L1399">                            .query(conn, countsql, new ScalarHandler&lt;&gt;());</span>
<span class="nc" id="L1400">            LOG.info(&quot;Totaal te bewerken records in tabel/kolom: &quot; + table + &quot; is: &quot; + o);</span>

<span class="nc bnc" id="L1402" title="All 2 branches missed.">            if (o instanceof BigDecimal) {</span>
<span class="nc" id="L1403">                total(this.total + o.longValue());</span>
<span class="nc bnc" id="L1404" title="All 2 branches missed.">            } else if (o instanceof Integer) {</span>
<span class="nc" id="L1405">                total(this.total + o.longValue());</span>
            } else {
<span class="nc" id="L1407">                total(this.total + (Long) o);</span>
            }

            do {
<span class="nc" id="L1411">                LOG.debug(</span>
<span class="nc" id="L1412">                        String.format(</span>
<span class="nc" id="L1413">                                &quot;Update berichten batch met offset %d, limit %d&quot;, offset, batch));</span>
<span class="nc" id="L1414">                String sql =</span>
                        &quot;select * from &quot;
<span class="nc" id="L1416">                                + table.getKey()</span>
                                + &quot; where &quot;
<span class="nc" id="L1418">                                + table.getValue()</span>
                                + &quot; = '&quot;
                                + _was
                                + &quot;'&quot;;
<span class="nc" id="L1422">                sql = geomToJdbc.buildPaginationSql(sql, offset, batch);</span>
<span class="nc" id="L1423">                LOG.trace(&quot;SQL voor ophalen berichten batch: &quot; + sql);</span>
<span class="nc" id="L1424">                _processed.setValue(0);</span>

<span class="nc" id="L1426">                Exception e =</span>
<span class="nc" id="L1427">                        new QueryRunner(geomToJdbc.isPmdKnownBroken())</span>
<span class="nc" id="L1428">                                .query(</span>
                                        conn,
                                        sql,
                                        rs -&gt; {
<span class="nc bnc" id="L1432" title="All 2 branches missed.">                                            while (rs.next()) {</span>
                                                try {
<span class="nc" id="L1434">                                                    new QueryRunner(geomToJdbc.isPmdKnownBroken())</span>
<span class="nc" id="L1435">                                                            .update(</span>
                                                                    conn,
                                                                    &quot;update &quot;
<span class="nc" id="L1438">                                                                            + table.getKey()</span>
                                                                            + &quot; set &quot;
<span class="nc" id="L1440">                                                                            + table.getValue()</span>
                                                                            + &quot; = '&quot;
                                                                            + _wordt
                                                                            + &quot;' where &quot;
<span class="nc" id="L1444">                                                                            + table.getValue()</span>
                                                                            + &quot; = '&quot;
                                                                            + _was
                                                                            + &quot;'&quot;);
<span class="nc" id="L1448">                                                } catch (Exception e1) {</span>
<span class="nc" id="L1449">                                                    return e1;</span>
<span class="nc" id="L1450">                                                }</span>
<span class="nc" id="L1451">                                                _processed.increment();</span>
                                            }
<span class="nc" id="L1453">                                            return null;</span>
                                        });
<span class="nc" id="L1455">                offset += _processed.intValue();</span>

<span class="nc" id="L1457">                progress(this.processed + _processed.intValue());</span>

<span class="nc bnc" id="L1459" title="All 2 branches missed.">                if (e != null) {</span>
<span class="nc" id="L1460">                    closeQuietly(conn);</span>
<span class="nc" id="L1461">                    throw e;</span>
                }
<span class="nc bnc" id="L1463" title="All 2 branches missed.">            } while (_processed.intValue() &gt; 0);</span>
<span class="nc" id="L1464">        }</span>
<span class="nc" id="L1465">        closeQuietly(conn);</span>
<span class="nc" id="L1466">    }</span>

    public void fillbestandsNaamHersteld(String soort, String config) throws Exception {
<span class="nc" id="L1469">        int offset = 0;</span>
<span class="nc" id="L1470">        int batch = 100;</span>
<span class="nc" id="L1471">        final MutableInt _processed = new MutableInt(0);</span>
<span class="nc" id="L1472">        final DataSource dataSourceRsgb = ConfigUtil.getDataSourceStaging();</span>
<span class="nc" id="L1473">        final Connection conn = dataSourceRsgb.getConnection();</span>
<span class="nc" id="L1474">        final GeometryJdbcConverter geomToJdbc =</span>
<span class="nc" id="L1475">                GeometryJdbcConverterFactory.getGeometryJdbcConverter(conn);</span>
<span class="nc" id="L1476">        final RowProcessor processor = new StagingRowHandler();</span>

<span class="nc" id="L1478">        String countsql =</span>
                &quot;select count(*) from &quot;
                        + BrmoFramework.BERICHT_TABLE
                        + &quot; where soort='&quot;
                        + soort
                        + &quot;' &quot;
                        + &quot; and volgordenummer &gt; &quot;
                        + config;

<span class="nc" id="L1487">        Number o =</span>
<span class="nc" id="L1488">                new QueryRunner(geomToJdbc.isPmdKnownBroken())</span>
<span class="nc" id="L1489">                        .query(conn, countsql, new ScalarHandler&lt;&gt;());</span>
<span class="nc bnc" id="L1490" title="All 2 branches missed.">        if (o instanceof BigDecimal) {</span>
<span class="nc" id="L1491">            total(o.longValue());</span>
<span class="nc bnc" id="L1492" title="All 2 branches missed.">        } else if (o instanceof Integer) {</span>
<span class="nc" id="L1493">            total(o.longValue());</span>
        } else {
<span class="nc" id="L1495">            total((Long) o);</span>
        }

        do {
<span class="nc" id="L1499">            LOG.debug(</span>
<span class="nc" id="L1500">                    String.format(</span>
                            &quot;Ophalen berichten batch met offset %d, limit %d, voortgang %f&quot;,
<span class="nc" id="L1502">                            offset, batch, progress));</span>
<span class="nc" id="L1503">            String sql =</span>
                    &quot;select * from &quot;
                            + BrmoFramework.BERICHT_TABLE
                            + &quot; where soort='&quot;
                            + soort
                            + &quot;' &quot;
                            + &quot; and volgordenummer &gt; &quot;
                            + config
                            + &quot; order by id &quot;;
<span class="nc" id="L1512">            sql = geomToJdbc.buildPaginationSql(sql, offset, batch);</span>
<span class="nc" id="L1513">            LOG.debug(&quot;SQL voor ophalen berichten batch: &quot; + sql);</span>

<span class="nc" id="L1515">            _processed.setValue(0);</span>
<span class="nc" id="L1516">            Exception e =</span>
<span class="nc" id="L1517">                    new QueryRunner(geomToJdbc.isPmdKnownBroken())</span>
<span class="nc" id="L1518">                            .query(</span>
                                    conn,
                                    sql,
                                    (ResultSetHandler&lt;Exception&gt;)
                                            rs -&gt; {
<span class="nc bnc" id="L1523" title="All 2 branches missed.">                                                while (rs.next()) {</span>
                                                    try {
<span class="nc" id="L1525">                                                        final Bericht bericht =</span>
<span class="nc" id="L1526">                                                                processor.toBean(rs, Bericht.class);</span>
<span class="nc" id="L1527">                                                        final BrkBericht brkBericht =</span>
<span class="nc" id="L1528">                                                                new BrkBericht(bericht.getBrXml());</span>
<span class="nc" id="L1529">                                                        brkBericht.setBrOrgineelXml(</span>
<span class="nc" id="L1530">                                                                bericht.getBrOrgineelXml());</span>
<span class="nc" id="L1531">                                                        final String bestandsnaamHersteld =</span>
<span class="nc" id="L1532">                                                                brkBericht.getRestoredFileName(</span>
<span class="nc" id="L1533">                                                                        bericht.getDatum(),</span>
                                                                        bericht
<span class="nc" id="L1535">                                                                                .getVolgordeNummer());</span>
<span class="nc" id="L1536">                                                        LOG.debug(</span>
<span class="nc" id="L1537">                                                                String.format(</span>
                                                                        &quot;Bijwerken bestand_naam_hersteld voor laadproces %d met waarde '%s' op basis van bericht %d&quot;,
<span class="nc" id="L1539">                                                                        bericht.getLaadProcesId(),</span>
                                                                        bestandsnaamHersteld,
<span class="nc" id="L1541">                                                                        bericht.getId()));</span>
<span class="nc" id="L1542">                                                        new QueryRunner(</span>
                                                                        geomToJdbc
<span class="nc" id="L1544">                                                                                .isPmdKnownBroken())</span>
<span class="nc" id="L1545">                                                                .update(</span>
                                                                        conn,
                                                                        &quot;update &quot;
                                                                                + BrmoFramework
                                                                                        .LAADPROCES_TABEL
                                                                                + &quot; set bestand_naam_hersteld = ? where id = ?&quot;,
                                                                        bestandsnaamHersteld,
<span class="nc" id="L1552">                                                                        bericht.getLaadProcesId());</span>
<span class="nc" id="L1553">                                                    } catch (SQLException e1) {</span>
<span class="nc" id="L1554">                                                        return e1;</span>
<span class="nc" id="L1555">                                                    }</span>
<span class="nc" id="L1556">                                                    _processed.increment();</span>
                                                }
<span class="nc" id="L1558">                                                return null;</span>
                                            });
<span class="nc" id="L1560">            offset += _processed.intValue();</span>

<span class="nc" id="L1562">            progress(this.processed + _processed.intValue());</span>

            // If handler threw exception processing row, rethrow it
<span class="nc bnc" id="L1565" title="All 2 branches missed.">            if (e != null) {</span>
<span class="nc" id="L1566">                closeQuietly(conn);</span>
<span class="nc" id="L1567">                throw e;</span>
            }
<span class="nc bnc" id="L1569" title="All 2 branches missed.">        } while (_processed.intValue() &gt; 0);</span>
<span class="nc" id="L1570">        closeQuietly(conn);</span>
<span class="nc" id="L1571">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>