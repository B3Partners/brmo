<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AdvancedFunctionsActionBean.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">BRMO service</a> &gt; <a href="index.source.html" class="el_package">nl.b3p.brmo.service.stripes</a> &gt; <span class="el_source">AdvancedFunctionsActionBean.java</span></div><h1>AdvancedFunctionsActionBean.java</h1><pre class="source lang-java linenums">package nl.b3p.brmo.service.stripes;

import static org.apache.commons.dbutils.DbUtils.closeQuietly;

import java.io.ByteArrayInputStream;
import java.io.InputStream;
import java.io.PrintWriter;
import java.io.StringWriter;
import java.math.BigDecimal;
import java.nio.charset.StandardCharsets;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Timestamp;
import java.util.Arrays;
import java.util.Calendar;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import javax.sql.DataSource;
import net.sourceforge.stripes.action.ActionBean;
import net.sourceforge.stripes.action.ActionBeanContext;
import net.sourceforge.stripes.action.Before;
import net.sourceforge.stripes.action.DefaultHandler;
import net.sourceforge.stripes.action.ForwardResolution;
import net.sourceforge.stripes.action.Resolution;
import net.sourceforge.stripes.action.SimpleMessage;
import net.sourceforge.stripes.action.StrictBinding;
import net.sourceforge.stripes.controller.LifecycleStage;
import net.sourceforge.stripes.validation.Validate;
import nl.b3p.brmo.loader.BrmoFramework;
import nl.b3p.brmo.loader.ProgressUpdateListener;
import nl.b3p.brmo.loader.RsgbProxy;
import nl.b3p.brmo.loader.StagingProxy;
import nl.b3p.brmo.loader.advancedfunctions.AdvancedFunctionProcess;
import nl.b3p.brmo.loader.entity.Bericht;
import nl.b3p.brmo.loader.util.BrmoException;
import nl.b3p.brmo.loader.util.StagingRowHandler;
import nl.b3p.brmo.loader.xml.WozXMLReader;
import nl.b3p.brmo.service.util.ConfigUtil;
import nl.b3p.jdbc.util.converter.GeometryJdbcConverter;
import nl.b3p.jdbc.util.converter.GeometryJdbcConverterFactory;
import org.apache.commons.dbutils.QueryRunner;
import org.apache.commons.dbutils.RowProcessor;
import org.apache.commons.dbutils.handlers.ScalarHandler;
import org.apache.commons.lang3.exception.ExceptionUtils;
import org.apache.commons.lang3.mutable.MutableInt;
import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import org.stripesstuff.plugin.waitpage.WaitPage;

/**
 * @author Chris van Lith
 * @author mprins
 */
@StrictBinding
<span class="nc" id="L59">public class AdvancedFunctionsActionBean implements ActionBean, ProgressUpdateListener {</span>

<span class="nc" id="L61">  private static final Log LOG = LogFactory.getLog(AdvancedFunctionsActionBean.class);</span>

  private static final String JSP = &quot;/WEB-INF/jsp/transform/advancedfunctions.jsp&quot;;
  private static final String JSP_PROGRESS = &quot;/WEB-INF/jsp/transform/advancedfunctionsprogress.jsp&quot;;

  private ActionBeanContext context;

  private List&lt;AdvancedFunctionProcess&gt; advancedFunctionProcesses;

  @Validate(required = true, on = &quot;perform&quot;)
  private String advancedFunctionProcessName;

  private double progress;
  private long total;
  private long processed;
  private boolean complete;
  private Date start;
  private Date update;
  private String exceptionStacktrace;

<span class="nc" id="L81">  private final String NHR_FIX_TYPERING = &quot;Fix 'typering' en 'clazz' van nHR persoon&quot;;</span>
<span class="nc" id="L82">  private final String NHR_ARCHIVING =</span>
      &quot;Opschonen en archiveren van nHR berichten met status RSGB_OK, ouder dan 3 maanden&quot;;
<span class="nc" id="L84">  private final String NHR_REMOVAL = &quot;Verwijderen van nHR berichten met status ARCHIVE&quot;;</span>
<span class="nc" id="L85">  private final String NHR_OPNIEUW_VERWERKEN = &quot;Opnieuw verwerken van nHR berichten&quot;;</span>
<span class="nc" id="L86">  private final String WOZ_OPNIEUW_VERWERKING = &quot;Originele WOZ berichten opnieuw verwerken&quot;;</span>

  // &lt;editor-fold defaultstate=&quot;collapsed&quot; desc=&quot;getters en setters&quot;&gt;
  @Override
  public ActionBeanContext getContext() {
<span class="nc" id="L91">    return context;</span>
  }

  @Override
  public void setContext(ActionBeanContext context) {
<span class="nc" id="L96">    this.context = context;</span>
<span class="nc" id="L97">  }</span>

  public double getProgress() {
<span class="nc" id="L100">    return progress;</span>
  }

  public void setProgress(double progress) {
<span class="nc" id="L104">    this.progress = progress;</span>
<span class="nc" id="L105">  }</span>

  public long getTotal() {
<span class="nc" id="L108">    return total;</span>
  }

  public void setTotal(long total) {
<span class="nc" id="L112">    this.total = total;</span>
<span class="nc" id="L113">  }</span>

  public long getProcessed() {
<span class="nc" id="L116">    return processed;</span>
  }

  public void setProcessed(long processed) {
<span class="nc" id="L120">    this.processed = processed;</span>
<span class="nc" id="L121">  }</span>

  public boolean isComplete() {
<span class="nc" id="L124">    return complete;</span>
  }

  public void setComplete(boolean complete) {
<span class="nc" id="L128">    this.complete = complete;</span>
<span class="nc" id="L129">  }</span>

  public Date getStart() {
<span class="nc" id="L132">    return start;</span>
  }

  public void setStart(Date start) {
<span class="nc" id="L136">    this.start = start;</span>
<span class="nc" id="L137">  }</span>

  public Date getUpdate() {
<span class="nc" id="L140">    return update;</span>
  }

  public void setUpdate(Date update) {
<span class="nc" id="L144">    this.update = update;</span>
<span class="nc" id="L145">  }</span>

  public String getExceptionStacktrace() {
<span class="nc" id="L148">    return exceptionStacktrace;</span>
  }

  public void setExceptionStacktrace(String exceptionStacktrace) {
<span class="nc" id="L152">    this.exceptionStacktrace = exceptionStacktrace;</span>
<span class="nc" id="L153">  }</span>

  @Override
  public void total(long total) {
<span class="nc" id="L157">    this.total = total;</span>
<span class="nc" id="L158">  }</span>

  @Override
  public void progress(long progress) {
<span class="nc" id="L162">    this.processed = progress;</span>
<span class="nc bnc" id="L163" title="All 2 branches missed.">    if (this.total != 0) {</span>
<span class="nc" id="L164">      this.progress = (100.0 / this.total) * this.processed;</span>
    }
<span class="nc" id="L166">    this.update = new Date();</span>
<span class="nc" id="L167">  }</span>

  @Override
  public void exception(Throwable t) {
<span class="nc" id="L171">    StringWriter sw = new StringWriter();</span>
<span class="nc" id="L172">    t.printStackTrace(new PrintWriter(sw));</span>
<span class="nc" id="L173">    this.exceptionStacktrace = sw.toString();</span>
<span class="nc" id="L174">  }</span>

  public List&lt;AdvancedFunctionProcess&gt; getAdvancedFunctionProcesses() {
<span class="nc" id="L177">    return advancedFunctionProcesses;</span>
  }

  public void setAdvancedFunctionProcesses(
      List&lt;AdvancedFunctionProcess&gt; advancedFunctionProcesses) {
<span class="nc" id="L182">    this.advancedFunctionProcesses = advancedFunctionProcesses;</span>
<span class="nc" id="L183">  }</span>

  public String getAdvancedFunctionProcessName() {
<span class="nc" id="L186">    return advancedFunctionProcessName;</span>
  }

  public void setAdvancedFunctionProcessName(String advancedFunctionProcessName) {
<span class="nc" id="L190">    this.advancedFunctionProcessName = advancedFunctionProcessName;</span>
<span class="nc" id="L191">  }</span>

  // &lt;/editor-fold&gt;

  @Before(stages = LifecycleStage.BindingAndValidation)
  public void populateAdvancedFunctionProcesses() {
    // bij een nieuw proces ook de wiki bijwerken:
    // https://github.com/B3Partners/brmo/wiki/Geavanceerde-functies
<span class="nc" id="L199">    advancedFunctionProcesses =</span>
<span class="nc" id="L200">        Arrays.asList(</span>
            new AdvancedFunctionProcess(
<span class="nc" id="L202">                NHR_ARCHIVING, BrmoFramework.BR_NHR, Bericht.STATUS.RSGB_OK.toString()),</span>
            new AdvancedFunctionProcess(
<span class="nc" id="L204">                NHR_REMOVAL, BrmoFramework.BR_NHR, Bericht.STATUS.ARCHIVE.toString()),</span>
            new AdvancedFunctionProcess(NHR_FIX_TYPERING, BrmoFramework.BR_NHR, null),
            new AdvancedFunctionProcess(NHR_OPNIEUW_VERWERKEN, BrmoFramework.BR_NHR, null),
            new AdvancedFunctionProcess(WOZ_OPNIEUW_VERWERKING, BrmoFramework.BR_WOZ, null));
<span class="nc" id="L208">  }</span>

  @DefaultHandler
  public Resolution form() {
<span class="nc bnc" id="L212" title="All 2 branches missed.">    return new ForwardResolution(complete ? JSP_PROGRESS : JSP);</span>
  }

  @WaitPage(path = JSP_PROGRESS, delay = 1000, refresh = 1000)
  public Resolution perform() {
<span class="nc" id="L217">    AdvancedFunctionProcess process = null;</span>

<span class="nc bnc" id="L219" title="All 2 branches missed.">    for (AdvancedFunctionProcess p : advancedFunctionProcesses) {</span>
<span class="nc bnc" id="L220" title="All 2 branches missed.">      if (p.getName().equals(advancedFunctionProcessName)) {</span>
<span class="nc" id="L221">        process = p;</span>
<span class="nc" id="L222">        break;</span>
      }
<span class="nc" id="L224">    }</span>
<span class="nc bnc" id="L225" title="All 2 branches missed.">    if (process == null) {</span>
<span class="nc" id="L226">      getContext().getMessages().add(new SimpleMessage(&quot;Ongeldig proces&quot;));</span>
<span class="nc" id="L227">      return new ForwardResolution(JSP);</span>
    }

<span class="nc" id="L230">    start = new Date();</span>
<span class="nc" id="L231">    LOG.info(&quot;Start process: &quot; + process.getName());</span>
<span class="nc" id="L232">    processed = 0;</span>

    // Get berichten
    try {
<span class="nc bnc" id="L236" title="All 6 branches missed.">      switch (process.getName()) {</span>
        case NHR_ARCHIVING:
<span class="nc" id="L238">          cleanupBerichten(process.getConfig(), BrmoFramework.BR_NHR);</span>
<span class="nc" id="L239">          break;</span>
        case NHR_REMOVAL:
<span class="nc" id="L241">          deleteBerichten(process.getConfig(), BrmoFramework.BR_NHR);</span>
<span class="nc" id="L242">          break;</span>
        case NHR_OPNIEUW_VERWERKEN:
<span class="nc" id="L244">          replayNHRVerwerking(process.getSoort(), process.getConfig());</span>
<span class="nc" id="L245">          break;</span>
        case NHR_FIX_TYPERING:
<span class="nc" id="L247">          fixNHRTypering(process.getSoort(), process.getConfig());</span>
<span class="nc" id="L248">          break;</span>
        case WOZ_OPNIEUW_VERWERKING:
<span class="nc" id="L250">          replayWOZVerwerking();</span>
          break;
      }

<span class="nc bnc" id="L254" title="All 2 branches missed.">      if (this.exceptionStacktrace == null) {</span>
<span class="nc" id="L255">        getContext().getMessages().add(new SimpleMessage(&quot;Geavanceerde functie afgerond.&quot;));</span>
      }
<span class="nc" id="L257">    } catch (Throwable t) {</span>
<span class="nc" id="L258">      LOG.error(&quot;Fout bij uitvoeren geavanceerde functie&quot;, t);</span>
<span class="nc" id="L259">      String m = &quot;Fout bij uitvoeren geavanceerde functie: &quot; + ExceptionUtils.getMessage(t);</span>
<span class="nc bnc" id="L260" title="All 2 branches missed.">      if (t.getCause() != null) {</span>
<span class="nc" id="L261">        m += &quot;, oorzaak: &quot; + ExceptionUtils.getRootCauseMessage(t);</span>
      }
<span class="nc" id="L263">      getContext().getMessages().add(new SimpleMessage(m));</span>
    } finally {
<span class="nc" id="L265">      complete = true;</span>
    }
<span class="nc" id="L267">    return new ForwardResolution(JSP_PROGRESS);</span>
  }

  private void replayWOZVerwerking() throws Exception {
<span class="nc" id="L271">    final DataSource dataSourceStaging = ConfigUtil.getDataSourceStaging();</span>
<span class="nc" id="L272">    StagingProxy stagingProxy = new StagingProxy(dataSourceStaging);</span>

<span class="nc" id="L274">    try (Connection conn = dataSourceStaging.getConnection()) {</span>
<span class="nc" id="L275">      final GeometryJdbcConverter geomToJdbc =</span>
<span class="nc" id="L276">          GeometryJdbcConverterFactory.getGeometryJdbcConverter(conn);</span>

<span class="nc" id="L278">      Number o =</span>
<span class="nc" id="L279">          new QueryRunner(geomToJdbc.isPmdKnownBroken())</span>
<span class="nc" id="L280">              .query(conn, &quot;SELECT count(*) FROM eerder_geladen_woz&quot;, new ScalarHandler&lt;&gt;());</span>
<span class="nc" id="L281">      int count = o.intValue();</span>

<span class="nc" id="L283">      this.total(count);</span>
<span class="nc" id="L284">      LOG.info(&quot;Aantal te verwerken WOZ berichten: &quot; + count);</span>

<span class="nc" id="L286">      int offset = 0;</span>
<span class="nc" id="L287">      int batch = 10000;</span>
<span class="nc" id="L288">      final String selectSql =</span>
          &quot;SELECT id, br_orgineel_xml, laadprocesid, datum FROM eerder_geladen_woz&quot;;
      Bericht b;
<span class="nc bnc" id="L291" title="All 2 branches missed.">      while (offset &lt; count) {</span>
<span class="nc" id="L292">        LOG.info(</span>
            &quot;Ophalen WOZ berichten vanaf offset: &quot;
                + offset
                + &quot; tot: &quot;
                + (offset + batch)
                + &quot; van: &quot;
                + count);
<span class="nc" id="L299">        PreparedStatement ps =</span>
<span class="nc" id="L300">            conn.prepareStatement(geomToJdbc.buildPaginationSql(selectSql, offset, batch));</span>
<span class="nc" id="L301">        ResultSet rs = ps.executeQuery();</span>
<span class="nc bnc" id="L302" title="All 2 branches missed.">        while (rs.next()) {</span>
<span class="nc" id="L303">          LOG.trace(</span>
              &quot;Verwerken WOZ bericht voor laadprocesid: &quot;
<span class="nc" id="L305">                  + rs.getLong(&quot;laadprocesid&quot;)</span>
                  + &quot; met id: &quot;
<span class="nc" id="L307">                  + rs.getLong(&quot;id&quot;));</span>
<span class="nc" id="L308">          InputStream origineelXMLInputStream =</span>
              new ByteArrayInputStream(
<span class="nc" id="L310">                  rs.getString(&quot;br_orgineel_xml&quot;).getBytes(StandardCharsets.UTF_8));</span>
<span class="nc" id="L311">          WozXMLReader reader =</span>
              new WozXMLReader(origineelXMLInputStream, /*rs.getDate(&quot;datum&quot;)*/ null, stagingProxy);

<span class="nc bnc" id="L314" title="All 2 branches missed.">          while (reader.hasNext()) {</span>
<span class="nc" id="L315">            b = reader.next();</span>
<span class="nc" id="L316">            b.setLaadProcesId(rs.getLong(&quot;laadprocesid&quot;));</span>
<span class="nc" id="L317">            b.setStatus(Bericht.STATUS.STAGING_OK);</span>
<span class="nc" id="L318">            b.setStatusDatum(new Date());</span>
<span class="nc" id="L319">            b.setSoort(BrmoFramework.BR_WOZ);</span>
<span class="nc" id="L320">            b.setOpmerking(&quot;Herstel van eerder geladen WOZ bericht&quot;);</span>
<span class="nc bnc" id="L321" title="All 2 branches missed.">            if (null == b.getObjectRef()) {</span>
<span class="nc" id="L322">              b.setStatus(Bericht.STATUS.STAGING_NOK);</span>
<span class="nc" id="L323">              b.setOpmerking(Bericht.GEEN_OBJECT_REF_MSG);</span>
            }

            Bericht existingBericht;
<span class="nc bnc" id="L327" title="All 2 branches missed.">            if (b.getVolgordeNummer() == 1) {</span>
<span class="nc" id="L328">              existingBericht = stagingProxy.getBerichtById(rs.getLong(&quot;id&quot;));</span>
            } else {
<span class="nc" id="L330">              existingBericht = stagingProxy.getExistingBericht(b);</span>
            }

<span class="nc bnc" id="L333" title="All 2 branches missed.">            if (existingBericht == null) {</span>
<span class="nc" id="L334">              stagingProxy.writeBericht(b);</span>
            } else {
<span class="nc" id="L336">              b.setId(existingBericht.getId());</span>
<span class="nc" id="L337">              stagingProxy.updateBericht(b);</span>
            }
<span class="nc" id="L339">          }</span>
<span class="nc" id="L340">          processed++;</span>
<span class="nc" id="L341">        }</span>
<span class="nc" id="L342">        closeQuietly(rs);</span>
<span class="nc" id="L343">        closeQuietly(ps);</span>
<span class="nc" id="L344">        offset += batch;</span>
<span class="nc" id="L345">        progress(processed);</span>
<span class="nc" id="L346">      }</span>
    } finally {
<span class="nc" id="L348">      stagingProxy.closeStagingProxy();</span>
<span class="nc" id="L349">      LOG.info(&quot;Originele WOZ berichten opnieuw verwerken afgerond.&quot;);</span>
    }
<span class="nc" id="L351">  }</span>

  public void cleanupBerichten(String config, String soort) throws Exception {
<span class="nc" id="L354">    final int offset = 0;</span>
<span class="nc" id="L355">    int progress = 0;</span>
<span class="nc" id="L356">    int batch = 1000;</span>
<span class="nc" id="L357">    final MutableInt processed = new MutableInt(0);</span>
<span class="nc" id="L358">    final DataSource dataSourceStaging = ConfigUtil.getDataSourceStaging();</span>
<span class="nc" id="L359">    final Connection conn = dataSourceStaging.getConnection();</span>
<span class="nc" id="L360">    final GeometryJdbcConverter geomToJdbc =</span>
<span class="nc" id="L361">        GeometryJdbcConverterFactory.getGeometryJdbcConverter(conn);</span>
<span class="nc" id="L362">    final RowProcessor processor = new StagingRowHandler();</span>

<span class="nc" id="L364">    Calendar c = Calendar.getInstance();</span>
<span class="nc" id="L365">    c.setTime(new Date());</span>
<span class="nc" id="L366">    c.add(Calendar.MONTH, -3);</span>

<span class="nc" id="L368">    String countsql =</span>
        &quot;select count(*) from &quot;
            + BrmoFramework.BERICHT_TABLE
            + &quot; where soort='&quot;
            + soort
            + &quot;' &quot;
            + &quot; and status='&quot;
            + config
            + &quot;'&quot;
            + &quot; and status_datum &lt; ? &quot;;
<span class="nc" id="L378">    Number o =</span>
<span class="nc" id="L379">        new QueryRunner(geomToJdbc.isPmdKnownBroken())</span>
<span class="nc" id="L380">            .query(conn, countsql, new ScalarHandler&lt;&gt;(), new Timestamp(c.getTimeInMillis()));</span>
<span class="nc bnc" id="L381" title="All 2 branches missed.">    if (o instanceof BigDecimal) {</span>
<span class="nc" id="L382">      total(o.longValue());</span>
<span class="nc bnc" id="L383" title="All 2 branches missed.">    } else if (o instanceof Integer) {</span>
<span class="nc" id="L384">      total(o.longValue());</span>
    } else {
<span class="nc" id="L386">      total((Long) o);</span>
    }

    do {
<span class="nc" id="L390">      LOG.debug(</span>
<span class="nc" id="L391">          String.format(</span>
              &quot;Ophalen berichten batch met offset %d, limit %d, tot datum %tc, voortgang %d&quot;,
<span class="nc" id="L393">              offset, batch, c, progress));</span>
<span class="nc" id="L394">      String sql =</span>
          &quot;select * from &quot;
              + BrmoFramework.BERICHT_TABLE
              + &quot; where soort='&quot;
              + soort
              + &quot;' &quot;
              + &quot; and status='&quot;
              + config
              + &quot;'&quot;
              + &quot; and status_datum &lt; ? &quot;
              + &quot; order by id &quot;;
<span class="nc" id="L405">      sql = geomToJdbc.buildPaginationSql(sql, offset, batch);</span>
<span class="nc" id="L406">      LOG.debug(&quot;SQL voor ophalen berichten batch: &quot; + sql);</span>

<span class="nc" id="L408">      processed.setValue(0);</span>
<span class="nc" id="L409">      Exception e =</span>
<span class="nc" id="L410">          new QueryRunner(geomToJdbc.isPmdKnownBroken())</span>
<span class="nc" id="L411">              .query(</span>
                  conn,
                  sql,
                  rs -&gt; {
<span class="nc bnc" id="L415" title="All 2 branches missed.">                    while (rs.next()) {</span>
                      try {
<span class="nc" id="L417">                        Bericht bericht = processor.toBean(rs, Bericht.class);</span>

<span class="nc" id="L419">                        bericht.setBrOrgineelXml(&quot;opgeschoond&quot;);</span>
<span class="nc" id="L420">                        bericht.setBrXml(&quot;opgeschoond&quot;);</span>
<span class="nc" id="L421">                        bericht.setOpmerking(</span>
<span class="nc" id="L422">                            &quot;opgeschoond, status was: &quot; + bericht.getStatus().toString());</span>
<span class="nc" id="L423">                        bericht.setStatus(Bericht.STATUS.ARCHIVE);</span>
<span class="nc" id="L424">                        bericht.setStatusDatum(new Date());</span>

<span class="nc" id="L426">                        new QueryRunner(geomToJdbc.isPmdKnownBroken())</span>
<span class="nc" id="L427">                            .update(</span>
                                conn,
                                &quot;update &quot;
                                    + BrmoFramework.BERICHT_TABLE
                                    + &quot; set status_datum = ?, status = ?, opmerking = ?, br_xml = ?, br_orgineel_xml = ? where id = ?&quot;,
<span class="nc" id="L432">                                new Timestamp(bericht.getStatusDatum().getTime()),</span>
<span class="nc" id="L433">                                bericht.getStatus().toString(),</span>
<span class="nc" id="L434">                                bericht.getOpmerking(),</span>
<span class="nc" id="L435">                                bericht.getBrXml(),</span>
<span class="nc" id="L436">                                bericht.getBrOrgineelXml(),</span>
<span class="nc" id="L437">                                bericht.getId());</span>

<span class="nc" id="L439">                      } catch (Exception e1) {</span>
<span class="nc" id="L440">                        return e1;</span>
<span class="nc" id="L441">                      }</span>
<span class="nc" id="L442">                      processed.increment();</span>
                    }
<span class="nc" id="L444">                    return null;</span>
                  },
<span class="nc" id="L446">                  new Timestamp(c.getTimeInMillis()));</span>
<span class="nc" id="L447">      progress += processed.intValue();</span>

<span class="nc" id="L449">      progress(progress);</span>

      // If handler threw exception processing row, rethrow it
<span class="nc bnc" id="L452" title="All 2 branches missed.">      if (e != null) {</span>
<span class="nc" id="L453">        closeQuietly(conn);</span>
<span class="nc" id="L454">        throw e;</span>
      }
<span class="nc bnc" id="L456" title="All 2 branches missed.">    } while (processed.intValue() &gt; 0);</span>
<span class="nc" id="L457">    closeQuietly(conn);</span>
<span class="nc" id="L458">  }</span>

  public void deleteBerichten(String config, String soort) throws Exception {
<span class="nc" id="L461">    final DataSource dataSourceStaging = ConfigUtil.getDataSourceStaging();</span>
<span class="nc" id="L462">    final Connection conn = dataSourceStaging.getConnection();</span>
<span class="nc" id="L463">    final GeometryJdbcConverter geomToJdbc =</span>
<span class="nc" id="L464">        GeometryJdbcConverterFactory.getGeometryJdbcConverter(conn);</span>

<span class="nc" id="L466">    String countsql =</span>
        &quot;select count(*) from &quot;
            + BrmoFramework.BERICHT_TABLE
            + &quot; WHERE soort='&quot;
            + soort
            + &quot;' &quot;
            + &quot; AND status='&quot;
            + config
            + &quot;'&quot;;
<span class="nc" id="L475">    Number o =</span>
<span class="nc" id="L476">        new QueryRunner(geomToJdbc.isPmdKnownBroken()).query(conn, countsql, new ScalarHandler&lt;&gt;());</span>
<span class="nc bnc" id="L477" title="All 2 branches missed.">    if (o instanceof BigDecimal) {</span>
<span class="nc" id="L478">      total(o.longValue());</span>
<span class="nc bnc" id="L479" title="All 2 branches missed.">    } else if (o instanceof Integer) {</span>
<span class="nc" id="L480">      total(o.longValue());</span>
    } else {
<span class="nc" id="L482">      total((Long) o);</span>
    }
<span class="nc" id="L484">    LOG.debug(&quot;Totaal te verwijderen &quot; + config + &quot; berichten: &quot; + o);</span>

<span class="nc" id="L486">    o =</span>
<span class="nc" id="L487">        new QueryRunner(geomToJdbc.isPmdKnownBroken())</span>
<span class="nc" id="L488">            .update(</span>
                conn,
                &quot;DELETE FROM &quot;
                    + BrmoFramework.BERICHT_TABLE
                    + &quot; WHERE soort='&quot;
                    + soort
                    + &quot;' &quot;
                    + &quot; AND status='&quot;
                    + config
                    + &quot;'&quot;);

<span class="nc bnc" id="L499" title="All 2 branches missed.">    if (o instanceof BigDecimal) {</span>
<span class="nc" id="L500">      progress(o.longValue());</span>
<span class="nc bnc" id="L501" title="All 2 branches missed.">    } else if (o instanceof Integer) {</span>
<span class="nc" id="L502">      progress(o.longValue());</span>
    } else {
<span class="nc" id="L504">      progress((Long) o);</span>
    }
<span class="nc" id="L506">    closeQuietly(conn);</span>
<span class="nc" id="L507">  }</span>

  /**
   * Deze actie verwerkt alle NHR berichten met status RSGB_NOK opnieuw.
   *
   * @param status bericht status
   * @param soort soort bericht
   * @throws SQLException if any
   * @throws BrmoException if any
   * @throws Exception if any
   */
  public void replayNHRVerwerking(String soort, String status)
      throws SQLException, BrmoException, Exception {
<span class="nc" id="L520">    int offset = 0;</span>
<span class="nc" id="L521">    int batch = 1000;</span>
<span class="nc" id="L522">    final MutableInt processed = new MutableInt(0);</span>
<span class="nc" id="L523">    final DataSource dataSourceStaging = ConfigUtil.getDataSourceStaging();</span>
<span class="nc" id="L524">    final DataSource dataSourceRsgb = ConfigUtil.getDataSourceRsgb();</span>
<span class="nc" id="L525">    final Connection conn = dataSourceStaging.getConnection();</span>
<span class="nc" id="L526">    final GeometryJdbcConverter geomToJdbc =</span>
<span class="nc" id="L527">        GeometryJdbcConverterFactory.getGeometryJdbcConverter(conn);</span>
<span class="nc" id="L528">    final RowProcessor processor = new StagingRowHandler();</span>

<span class="nc" id="L530">    LOG.debug(&quot;staging datasource: &quot; + dataSourceStaging);</span>
<span class="nc" id="L531">    LOG.debug(&quot;rsgb datasource: &quot; + dataSourceRsgb);</span>

<span class="nc" id="L533">    String countsql =</span>
        &quot;select count(id) from &quot;
            + BrmoFramework.BERICHT_TABLE
            + &quot; where soort='&quot;
            + soort
            + &quot;'&quot;
            + &quot; and status='&quot;
            + status
            + &quot;'&quot;;
<span class="nc" id="L542">    LOG.debug(&quot;SQL voor tellen van berichten batch: &quot; + countsql);</span>
<span class="nc" id="L543">    Number o =</span>
<span class="nc" id="L544">        new QueryRunner(geomToJdbc.isPmdKnownBroken()).query(conn, countsql, new ScalarHandler&lt;&gt;());</span>
<span class="nc" id="L545">    LOG.debug(&quot;Totaal te verwerken verwijder berichten: &quot; + o);</span>

<span class="nc bnc" id="L547" title="All 2 branches missed.">    if (o instanceof BigDecimal) {</span>
<span class="nc" id="L548">      total(o.longValue());</span>
<span class="nc bnc" id="L549" title="All 2 branches missed.">    } else if (o instanceof Integer) {</span>
<span class="nc" id="L550">      total(o.longValue());</span>
    } else {
<span class="nc" id="L552">      total((Long) o);</span>
    }

<span class="nc" id="L555">    StagingProxy staging = new StagingProxy(dataSourceStaging);</span>
<span class="nc" id="L556">    RsgbProxy rsgb = new RsgbProxy(dataSourceRsgb, null, staging, Bericht.STATUS.RSGB_NOK, this);</span>
<span class="nc" id="L557">    rsgb.setErrorState(getContext().getServletContext().getInitParameter(&quot;error.state&quot;));</span>
<span class="nc" id="L558">    rsgb.setOrderBerichten(true);</span>
<span class="nc" id="L559">    rsgb.init();</span>

    do {
<span class="nc" id="L562">      LOG.debug(String.format(&quot;Ophalen berichten batch met offset %d, limit %d&quot;, offset, batch));</span>
<span class="nc" id="L563">      String sql =</span>
          &quot;select * from &quot;
              + BrmoFramework.BERICHT_TABLE
              + &quot; where soort='&quot;
              + soort
              + &quot;'&quot;
              + &quot; and status='&quot;
              + status
              + &quot;'&quot;
              + &quot; order by id&quot;;
<span class="nc" id="L573">      sql = geomToJdbc.buildPaginationSql(sql, offset, batch);</span>
<span class="nc" id="L574">      LOG.debug(&quot;SQL voor ophalen berichten batch: &quot; + sql);</span>

<span class="nc" id="L576">      processed.setValue(0);</span>
<span class="nc" id="L577">      Exception e =</span>
<span class="nc" id="L578">          new QueryRunner(geomToJdbc.isPmdKnownBroken())</span>
<span class="nc" id="L579">              .query(</span>
                  conn,
                  sql,
                  rs -&gt; {
<span class="nc bnc" id="L583" title="All 2 branches missed.">                    while (rs.next()) {</span>
                      try {
<span class="nc" id="L585">                        Bericht bericht = processor.toBean(rs, Bericht.class);</span>
<span class="nc" id="L586">                        LOG.debug(&quot;Opnieuw verwerken van bericht: &quot; + bericht);</span>
                        // bewaar oude log
<span class="nc" id="L588">                        String oudeOpmerkingen = bericht.getOpmerking();</span>
                        // forceer verwerking door bericht op STAGING_OK te
                        // zetten en dan opnieuw te verwerken
<span class="nc" id="L591">                        bericht.setStatus(Bericht.STATUS.STAGING_OK);</span>
<span class="nc" id="L592">                        new QueryRunner(geomToJdbc.isPmdKnownBroken())</span>
<span class="nc" id="L593">                            .update(</span>
                                conn,
                                &quot;update &quot;
                                    + BrmoFramework.BERICHT_TABLE
                                    + &quot; set status_datum = ?, status = ? where id = ?&quot;,
<span class="nc" id="L598">                                new Timestamp(bericht.getStatusDatum().getTime()),</span>
<span class="nc" id="L599">                                bericht.getStatus().toString(),</span>
<span class="nc" id="L600">                                bericht.getId());</span>

<span class="nc" id="L602">                        rsgb.handle(bericht, rsgb.transformToTableData(bericht), true);</span>

<span class="nc" id="L604">                        bericht.setOpmerking(</span>
                            &quot;Opnieuw verwerkt met geavanceerde functies optie.\nNieuwe verwerkingslog (oude log daaronder)\n&quot;
<span class="nc" id="L606">                                + bericht.getOpmerking()</span>
                                + &quot;\n\nOude verwerkingslog\n\n&quot;
                                + oudeOpmerkingen);
<span class="nc" id="L609">                        bericht.setStatusDatum(new Date());</span>
<span class="nc" id="L610">                        new QueryRunner(geomToJdbc.isPmdKnownBroken())</span>
<span class="nc" id="L611">                            .update(</span>
                                conn,
                                &quot;update &quot;
                                    + BrmoFramework.BERICHT_TABLE
                                    + &quot; set opmerking = ? where id = ?&quot;,
<span class="nc" id="L616">                                bericht.getOpmerking(),</span>
<span class="nc" id="L617">                                bericht.getId());</span>
<span class="nc" id="L618">                      } catch (Exception e1) {</span>
<span class="nc" id="L619">                        return e1;</span>
<span class="nc" id="L620">                      }</span>
<span class="nc" id="L621">                      processed.increment();</span>
                    }
<span class="nc" id="L623">                    return null;</span>
                  });
<span class="nc" id="L625">      offset += processed.intValue();</span>

<span class="nc" id="L627">      progress(offset);</span>

      // If handler threw exception processing row, rethrow it
<span class="nc bnc" id="L630" title="All 2 branches missed.">      if (e != null) {</span>
<span class="nc" id="L631">        closeQuietly(conn);</span>
<span class="nc" id="L632">        throw e;</span>
      }
<span class="nc bnc" id="L634" title="All 2 branches missed.">    } while (processed.intValue() &gt; 0);</span>
<span class="nc" id="L635">    closeQuietly(conn);</span>
<span class="nc" id="L636">    rsgb.close();</span>
<span class="nc" id="L637">  }</span>

  /**
   * Verwijderen van enkele aanhalingstekens van typering en clazz van sommige nHR persoon records
   * door middel van SQL update. Fix voor issue #527, {@code 'INGESCHREVEN NIET-NATUURLIJK PERSOON'}
   * moet worden {@code INGESCHREVEN NIET-NATUURLIJK PERSOON} (evt. afgekort op 35 char voor de
   * 'ingeschr_niet_nat_prs' tabel/'typering' kolom)
   *
   * @param soort soort bericht
   * @param status bericht status
   * @throws SQLException if any
   * @throws BrmoException if any
   * @throws Exception if any
   */
  public void fixNHRTypering(String soort, String status)
      throws SQLException, BrmoException, Exception {

<span class="nc" id="L654">    final MutableInt _processed = new MutableInt(0);</span>
<span class="nc" id="L655">    final DataSource dataSourceRsgb = ConfigUtil.getDataSourceRsgb();</span>
<span class="nc" id="L656">    final Connection conn = dataSourceRsgb.getConnection();</span>
<span class="nc" id="L657">    final GeometryJdbcConverter geomToJdbc =</span>
<span class="nc" id="L658">        GeometryJdbcConverterFactory.getGeometryJdbcConverter(conn);</span>

<span class="nc" id="L660">    final String was = &quot;'INGESCHREVEN NIET-NATUURLIJK PERSOON'&quot;;</span>
<span class="nc" id="L661">    final String wordt = was.replace(&quot;'&quot;, &quot;&quot;);</span>
    // typering kolom is smaller dan clazz kolom
<span class="nc" id="L663">    final int typeringColWidth = 35;</span>

    // betroffen tabel + kolom
<span class="nc" id="L666">    final Map&lt;String, String&gt; tables =</span>
<span class="nc" id="L667">        new HashMap&lt;&gt;() {</span>
          {
<span class="nc" id="L669">            put(&quot;subject&quot;, &quot;clazz&quot;);</span>
<span class="nc" id="L670">            put(&quot;prs&quot;, &quot;clazz&quot;);</span>
<span class="nc" id="L671">            put(&quot;niet_nat_prs&quot;, &quot;clazz&quot;);</span>
<span class="nc" id="L672">            put(&quot;ingeschr_niet_nat_prs&quot;, &quot;typering&quot;);</span>
<span class="nc" id="L673">          }</span>
        };

<span class="nc bnc" id="L676" title="All 2 branches missed.">    for (Map.Entry&lt;String, String&gt; table : tables.entrySet()) {</span>
<span class="nc" id="L677">      int offset = 0;</span>
<span class="nc" id="L678">      int batch = 1000;</span>

      final String _was =
<span class="nc bnc" id="L681" title="All 2 branches missed.">          (table.getValue().equalsIgnoreCase(&quot;typering&quot;)</span>
<span class="nc" id="L682">              ? &quot;'&quot; + was.substring(0, typeringColWidth)</span>
<span class="nc" id="L683">              : &quot;'&quot; + was + &quot;'&quot;);</span>
      final String _wordt =
<span class="nc bnc" id="L685" title="All 2 branches missed.">          (table.getValue().equalsIgnoreCase(&quot;typering&quot;)</span>
<span class="nc" id="L686">              ? wordt.substring(0, typeringColWidth)</span>
<span class="nc" id="L687">              : wordt);</span>

<span class="nc" id="L689">      String countsql =</span>
          &quot;select count(*) from &quot;
<span class="nc" id="L691">              + table.getKey()</span>
              + &quot; where &quot;
<span class="nc" id="L693">              + table.getValue()</span>
              + &quot; = '&quot;
              + _was
              + &quot;'&quot;;
<span class="nc" id="L697">      LOG.debug(&quot;SQL voor tellen van berichten batch: &quot; + countsql);</span>

<span class="nc" id="L699">      Number o =</span>
<span class="nc" id="L700">          new QueryRunner(geomToJdbc.isPmdKnownBroken())</span>
<span class="nc" id="L701">              .query(conn, countsql, new ScalarHandler&lt;&gt;());</span>
<span class="nc" id="L702">      LOG.info(&quot;Totaal te bewerken records in tabel/kolom: &quot; + table + &quot; is: &quot; + o);</span>

<span class="nc bnc" id="L704" title="All 2 branches missed.">      if (o instanceof BigDecimal) {</span>
<span class="nc" id="L705">        total(this.total + o.longValue());</span>
<span class="nc bnc" id="L706" title="All 2 branches missed.">      } else if (o instanceof Integer) {</span>
<span class="nc" id="L707">        total(this.total + o.longValue());</span>
      } else {
<span class="nc" id="L709">        total(this.total + (Long) o);</span>
      }

      do {
<span class="nc" id="L713">        LOG.debug(String.format(&quot;Update berichten batch met offset %d, limit %d&quot;, offset, batch));</span>
<span class="nc" id="L714">        String sql =</span>
<span class="nc" id="L715">            &quot;select * from &quot; + table.getKey() + &quot; where &quot; + table.getValue() + &quot; = '&quot; + _was + &quot;'&quot;;</span>
<span class="nc" id="L716">        sql = geomToJdbc.buildPaginationSql(sql, offset, batch);</span>
<span class="nc" id="L717">        LOG.trace(&quot;SQL voor ophalen berichten batch: &quot; + sql);</span>
<span class="nc" id="L718">        _processed.setValue(0);</span>

<span class="nc" id="L720">        Exception e =</span>
<span class="nc" id="L721">            new QueryRunner(geomToJdbc.isPmdKnownBroken())</span>
<span class="nc" id="L722">                .query(</span>
                    conn,
                    sql,
                    rs -&gt; {
<span class="nc bnc" id="L726" title="All 2 branches missed.">                      while (rs.next()) {</span>
                        try {
<span class="nc" id="L728">                          new QueryRunner(geomToJdbc.isPmdKnownBroken())</span>
<span class="nc" id="L729">                              .update(</span>
                                  conn,
                                  &quot;update &quot;
<span class="nc" id="L732">                                      + table.getKey()</span>
                                      + &quot; set &quot;
<span class="nc" id="L734">                                      + table.getValue()</span>
                                      + &quot; = '&quot;
                                      + _wordt
                                      + &quot;' where &quot;
<span class="nc" id="L738">                                      + table.getValue()</span>
                                      + &quot; = '&quot;
                                      + _was
                                      + &quot;'&quot;);
<span class="nc" id="L742">                        } catch (Exception e1) {</span>
<span class="nc" id="L743">                          return e1;</span>
<span class="nc" id="L744">                        }</span>
<span class="nc" id="L745">                        _processed.increment();</span>
                      }
<span class="nc" id="L747">                      return null;</span>
                    });
<span class="nc" id="L749">        offset += _processed.intValue();</span>

<span class="nc" id="L751">        progress(this.processed + _processed.intValue());</span>

<span class="nc bnc" id="L753" title="All 2 branches missed.">        if (e != null) {</span>
<span class="nc" id="L754">          closeQuietly(conn);</span>
<span class="nc" id="L755">          throw e;</span>
        }
<span class="nc bnc" id="L757" title="All 2 branches missed.">      } while (_processed.intValue() &gt; 0);</span>
<span class="nc" id="L758">    }</span>
<span class="nc" id="L759">    closeQuietly(conn);</span>
<span class="nc" id="L760">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>