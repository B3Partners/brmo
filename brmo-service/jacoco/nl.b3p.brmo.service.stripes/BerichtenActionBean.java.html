<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BerichtenActionBean.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">BRMO service</a> &gt; <a href="index.source.html" class="el_package">nl.b3p.brmo.service.stripes</a> &gt; <span class="el_source">BerichtenActionBean.java</span></div><h1>BerichtenActionBean.java</h1><pre class="source lang-java linenums">package nl.b3p.brmo.service.stripes;

import java.util.List;
import javax.persistence.EntityManager;
import javax.servlet.http.HttpServletResponse;
import javax.sql.DataSource;
import net.sourceforge.stripes.action.ActionBean;
import net.sourceforge.stripes.action.ActionBeanContext;
import net.sourceforge.stripes.action.DefaultHandler;
import net.sourceforge.stripes.action.ForwardResolution;
import net.sourceforge.stripes.action.Resolution;
import net.sourceforge.stripes.action.StreamingResolution;
import net.sourceforge.stripes.validation.Validate;
import nl.b3p.brmo.loader.BrmoFramework;
import nl.b3p.brmo.loader.entity.Bericht;
import nl.b3p.brmo.loader.util.BrmoException;
import nl.b3p.brmo.service.util.ConfigUtil;
import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import org.json.JSONArray;
import org.json.JSONObject;
import org.stripesstuff.stripersist.Stripersist;

/**
 * @author Boy de Wit
 */
<span class="nc" id="L27">public class BerichtenActionBean implements ActionBean {</span>

<span class="nc" id="L29">  private static final Log log = LogFactory.getLog(BerichtenActionBean.class);</span>

  private ActionBeanContext context;
  private List&lt;Bericht&gt; berichten;

  private long[] selectedIds;

  @Validate private int page;
  @Validate private int start;
  @Validate private int limit;
  @Validate private String sort;
  @Validate private String dir;
  @Validate private JSONArray filter;
  @Validate private JSONObject changedItem;

  //    private String result;

  @DefaultHandler
  public Resolution list() {
<span class="nc" id="L48">    return new ForwardResolution(&quot;/WEB-INF/jsp/bericht/list.jsp&quot;);</span>
  }

  public Resolution getGridData() throws BrmoException {

    // ophalen filters
<span class="nc" id="L54">    String filterSoort = &quot;&quot;;</span>
<span class="nc" id="L55">    String filterStatus = &quot;&quot;;</span>

<span class="nc bnc" id="L57" title="All 2 branches missed.">    if (this.getFilter() != null) {</span>
<span class="nc bnc" id="L58" title="All 2 branches missed.">      for (int k = 0; k &lt; this.getFilter().length(); k++) {</span>
<span class="nc" id="L59">        JSONObject j = this.getFilter().getJSONObject(k);</span>
<span class="nc" id="L60">        String property = j.getString(&quot;property&quot;);</span>
<span class="nc" id="L61">        Object value = j.opt(&quot;value&quot;); // JSONARRAY [&quot;STAGING_OK&quot;,&quot;RSGB_OK&quot;,&quot;RSGB_NOK&quot;] of string</span>
<span class="nc" id="L62">        String stringValue = &quot;&quot;;</span>
<span class="nc bnc" id="L63" title="All 2 branches missed.">        if (value instanceof String) {</span>
<span class="nc" id="L64">          stringValue = (String) value;</span>
<span class="nc bnc" id="L65" title="All 2 branches missed.">        } else if (value instanceof JSONArray) {</span>
<span class="nc" id="L66">          JSONArray jaValue = (JSONArray) value;</span>
<span class="nc" id="L67">          stringValue = jaValue.join(&quot;,&quot;); // lelijk</span>
<span class="nc" id="L68">          stringValue = stringValue.replaceAll(&quot;\&quot;&quot;, &quot;&quot;);</span>
        }
<span class="nc bnc" id="L70" title="All 2 branches missed.">        if (property.equals(&quot;soort&quot;)) {</span>
<span class="nc" id="L71">          filterSoort = stringValue;</span>
        }
<span class="nc bnc" id="L73" title="All 2 branches missed.">        if (property.equals(&quot;status&quot;)) {</span>
<span class="nc" id="L74">          filterStatus = stringValue;</span>
        }
      }
    }

<span class="nc" id="L79">    DataSource dataSourceStaging = ConfigUtil.getDataSourceStaging();</span>
    long count;
<span class="nc" id="L81">    JSONArray jsoNBerichten = new JSONArray();</span>
<span class="nc" id="L82">    BrmoFramework brmo = null;</span>
    try {
<span class="nc" id="L84">      brmo = new BrmoFramework(dataSourceStaging, null, null);</span>

<span class="nc" id="L86">      count = brmo.getCountBerichten(filterSoort, filterStatus);</span>

<span class="nc bnc" id="L88" title="All 2 branches missed.">      if (start &lt; 0) {</span>
<span class="nc" id="L89">        start = 0;</span>
      }
<span class="nc" id="L91">      berichten =</span>
<span class="nc" id="L92">          brmo.getBerichten(</span>
              page,
              start,
              limit,
<span class="nc bnc" id="L96" title="All 4 branches missed.">              (sort == null || sort.trim().isEmpty()) ? &quot;id&quot; : sort,</span>
<span class="nc bnc" id="L97" title="All 4 branches missed.">              (dir == null || dir.trim().isEmpty()) ? &quot;asc&quot; : dir,</span>
              filterSoort,
              filterStatus);

    } finally {
<span class="nc bnc" id="L102" title="All 2 branches missed.">      if (brmo != null) {</span>
<span class="nc" id="L103">        brmo.closeBrmoFramework();</span>
      }
    }
<span class="nc bnc" id="L106" title="All 2 branches missed.">    for (Bericht b : berichten) {</span>
<span class="nc" id="L107">      JSONObject jsonObject = bericht2Json(b);</span>
<span class="nc" id="L108">      jsoNBerichten.put(jsonObject);</span>
<span class="nc" id="L109">    }</span>

<span class="nc" id="L111">    final JSONObject grid = new JSONObject();</span>
<span class="nc bnc" id="L112" title="All 2 branches missed.">    if (count &lt; 0) {</span>
<span class="nc" id="L113">      grid.put(&quot;virtualtotal&quot;, true);</span>
<span class="nc" id="L114">      count = 0L;</span>
    }
<span class="nc" id="L116">    grid.put(&quot;total&quot;, count);</span>
<span class="nc" id="L117">    grid.put(&quot;items&quot;, jsoNBerichten);</span>

<span class="nc" id="L119">    return new StreamingResolution(&quot;application/json&quot;) {</span>
      @Override
      public void stream(HttpServletResponse response) throws Exception {
<span class="nc" id="L122">        response.getWriter().print(grid.toString());</span>
<span class="nc" id="L123">      }</span>
    };
  }

  private JSONObject bericht2Json(Bericht ber) {
<span class="nc" id="L128">    JSONObject json = new JSONObject();</span>

<span class="nc" id="L130">    json.put(&quot;id&quot;, ber.getId());</span>
<span class="nc" id="L131">    json.put(&quot;object_ref&quot;, ber.getObjectRef());</span>
<span class="nc" id="L132">    json.put(&quot;datum&quot;, ber.getDatum());</span>
<span class="nc" id="L133">    json.put(&quot;soort&quot;, ber.getSoort());</span>
<span class="nc" id="L134">    json.put(&quot;status&quot;, ber.getStatus());</span>
<span class="nc" id="L135">    json.put(&quot;volgordenummer&quot;, ber.getVolgordeNummer());</span>

<span class="nc" id="L137">    return json;</span>
  }

  public Resolution saveRecord() {
<span class="nc" id="L141">    JSONObject item = this.getChangedItem();</span>

<span class="nc" id="L143">    final EntityManager em = Stripersist.getEntityManager();</span>
<span class="nc" id="L144">    nl.b3p.brmo.persistence.staging.Bericht bericht =</span>
<span class="nc" id="L145">        em.find(nl.b3p.brmo.persistence.staging.Bericht.class, item.getLong(&quot;id&quot;));</span>
<span class="nc" id="L146">    bericht.setStatus(</span>
<span class="nc" id="L147">        nl.b3p.brmo.persistence.staging.Bericht.STATUS.valueOf(item.getString(&quot;status&quot;)));</span>
    // TODO / VRAAG moeten we ook iets aan de log/opmerking van het bericht doen?
    // bericht.setOpmerking(&quot;&quot;);
<span class="nc" id="L150">    em.merge(bericht);</span>
<span class="nc" id="L151">    em.getTransaction().commit();</span>

<span class="nc" id="L153">    final JSONObject jsonResponse = new JSONObject();</span>
<span class="nc" id="L154">    jsonResponse.put(&quot;success&quot;, true);</span>
<span class="nc" id="L155">    return new StreamingResolution(&quot;application/json&quot;) {</span>
      @Override
      public void stream(HttpServletResponse response) throws Exception {
<span class="nc" id="L158">        response.getWriter().print(jsonResponse.toString());</span>
<span class="nc" id="L159">      }</span>
    };
  }

  public Resolution log() throws BrmoException {
<span class="nc" id="L164">    DataSource dataSourceStaging = ConfigUtil.getDataSourceStaging();</span>
<span class="nc" id="L165">    JSONObject jsonObj = new JSONObject();</span>
<span class="nc" id="L166">    jsonObj.put(&quot;success&quot;, Boolean.FALSE);</span>
<span class="nc" id="L167">    BrmoFramework brmo = new BrmoFramework(dataSourceStaging, null, null);</span>
    try {
<span class="nc" id="L169">      Bericht bericht = brmo.getBerichtById(selectedIds[0]);</span>
<span class="nc" id="L170">      jsonObj = bericht2Json(bericht);</span>
<span class="nc" id="L171">      jsonObj.put(&quot;opmerking&quot;, bericht.getOpmerking());</span>
<span class="nc" id="L172">      jsonObj.put(&quot;success&quot;, Boolean.TRUE);</span>
    } finally {
<span class="nc" id="L174">      brmo.closeBrmoFramework();</span>
    }
<span class="nc" id="L176">    final String returnValue = jsonObj.toString();</span>
<span class="nc" id="L177">    return new StreamingResolution(&quot;application/json&quot;) {</span>
      @Override
      public void stream(HttpServletResponse response) throws Exception {
<span class="nc" id="L180">        response.getWriter().print(returnValue);</span>
<span class="nc" id="L181">      }</span>
    };
  }

  @Override
  public ActionBeanContext getContext() {
<span class="nc" id="L187">    return context;</span>
  }

  @Override
  public void setContext(ActionBeanContext context) {
<span class="nc" id="L192">    this.context = context;</span>
<span class="nc" id="L193">  }</span>

  public List&lt;Bericht&gt; getBerichten() {
<span class="nc" id="L196">    return berichten;</span>
  }

  public void setBerichten(List&lt;Bericht&gt; berichten) {
<span class="nc" id="L200">    this.berichten = berichten;</span>
<span class="nc" id="L201">  }</span>

  public long[] getSelectedIds() {
<span class="nc" id="L204">    return selectedIds;</span>
  }

  public void setSelectedIds(long[] selectedIds) {
<span class="nc" id="L208">    this.selectedIds = selectedIds;</span>
<span class="nc" id="L209">  }</span>

  public int getPage() {
<span class="nc" id="L212">    return page;</span>
  }

  public void setPage(int page) {
<span class="nc" id="L216">    this.page = page;</span>
<span class="nc" id="L217">  }</span>

  public int getStart() {
<span class="nc" id="L220">    return start;</span>
  }

  public void setStart(int start) {
<span class="nc" id="L224">    this.start = start;</span>
<span class="nc" id="L225">  }</span>

  public int getLimit() {
<span class="nc" id="L228">    return limit;</span>
  }

  public void setLimit(int limit) {
<span class="nc" id="L232">    this.limit = limit;</span>
<span class="nc" id="L233">  }</span>

  public String getSort() {
<span class="nc" id="L236">    return sort;</span>
  }

  public void setSort(String sort) {
<span class="nc" id="L240">    this.sort = sort;</span>
<span class="nc" id="L241">  }</span>

  public String getDir() {
<span class="nc" id="L244">    return dir;</span>
  }

  public void setDir(String dir) {
<span class="nc" id="L248">    this.dir = dir;</span>
<span class="nc" id="L249">  }</span>

  public JSONArray getFilter() {
<span class="nc" id="L252">    return filter;</span>
  }

  public void setFilter(JSONArray filter) {
<span class="nc" id="L256">    this.filter = filter;</span>
<span class="nc" id="L257">  }</span>

  //    public String getResult() {
  //        return result;
  //    }
  //
  //    public void setResult(String result) {
  //        this.result = result;
  //    }

  public JSONObject getChangedItem() {
<span class="nc" id="L268">    return changedItem;</span>
  }

  public void setChangedItem(JSONObject changedItem) {
<span class="nc" id="L272">    this.changedItem = changedItem;</span>
<span class="nc" id="L273">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>