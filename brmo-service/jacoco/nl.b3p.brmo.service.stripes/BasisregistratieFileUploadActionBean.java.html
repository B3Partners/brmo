<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BasisregistratieFileUploadActionBean.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">BRMO service</a> &gt; <a href="index.source.html" class="el_package">nl.b3p.brmo.service.stripes</a> &gt; <span class="el_source">BasisregistratieFileUploadActionBean.java</span></div><h1>BasisregistratieFileUploadActionBean.java</h1><pre class="source lang-java linenums">package nl.b3p.brmo.service.stripes;

import java.io.BufferedInputStream;
import java.io.DataInputStream;
import java.io.IOException;
import java.io.InputStream;
import java.util.ArrayList;
import java.util.List;
import java.util.zip.ZipEntry;
import java.util.zip.ZipInputStream;
import javax.sql.DataSource;
import net.sourceforge.stripes.action.ActionBean;
import net.sourceforge.stripes.action.ActionBeanContext;
import net.sourceforge.stripes.action.DefaultHandler;
import net.sourceforge.stripes.action.DontValidate;
import net.sourceforge.stripes.action.FileBean;
import net.sourceforge.stripes.action.ForwardResolution;
import net.sourceforge.stripes.action.Resolution;
import net.sourceforge.stripes.action.SimpleMessage;
import net.sourceforge.stripes.action.StrictBinding;
import net.sourceforge.stripes.validation.Validate;
import nl.b3p.brmo.loader.BrmoFramework;
import nl.b3p.brmo.loader.ProgressUpdateListener;
import nl.b3p.brmo.loader.util.BrmoDuplicaatLaadprocesException;
import nl.b3p.brmo.loader.util.BrmoException;
import nl.b3p.brmo.loader.util.BrmoLeegBestandException;
import nl.b3p.brmo.service.util.ConfigUtil;
import org.apache.commons.io.input.CloseShieldInputStream;
import org.apache.commons.lang3.exception.ExceptionUtils;
import org.apache.commons.lang3.mutable.MutableLong;
import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;

/**
 * Action voor het handmatig uploaden van bestanden met basisregistratiegegevens via een formulier.
 */
@StrictBinding
<span class="nc" id="L38">public class BasisregistratieFileUploadActionBean implements ActionBean {</span>
  private static final int ZIP_HEADER = 0x504b0304;

<span class="nc" id="L41">  private static final Log log = LogFactory.getLog(BasisregistratieFileUploadActionBean.class);</span>

  private ActionBeanContext context;

  @Validate(required = true)
  private String basisregistratie;

  @Validate(required = true)
  private FileBean bestand;

  @DefaultHandler
  @DontValidate
  public Resolution form() {
<span class="nc" id="L54">    return new ForwardResolution(&quot;/WEB-INF/jsp/bestand/form.jsp&quot;);</span>
  }

  public Resolution upload() throws BrmoException {
<span class="nc" id="L58">    DataSource ds = ConfigUtil.getDataSourceStaging();</span>
<span class="nc" id="L59">    BrmoFramework brmo = new BrmoFramework(ds, null, null);</span>
<span class="nc" id="L60">    ZipInputStream zip = null;</span>
<span class="nc" id="L61">    ZipEntry entry = null;</span>
<span class="nc" id="L62">    int errors = 0;</span>
<span class="nc" id="L63">    int empty = 0;</span>
<span class="nc" id="L64">    int duplicate = 0;</span>
<span class="nc" id="L65">    final int ERROR_LIMIT = 5;</span>
    try {
<span class="nc" id="L67">      final MutableLong theTotal = new MutableLong(0);</span>
<span class="nc" id="L68">      int extractedFiles = 0;</span>
<span class="nc" id="L69">      final ProgressUpdateListener totalAdder =</span>
<span class="nc" id="L70">          new ProgressUpdateListener() {</span>

            @Override
            public void total(long total) {
<span class="nc" id="L74">              theTotal.setValue(theTotal.getValue() + total);</span>
<span class="nc" id="L75">            }</span>

            @Override
<span class="nc" id="L78">            public void progress(long progress) {}</span>

            @Override
<span class="nc" id="L81">            public void exception(Throwable t) {}</span>
          };

      // Check of bestand begint met ZIP header
<span class="nc" id="L85">      InputStream in = new BufferedInputStream(bestand.getInputStream());</span>
<span class="nc" id="L86">      in.mark(4);</span>
<span class="nc" id="L87">      int header = new DataInputStream(in).readInt();</span>
<span class="nc" id="L88">      in.reset();</span>

<span class="nc bnc" id="L90" title="All 2 branches missed.">      if (header == ZIP_HEADER) {</span>
        // Pak .xml bestanden in ZIP uit en verwerk deze

<span class="nc" id="L93">        zip = new ZipInputStream(in);</span>
        try {
<span class="nc" id="L95">          entry = zip.getNextEntry();</span>
<span class="nc bnc" id="L96" title="All 2 branches missed.">          while (entry != null) {</span>
<span class="nc bnc" id="L97" title="All 2 branches missed.">            if (!entry.getName().toLowerCase().endsWith(&quot;.xml&quot;)) {</span>
<span class="nc" id="L98">              log.warn(&quot;Overslaan zip entry geen XML: &quot; + entry.getName());</span>
            } else {
<span class="nc" id="L100">              log.debug(&quot;Lezen XML bestand uit zip: &quot; + entry.getName());</span>
              try {
<span class="nc" id="L102">                brmo.loadFromStream(</span>
                    basisregistratie,
<span class="nc" id="L104">                    CloseShieldInputStream.wrap(zip),</span>
<span class="nc" id="L105">                    bestand.getFileName() + &quot;/&quot; + entry.getName(),</span>
                    totalAdder,
                    null);
<span class="nc" id="L108">              } catch (BrmoLeegBestandException e) {</span>
<span class="nc" id="L109">                log.info(&quot;Negeer ZIP entry &quot; + entry.getName() + &quot;: &quot; + e.getMessage());</span>
<span class="nc" id="L110">                empty++;</span>
<span class="nc" id="L111">              } catch (BrmoDuplicaatLaadprocesException e) {</span>
<span class="nc" id="L112">                log.info(&quot;Negeer ZIP entry &quot; + entry.getName() + &quot;: duplicaat laadproces&quot;);</span>
<span class="nc" id="L113">                duplicate++;</span>
<span class="nc" id="L114">              } catch (BrmoException e) {</span>
<span class="nc" id="L115">                errors++;</span>
<span class="nc" id="L116">                log.error(</span>
                    &quot;BrmoException bij laden ZIP entry &quot;
<span class="nc" id="L118">                        + entry.getName()</span>
<span class="nc bnc" id="L119" title="All 2 branches missed.">                        + (errors &gt; ERROR_LIMIT ? &quot;; afbreken&quot; : &quot;; doorgaan met volgende&quot;),</span>
                    e);
<span class="nc bnc" id="L121" title="All 2 branches missed.">                if (errors &gt; ERROR_LIMIT) {</span>
<span class="nc" id="L122">                  throw new BrmoException(</span>
                      &quot;Maximum aantal fouten (&quot;
                          + ERROR_LIMIT
                          + &quot;) bereikt bij inladen ZIP bestanden, inladen afgebroken. Controleer brmo-service.log&quot;,
                      e);
                }
<span class="nc" id="L128">              }</span>
<span class="nc" id="L129">              extractedFiles++;</span>
            }
<span class="nc" id="L131">            entry = zip.getNextEntry();</span>
          }
        } finally {
<span class="nc" id="L134">          zip.close();</span>
<span class="nc" id="L135">        }</span>
      } else {
        // Geen ZIP, direct BR XML laden
<span class="nc" id="L138">        brmo.loadFromStream(basisregistratie, in, bestand.getFileName(), totalAdder, null);</span>
      }

<span class="nc" id="L141">      List&lt;String&gt; warnings = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L142" title="All 2 branches missed.">      if (errors &gt; 0) {</span>
<span class="nc" id="L143">        warnings.add(</span>
            &quot;let op: &quot;
                + errors
                + &quot; bericht&quot;
<span class="nc bnc" id="L147" title="All 2 branches missed.">                + (errors &gt; 1 ? &quot;en&quot; : &quot;&quot;)</span>
                + &quot; niet ingeladen wegens fouten&quot;);
      }
<span class="nc bnc" id="L150" title="All 2 branches missed.">      if (empty &gt; 0) {</span>
<span class="nc" id="L151">        warnings.add(</span>
            &quot;let op: &quot;
                + empty
<span class="nc bnc" id="L154" title="All 2 branches missed.">                + (empty &gt; 1 ? &quot; lege berichten&quot; : &quot; leeg bericht&quot;)</span>
                + &quot; overgeslagen&quot;);
      }
<span class="nc bnc" id="L157" title="All 2 branches missed.">      if (duplicate &gt; 0) {</span>
<span class="nc" id="L158">        warnings.add(</span>
            &quot;let op: &quot;
                + duplicate
<span class="nc bnc" id="L161" title="All 2 branches missed.">                + (duplicate &gt; 1 ? &quot; duplicate berichten&quot; : &quot; duplicaat bericht&quot;)</span>
                + &quot; overgeslagen&quot;);
      }

      String warning =
<span class="nc bnc" id="L166" title="All 2 branches missed.">          warnings.isEmpty()</span>
<span class="nc" id="L167">              ? &quot;&quot;</span>
              : &quot;, &quot;
<span class="nc" id="L169">                  + String.join(&quot;, &quot;, warnings.toArray(new String[] {}))</span>
<span class="nc" id="L170">                  + &quot;, zie log voor bestandsnamen uit ZIP en details!&quot;;</span>

<span class="nc" id="L172">      getContext()</span>
<span class="nc" id="L173">          .getMessages()</span>
<span class="nc" id="L174">          .add(</span>
              new SimpleMessage(
                  &quot;Bestand &quot;
<span class="nc" id="L177">                      + bestand.getFileName()</span>
                      + &quot; is ingelezen, &quot;
<span class="nc" id="L179">                      + theTotal.getValue()</span>
                      + &quot; berichten&quot;
<span class="nc bnc" id="L181" title="All 2 branches missed.">                      + (extractedFiles &gt; 0</span>
<span class="nc" id="L182">                          ? &quot; (uit &quot; + extractedFiles + &quot; uitgepakte XML bestanden)&quot;</span>
<span class="nc" id="L183">                          : &quot;&quot;)</span>
                      + warning));
<span class="nc" id="L185">      log.info(</span>
<span class="nc" id="L186">          String.format(</span>
              &quot;Stored %s data from file \&quot;%s\&quot; uploaded via form&quot;,
<span class="nc" id="L188">              basisregistratie, bestand.getFileName()));</span>
<span class="nc" id="L189">    } catch (Exception ex) {</span>
      String msg =
          &quot;Fout bij inlezen bestand &quot;
<span class="nc bnc" id="L192" title="All 4 branches missed.">              + (zip != null &amp;&amp; entry != null</span>
<span class="nc" id="L193">                  ? entry.getName() + &quot; uit ZIP bestand &quot; + bestand.getFileName()</span>
<span class="nc" id="L194">                  : bestand.getFileName());</span>
<span class="nc" id="L195">      log.error(msg, ex);</span>

<span class="nc" id="L197">      getContext()</span>
<span class="nc" id="L198">          .getMessages()</span>
<span class="nc" id="L199">          .add(new SimpleMessage(msg + &quot;: &quot; + ExceptionUtils.getRootCauseMessage(ex)));</span>
    } finally {
      try {
<span class="nc" id="L202">        bestand.delete();</span>
<span class="nc" id="L203">      } catch (IOException e) {</span>
        // ignore
<span class="nc" id="L205">      }</span>
<span class="nc" id="L206">      brmo.closeBrmoFramework();</span>
    }

<span class="nc" id="L209">    return new ForwardResolution(&quot;/WEB-INF/jsp/bestand/form.jsp&quot;);</span>
  }

  // &lt;editor-fold defaultstate=&quot;collapsed&quot; desc=&quot;getters en setters&quot;&gt;
  @Override
  public ActionBeanContext getContext() {
<span class="nc" id="L215">    return context;</span>
  }

  @Override
  public void setContext(ActionBeanContext context) {
<span class="nc" id="L220">    this.context = context;</span>
<span class="nc" id="L221">  }</span>

  public String getBasisregistratie() {
<span class="nc" id="L224">    return basisregistratie;</span>
  }

  public void setBasisregistratie(String basisregistratie) {
<span class="nc" id="L228">    this.basisregistratie = basisregistratie;</span>
<span class="nc" id="L229">  }</span>

  public FileBean getBestand() {
<span class="nc" id="L232">    return bestand;</span>
  }

  public void setBestand(FileBean bestand) {
<span class="nc" id="L236">    this.bestand = bestand;</span>
<span class="nc" id="L237">  }</span>
  // &lt;/editor-fold&gt;
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.10.202304240956</span></div></body></html>