<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>WebMirrorBAGDirectoryScanner.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">BRMO service</a> &gt; <a href="index.source.html" class="el_package">nl.b3p.brmo.service.scanner</a> &gt; <span class="el_source">WebMirrorBAGDirectoryScanner.java</span></div><h1>WebMirrorBAGDirectoryScanner.java</h1><pre class="source lang-java linenums">/*
 * Copyright (C) 2015 B3Partners B.V.
 */
package nl.b3p.brmo.service.scanner;

import static nl.b3p.brmo.persistence.staging.AutomatischProces.ProcessingStatus.ERROR;
import static nl.b3p.brmo.persistence.staging.AutomatischProces.ProcessingStatus.WAITING;

import java.io.File;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.net.URI;
import java.net.URL;
import java.net.URLConnection;
import java.util.Calendar;
import java.util.Date;
import java.util.zip.ZipEntry;
import java.util.zip.ZipInputStream;
import nl.b3p.brmo.loader.BrmoFramework;
import nl.b3p.brmo.loader.util.BrmoDuplicaatLaadprocesException;
import nl.b3p.brmo.loader.util.BrmoException;
import nl.b3p.brmo.loader.util.BrmoLeegBestandException;
import nl.b3p.brmo.persistence.staging.AutomatischProces;
import nl.b3p.brmo.persistence.staging.WebMirrorBAGScannerProces;
import nl.b3p.brmo.service.util.ConfigUtil;
import org.apache.commons.io.IOUtils;
import org.apache.commons.io.input.CloseShieldInputStream;
import org.apache.commons.io.input.TeeInputStream;
import org.apache.commons.lang3.exception.ExceptionUtils;
import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import org.jsoup.HttpStatusException;
import org.jsoup.Jsoup;
import org.jsoup.nodes.Document;
import org.jsoup.select.Elements;
import org.stripesstuff.stripersist.Stripersist;

/**
 * Proces dat een web directory uitleest voor BAG mutaties in zipfiles.
 *
 * @author mprins
 */
public class WebMirrorBAGDirectoryScanner extends AbstractExecutableProces {

<span class="nc" id="L46">  private static final Log log = LogFactory.getLog(WebMirrorBAGDirectoryScanner.class);</span>

  /** proces data. */
  private final WebMirrorBAGScannerProces config;

  private ProgressUpdateListener listener;

<span class="nc" id="L53">  private BrmoFramework brmo = null;</span>

<span class="nc" id="L55">  private int progress = 0, aantalZipGeladen = 0, aantalXMLGeladen = 0, filterXMLAlVerwerkt = 0;</span>

<span class="nc" id="L57">  public WebMirrorBAGDirectoryScanner(WebMirrorBAGScannerProces config) {</span>
<span class="nc" id="L58">    this.config = config;</span>
    try {
<span class="nc" id="L60">      brmo = new BrmoFramework(ConfigUtil.getDataSourceStaging(), null, null);</span>
<span class="nc" id="L61">    } catch (BrmoException ex) {</span>
<span class="nc" id="L62">      log.fatal(&quot;Initialisatie van BRMO framework is mislukt&quot;, ex);</span>
<span class="nc" id="L63">    }</span>
<span class="nc" id="L64">  }</span>

  @Override
  public void execute() throws BrmoException {
<span class="nc" id="L68">    this.execute(</span>
<span class="nc" id="L69">        new ProgressUpdateListener() {</span>
          @Override
<span class="nc" id="L71">          public void total(long total) {}</span>

          @Override
<span class="nc" id="L74">          public void progress(long progress) {}</span>

          @Override
          public void exception(Throwable t) {
<span class="nc" id="L78">            log.error(t);</span>
<span class="nc" id="L79">          }</span>

          @Override
<span class="nc" id="L82">          public void updateStatus(String status) {}</span>

          @Override
<span class="nc" id="L85">          public void addLog(String log) {}</span>
        });
<span class="nc" id="L87">  }</span>

  @Override
  public void execute(ProgressUpdateListener listener) {
<span class="nc" id="L91">    this.listener = listener;</span>

<span class="nc" id="L93">    String msg = String.format(&quot;Initialiseren... %tc&quot;, new Date());</span>
<span class="nc" id="L94">    listener.updateStatus(msg);</span>
<span class="nc" id="L95">    listener.addLog(msg);</span>
<span class="nc" id="L96">    config.setStatus(AutomatischProces.ProcessingStatus.PROCESSING);</span>
<span class="nc" id="L97">    Stripersist.getEntityManager().flush();</span>

    try {
<span class="nc" id="L100">      String url = this.config.getScanDirectory();</span>
<span class="nc" id="L101">      msg = String.format(&quot;Ophalen van de lijst van links van %s.&quot;, url);</span>
<span class="nc" id="L102">      listener.addLog(msg);</span>
<span class="nc" id="L103">      Document doc =</span>
<span class="nc" id="L104">          Jsoup.connect(url).timeout(5000).followRedirects(true).ignoreHttpErrors(false).get();</span>
<span class="nc" id="L105">      msg = &quot;De lijst met download links is succesvol opgehaald.&quot;;</span>
<span class="nc" id="L106">      listener.updateStatus(msg);</span>
<span class="nc" id="L107">      listener.addLog(msg);</span>

<span class="nc" id="L109">      String expression = this.config.getConfig().get(&quot;csspath&quot;).getValue();</span>
<span class="nc" id="L110">      Elements links = doc.select(expression);</span>

      // verwijder een eventuele parent directory link uit de set links
<span class="nc" id="L113">      URI uri = new URI(url);</span>
<span class="nc bnc" id="L114" title="All 2 branches missed.">      URI parent = uri.getPath().endsWith(&quot;/&quot;) ? uri.resolve(&quot;..&quot;) : uri.resolve(&quot;.&quot;);</span>
<span class="nc bnc" id="L115" title="All 2 branches missed.">      if (parent.toString().equalsIgnoreCase(links.first().attr(&quot;abs:href&quot;))) {</span>
<span class="nc" id="L116">        msg = String.format(&quot;Overslaan van (parent) link %s&quot;, parent);</span>
<span class="nc" id="L117">        listener.updateStatus(msg);</span>
<span class="nc" id="L118">        listener.addLog(msg);</span>
<span class="nc" id="L119">        log.info(msg);</span>
<span class="nc" id="L120">        links.remove(links.first());</span>
      }
<span class="nc" id="L122">      int items = links.size();</span>
<span class="nc" id="L123">      listener.total(items);</span>

      String berichtUrl, bestandsnaam;
<span class="nc" id="L126">      progress = 0;</span>
<span class="nc" id="L127">      filterXMLAlVerwerkt = 0;</span>
<span class="nc" id="L128">      aantalZipGeladen = 0;</span>
<span class="nc" id="L129">      aantalXMLGeladen = 0;</span>
<span class="nc bnc" id="L130" title="All 2 branches missed.">      for (org.jsoup.nodes.Element link : links) {</span>
<span class="nc" id="L131">        berichtUrl = link.attr(&quot;abs:href&quot;);</span>
<span class="nc" id="L132">        bestandsnaam = link.text();</span>
<span class="nc" id="L133">        laadBestand(berichtUrl, bestandsnaam);</span>
<span class="nc" id="L134">        aantalZipGeladen++;</span>
<span class="nc" id="L135">        listener.progress(++progress);</span>
<span class="nc" id="L136">      }</span>

<span class="nc" id="L138">      msg = String.format(&quot;Klaar met run op %tc.&quot;, Calendar.getInstance());</span>
<span class="nc" id="L139">      listener.updateStatus(msg);</span>
<span class="nc" id="L140">      listener.addLog(msg);</span>
<span class="nc" id="L141">      listener.addLog(&quot;\n**** resultaat ****\n&quot;);</span>
<span class="nc" id="L142">      listener.addLog(&quot;Aantal url's gedownloaded: &quot; + aantalZipGeladen);</span>
<span class="nc" id="L143">      listener.addLog(&quot;Aantal xml's geladen: &quot; + aantalXMLGeladen);</span>
<span class="nc" id="L144">      listener.addLog(&quot;Aantal xml's die al waren geladen: &quot; + filterXMLAlVerwerkt);</span>

<span class="nc" id="L146">      config.updateSamenvattingEnLogfile(</span>
          msg
              + &quot;\nAantal url's gedownloaded: &quot;
              + aantalZipGeladen
              + &quot;\nAantal xml's geladen: &quot;
              + aantalXMLGeladen
              + &quot;\nAantal xml's die al waren geladen: &quot;
              + filterXMLAlVerwerkt);
<span class="nc" id="L154">      config.setStatus(WAITING);</span>
<span class="nc" id="L155">      this.config.setLastrun(new Date());</span>
<span class="nc" id="L156">      Stripersist.getEntityManager().merge(this.config);</span>
<span class="nc" id="L157">      Stripersist.getEntityManager().getTransaction().commit();</span>
<span class="nc" id="L158">    } catch (HttpStatusException ex) {</span>
<span class="nc" id="L159">      msg =</span>
<span class="nc" id="L160">          String.format(</span>
              &quot;Er is een fout opgetreden bij het uitlezen van de url %s. Status code %s&quot;,
<span class="nc" id="L162">              ex.getUrl(), ex.getStatusCode());</span>
<span class="nc" id="L163">      log.error(msg);</span>
<span class="nc" id="L164">      config.setStatus(ERROR);</span>
<span class="nc" id="L165">      listener.exception(ex);</span>
<span class="nc" id="L166">    } catch (IOException ex) {</span>
<span class="nc" id="L167">      log.error(ex);</span>
<span class="nc" id="L168">      config.setStatus(ERROR);</span>
<span class="nc" id="L169">      listener.exception(ex);</span>
<span class="nc" id="L170">    } catch (Exception ex) {</span>
<span class="nc" id="L171">      log.error(ex);</span>
<span class="nc" id="L172">      listener.exception(ex);</span>
<span class="nc" id="L173">      String m = &quot;Fout bij inladen van berichten: &quot; + ExceptionUtils.getMessage(ex);</span>
<span class="nc bnc" id="L174" title="All 2 branches missed.">      if (ex.getCause() != null) {</span>
<span class="nc" id="L175">        m += &quot;, oorzaak: &quot; + ExceptionUtils.getRootCauseMessage(ex);</span>
      }
<span class="nc" id="L177">      log.error(m, ex);</span>
<span class="nc" id="L178">      this.config.updateSamenvattingEnLogfile(m);</span>
<span class="nc" id="L179">      config.setStatus(ERROR);</span>
    } finally {
<span class="nc" id="L181">      config.setLastrun(new Date());</span>
<span class="nc" id="L182">      Stripersist.getEntityManager().merge(this.config);</span>
<span class="nc bnc" id="L183" title="All 2 branches missed.">      if (Stripersist.getEntityManager().getTransaction().getRollbackOnly()) {</span>
        // XXX bij rollback only wordt status niet naar ERROR gezet vanwege
        // rollback, zou in aparte transactie moeten
<span class="nc" id="L186">        Stripersist.getEntityManager().getTransaction().rollback();</span>
      } else {
<span class="nc" id="L188">        Stripersist.getEntityManager().merge(this.config);</span>
<span class="nc" id="L189">        Stripersist.getEntityManager().getTransaction().commit();</span>
      }
    }
<span class="nc" id="L192">  }</span>

  /**
   * Laadt de berichten uit de xml documenten in een zipfile.
   *
   * @param sUrl te downloaden url van zip file
   * @param naam te gebruiken naam voor zip file
   * @throws Exception if any
   */
  private void laadBestand(String sUrl, final String naam) throws Exception {
<span class="nc" id="L202">    String msg = &quot;Downloaden &quot; + sUrl;</span>
<span class="nc" id="L203">    listener.updateStatus(msg);</span>
<span class="nc" id="L204">    listener.addLog(msg);</span>
<span class="nc" id="L205">    log.info(msg);</span>

<span class="nc" id="L207">    final URL url = new URL(sUrl);</span>
<span class="nc" id="L208">    URLConnection conn = url.openConnection();</span>
<span class="nc" id="L209">    conn.setDoInput(true);</span>
<span class="nc" id="L210">    conn.setDoOutput(false);</span>
<span class="nc" id="L211">    conn.setUseCaches(false);</span>
<span class="nc" id="L212">    conn.setDefaultUseCaches(false);</span>
<span class="nc" id="L213">    conn.setConnectTimeout(30 * 1000);</span>
<span class="nc" id="L214">    conn.setReadTimeout(60 * 1000);</span>
<span class="nc" id="L215">    conn.connect();</span>

<span class="nc" id="L217">    InputStream zipData = conn.getInputStream();</span>
<span class="nc bnc" id="L218" title="All 2 branches missed.">    if (isArchivingOK()) {</span>
<span class="nc" id="L219">      FileOutputStream archiveFile =</span>
<span class="nc" id="L220">          new FileOutputStream(new File(this.config.getArchiefDirectory(), naam));</span>
<span class="nc" id="L221">      zipData = new TeeInputStream(zipData, archiveFile, true);</span>
    }

<span class="nc" id="L224">    ZipInputStream zis = new ZipInputStream(zipData);</span>
<span class="nc" id="L225">    ZipEntry entry = zis.getNextEntry();</span>
<span class="nc bnc" id="L226" title="All 2 branches missed.">    if (entry == null) {</span>
<span class="nc" id="L227">      msg = String.format(&quot;  Geen geschikt bestand gevonden in download %s.&quot;, sUrl);</span>
<span class="nc" id="L228">      listener.addLog(msg);</span>
<span class="nc" id="L229">      return;</span>
    }

<span class="nc bnc" id="L232" title="All 2 branches missed.">    while (entry != null) {</span>
<span class="nc bnc" id="L233" title="All 2 branches missed.">      if (!entry.getName().toLowerCase().endsWith(&quot;.xml&quot;)) {</span>
<span class="nc" id="L234">        msg = &quot;Overslaan zip entry geen XML: &quot; + entry.getName();</span>
<span class="nc" id="L235">        listener.updateStatus(msg);</span>
<span class="nc" id="L236">        listener.addLog(msg);</span>
<span class="nc" id="L237">        log.info(msg);</span>
      } else {
<span class="nc" id="L239">        msg = String.format(&quot;  Lezen XML bestand: %s uit zip&quot;, entry.getName());</span>
<span class="nc" id="L240">        listener.updateStatus(msg);</span>
<span class="nc" id="L241">        listener.addLog(msg);</span>
<span class="nc" id="L242">        log.info(msg);</span>
<span class="nc" id="L243">        final String bestandNaam = naam + &quot;/&quot; + entry.getName();</span>

        try {
<span class="nc" id="L246">          brmo.loadFromStream(</span>
              BrmoFramework.BR_BAG,
<span class="nc" id="L248">              CloseShieldInputStream.wrap(zis),</span>
              bestandNaam,
<span class="nc" id="L250">              new nl.b3p.brmo.loader.ProgressUpdateListener() {</span>
                @Override
                public void total(long total) {
<span class="nc" id="L253">                  listener.addLog(total + &quot; berichten gelezen uit &quot; + bestandNaam);</span>
<span class="nc" id="L254">                  log.info(total + &quot; berichten gelezen uit &quot; + bestandNaam);</span>
<span class="nc" id="L255">                }</span>

                @Override
<span class="nc" id="L258">                public void progress(long progress) {}</span>

                @Override
                public void exception(Throwable t) {
<span class="nc" id="L262">                  listener.exception(t);</span>
<span class="nc" id="L263">                }</span>
              },
<span class="nc" id="L265">              config.getId());</span>
<span class="nc" id="L266">          this.aantalXMLGeladen++;</span>
<span class="nc" id="L267">        } catch (BrmoDuplicaatLaadprocesException dup) {</span>
<span class="nc" id="L268">          this.filterXMLAlVerwerkt++;</span>
<span class="nc" id="L269">          msg = dup.getLocalizedMessage();</span>
<span class="nc" id="L270">          listener.updateStatus(msg);</span>
<span class="nc" id="L271">          listener.addLog(msg);</span>
<span class="nc" id="L272">          log.info(msg);</span>
<span class="nc" id="L273">        } catch (BrmoLeegBestandException ex) {</span>
<span class="nc" id="L274">          this.aantalXMLGeladen++;</span>
<span class="nc" id="L275">          msg = ex.getLocalizedMessage();</span>
<span class="nc" id="L276">          listener.updateStatus(msg);</span>
<span class="nc" id="L277">          listener.addLog(msg);</span>
<span class="nc" id="L278">          log.info(msg);</span>
<span class="nc" id="L279">        }</span>
      }
<span class="nc" id="L281">      entry = zis.getNextEntry();</span>
    }
<span class="nc" id="L283">    IOUtils.closeQuietly(zis);</span>
<span class="nc" id="L284">  }</span>

  /**
   * Bepaal of de zipfile kan worden opgeslagen in de geconfigureerde directory. Als de directory
   * niet bestaat wordt deze aangemaakt.
   *
   * @return true als we de zipfile lokaal kunnen opslaan.
   */
  private boolean isArchivingOK() {
<span class="nc" id="L293">    final String aDir = this.config.getArchiefDirectory();</span>
<span class="nc bnc" id="L294" title="All 2 branches missed.">    boolean isArchiving = (aDir != null);</span>
<span class="nc bnc" id="L295" title="All 2 branches missed.">    if (isArchiving) {</span>
<span class="nc" id="L296">      final File archiefDirectory = new File(aDir);</span>
      try {
<span class="nc" id="L298">        archiefDirectory.mkdirs();</span>
<span class="nc bnc" id="L299" title="All 4 branches missed.">        if (!archiefDirectory.isDirectory() || !archiefDirectory.canWrite()) {</span>
<span class="nc" id="L300">          config.setStatus(ERROR);</span>
<span class="nc" id="L301">          String msg =</span>
<span class="nc" id="L302">              String.format(</span>
                  &quot;FOUT: De archief directory '%s' is geen beschrijfbare directory, zipfiles worden niet gearchiveerd.&quot;,
                  archiefDirectory);
<span class="nc" id="L305">          listener.addLog(msg);</span>
<span class="nc" id="L306">          isArchiving = false;</span>
        }
<span class="nc" id="L308">      } catch (SecurityException e) {</span>
<span class="nc" id="L309">        String msg =</span>
<span class="nc" id="L310">            String.format(</span>
                &quot;SecurityException voor archief directory '%s', zipfiles worden niet gearchiveerd.&quot;,
                archiefDirectory);
<span class="nc" id="L313">        listener.addLog(msg);</span>
<span class="nc" id="L314">        log.error(msg, e);</span>
<span class="nc" id="L315">        isArchiving = false;</span>
<span class="nc" id="L316">      }</span>
    }
<span class="nc" id="L318">    log.debug(&quot;Archief directory ingesteld op &quot; + aDir);</span>
<span class="nc" id="L319">    return isArchiving;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.10.202304240956</span></div></body></html>