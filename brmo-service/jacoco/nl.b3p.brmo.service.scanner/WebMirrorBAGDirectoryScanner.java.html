<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>WebMirrorBAGDirectoryScanner.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">BRMO service</a> &gt; <a href="index.source.html" class="el_package">nl.b3p.brmo.service.scanner</a> &gt; <span class="el_source">WebMirrorBAGDirectoryScanner.java</span></div><h1>WebMirrorBAGDirectoryScanner.java</h1><pre class="source lang-java linenums">/*
 * Copyright (C) 2015 B3Partners B.V.
 */
package nl.b3p.brmo.service.scanner;

import static nl.b3p.brmo.persistence.staging.AutomatischProces.ProcessingStatus.ERROR;
import static nl.b3p.brmo.persistence.staging.AutomatischProces.ProcessingStatus.WAITING;

import nl.b3p.brmo.loader.BrmoFramework;
import nl.b3p.brmo.loader.util.BrmoDuplicaatLaadprocesException;
import nl.b3p.brmo.loader.util.BrmoException;
import nl.b3p.brmo.loader.util.BrmoLeegBestandException;
import nl.b3p.brmo.persistence.staging.AutomatischProces;
import nl.b3p.brmo.persistence.staging.WebMirrorBAGScannerProces;
import nl.b3p.brmo.service.util.ConfigUtil;

import org.apache.commons.io.IOUtils;
import org.apache.commons.io.input.CloseShieldInputStream;
import org.apache.commons.io.input.TeeInputStream;
import org.apache.commons.lang3.exception.ExceptionUtils;
import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import org.jsoup.HttpStatusException;
import org.jsoup.Jsoup;
import org.jsoup.nodes.Document;
import org.jsoup.select.Elements;
import org.stripesstuff.stripersist.Stripersist;

import java.io.File;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.net.MalformedURLException;
import java.net.SocketTimeoutException;
import java.net.URI;
import java.net.URL;
import java.net.URLConnection;
import java.util.Calendar;
import java.util.Date;
import java.util.zip.ZipEntry;
import java.util.zip.ZipInputStream;

/**
 * Proces dat een web directory uitleest voor BAG mutaties in zipfiles.
 *
 * @author mprins
 */
public class WebMirrorBAGDirectoryScanner extends AbstractExecutableProces {

<span class="nc" id="L50">    private static final Log log = LogFactory.getLog(WebMirrorBAGDirectoryScanner.class);</span>

    /** proces data. */
    private final WebMirrorBAGScannerProces config;

    private ProgressUpdateListener listener;

<span class="nc" id="L57">    private BrmoFramework brmo = null;</span>

<span class="nc" id="L59">    private int progress = 0, aantalZipGeladen = 0, aantalXMLGeladen = 0, filterXMLAlVerwerkt = 0;</span>

<span class="nc" id="L61">    public WebMirrorBAGDirectoryScanner(WebMirrorBAGScannerProces config) {</span>
<span class="nc" id="L62">        this.config = config;</span>
        try {
<span class="nc" id="L64">            brmo = new BrmoFramework(ConfigUtil.getDataSourceStaging(), null, null);</span>
<span class="nc" id="L65">        } catch (BrmoException ex) {</span>
<span class="nc" id="L66">            log.fatal(&quot;Initialisatie van BRMO framework is mislukt&quot;, ex);</span>
<span class="nc" id="L67">        }</span>
<span class="nc" id="L68">    }</span>

    @Override
    public void execute() throws BrmoException {
<span class="nc" id="L72">        this.execute(</span>
<span class="nc" id="L73">                new ProgressUpdateListener() {</span>
                    @Override
<span class="nc" id="L75">                    public void total(long total) {}</span>

                    @Override
<span class="nc" id="L78">                    public void progress(long progress) {}</span>

                    @Override
                    public void exception(Throwable t) {
<span class="nc" id="L82">                        log.error(t);</span>
<span class="nc" id="L83">                    }</span>

                    @Override
<span class="nc" id="L86">                    public void updateStatus(String status) {}</span>

                    @Override
<span class="nc" id="L89">                    public void addLog(String log) {}</span>
                });
<span class="nc" id="L91">    }</span>

    @Override
    public void execute(ProgressUpdateListener listener) {
<span class="nc" id="L95">        this.listener = listener;</span>

<span class="nc" id="L97">        String msg = String.format(&quot;Initialiseren... %tc&quot;, new Date());</span>
<span class="nc" id="L98">        listener.updateStatus(msg);</span>
<span class="nc" id="L99">        listener.addLog(msg);</span>
<span class="nc" id="L100">        config.setStatus(AutomatischProces.ProcessingStatus.PROCESSING);</span>
<span class="nc" id="L101">        Stripersist.getEntityManager().flush();</span>

        try {
<span class="nc" id="L104">            String url = this.config.getScanDirectory();</span>
<span class="nc" id="L105">            msg = String.format(&quot;Ophalen van de lijst van links van %s.&quot;, url);</span>
<span class="nc" id="L106">            listener.addLog(msg);</span>
<span class="nc" id="L107">            Document doc =</span>
<span class="nc" id="L108">                    Jsoup.connect(url)</span>
<span class="nc" id="L109">                            .timeout(5000)</span>
<span class="nc" id="L110">                            .followRedirects(true)</span>
<span class="nc" id="L111">                            .ignoreHttpErrors(false)</span>
<span class="nc" id="L112">                            .get();</span>
<span class="nc" id="L113">            msg = &quot;De lijst met download links is succesvol opgehaald.&quot;;</span>
<span class="nc" id="L114">            listener.updateStatus(msg);</span>
<span class="nc" id="L115">            listener.addLog(msg);</span>

<span class="nc" id="L117">            String expression = this.config.getConfig().get(&quot;csspath&quot;).getValue();</span>
<span class="nc" id="L118">            Elements links = doc.select(expression);</span>

            // verwijder een eventuele parent directory link uit de set links
<span class="nc" id="L121">            URI uri = new URI(url);</span>
<span class="nc bnc" id="L122" title="All 2 branches missed.">            URI parent = uri.getPath().endsWith(&quot;/&quot;) ? uri.resolve(&quot;..&quot;) : uri.resolve(&quot;.&quot;);</span>
<span class="nc bnc" id="L123" title="All 2 branches missed.">            if (parent.toString().equalsIgnoreCase(links.first().attr(&quot;abs:href&quot;))) {</span>
<span class="nc" id="L124">                msg = String.format(&quot;Overslaan van (parent) link %s&quot;, parent);</span>
<span class="nc" id="L125">                listener.updateStatus(msg);</span>
<span class="nc" id="L126">                listener.addLog(msg);</span>
<span class="nc" id="L127">                log.info(msg);</span>
<span class="nc" id="L128">                links.remove(links.first());</span>
            }
<span class="nc" id="L130">            int items = links.size();</span>
<span class="nc" id="L131">            listener.total(items);</span>

            String berichtUrl, bestandsnaam;
<span class="nc" id="L134">            progress = 0;</span>
<span class="nc" id="L135">            filterXMLAlVerwerkt = 0;</span>
<span class="nc" id="L136">            aantalZipGeladen = 0;</span>
<span class="nc" id="L137">            aantalXMLGeladen = 0;</span>
<span class="nc bnc" id="L138" title="All 2 branches missed.">            for (int i = 0; i &lt; items; i++) {</span>
<span class="nc" id="L139">                berichtUrl = links.get(i).attr(&quot;abs:href&quot;);</span>
<span class="nc" id="L140">                bestandsnaam = links.get(i).text();</span>
<span class="nc" id="L141">                laadBestand(berichtUrl, bestandsnaam);</span>
<span class="nc" id="L142">                aantalZipGeladen++;</span>
<span class="nc" id="L143">                listener.progress(++progress);</span>
            }

<span class="nc" id="L146">            msg = String.format(&quot;Klaar met run op %tc.&quot;, Calendar.getInstance());</span>
<span class="nc" id="L147">            listener.updateStatus(msg);</span>
<span class="nc" id="L148">            listener.addLog(msg);</span>
<span class="nc" id="L149">            listener.addLog(&quot;\n**** resultaat ****\n&quot;);</span>
<span class="nc" id="L150">            listener.addLog(&quot;Aantal url's gedownloaded: &quot; + aantalZipGeladen);</span>
<span class="nc" id="L151">            listener.addLog(&quot;Aantal xml's geladen: &quot; + aantalXMLGeladen);</span>
<span class="nc" id="L152">            listener.addLog(&quot;Aantal xml's die al waren geladen: &quot; + filterXMLAlVerwerkt);</span>

<span class="nc" id="L154">            config.updateSamenvattingEnLogfile(</span>
                    msg
                            + &quot;\nAantal url's gedownloaded: &quot;
                            + aantalZipGeladen
                            + &quot;\nAantal xml's geladen: &quot;
                            + aantalXMLGeladen
                            + &quot;\nAantal xml's die al waren geladen: &quot;
                            + filterXMLAlVerwerkt);
<span class="nc" id="L162">            config.setStatus(WAITING);</span>
<span class="nc" id="L163">            this.config.setLastrun(new Date());</span>
<span class="nc" id="L164">            Stripersist.getEntityManager().merge(this.config);</span>
<span class="nc" id="L165">            Stripersist.getEntityManager().getTransaction().commit();</span>
<span class="nc" id="L166">        } catch (MalformedURLException | SocketTimeoutException ex) {</span>
<span class="nc" id="L167">            log.error(ex);</span>
<span class="nc" id="L168">            config.setStatus(ERROR);</span>
<span class="nc" id="L169">            listener.exception(ex);</span>
<span class="nc" id="L170">        } catch (HttpStatusException ex) {</span>
<span class="nc" id="L171">            msg =</span>
<span class="nc" id="L172">                    String.format(</span>
                            &quot;Er is een fout opgetreden bij het uitlezen van de url %s. Status code %s&quot;,
<span class="nc" id="L174">                            ex.getUrl(), ex.getStatusCode());</span>
<span class="nc" id="L175">            log.error(msg);</span>
<span class="nc" id="L176">            config.setStatus(ERROR);</span>
<span class="nc" id="L177">            listener.exception(ex);</span>
<span class="nc" id="L178">        } catch (IOException ex) {</span>
<span class="nc" id="L179">            log.error(ex);</span>
<span class="nc" id="L180">            config.setStatus(ERROR);</span>
<span class="nc" id="L181">            listener.exception(ex);</span>
<span class="nc" id="L182">        } catch (Exception ex) {</span>
<span class="nc" id="L183">            log.error(ex);</span>
<span class="nc" id="L184">            listener.exception(ex);</span>
<span class="nc" id="L185">            String m = &quot;Fout bij inladen van berichten: &quot; + ExceptionUtils.getMessage(ex);</span>
<span class="nc bnc" id="L186" title="All 2 branches missed.">            if (ex.getCause() != null) {</span>
<span class="nc" id="L187">                m += &quot;, oorzaak: &quot; + ExceptionUtils.getRootCauseMessage(ex);</span>
            }
<span class="nc" id="L189">            log.error(m, ex);</span>
<span class="nc" id="L190">            this.config.updateSamenvattingEnLogfile(m);</span>
<span class="nc" id="L191">            config.setStatus(ERROR);</span>
        } finally {
<span class="nc" id="L193">            config.setLastrun(new Date());</span>
<span class="nc" id="L194">            Stripersist.getEntityManager().merge(this.config);</span>
<span class="nc bnc" id="L195" title="All 2 branches missed.">            if (Stripersist.getEntityManager().getTransaction().getRollbackOnly()) {</span>
                // XXX bij rollback only wordt status niet naar ERROR gezet vanwege
                // rollback, zou in aparte transactie moeten
<span class="nc" id="L198">                Stripersist.getEntityManager().getTransaction().rollback();</span>
            } else {
<span class="nc" id="L200">                Stripersist.getEntityManager().merge(this.config);</span>
<span class="nc" id="L201">                Stripersist.getEntityManager().getTransaction().commit();</span>
            }
        }
<span class="nc" id="L204">    }</span>

    /**
     * Laadt de berichten uit de xml documenten in een zipfile.
     *
     * @param sUrl te downloaden url van zip file
     * @param naam te gebruiken naam voor zip file
     * @throws Exception if any
     */
    private void laadBestand(String sUrl, final String naam) throws Exception {
<span class="nc" id="L214">        String msg = &quot;Downloaden &quot; + sUrl;</span>
<span class="nc" id="L215">        listener.updateStatus(msg);</span>
<span class="nc" id="L216">        listener.addLog(msg);</span>
<span class="nc" id="L217">        log.info(msg);</span>

<span class="nc" id="L219">        final URL url = new URL(sUrl);</span>
<span class="nc" id="L220">        URLConnection conn = url.openConnection();</span>
<span class="nc" id="L221">        conn.setDoInput(true);</span>
<span class="nc" id="L222">        conn.setDoOutput(false);</span>
<span class="nc" id="L223">        conn.setUseCaches(false);</span>
<span class="nc" id="L224">        conn.setDefaultUseCaches(false);</span>
<span class="nc" id="L225">        conn.setConnectTimeout(30 * 1000);</span>
<span class="nc" id="L226">        conn.setReadTimeout(60 * 1000);</span>
<span class="nc" id="L227">        conn.connect();</span>

<span class="nc" id="L229">        InputStream zipData = conn.getInputStream();</span>
<span class="nc bnc" id="L230" title="All 2 branches missed.">        if (isArchivingOK()) {</span>
<span class="nc" id="L231">            FileOutputStream archiveFile =</span>
<span class="nc" id="L232">                    new FileOutputStream(new File(this.config.getArchiefDirectory(), naam));</span>
<span class="nc" id="L233">            zipData = new TeeInputStream(zipData, archiveFile, true);</span>
        }

<span class="nc" id="L236">        ZipInputStream zis = new ZipInputStream(zipData);</span>
<span class="nc" id="L237">        ZipEntry entry = zis.getNextEntry();</span>
<span class="nc bnc" id="L238" title="All 2 branches missed.">        if (entry == null) {</span>
<span class="nc" id="L239">            msg = String.format(&quot;  Geen geschikt bestand gevonden in download %s.&quot;, sUrl);</span>
<span class="nc" id="L240">            listener.addLog(msg);</span>
<span class="nc" id="L241">            return;</span>
        }

<span class="nc bnc" id="L244" title="All 2 branches missed.">        while (entry != null) {</span>
<span class="nc bnc" id="L245" title="All 2 branches missed.">            if (!entry.getName().toLowerCase().endsWith(&quot;.xml&quot;)) {</span>
<span class="nc" id="L246">                msg = &quot;Overslaan zip entry geen XML: &quot; + entry.getName();</span>
<span class="nc" id="L247">                listener.updateStatus(msg);</span>
<span class="nc" id="L248">                listener.addLog(msg);</span>
<span class="nc" id="L249">                log.info(msg);</span>
            } else {
<span class="nc" id="L251">                msg = String.format(&quot;  Lezen XML bestand: %s uit zip&quot;, entry.getName());</span>
<span class="nc" id="L252">                listener.updateStatus(msg);</span>
<span class="nc" id="L253">                listener.addLog(msg);</span>
<span class="nc" id="L254">                log.info(msg);</span>
<span class="nc" id="L255">                final String bestandNaam = naam + &quot;/&quot; + entry.getName();</span>

                try {
<span class="nc" id="L258">                    brmo.loadFromStream(</span>
                            BrmoFramework.BR_BAG,
<span class="nc" id="L260">                            CloseShieldInputStream.wrap(zis),</span>
                            bestandNaam,
<span class="nc" id="L262">                            new nl.b3p.brmo.loader.ProgressUpdateListener() {</span>
                                @Override
                                public void total(long total) {
<span class="nc" id="L265">                                    listener.addLog(</span>
                                            total + &quot; berichten gelezen uit &quot; + bestandNaam);
<span class="nc" id="L267">                                    log.info(total + &quot; berichten gelezen uit &quot; + bestandNaam);</span>
<span class="nc" id="L268">                                }</span>

                                @Override
<span class="nc" id="L271">                                public void progress(long progress) {}</span>

                                @Override
                                public void exception(Throwable t) {
<span class="nc" id="L275">                                    listener.exception(t);</span>
<span class="nc" id="L276">                                }</span>
                            },
<span class="nc" id="L278">                            config.getId());</span>
<span class="nc" id="L279">                    this.aantalXMLGeladen++;</span>
<span class="nc" id="L280">                } catch (BrmoDuplicaatLaadprocesException dup) {</span>
<span class="nc" id="L281">                    this.filterXMLAlVerwerkt++;</span>
<span class="nc" id="L282">                    msg = dup.getLocalizedMessage();</span>
<span class="nc" id="L283">                    listener.updateStatus(msg);</span>
<span class="nc" id="L284">                    listener.addLog(msg);</span>
<span class="nc" id="L285">                    log.info(msg);</span>
<span class="nc" id="L286">                } catch (BrmoLeegBestandException ex) {</span>
<span class="nc" id="L287">                    this.aantalXMLGeladen++;</span>
<span class="nc" id="L288">                    msg = ex.getLocalizedMessage();</span>
<span class="nc" id="L289">                    listener.updateStatus(msg);</span>
<span class="nc" id="L290">                    listener.addLog(msg);</span>
<span class="nc" id="L291">                    log.info(msg);</span>
<span class="nc" id="L292">                }</span>
            }
<span class="nc" id="L294">            entry = zis.getNextEntry();</span>
        }
<span class="nc" id="L296">        IOUtils.closeQuietly(zis);</span>
<span class="nc" id="L297">    }</span>

    /**
     * Bepaal of de zipfile kan worden opgeslagen in de geconfigureerde directory. Als de directory
     * niet bestaat wordt deze aangemaakt.
     *
     * @return true als we de zipfile lokaal kunnen opslaan.
     */
    private boolean isArchivingOK() {
<span class="nc" id="L306">        final String aDir = this.config.getArchiefDirectory();</span>
<span class="nc bnc" id="L307" title="All 2 branches missed.">        boolean isArchiving = (aDir != null);</span>
<span class="nc bnc" id="L308" title="All 2 branches missed.">        if (isArchiving) {</span>
<span class="nc" id="L309">            final File archiefDirectory = new File(aDir);</span>
            try {
<span class="nc" id="L311">                archiefDirectory.mkdirs();</span>
<span class="nc bnc" id="L312" title="All 4 branches missed.">                if (!archiefDirectory.isDirectory() || !archiefDirectory.canWrite()) {</span>
<span class="nc" id="L313">                    config.setStatus(ERROR);</span>
<span class="nc" id="L314">                    String msg =</span>
<span class="nc" id="L315">                            String.format(</span>
                                    &quot;FOUT: De archief directory '%s' is geen beschrijfbare directory, zipfiles worden niet gearchiveerd.&quot;,
                                    archiefDirectory);
<span class="nc" id="L318">                    listener.addLog(msg);</span>
<span class="nc" id="L319">                    isArchiving = false;</span>
                }
<span class="nc" id="L321">            } catch (SecurityException e) {</span>
<span class="nc" id="L322">                String msg =</span>
<span class="nc" id="L323">                        String.format(</span>
                                &quot;SecurityException voor archief directory '%s', zipfiles worden niet gearchiveerd.&quot;,
                                archiefDirectory);
<span class="nc" id="L326">                listener.addLog(msg);</span>
<span class="nc" id="L327">                log.error(msg, e);</span>
<span class="nc" id="L328">                isArchiving = false;</span>
<span class="nc" id="L329">            }</span>
        }
<span class="nc" id="L331">        log.debug(&quot;Archief directory ingesteld op &quot; + aDir);</span>
<span class="nc" id="L332">        return isArchiving;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>