<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="nl"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BAG2GMLMutatieGroepStream.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">BRMO BAG 2.0 loader</a> &gt; <a href="index.source.html" class="el_package">nl.b3p.brmo.bag2.loader</a> &gt; <span class="el_source">BAG2GMLMutatieGroepStream.java</span></div><h1>BAG2GMLMutatieGroepStream.java</h1><pre class="source lang-java linenums">/*
 * Copyright (C) 2021 B3Partners B.V.
 *
 * SPDX-License-Identifier: MIT
 *
 */

package nl.b3p.brmo.bag2.loader;

import nl.b3p.brmo.bag2.schema.BAG2Object;
import nl.b3p.brmo.bag2.schema.BAG2ObjectType;
import nl.b3p.brmo.bag2.schema.BAG2Schema;
import nl.b3p.brmo.bag2.util.Force2DCoordinateSequenceFactory;
import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import org.codehaus.staxmate.SMInputFactory;
import org.codehaus.staxmate.in.SMEvent;
import org.codehaus.staxmate.in.SMInputCursor;
import org.geotools.gml.stream.XmlStreamGeometryReader;
import org.locationtech.jts.geom.Geometry;
import org.locationtech.jts.geom.GeometryFactory;
import org.locationtech.jts.geom.PrecisionModel;
import org.opengis.referencing.FactoryException;

import javax.xml.namespace.QName;
import javax.xml.stream.Location;
import javax.xml.stream.XMLInputFactory;
import javax.xml.stream.XMLStreamConstants;
import javax.xml.stream.XMLStreamException;
import java.io.IOException;
import java.io.InputStream;
import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Collections;
import java.util.Date;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Objects;
import java.util.Set;

public class BAG2GMLMutatieGroepStream implements Iterable&lt;BAG2MutatieGroep&gt; {
<span class="fc" id="L46">    private static final Log log = LogFactory.getLog(BAG2GMLMutatieGroepStream.class);</span>

    private static final String NS_BAG_EXTRACT = &quot;http://www.kadaster.nl/schemas/lvbag/extract-deelbestand-lvc/v20200601&quot;;
    private static final String NS_BAG_SELECTIES = &quot;http://www.kadaster.nl/schemas/lvbag/extract-selecties/v20200601&quot;;
    private static final String NS_STANDLEVERING = &quot;http://www.kadaster.nl/schemas/standlevering-generiek/1.0&quot;;
    private static final String NS_GML_32 = &quot;http://www.opengis.net/gml/3.2&quot;;
    private static final String NS_HISTORIE = &quot;www.kadaster.nl/schemas/lvbag/imbag/historie/v20200601&quot;;
    private static final String NS_OBJECTEN_REF = &quot;www.kadaster.nl/schemas/lvbag/imbag/objecten-ref/v20200601&quot;;
    private static final String NS_BAG_EXTRACT_MUTATIES = &quot;http://www.kadaster.nl/schemas/lvbag/extract-deelbestand-mutaties-lvc/v20200601&quot;;
    private static final String NS_MUTATIELEVERING = &quot;http://www.kadaster.nl/schemas/mutatielevering-generiek/1.0&quot;;

<span class="fc" id="L57">    private static final QName BAG_STAND = new QName(NS_BAG_EXTRACT, &quot;bagStand&quot;);</span>
<span class="fc" id="L58">    private static final QName BAG_MUTATIES = new QName(NS_BAG_EXTRACT_MUTATIES, &quot;bagMutaties&quot;);</span>
    private static final int SRID = 28992;

    private final XmlStreamGeometryReader geometryReader;

    private final SMInputCursor cursor;

    private boolean isMutaties;
    private boolean hasMutatieGroep;

    private BagInfo bagInfo;

    public static class BagInfo {
        private final Date standTechnischeDatum;
        private final Date mutatieDatumVanaf;
        private final Date mutatieDatumTot;
        private Set&lt;String&gt; gemeenteIdentificaties;

        protected BagInfo(Date standTechnischeDatum, Date mutatieDatumVanaf, Date mutatieDatumTot) {
<span class="fc" id="L77">            this(standTechnischeDatum, mutatieDatumVanaf, mutatieDatumTot, (String)null);</span>
<span class="fc" id="L78">        }</span>

        protected BagInfo(Date standTechnischeDatum, Date mutatieDatumVanaf, Date mutatieDatumTot, String gemeenteIdentificatie) {
<span class="fc" id="L81">            this(standTechnischeDatum, mutatieDatumVanaf, mutatieDatumTot, Collections.singleton(gemeenteIdentificatie));</span>
<span class="fc" id="L82">        }</span>

<span class="fc" id="L84">        protected BagInfo(Date standTechnischeDatum, Date mutatieDatumVanaf, Date mutatieDatumTot, Set&lt;String&gt; gemeenteIdentificaties) {</span>
<span class="fc" id="L85">            this.standTechnischeDatum = standTechnischeDatum;</span>
<span class="fc" id="L86">            this.mutatieDatumVanaf = mutatieDatumVanaf;</span>
<span class="fc" id="L87">            this.mutatieDatumTot = mutatieDatumTot;</span>
<span class="fc" id="L88">            this.gemeenteIdentificaties = gemeenteIdentificaties;</span>
<span class="fc" id="L89">        }</span>

        public Date getStandTechnischeDatum() {
<span class="fc" id="L92">            return standTechnischeDatum;</span>
        }

        public Date getMutatieDatumVanaf() {
<span class="fc" id="L96">            return mutatieDatumVanaf;</span>
        }

        public Date getMutatieDatumTot() {
<span class="fc" id="L100">            return mutatieDatumTot;</span>
        }

        public Set&lt;String&gt; getGemeenteIdentificaties() {
<span class="fc" id="L104">            return gemeenteIdentificaties;</span>
        }

        public void setGemeenteIdentificaties(Set&lt;String&gt; gemeenteIdentificaties) {
<span class="nc" id="L108">            this.gemeenteIdentificaties = gemeenteIdentificaties;</span>
<span class="nc" id="L109">        }</span>

        public boolean equalsExceptGemeenteIdentificaties(Object o) {
<span class="nc bnc" id="L112" title="All 2 branches missed.">            if (this == o) return true;</span>
<span class="nc bnc" id="L113" title="All 4 branches missed.">            if (o == null || getClass() != o.getClass()) return false;</span>
<span class="nc" id="L114">            BagInfo that = (BagInfo) o;</span>
<span class="nc bnc" id="L115" title="All 6 branches missed.">            return Objects.equals(standTechnischeDatum, that.standTechnischeDatum) &amp;&amp; Objects.equals(mutatieDatumVanaf, that.mutatieDatumVanaf) &amp;&amp; Objects.equals(mutatieDatumTot, that.mutatieDatumTot);</span>
        }

        @Override
        public int hashCode() {
<span class="nc" id="L120">            return Objects.hash(standTechnischeDatum, mutatieDatumVanaf, mutatieDatumTot);</span>
        }

        @Override
        public String toString() {
<span class="nc" id="L125">            return &quot;BagInfo{&quot; +</span>
                    &quot;standTechnischeDatum=&quot; + standTechnischeDatum +
                    &quot;, mutatieDatumVanaf=&quot; + mutatieDatumVanaf +
                    &quot;, mutatieDatumTot=&quot; + mutatieDatumTot +
                    '}';
        }
    }

<span class="fc" id="L133">    public BAG2GMLMutatieGroepStream(InputStream in) throws XMLStreamException {</span>
<span class="fc" id="L134">        this.cursor = initCursor(buildSMInputFactory().rootElementCursor(in));</span>
<span class="fc" id="L135">        this.geometryReader = buildGeometryReader();</span>
<span class="fc" id="L136">    }</span>

    protected SMInputFactory buildSMInputFactory() {
        // Using alternative StAX parsers explicitly:
        // final XMLInputFactory stax = new WstxInputFactory(); // Woodstox
        // final XMLInputFactory stax = new com.fasterxml.aalto.stax.InputFactoryImpl(); // Aalto
<span class="fc" id="L142">        final XMLInputFactory xmlInputFactory = XMLInputFactory.newFactory(); // JRE Default, depends on JAR's present or javax.xml.stream.XMLInputFactory property, can be SJSXP</span>
<span class="fc" id="L143">        log.trace(&quot;StAX XMLInputFactory: &quot; + xmlInputFactory.getClass().getName());</span>

<span class="fc" id="L145">        xmlInputFactory.setProperty(XMLInputFactory.IS_COALESCING, Boolean.TRUE); // Coalesce characters</span>
<span class="fc" id="L146">        xmlInputFactory.setProperty(XMLInputFactory.SUPPORT_DTD, Boolean.FALSE); // No XML entity expansions or external entities</span>

<span class="fc" id="L148">        return new SMInputFactory(xmlInputFactory);</span>
    }

    protected XmlStreamGeometryReader buildGeometryReader() {
<span class="fc" id="L152">        GeometryFactory geometryFactory = new GeometryFactory(new PrecisionModel(), 28992, new Force2DCoordinateSequenceFactory());</span>
<span class="fc" id="L153">        return new XmlStreamGeometryReader(this.cursor.getStreamReader(), geometryFactory);</span>
    }

    private SMInputCursor initCursor(SMInputCursor cursor) throws XMLStreamException {
<span class="fc" id="L157">        QName root = cursor.advance().getQName();</span>

<span class="fc bfc" id="L159" title="All 2 branches covered.">        if(root.equals(BAG_STAND)) {</span>
<span class="fc" id="L160">            isMutaties = false;</span>
<span class="pc bpc" id="L161" title="1 of 2 branches missed.">        } else if (root.equals(BAG_MUTATIES)) {</span>
<span class="fc" id="L162">            isMutaties = true;</span>
        } else {
<span class="nc" id="L164">            throw new IllegalArgumentException(&quot;XML root element moet bagStand of bagMutaties zijn&quot;);</span>
        }

<span class="fc" id="L167">        SimpleDateFormat df = new SimpleDateFormat(&quot;yyyy-MM-dd&quot;);</span>
<span class="fc" id="L168">        Date standTechnischeDatum = null;</span>
<span class="fc bfc" id="L169" title="All 2 branches covered.">        if(isMutaties) {</span>
<span class="fc" id="L170">            cursor = cursor.childElementCursor().advance();</span>
<span class="fc" id="L171">            cursor.getStreamReader().require(XMLStreamConstants.START_ELEMENT, NS_BAG_EXTRACT_MUTATIES, &quot;bagInfo&quot;);</span>

<span class="fc" id="L173">            SMInputCursor bagInfoCursor = cursor.descendantElementCursor().advance();</span>
<span class="fc" id="L174">            Date mutatieDatumVanaf = null, mutatieDatumTot = null;</span>
            do {
                try {
<span class="fc bfc" id="L177" title="All 4 branches covered.">                    switch (bagInfoCursor.getLocalName()) {</span>
                        case &quot;StandTechnischeDatum&quot;:
<span class="fc" id="L179">                            standTechnischeDatum = df.parse(bagInfoCursor.collectDescendantText());</span>
<span class="fc" id="L180">                            break;</span>
                        case &quot;MutatiedatumVanaf&quot;:
<span class="fc" id="L182">                            mutatieDatumVanaf = df.parse(bagInfoCursor.collectDescendantText());</span>
<span class="fc" id="L183">                            break;</span>
                        case &quot;MutatiedatumTot&quot;:
<span class="fc" id="L185">                            mutatieDatumTot = df.parse(bagInfoCursor.collectDescendantText());</span>
                            break;
                    }
<span class="nc" id="L188">                } catch(ParseException ignored) {</span>
<span class="fc" id="L189">                }</span>
<span class="fc bfc" id="L190" title="All 2 branches covered.">            } while(bagInfoCursor.getNext() != null);</span>
<span class="fc" id="L191">            bagInfo = new BagInfo(standTechnischeDatum, mutatieDatumVanaf, mutatieDatumTot);</span>

<span class="fc" id="L193">            cursor.getNext();</span>
<span class="fc" id="L194">            cursor.getStreamReader().require(XMLStreamConstants.START_ELEMENT, NS_MUTATIELEVERING, &quot;mutatieBericht&quot;);</span>

<span class="fc" id="L196">            cursor = cursor.childElementCursor(new QName(NS_MUTATIELEVERING, &quot;mutatieGroep&quot;));</span>

<span class="pc bpc" id="L198" title="1 of 2 branches missed.">            hasMutatieGroep = cursor.getNext() != null;</span>
<span class="fc" id="L199">        } else {</span>
<span class="fc" id="L200">            cursor = cursor.childElementCursor().advance();</span>
<span class="fc" id="L201">            cursor.getStreamReader().require(XMLStreamConstants.START_ELEMENT, NS_BAG_EXTRACT, &quot;bagInfo&quot;);</span>

<span class="fc" id="L203">            SMInputCursor bagInfoCursor = cursor.descendantElementCursor().advance();</span>
<span class="fc" id="L204">            String gemeenteIdentificatie = null;</span>
            do {
<span class="pc bpc" id="L206" title="1 of 4 branches missed.">                switch(bagInfoCursor.getLocalName()) {</span>
                    case &quot;StandTechnischeDatum&quot;:
                        try {
<span class="fc" id="L209">                            standTechnischeDatum = df.parse(bagInfoCursor.collectDescendantText());</span>
<span class="nc" id="L210">                        } catch(ParseException ignored) {</span>
<span class="fc" id="L211">                        }</span>
<span class="nc" id="L212">                        break;</span>
                    case &quot;GemeenteIdentificatie&quot;:
<span class="nc bnc" id="L214" title="All 2 branches missed.">                        if (gemeenteIdentificatie != null) {</span>
<span class="nc" id="L215">                            throw new IllegalArgumentException(&quot;Alleen een enkele GemeenteIdentificatie in een GemeenteCollectie wordt ondersteund&quot;);</span>
                        }
<span class="nc" id="L217">                        gemeenteIdentificatie = bagInfoCursor.collectDescendantText();</span>
<span class="nc" id="L218">                        break;</span>
                    case &quot;Gebied-NLD&quot;:
                        // &quot;9999&quot; is code for entire NL area
<span class="fc" id="L221">                        gemeenteIdentificatie = &quot;9999&quot;;</span>
                        break;
                }
<span class="fc bfc" id="L224" title="All 2 branches covered.">            } while(bagInfoCursor.getNext() != null);</span>

<span class="fc" id="L226">            bagInfo = new BagInfo(standTechnischeDatum, null, null, gemeenteIdentificatie);</span>

<span class="fc" id="L228">            cursor.getNext();</span>
<span class="fc" id="L229">            cursor.getStreamReader().require(XMLStreamConstants.START_ELEMENT, NS_STANDLEVERING, &quot;standBestand&quot;);</span>

<span class="fc" id="L231">            cursor = cursor.childElementCursor(new QName(NS_STANDLEVERING, &quot;stand&quot;));</span>
        }

<span class="fc" id="L234">        return cursor;</span>
    }

    public BagInfo getBagInfo() {
<span class="fc" id="L238">        return bagInfo;</span>
    }

    @Override
    public Iterator&lt;BAG2MutatieGroep&gt; iterator() {
<span class="fc" id="L243">        return new Iterator&lt;&gt;() {</span>
<span class="fc" id="L244">            SMEvent event = cursor.getCurrEvent();</span>

            @Override
            public boolean hasNext() {
<span class="pc bpc" id="L248" title="1 of 4 branches missed.">                if (isMutaties &amp;&amp; !hasMutatieGroep) {</span>
<span class="nc" id="L249">                    return false;</span>
                }

<span class="pc bpc" id="L252" title="1 of 2 branches missed.">                if (event != null) {</span>
<span class="nc" id="L253">                    return true;</span>
                }
                try {
<span class="fc" id="L256">                    event = cursor.getNext();</span>
<span class="fc bfc" id="L257" title="All 2 branches covered.">                    return event != null;</span>
<span class="nc" id="L258">                } catch(XMLStreamException e) {</span>
<span class="nc" id="L259">                    throw new RuntimeException(e);</span>
                }
            }

            @Override
            public BAG2MutatieGroep next() {
<span class="fc bfc" id="L265" title="All 2 branches covered.">                if (event == null) {</span>
<span class="pc bpc" id="L266" title="1 of 2 branches missed.">                    if(!hasNext()) {</span>
<span class="nc" id="L267">                        throw new IllegalStateException(&quot;No more items&quot;);</span>
                    }
                }
                // Make sure cursor.getNext() is called in a future next() call
<span class="fc" id="L271">                event = null;</span>

                try {
<span class="fc bfc" id="L274" title="All 2 branches covered.">                    if (isMutaties) {</span>
<span class="pc bpc" id="L275" title="1 of 2 branches missed.">                        if (!hasMutatieGroep) {</span>
<span class="nc" id="L276">                            throw new IllegalStateException(&quot;No items&quot;);</span>
                        }

<span class="fc" id="L279">                        cursor.getStreamReader().require(XMLStreamConstants.START_ELEMENT, NS_MUTATIELEVERING, &quot;mutatieGroep&quot;);</span>
<span class="fc" id="L280">                        SMInputCursor mutatieCursor = cursor.childElementCursor().advance();</span>
<span class="fc" id="L281">                        List&lt;BAG2Mutatie&gt; mutaties = new ArrayList&lt;&gt;();</span>
                        do {
<span class="fc" id="L283">                            String mutatieNaam = mutatieCursor.getLocalName();</span>

<span class="fc" id="L285">                            Location location = mutatieCursor.getCursorLocation();</span>
<span class="fc bfc" id="L286" title="All 2 branches covered.">                            if (mutatieNaam.equals(&quot;wijziging&quot;)) {</span>
<span class="fc" id="L287">                                SMInputCursor wijziging = mutatieCursor.childElementCursor().advance();</span>
<span class="fc" id="L288">                                wijziging.getStreamReader().require(XMLStreamConstants.START_ELEMENT, NS_MUTATIELEVERING, &quot;was&quot;);</span>
<span class="fc" id="L289">                                BAG2Object was = parseBAG2ObjectFromBagObjectParentElement(wijziging, NS_BAG_EXTRACT_MUTATIES);</span>
<span class="fc" id="L290">                                wijziging.getNext();</span>
<span class="fc" id="L291">                                wijziging.getStreamReader().require(XMLStreamConstants.START_ELEMENT, NS_MUTATIELEVERING, &quot;wordt&quot;);</span>
<span class="fc" id="L292">                                BAG2Object wordt = parseBAG2ObjectFromBagObjectParentElement(wijziging, NS_BAG_EXTRACT_MUTATIES);</span>

<span class="fc" id="L294">                                mutaties.add(new BAG2WijzigingMutatie(location, was, wordt));</span>
<span class="pc bpc" id="L295" title="1 of 2 branches missed.">                            } else if (mutatieNaam.equals(&quot;toevoeging&quot;)) {</span>
<span class="fc" id="L296">                                SMInputCursor wijziging = mutatieCursor.childElementCursor().advance();</span>
<span class="fc" id="L297">                                wijziging.getStreamReader().require(XMLStreamConstants.START_ELEMENT, NS_MUTATIELEVERING, &quot;wordt&quot;);</span>
<span class="fc" id="L298">                                BAG2Object toevoeging = parseBAG2ObjectFromBagObjectParentElement(wijziging, NS_BAG_EXTRACT_MUTATIES);</span>
<span class="fc" id="L299">                                mutaties.add(new BAG2ToevoegingMutatie(location, toevoeging));</span>

<span class="pc bnc" id="L301" title="All 2 branches missed.">                            } else if (mutatieNaam.equals(&quot;verwijdering&quot;)) {</span>
<span class="nc" id="L302">                                throw new IllegalArgumentException(&quot;Verwijdering-mutaties mogen niet voorkomen in de BAG2&quot;);</span>
                            } else {
<span class="nc" id="L304">                                throw new IllegalArgumentException(&quot;Onbekende mutatie: &quot; + mutatieNaam);</span>
                            }
<span class="fc bfc" id="L306" title="All 2 branches covered.">                        } while(mutatieCursor.getNext() == SMEvent.START_ELEMENT);</span>

<span class="fc" id="L308">                        return new BAG2MutatieGroep(mutaties);</span>
                    } else {
<span class="fc" id="L310">                        cursor.getStreamReader().require(XMLStreamConstants.START_ELEMENT, NS_STANDLEVERING, &quot;stand&quot;);</span>
<span class="fc" id="L311">                        Location location = cursor.getCursorLocation();</span>
<span class="fc" id="L312">                        BAG2Object object = parseBAG2ObjectFromBagObjectParentElement(cursor, NS_BAG_EXTRACT);</span>
<span class="fc" id="L313">                        return new BAG2MutatieGroep(List.of(new BAG2ToevoegingMutatie(location, object)));</span>
                    }
<span class="nc" id="L315">                } catch(Exception e) {</span>
<span class="nc" id="L316">                    throw new RuntimeException(e);</span>
                }
            }
        };
    }

    private BAG2Object parseBAG2ObjectFromBagObjectParentElement(SMInputCursor bagObjectParentCursor, String bagObjectNamespace) throws XMLStreamException, FactoryException, IOException {
<span class="fc" id="L323">        SMInputCursor bagObjectCursor = bagObjectParentCursor</span>
<span class="fc" id="L324">                .childElementCursor(new QName(bagObjectNamespace, &quot;bagObject&quot;)).advance()</span>
<span class="fc" id="L325">                .childElementCursor().advance();</span>
<span class="fc" id="L326">        return parseBAG2Object(bagObjectCursor);</span>
    }

    private BAG2Object parseBAG2Object(SMInputCursor bagObjectCursor) throws XMLStreamException, FactoryException, IOException {
<span class="fc" id="L330">        String name = bagObjectCursor.getLocalName();</span>

<span class="fc" id="L332">        final BAG2ObjectType objectType = BAG2Schema.getInstance().getObjectTypeByName(name);</span>
<span class="pc bpc" id="L333" title="1 of 2 branches missed.">        if (objectType == null) {</span>
<span class="nc" id="L334">            throw new IllegalArgumentException(&quot;Onbekend object type: &quot; + name);</span>
        }

<span class="fc" id="L337">        Map&lt;String, Object&gt; attributes = new HashMap&lt;&gt;();</span>
<span class="fc" id="L338">        SMInputCursor attributeCursor = bagObjectCursor.childElementCursor();</span>
<span class="fc bfc" id="L339" title="All 2 branches covered.">        while (attributeCursor.getNext() != null) {</span>
<span class="fc" id="L340">            parseAttribute(attributeCursor, attributes);</span>
        }
<span class="fc" id="L342">        return new BAG2Object(objectType, attributes);</span>
    }

    private void parseAttribute(SMInputCursor attribute, Map&lt;String, Object&gt; objectAttributes) throws XMLStreamException, FactoryException, IOException {
<span class="fc" id="L346">        String attributeName = attribute.getLocalName();</span>

<span class="fc bfc" id="L348" title="All 7 branches covered.">        switch (attributeName) {</span>
            case &quot;geometrie&quot;:
                // Position cursor at child element
<span class="fc" id="L351">                SMInputCursor geomCursor = attribute.childElementCursor().advance();</span>
                // Sometimes there is an element like &quot;punt&quot; which has the actual geometry as child element
<span class="fc bfc" id="L353" title="All 2 branches covered.">                if (!geomCursor.getNsUri().equals(NS_GML_32)) {</span>
<span class="fc" id="L354">                    geomCursor.childElementCursor().advance();</span>
                }
<span class="fc" id="L356">                Geometry geom = geometryReader.readGeometry();</span>
<span class="fc" id="L357">                geom.setSRID(SRID);</span>
<span class="fc" id="L358">                objectAttributes.put(attributeName, geom);</span>
<span class="fc" id="L359">                break;</span>
            case &quot;voorkomen&quot;:
                // Flatten al Voorkomen child attributes, according to the schema the element names do not conflict
<span class="fc" id="L362">                parseVoorkomen(attribute, objectAttributes);</span>
<span class="fc" id="L363">                break;</span>
            case &quot;BeschikbaarLV&quot;:
                // Flatten al Voorkomen/BeschikbaarLV child attributes to the top level, according to the schema the element
                // names do not conflict
<span class="fc" id="L367">                parseBeschikbaarLV(attribute, objectAttributes);</span>
<span class="fc" id="L368">                break;</span>
            case &quot;heeftAlsNevenadres&quot;:
<span class="fc" id="L370">                parseNevenadres(attribute, objectAttributes);</span>
<span class="fc" id="L371">                break;</span>
            case &quot;maaktDeelUitVan&quot;:
<span class="fc" id="L373">                parseMaaktDeelUitVan(attribute, objectAttributes);</span>
<span class="fc" id="L374">                break;</span>
            case &quot;gebruiksdoel&quot;:
<span class="fc" id="L376">                parseGebruiksdoel(attribute, objectAttributes);</span>
<span class="fc" id="L377">                break;</span>
            default:
                // String attribute value as default

                // This also works for ligtIn en ligtAan
<span class="fc" id="L382">                objectAttributes.put(attributeName, attribute.collectDescendantText().trim());</span>
                break;
        }
<span class="fc" id="L385">    }</span>

    private void parseVoorkomen(SMInputCursor attributeCursor, Map&lt;String, Object&gt; objectAttributes) throws XMLStreamException, FactoryException, IOException {
<span class="fc" id="L388">        attributeCursor = attributeCursor.childElementCursor(new QName(NS_HISTORIE, &quot;Voorkomen&quot;)).advance().childElementCursor();</span>
<span class="fc bfc" id="L389" title="All 2 branches covered.">        while (attributeCursor.getNext() != null) {</span>
<span class="fc" id="L390">            parseAttribute(attributeCursor, objectAttributes);</span>
        }
<span class="fc" id="L392">    }</span>

    private void parseBeschikbaarLV(SMInputCursor attributeCursor, Map&lt;String, Object&gt; objectAttributes) throws XMLStreamException, FactoryException, IOException {
<span class="fc" id="L395">        attributeCursor = attributeCursor.childElementCursor();</span>
<span class="fc bfc" id="L396" title="All 2 branches covered.">        while (attributeCursor.getNext() != null) {</span>
<span class="fc" id="L397">            parseAttribute(attributeCursor, objectAttributes);</span>
        }
<span class="fc" id="L399">    }</span>

    private void parseNevenadres(SMInputCursor attributeCursor, Map&lt;String, Object&gt; objectAttributes) throws XMLStreamException {
<span class="fc" id="L402">        Set&lt;String&gt; values = new HashSet&lt;&gt;();</span>
<span class="fc" id="L403">        attributeCursor = attributeCursor.childElementCursor(new QName(NS_OBJECTEN_REF, &quot;NummeraanduidingRef&quot;));</span>
<span class="fc bfc" id="L404" title="All 2 branches covered.">        while (attributeCursor.getNext() != null) {</span>
<span class="fc" id="L405">            values.add(attributeCursor.collectDescendantText().trim());</span>
        }
<span class="fc" id="L407">        objectAttributes.put(&quot;heeftAlsNevenadres&quot;, values);</span>
<span class="fc" id="L408">    }</span>

    private void parseMaaktDeelUitVan(SMInputCursor attributeCursor, Map&lt;String, Object&gt; objectAttributes) throws XMLStreamException {
<span class="fc" id="L411">        Set&lt;String&gt; values = new HashSet&lt;&gt;();</span>
<span class="fc" id="L412">        attributeCursor = attributeCursor.childElementCursor(new QName(NS_OBJECTEN_REF, &quot;PandRef&quot;));</span>
<span class="fc bfc" id="L413" title="All 2 branches covered.">        while (attributeCursor.getNext() != null) {</span>
<span class="fc" id="L414">            values.add(attributeCursor.collectDescendantText().trim());</span>
        }
<span class="fc" id="L416">        objectAttributes.put(&quot;maaktDeelUitVan&quot;, values);</span>
<span class="fc" id="L417">    }</span>

    private void parseGebruiksdoel(SMInputCursor attributeCursor, Map&lt;String, Object&gt; objectAttributes) throws XMLStreamException {
<span class="fc" id="L420">        Set&lt;String&gt; values = (Set&lt;String&gt;) objectAttributes.get(&quot;gebruiksdoel&quot;);</span>
<span class="fc bfc" id="L421" title="All 2 branches covered.">        if (values == null) {</span>
<span class="fc" id="L422">            values = new HashSet&lt;&gt;();</span>
<span class="fc" id="L423">            objectAttributes.put(&quot;gebruiksdoel&quot;, values);</span>
        }
<span class="fc" id="L425">        values.add(attributeCursor.collectDescendantText().trim());</span>
<span class="fc" id="L426">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>