<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BAG2GMLMutatieGroepStream.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">BRMO BAG 2.0 loader</a> &gt; <a href="index.source.html" class="el_package">nl.b3p.brmo.bag2.loader</a> &gt; <span class="el_source">BAG2GMLMutatieGroepStream.java</span></div><h1>BAG2GMLMutatieGroepStream.java</h1><pre class="source lang-java linenums">/*
 * Copyright (C) 2021 B3Partners B.V.
 *
 * SPDX-License-Identifier: MIT
 *
 */

package nl.b3p.brmo.bag2.loader;

import java.io.IOException;
import java.io.InputStream;
import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Collections;
import java.util.Date;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Objects;
import java.util.Set;
import javax.xml.namespace.QName;
import javax.xml.stream.Location;
import javax.xml.stream.XMLInputFactory;
import javax.xml.stream.XMLStreamConstants;
import javax.xml.stream.XMLStreamException;
import nl.b3p.brmo.bag2.schema.BAG2Object;
import nl.b3p.brmo.bag2.schema.BAG2ObjectType;
import nl.b3p.brmo.bag2.schema.BAG2Schema;
import nl.b3p.brmo.bag2.util.Force2DCoordinateSequenceFactory;
import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import org.codehaus.staxmate.SMInputFactory;
import org.codehaus.staxmate.in.SMEvent;
import org.codehaus.staxmate.in.SMInputCursor;
import org.geotools.api.referencing.FactoryException;
import org.geotools.gml.stream.XmlStreamGeometryReader;
import org.locationtech.jts.geom.Geometry;
import org.locationtech.jts.geom.GeometryFactory;
import org.locationtech.jts.geom.PrecisionModel;

public class BAG2GMLMutatieGroepStream implements Iterable&lt;BAG2MutatieGroep&gt; {
<span class="fc" id="L45">  private static final Log log = LogFactory.getLog(BAG2GMLMutatieGroepStream.class);</span>

  private static final String NS_BAG_EXTRACT =
      &quot;http://www.kadaster.nl/schemas/lvbag/extract-deelbestand-lvc/v20200601&quot;;
  private static final String NS_STANDLEVERING =
      &quot;http://www.kadaster.nl/schemas/standlevering-generiek/1.0&quot;;
  private static final String NS_GML_32 = &quot;http://www.opengis.net/gml/3.2&quot;;
  private static final String NS_HISTORIE =
      &quot;www.kadaster.nl/schemas/lvbag/imbag/historie/v20200601&quot;;
  private static final String NS_OBJECTEN_REF =
      &quot;www.kadaster.nl/schemas/lvbag/imbag/objecten-ref/v20200601&quot;;
  private static final String NS_BAG_EXTRACT_MUTATIES =
      &quot;http://www.kadaster.nl/schemas/lvbag/extract-deelbestand-mutaties-lvc/v20200601&quot;;
  private static final String NS_MUTATIELEVERING =
      &quot;http://www.kadaster.nl/schemas/mutatielevering-generiek/1.0&quot;;

<span class="fc" id="L61">  private static final QName BAG_STAND = new QName(NS_BAG_EXTRACT, &quot;bagStand&quot;);</span>
<span class="fc" id="L62">  private static final QName BAG_MUTATIES = new QName(NS_BAG_EXTRACT_MUTATIES, &quot;bagMutaties&quot;);</span>
  private static final int SRID = 28992;

  private final XmlStreamGeometryReader geometryReader;

  private final SMInputCursor cursor;

  private boolean isMutaties;
  private boolean hasMutatieGroep;

  private BagInfo bagInfo;

  public static class BagInfo {
    private final Date standTechnischeDatum;
    private final Date mutatieDatumVanaf;
    private final Date mutatieDatumTot;
    private Set&lt;String&gt; gemeenteIdentificaties;

    protected BagInfo(Date standTechnischeDatum, Date mutatieDatumVanaf, Date mutatieDatumTot) {
<span class="fc" id="L81">      this(standTechnischeDatum, mutatieDatumVanaf, mutatieDatumTot, (String) null);</span>
<span class="fc" id="L82">    }</span>

    protected BagInfo(
        Date standTechnischeDatum,
        Date mutatieDatumVanaf,
        Date mutatieDatumTot,
        String gemeenteIdentificatie) {
<span class="fc" id="L89">      this(</span>
          standTechnischeDatum,
          mutatieDatumVanaf,
          mutatieDatumTot,
<span class="fc" id="L93">          Collections.singleton(gemeenteIdentificatie));</span>
<span class="fc" id="L94">    }</span>

    protected BagInfo(
        Date standTechnischeDatum,
        Date mutatieDatumVanaf,
        Date mutatieDatumTot,
<span class="fc" id="L100">        Set&lt;String&gt; gemeenteIdentificaties) {</span>
<span class="fc" id="L101">      this.standTechnischeDatum = standTechnischeDatum;</span>
<span class="fc" id="L102">      this.mutatieDatumVanaf = mutatieDatumVanaf;</span>
<span class="fc" id="L103">      this.mutatieDatumTot = mutatieDatumTot;</span>
<span class="fc" id="L104">      this.gemeenteIdentificaties = gemeenteIdentificaties;</span>
<span class="fc" id="L105">    }</span>

    public Date getStandTechnischeDatum() {
<span class="fc" id="L108">      return standTechnischeDatum;</span>
    }

    public Date getMutatieDatumVanaf() {
<span class="fc" id="L112">      return mutatieDatumVanaf;</span>
    }

    public Date getMutatieDatumTot() {
<span class="fc" id="L116">      return mutatieDatumTot;</span>
    }

    public Set&lt;String&gt; getGemeenteIdentificaties() {
<span class="fc" id="L120">      return gemeenteIdentificaties;</span>
    }

    public void setGemeenteIdentificaties(Set&lt;String&gt; gemeenteIdentificaties) {
<span class="nc" id="L124">      this.gemeenteIdentificaties = gemeenteIdentificaties;</span>
<span class="nc" id="L125">    }</span>

    public boolean equalsExceptGemeenteIdentificaties(Object o) {
<span class="nc bnc" id="L128" title="All 2 branches missed.">      if (this == o) return true;</span>
<span class="nc bnc" id="L129" title="All 4 branches missed.">      if (o == null || getClass() != o.getClass()) return false;</span>
<span class="nc" id="L130">      BagInfo that = (BagInfo) o;</span>
<span class="nc bnc" id="L131" title="All 2 branches missed.">      return Objects.equals(standTechnischeDatum, that.standTechnischeDatum)</span>
<span class="nc bnc" id="L132" title="All 2 branches missed.">          &amp;&amp; Objects.equals(mutatieDatumVanaf, that.mutatieDatumVanaf)</span>
<span class="nc bnc" id="L133" title="All 2 branches missed.">          &amp;&amp; Objects.equals(mutatieDatumTot, that.mutatieDatumTot);</span>
    }

    @Override
    public int hashCode() {
<span class="nc" id="L138">      return Objects.hash(standTechnischeDatum, mutatieDatumVanaf, mutatieDatumTot);</span>
    }

    @SuppressWarnings(&quot;EqualsWhichDoesntCheckParameterClass&quot;)
    @Override
    public boolean equals(Object o) {
<span class="nc" id="L144">      return this.equalsExceptGemeenteIdentificaties(o);</span>
    }

    @Override
    public String toString() {
<span class="nc" id="L149">      return &quot;BagInfo{&quot;</span>
          + &quot;standTechnischeDatum=&quot;
          + standTechnischeDatum
          + &quot;, mutatieDatumVanaf=&quot;
          + mutatieDatumVanaf
          + &quot;, mutatieDatumTot=&quot;
          + mutatieDatumTot
          + '}';
    }
  }

<span class="fc" id="L160">  public BAG2GMLMutatieGroepStream(InputStream in) throws XMLStreamException {</span>
<span class="fc" id="L161">    this.cursor = initCursor(buildSMInputFactory().rootElementCursor(in));</span>
<span class="fc" id="L162">    this.geometryReader = buildGeometryReader();</span>
<span class="fc" id="L163">  }</span>

  protected SMInputFactory buildSMInputFactory() {
    // Using alternative StAX parsers explicitly:
    // final XMLInputFactory stax = new WstxInputFactory(); // Woodstox
    // final XMLInputFactory stax = new com.fasterxml.aalto.stax.InputFactoryImpl(); // Aalto
    final XMLInputFactory xmlInputFactory =
<span class="fc" id="L170">        XMLInputFactory.newFactory(); // JRE Default, depends on JAR's present or</span>
    // javax.xml.stream.XMLInputFactory property, can be SJSXP
<span class="fc" id="L172">    log.trace(&quot;StAX XMLInputFactory: &quot; + xmlInputFactory.getClass().getName());</span>

<span class="fc" id="L174">    xmlInputFactory.setProperty(XMLInputFactory.IS_COALESCING, Boolean.TRUE); // Coalesce characters</span>
<span class="fc" id="L175">    xmlInputFactory.setProperty(</span>
        XMLInputFactory.SUPPORT_DTD,
        Boolean.FALSE); // No XML entity expansions or external entities

<span class="fc" id="L179">    return new SMInputFactory(xmlInputFactory);</span>
  }

  protected XmlStreamGeometryReader buildGeometryReader() {
<span class="fc" id="L183">    GeometryFactory geometryFactory =</span>
        new GeometryFactory(new PrecisionModel(), 28992, new Force2DCoordinateSequenceFactory());
<span class="fc" id="L185">    return new XmlStreamGeometryReader(this.cursor.getStreamReader(), geometryFactory);</span>
  }

  private SMInputCursor initCursor(SMInputCursor cursor) throws XMLStreamException {
<span class="fc" id="L189">    QName root = cursor.advance().getQName();</span>

<span class="fc bfc" id="L191" title="All 2 branches covered.">    if (root.equals(BAG_STAND)) {</span>
<span class="fc" id="L192">      isMutaties = false;</span>
<span class="pc bpc" id="L193" title="1 of 2 branches missed.">    } else if (root.equals(BAG_MUTATIES)) {</span>
<span class="fc" id="L194">      isMutaties = true;</span>
    } else {
<span class="nc" id="L196">      throw new IllegalArgumentException(&quot;XML root element moet bagStand of bagMutaties zijn&quot;);</span>
    }

<span class="fc" id="L199">    SimpleDateFormat df = new SimpleDateFormat(&quot;yyyy-MM-dd&quot;);</span>
<span class="fc" id="L200">    Date standTechnischeDatum = null;</span>
<span class="fc bfc" id="L201" title="All 2 branches covered.">    if (isMutaties) {</span>
<span class="fc" id="L202">      cursor = cursor.childElementCursor().advance();</span>
<span class="fc" id="L203">      cursor</span>
<span class="fc" id="L204">          .getStreamReader()</span>
<span class="fc" id="L205">          .require(XMLStreamConstants.START_ELEMENT, NS_BAG_EXTRACT_MUTATIES, &quot;bagInfo&quot;);</span>

<span class="fc" id="L207">      SMInputCursor bagInfoCursor = cursor.descendantElementCursor().advance();</span>
<span class="fc" id="L208">      Date mutatieDatumVanaf = null, mutatieDatumTot = null;</span>
      do {
        try {
<span class="fc bfc" id="L211" title="All 4 branches covered.">          switch (bagInfoCursor.getLocalName()) {</span>
            case &quot;StandTechnischeDatum&quot;:
<span class="fc" id="L213">              standTechnischeDatum = df.parse(bagInfoCursor.collectDescendantText());</span>
<span class="fc" id="L214">              break;</span>
            case &quot;MutatiedatumVanaf&quot;:
<span class="fc" id="L216">              mutatieDatumVanaf = df.parse(bagInfoCursor.collectDescendantText());</span>
<span class="fc" id="L217">              break;</span>
            case &quot;MutatiedatumTot&quot;:
<span class="fc" id="L219">              mutatieDatumTot = df.parse(bagInfoCursor.collectDescendantText());</span>
              break;
          }
<span class="nc" id="L222">        } catch (ParseException ignored) {</span>
<span class="fc" id="L223">        }</span>
<span class="fc bfc" id="L224" title="All 2 branches covered.">      } while (bagInfoCursor.getNext() != null);</span>
<span class="fc" id="L225">      bagInfo = new BagInfo(standTechnischeDatum, mutatieDatumVanaf, mutatieDatumTot);</span>

<span class="fc" id="L227">      cursor.getNext();</span>
<span class="fc" id="L228">      cursor</span>
<span class="fc" id="L229">          .getStreamReader()</span>
<span class="fc" id="L230">          .require(XMLStreamConstants.START_ELEMENT, NS_MUTATIELEVERING, &quot;mutatieBericht&quot;);</span>

<span class="fc" id="L232">      cursor = cursor.childElementCursor(new QName(NS_MUTATIELEVERING, &quot;mutatieGroep&quot;));</span>

<span class="pc bpc" id="L234" title="1 of 2 branches missed.">      hasMutatieGroep = cursor.getNext() != null;</span>
<span class="fc" id="L235">    } else {</span>
<span class="fc" id="L236">      cursor = cursor.childElementCursor().advance();</span>
<span class="fc" id="L237">      cursor.getStreamReader().require(XMLStreamConstants.START_ELEMENT, NS_BAG_EXTRACT, &quot;bagInfo&quot;);</span>

<span class="fc" id="L239">      SMInputCursor bagInfoCursor = cursor.descendantElementCursor().advance();</span>
<span class="fc" id="L240">      String gemeenteIdentificatie = null;</span>
      do {
<span class="pc bpc" id="L242" title="1 of 4 branches missed.">        switch (bagInfoCursor.getLocalName()) {</span>
          case &quot;StandTechnischeDatum&quot;:
            try {
<span class="fc" id="L245">              standTechnischeDatum = df.parse(bagInfoCursor.collectDescendantText());</span>
<span class="nc" id="L246">            } catch (ParseException ignored) {</span>
<span class="fc" id="L247">            }</span>
<span class="nc" id="L248">            break;</span>
          case &quot;GemeenteIdentificatie&quot;:
<span class="nc bnc" id="L250" title="All 2 branches missed.">            if (gemeenteIdentificatie != null) {</span>
<span class="nc" id="L251">              throw new IllegalArgumentException(</span>
                  &quot;Alleen een enkele GemeenteIdentificatie in een GemeenteCollectie wordt ondersteund&quot;);
            }
<span class="nc" id="L254">            gemeenteIdentificatie = bagInfoCursor.collectDescendantText();</span>
<span class="nc" id="L255">            break;</span>
          case &quot;Gebied-NLD&quot;:
            // &quot;9999&quot; is code for entire NL area
<span class="fc" id="L258">            gemeenteIdentificatie = &quot;9999&quot;;</span>
            break;
        }
<span class="fc bfc" id="L261" title="All 2 branches covered.">      } while (bagInfoCursor.getNext() != null);</span>

<span class="fc" id="L263">      bagInfo = new BagInfo(standTechnischeDatum, null, null, gemeenteIdentificatie);</span>

<span class="fc" id="L265">      cursor.getNext();</span>
<span class="fc" id="L266">      cursor</span>
<span class="fc" id="L267">          .getStreamReader()</span>
<span class="fc" id="L268">          .require(XMLStreamConstants.START_ELEMENT, NS_STANDLEVERING, &quot;standBestand&quot;);</span>

<span class="fc" id="L270">      cursor = cursor.childElementCursor(new QName(NS_STANDLEVERING, &quot;stand&quot;));</span>
    }

<span class="fc" id="L273">    return cursor;</span>
  }

  public BagInfo getBagInfo() {
<span class="fc" id="L277">    return bagInfo;</span>
  }

  @Override
  public Iterator&lt;BAG2MutatieGroep&gt; iterator() {
<span class="fc" id="L282">    return new Iterator&lt;&gt;() {</span>
<span class="fc" id="L283">      SMEvent event = cursor.getCurrEvent();</span>

      @Override
      public boolean hasNext() {
<span class="pc bpc" id="L287" title="1 of 4 branches missed.">        if (isMutaties &amp;&amp; !hasMutatieGroep) {</span>
<span class="nc" id="L288">          return false;</span>
        }

<span class="pc bpc" id="L291" title="1 of 2 branches missed.">        if (event != null) {</span>
<span class="nc" id="L292">          return true;</span>
        }
        try {
<span class="fc" id="L295">          event = cursor.getNext();</span>
<span class="fc bfc" id="L296" title="All 2 branches covered.">          return event != null;</span>
<span class="nc" id="L297">        } catch (XMLStreamException e) {</span>
<span class="nc" id="L298">          throw new RuntimeException(e);</span>
        }
      }

      @Override
      public BAG2MutatieGroep next() {
<span class="fc bfc" id="L304" title="All 2 branches covered.">        if (event == null) {</span>
<span class="pc bpc" id="L305" title="1 of 2 branches missed.">          if (!hasNext()) {</span>
<span class="nc" id="L306">            throw new IllegalStateException(&quot;No more items&quot;);</span>
          }
        }
        // Make sure cursor.getNext() is called in a future next() call
<span class="fc" id="L310">        event = null;</span>

        try {
<span class="fc bfc" id="L313" title="All 2 branches covered.">          if (isMutaties) {</span>
<span class="pc bpc" id="L314" title="1 of 2 branches missed.">            if (!hasMutatieGroep) {</span>
<span class="nc" id="L315">              throw new IllegalStateException(&quot;No items&quot;);</span>
            }

<span class="fc" id="L318">            cursor</span>
<span class="fc" id="L319">                .getStreamReader()</span>
<span class="fc" id="L320">                .require(XMLStreamConstants.START_ELEMENT, NS_MUTATIELEVERING, &quot;mutatieGroep&quot;);</span>
<span class="fc" id="L321">            SMInputCursor mutatieCursor = cursor.childElementCursor().advance();</span>
<span class="fc" id="L322">            List&lt;BAG2Mutatie&gt; mutaties = new ArrayList&lt;&gt;();</span>
            do {
<span class="fc" id="L324">              String mutatieNaam = mutatieCursor.getLocalName();</span>

<span class="fc" id="L326">              Location location = mutatieCursor.getCursorLocation();</span>
<span class="pc bpc" id="L327" title="2 of 4 branches missed.">              switch (mutatieNaam) {</span>
                case &quot;wijziging&quot;:
                  {
<span class="fc" id="L330">                    SMInputCursor wijziging = mutatieCursor.childElementCursor().advance();</span>
<span class="fc" id="L331">                    wijziging</span>
<span class="fc" id="L332">                        .getStreamReader()</span>
<span class="fc" id="L333">                        .require(XMLStreamConstants.START_ELEMENT, NS_MUTATIELEVERING, &quot;was&quot;);</span>
<span class="fc" id="L334">                    BAG2Object was =</span>
<span class="fc" id="L335">                        parseBAG2ObjectFromBagObjectParentElement(</span>
                            wijziging, NS_BAG_EXTRACT_MUTATIES);
<span class="fc" id="L337">                    wijziging.getNext();</span>
<span class="fc" id="L338">                    wijziging</span>
<span class="fc" id="L339">                        .getStreamReader()</span>
<span class="fc" id="L340">                        .require(XMLStreamConstants.START_ELEMENT, NS_MUTATIELEVERING, &quot;wordt&quot;);</span>
<span class="fc" id="L341">                    BAG2Object wordt =</span>
<span class="fc" id="L342">                        parseBAG2ObjectFromBagObjectParentElement(</span>
                            wijziging, NS_BAG_EXTRACT_MUTATIES);

<span class="fc" id="L345">                    mutaties.add(new BAG2WijzigingMutatie(location, was, wordt));</span>
<span class="fc" id="L346">                    break;</span>
                  }
                case &quot;toevoeging&quot;:
                  {
<span class="fc" id="L350">                    SMInputCursor wijziging = mutatieCursor.childElementCursor().advance();</span>
<span class="fc" id="L351">                    wijziging</span>
<span class="fc" id="L352">                        .getStreamReader()</span>
<span class="fc" id="L353">                        .require(XMLStreamConstants.START_ELEMENT, NS_MUTATIELEVERING, &quot;wordt&quot;);</span>
<span class="fc" id="L354">                    BAG2Object toevoeging =</span>
<span class="fc" id="L355">                        parseBAG2ObjectFromBagObjectParentElement(</span>
                            wijziging, NS_BAG_EXTRACT_MUTATIES);
<span class="fc" id="L357">                    mutaties.add(new BAG2ToevoegingMutatie(location, toevoeging));</span>

<span class="fc" id="L359">                    break;</span>
                  }
                case &quot;verwijdering&quot;:
<span class="nc" id="L362">                  throw new IllegalArgumentException(</span>
                      &quot;Verwijdering-mutaties mogen niet voorkomen in de BAG2&quot;);
                default:
<span class="nc" id="L365">                  throw new IllegalArgumentException(&quot;Onbekende mutatie: &quot; + mutatieNaam);</span>
              }
<span class="fc bfc" id="L367" title="All 2 branches covered.">            } while (mutatieCursor.getNext() == SMEvent.START_ELEMENT);</span>

<span class="fc" id="L369">            return new BAG2MutatieGroep(mutaties);</span>
          } else {
<span class="fc" id="L371">            cursor</span>
<span class="fc" id="L372">                .getStreamReader()</span>
<span class="fc" id="L373">                .require(XMLStreamConstants.START_ELEMENT, NS_STANDLEVERING, &quot;stand&quot;);</span>
<span class="fc" id="L374">            Location location = cursor.getCursorLocation();</span>
<span class="fc" id="L375">            BAG2Object object = parseBAG2ObjectFromBagObjectParentElement(cursor, NS_BAG_EXTRACT);</span>
<span class="fc" id="L376">            return new BAG2MutatieGroep(List.of(new BAG2ToevoegingMutatie(location, object)));</span>
          }
<span class="nc" id="L378">        } catch (Exception e) {</span>
<span class="nc" id="L379">          throw new RuntimeException(e);</span>
        }
      }
    };
  }

  private BAG2Object parseBAG2ObjectFromBagObjectParentElement(
      SMInputCursor bagObjectParentCursor, String bagObjectNamespace)
      throws XMLStreamException, FactoryException, IOException {
<span class="fc" id="L388">    SMInputCursor bagObjectCursor =</span>
        bagObjectParentCursor
<span class="fc" id="L390">            .childElementCursor(new QName(bagObjectNamespace, &quot;bagObject&quot;))</span>
<span class="fc" id="L391">            .advance()</span>
<span class="fc" id="L392">            .childElementCursor()</span>
<span class="fc" id="L393">            .advance();</span>
<span class="fc" id="L394">    return parseBAG2Object(bagObjectCursor);</span>
  }

  private BAG2Object parseBAG2Object(SMInputCursor bagObjectCursor)
      throws XMLStreamException, FactoryException, IOException {
<span class="fc" id="L399">    String name = bagObjectCursor.getLocalName();</span>

<span class="fc" id="L401">    final BAG2ObjectType objectType = BAG2Schema.getInstance().getObjectTypeByName(name);</span>
<span class="pc bpc" id="L402" title="1 of 2 branches missed.">    if (objectType == null) {</span>
<span class="nc" id="L403">      throw new IllegalArgumentException(&quot;Onbekend object type: &quot; + name);</span>
    }

<span class="fc" id="L406">    Map&lt;String, Object&gt; attributes = new HashMap&lt;&gt;();</span>
<span class="fc" id="L407">    SMInputCursor attributeCursor = bagObjectCursor.childElementCursor();</span>
<span class="fc bfc" id="L408" title="All 2 branches covered.">    while (attributeCursor.getNext() != null) {</span>
<span class="fc" id="L409">      parseAttribute(attributeCursor, attributes);</span>
    }
<span class="fc" id="L411">    return new BAG2Object(objectType, attributes);</span>
  }

  private void parseAttribute(SMInputCursor attribute, Map&lt;String, Object&gt; objectAttributes)
      throws XMLStreamException, FactoryException, IOException {
<span class="fc" id="L416">    String attributeName = attribute.getLocalName();</span>

<span class="fc bfc" id="L418" title="All 7 branches covered.">    switch (attributeName) {</span>
      case &quot;geometrie&quot;:
        // Position cursor at child element
<span class="fc" id="L421">        SMInputCursor geomCursor = attribute.childElementCursor().advance();</span>
        // Sometimes there is an element like &quot;punt&quot; which has the actual geometry as child
        // element
<span class="fc bfc" id="L424" title="All 2 branches covered.">        if (!geomCursor.getNsUri().equals(NS_GML_32)) {</span>
<span class="fc" id="L425">          geomCursor.childElementCursor().advance();</span>
        }
<span class="fc" id="L427">        Geometry geom = geometryReader.readGeometry();</span>
<span class="fc" id="L428">        geom.setSRID(SRID);</span>
<span class="fc" id="L429">        objectAttributes.put(attributeName, geom);</span>
<span class="fc" id="L430">        break;</span>
      case &quot;voorkomen&quot;:
        // Flatten al Voorkomen child attributes, according to the schema the element names
        // do not conflict
<span class="fc" id="L434">        parseVoorkomen(attribute, objectAttributes);</span>
<span class="fc" id="L435">        break;</span>
      case &quot;BeschikbaarLV&quot;:
        // Flatten al Voorkomen/BeschikbaarLV child attributes to the top level, according
        // to the schema the element
        // names do not conflict
<span class="fc" id="L440">        parseBeschikbaarLV(attribute, objectAttributes);</span>
<span class="fc" id="L441">        break;</span>
      case &quot;heeftAlsNevenadres&quot;:
<span class="fc" id="L443">        parseNevenadres(attribute, objectAttributes);</span>
<span class="fc" id="L444">        break;</span>
      case &quot;maaktDeelUitVan&quot;:
<span class="fc" id="L446">        parseMaaktDeelUitVan(attribute, objectAttributes);</span>
<span class="fc" id="L447">        break;</span>
      case &quot;gebruiksdoel&quot;:
<span class="fc" id="L449">        parseGebruiksdoel(attribute, objectAttributes);</span>
<span class="fc" id="L450">        break;</span>
      default:
        // String attribute value as default

        // This also works for ligtIn en ligtAan
<span class="fc" id="L455">        objectAttributes.put(attributeName, attribute.collectDescendantText().trim());</span>
        break;
    }
<span class="fc" id="L458">  }</span>

  private void parseVoorkomen(SMInputCursor attributeCursor, Map&lt;String, Object&gt; objectAttributes)
      throws XMLStreamException, FactoryException, IOException {
<span class="fc" id="L462">    attributeCursor =</span>
        attributeCursor
<span class="fc" id="L464">            .childElementCursor(new QName(NS_HISTORIE, &quot;Voorkomen&quot;))</span>
<span class="fc" id="L465">            .advance()</span>
<span class="fc" id="L466">            .childElementCursor();</span>
<span class="fc bfc" id="L467" title="All 2 branches covered.">    while (attributeCursor.getNext() != null) {</span>
<span class="fc" id="L468">      parseAttribute(attributeCursor, objectAttributes);</span>
    }
<span class="fc" id="L470">  }</span>

  private void parseBeschikbaarLV(
      SMInputCursor attributeCursor, Map&lt;String, Object&gt; objectAttributes)
      throws XMLStreamException, FactoryException, IOException {
<span class="fc" id="L475">    attributeCursor = attributeCursor.childElementCursor();</span>
<span class="fc bfc" id="L476" title="All 2 branches covered.">    while (attributeCursor.getNext() != null) {</span>
<span class="fc" id="L477">      parseAttribute(attributeCursor, objectAttributes);</span>
    }
<span class="fc" id="L479">  }</span>

  private void parseNevenadres(SMInputCursor attributeCursor, Map&lt;String, Object&gt; objectAttributes)
      throws XMLStreamException {
<span class="fc" id="L483">    Set&lt;String&gt; values = new HashSet&lt;&gt;();</span>
<span class="fc" id="L484">    attributeCursor =</span>
<span class="fc" id="L485">        attributeCursor.childElementCursor(new QName(NS_OBJECTEN_REF, &quot;NummeraanduidingRef&quot;));</span>
<span class="fc bfc" id="L486" title="All 2 branches covered.">    while (attributeCursor.getNext() != null) {</span>
<span class="fc" id="L487">      values.add(attributeCursor.collectDescendantText().trim());</span>
    }
<span class="fc" id="L489">    objectAttributes.put(&quot;heeftAlsNevenadres&quot;, values);</span>
<span class="fc" id="L490">  }</span>

  private void parseMaaktDeelUitVan(
      SMInputCursor attributeCursor, Map&lt;String, Object&gt; objectAttributes)
      throws XMLStreamException {
<span class="fc" id="L495">    Set&lt;String&gt; values = new HashSet&lt;&gt;();</span>
<span class="fc" id="L496">    attributeCursor = attributeCursor.childElementCursor(new QName(NS_OBJECTEN_REF, &quot;PandRef&quot;));</span>
<span class="fc bfc" id="L497" title="All 2 branches covered.">    while (attributeCursor.getNext() != null) {</span>
<span class="fc" id="L498">      values.add(attributeCursor.collectDescendantText().trim());</span>
    }
<span class="fc" id="L500">    objectAttributes.put(&quot;maaktDeelUitVan&quot;, values);</span>
<span class="fc" id="L501">  }</span>

  private void parseGebruiksdoel(
      SMInputCursor attributeCursor, Map&lt;String, Object&gt; objectAttributes)
      throws XMLStreamException {
<span class="fc" id="L506">    Set&lt;String&gt; values = (Set&lt;String&gt;) objectAttributes.get(&quot;gebruiksdoel&quot;);</span>
<span class="fc bfc" id="L507" title="All 2 branches covered.">    if (values == null) {</span>
<span class="fc" id="L508">      values = new HashSet&lt;&gt;();</span>
<span class="fc" id="L509">      objectAttributes.put(&quot;gebruiksdoel&quot;, values);</span>
    }
<span class="fc" id="L511">    values.add(attributeCursor.collectDescendantText().trim());</span>
<span class="fc" id="L512">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>