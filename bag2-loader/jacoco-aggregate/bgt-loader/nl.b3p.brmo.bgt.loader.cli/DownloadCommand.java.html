<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="nl"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>DownloadCommand.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">BRMO BAG 2.0 loader</a> &gt; <a href="../index.html" class="el_bundle">bgt-loader</a> &gt; <a href="index.source.html" class="el_package">nl.b3p.brmo.bgt.loader.cli</a> &gt; <span class="el_source">DownloadCommand.java</span></div><h1>DownloadCommand.java</h1><pre class="source lang-java linenums">/*
 * Copyright (C) 2021 B3Partners B.V.
 *
 * SPDX-License-Identifier: MIT
 */

package nl.b3p.brmo.bgt.loader.cli;

import nl.b3p.brmo.bgt.download.api.CustomDownloadProgress;
import nl.b3p.brmo.bgt.download.api.DeltaApi;
import nl.b3p.brmo.bgt.download.api.DownloadApiUtils;
import nl.b3p.brmo.bgt.download.client.ApiClient;
import nl.b3p.brmo.bgt.download.client.ApiException;
import nl.b3p.brmo.bgt.download.model.Delta;
import nl.b3p.brmo.bgt.download.model.GetDeltasResponse;
import nl.b3p.brmo.bgt.loader.BGTDatabase;
import nl.b3p.brmo.bgt.loader.ProgressReporter;
import nl.b3p.brmo.bgt.schema.BGTObjectTableWriter;
import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import picocli.CommandLine.Command;
import picocli.CommandLine.ExitCode;
import picocli.CommandLine.Mixin;
import picocli.CommandLine.Option;

import java.net.URI;
import java.sql.SQLException;
import java.time.Instant;
import java.time.OffsetDateTime;
import java.time.format.DateTimeFormatter;
import java.util.Arrays;
import java.util.List;
import java.util.Objects;
import java.util.function.Consumer;

import static nl.b3p.brmo.bgt.loader.Utils.formatTimeSince;
import static nl.b3p.brmo.bgt.loader.Utils.getBrmoVersion;
import static nl.b3p.brmo.bgt.loader.Utils.getBundleString;
import static nl.b3p.brmo.bgt.loader.Utils.getLoaderVersion;
import static nl.b3p.brmo.bgt.loader.Utils.getMessageFormattedString;
import static nl.b3p.brmo.bgt.loader.Utils.getUserAgent;
import static nl.b3p.brmo.bgt.schema.BGTSchemaMapper.Metadata;

@Command(name = &quot;download&quot;, mixinStandardHelpOptions = true)
<span class="nc" id="L45">public class DownloadCommand {</span>
<span class="nc" id="L46">    private static final Log log = LogFactory.getLog(DownloadCommand.class);</span>

    private static final String PREDEFINED_FULL_DELTA_URI = &quot;https://api.pdok.nl/lv/bgt/download/v1_0/delta/predefined/bgt-citygml-nl-delta.zip&quot;;

    /** zodat we een JNDI database kunne gebruiken. */
<span class="nc" id="L51">    private BGTDatabase bgtDatabase = null;</span>

    public static ApiClient getApiClient(URI baseUri) {
<span class="nc" id="L54">        ApiClient client = new ApiClient();</span>
<span class="nc bnc" id="L55" title="All 2 branches missed.">        if (baseUri != null) {</span>
<span class="nc" id="L56">            client.updateBaseUri(baseUri.toString());</span>
        }
<span class="nc" id="L58">        client.setRequestInterceptor(builder -&gt; builder.headers(&quot;User-Agent&quot;, getUserAgent()));</span>
<span class="nc" id="L59">        return client;</span>
    }

    private BGTObjectTableWriter createWriter(BGTDatabase db, DatabaseOptions dbOptions, LoadOptions loadOptions, CLIOptions cliOptions) throws SQLException {
<span class="nc" id="L63">        BGTObjectTableWriter writer = db.createObjectTableWriter(loadOptions, dbOptions);</span>
        ProgressReporter progressReporter;
<span class="nc bnc" id="L65" title="All 2 branches missed.">        if (cliOptions.isConsoleProgressEnabled()) {</span>
<span class="nc" id="L66">            progressReporter = new ConsoleProgressReporter();</span>
        } else {
<span class="nc" id="L68">            progressReporter = new ProgressReporter();</span>
        }
<span class="nc" id="L70">        writer.setProgressUpdater(progressReporter);</span>
<span class="nc" id="L71">        return writer;</span>
    }

    @Command(name=&quot;initial&quot;, sortOptions = false)
    public int initial(
            @Mixin DatabaseOptions dbOptions,
            @Mixin LoadOptions loadOptions,
            @Mixin ExtractSelectionOptions extractSelectionOptions,
            @Option(names=&quot;--no-geo-filter&quot;) boolean noGeoFilter,
            @Option(names=&quot;--download-service&quot;, hidden = true) URI downloadServiceURI,
            @Mixin CLIOptions cliOptions,
            @Option(names={&quot;-h&quot;,&quot;--help&quot;}, usageHelp = true) boolean showHelp
    ) throws Exception {

<span class="nc bnc" id="L85" title="All 4 branches missed.">        if (extractSelectionOptions.getGeoFilterWkt() == null &amp;&amp; !noGeoFilter) {</span>
<span class="nc" id="L86">            log.error(getBundleString(&quot;download.no_geo_filter&quot;));</span>
<span class="nc" id="L87">            return ExitCode.USAGE;</span>
        }

<span class="nc" id="L90">        log.info(getUserAgent());</span>

<span class="nc" id="L92">        try(BGTDatabase db = this.getBGTdatabase(dbOptions)) {</span>
<span class="nc bnc" id="L93" title="All 2 branches missed.">            if (loadOptions.createSchema) {</span>
<span class="nc" id="L94">                db.createMetadataTable(loadOptions);</span>
            } else {
<span class="nc" id="L96">                log.info(getBundleString(&quot;download.connect_db&quot;));</span>
            }

<span class="nc" id="L99">            db.setMetadataValue(Metadata.LOADER_VERSION, getLoaderVersion());</span>
<span class="nc" id="L100">            db.setMetadataValue(Metadata.BRMOVERSIE, getBrmoVersion());</span>
<span class="nc" id="L101">            db.setFeatureTypesEnumMetadata(extractSelectionOptions.getFeatureTypesList());</span>
<span class="nc" id="L102">            db.setMetadataValue(Metadata.INCLUDE_HISTORY, loadOptions.includeHistory + &quot;&quot;);</span>
<span class="nc" id="L103">            db.setMetadataValue(Metadata.LINEARIZE_CURVES, loadOptions.linearizeCurves + &quot;&quot;);</span>
<span class="nc" id="L104">            db.setMetadataValue(Metadata.TABLE_PREFIX, loadOptions.tablePrefix);</span>

<span class="nc" id="L106">            Instant start = null;</span>
            URI uri;
<span class="nc bnc" id="L108" title="All 2 branches missed.">            if (noGeoFilter) {</span>
<span class="nc" id="L109">                uri = new URI(PREDEFINED_FULL_DELTA_URI);</span>
            } else {
                // Close connection while waiting for extract
<span class="nc" id="L112">                db.close();</span>
<span class="nc" id="L113">                start = Instant.now(); // Record total time waiting for extract</span>
<span class="nc" id="L114">                uri = getCustomDownloadURI(downloadServiceURI, extractSelectionOptions, new CustomDownloadProgressReporter(cliOptions.isConsoleProgressEnabled()));</span>
            }
<span class="nc" id="L116">            BGTObjectTableWriter writer = createWriter(db, dbOptions, loadOptions, cliOptions);</span>
<span class="nc" id="L117">            loadZipFromURI(uri, db, writer, extractSelectionOptions, loadOptions, noGeoFilter, start);</span>

<span class="nc" id="L119">            db.setMetadataValue(Metadata.DELTA_TIME_TO, null);</span>
            // Do not set geom filter from MutatieInhoud, a custom download without geo filter will have gebied
            // &quot;POLYGON ((-100000 200000, 412000 200000, 412000 712000, -100000 712000, -100000 200000))&quot;
<span class="nc" id="L122">            db.setMetadataValue(Metadata.GEOM_FILTER, extractSelectionOptions.getGeoFilterWkt());</span>

<span class="nc" id="L124">            db.getConnection().commit();</span>
<span class="nc" id="L125">            return ExitCode.OK;</span>
        }
    }

    /**
     * set a preconfigured database instead of using one created in the command using the dbOtions. Useful when using a JDNI database.
     *
     * @param bgtDatabase the BGT database to use for any issued commands
     */
    public void setBGTDatabase(BGTDatabase bgtDatabase) {
<span class="nc" id="L135">        this.bgtDatabase = bgtDatabase;</span>
<span class="nc" id="L136">    }</span>

    private BGTDatabase getBGTdatabase(DatabaseOptions dbOptions) throws ClassNotFoundException {
<span class="nc bnc" id="L139" title="All 2 branches missed.">        if (null == this.bgtDatabase) {</span>
<span class="nc" id="L140">            return new BGTDatabase(dbOptions);</span>
<span class="nc" id="L141">        } else return this.bgtDatabase;</span>
    }

    private static URI getCustomDownloadURI(URI downloadServiceURI, ExtractSelectionOptions extractSelectionOptions, Consumer&lt;CustomDownloadProgress&gt; progressConsumer) throws ApiException, InterruptedException {
        try {
<span class="nc" id="L146">            log.info(getBundleString(&quot;download.create&quot;));</span>
<span class="nc" id="L147">            ApiClient client = getApiClient(downloadServiceURI);</span>
<span class="nc" id="L148">            return DownloadApiUtils.getCustomDownloadURL(client, null, extractSelectionOptions, progressConsumer);</span>
<span class="nc" id="L149">        } catch(ApiException apiException) {</span>
<span class="nc" id="L150">            printApiException(apiException);</span>
<span class="nc" id="L151">            throw apiException;</span>
        }
    }

    @Command(name=&quot;update&quot;, sortOptions = false)
    public int update(
            @Mixin DatabaseOptions dbOptions,
            @Mixin CLIOptions cliOptions,
            @Option(names=&quot;--download-service&quot;, hidden = true) URI downloadServiceURI,
            @Option(names=&quot;--no-http-zip-random-access&quot;, negatable = true, hidden = true) boolean noHttpZipRandomAccess,
            @Option(names={&quot;-h&quot;,&quot;--help&quot;}, usageHelp = true) boolean showHelp
    ) throws Exception {
<span class="nc" id="L163">        log.info(getUserAgent());</span>

<span class="nc" id="L165">        ApiClient client = getApiClient(downloadServiceURI);</span>

<span class="nc" id="L167">        log.info(getBundleString(&quot;download.connect_db&quot;));</span>
<span class="nc" id="L168">        try(BGTDatabase db = getBGTdatabase(dbOptions)) {</span>
<span class="nc" id="L169">            String deltaId = db.getMetadata(Metadata.DELTA_ID);</span>
<span class="nc" id="L170">            OffsetDateTime deltaIdTimeTo = null;</span>
<span class="nc" id="L171">            String s = db.getMetadata(Metadata.DELTA_TIME_TO);</span>
<span class="nc bnc" id="L172" title="All 4 branches missed.">            if (s != null &amp;&amp; s.length() &gt; 0) {</span>
<span class="nc" id="L173">                deltaIdTimeTo = OffsetDateTime.parse(s);</span>
            }
<span class="nc bnc" id="L175" title="All 2 branches missed.">            if (deltaId == null) {</span>
<span class="nc" id="L176">                log.error(getBundleString(&quot;download.no_delta_id&quot;));</span>
<span class="nc" id="L177">                return ExitCode.SOFTWARE;</span>
            }
<span class="nc" id="L179">            ExtractSelectionOptions extractSelectionOptions = new ExtractSelectionOptions();</span>
<span class="nc" id="L180">            extractSelectionOptions.setGeoFilterWkt(db.getMetadata(Metadata.GEOM_FILTER));</span>
<span class="nc bnc" id="L181" title="All 4 branches missed.">            if (extractSelectionOptions.getGeoFilterWkt() != null &amp;&amp; extractSelectionOptions.getGeoFilterWkt().length() == 0) {</span>
<span class="nc" id="L182">                extractSelectionOptions.setGeoFilterWkt(null);</span>
            }
<span class="nc" id="L184">            extractSelectionOptions.setFeatureTypes(Arrays.asList(db.getMetadata(Metadata.FEATURE_TYPES).split(&quot;,&quot;)));</span>
<span class="nc" id="L185">            LoadOptions loadOptions = new LoadOptions();</span>
<span class="nc bnc" id="L186" title="All 2 branches missed.">            loadOptions.setHttpZipRandomAccess(!noHttpZipRandomAccess);</span>
<span class="nc" id="L187">            loadOptions.includeHistory = Boolean.parseBoolean(db.getMetadata(Metadata.INCLUDE_HISTORY));</span>
<span class="nc" id="L188">            loadOptions.linearizeCurves = Boolean.parseBoolean(db.getMetadata(Metadata.LINEARIZE_CURVES));</span>
<span class="nc" id="L189">            loadOptions.tablePrefix = Objects.requireNonNullElse(db.getMetadata(Metadata.TABLE_PREFIX), &quot;&quot;);</span>

<span class="nc" id="L191">            log.info(getMessageFormattedString(&quot;download.current_delta_id&quot;, deltaId) + &quot;, &quot; +</span>
<span class="nc bnc" id="L192" title="All 2 branches missed.">                    (deltaIdTimeTo != null</span>
<span class="nc" id="L193">                            ? getMessageFormattedString(&quot;download.current_delta_time&quot;, DateTimeFormatter.ISO_INSTANT.format(deltaIdTimeTo))</span>
<span class="nc" id="L194">                            : getBundleString(&quot;download.current_delta_time_unknown&quot;)));</span>

            try {
<span class="nc" id="L197">                Instant start = Instant.now();</span>
<span class="nc" id="L198">                log.info(getBundleString(&quot;download.loading_deltas&quot;));</span>
                // Note that the afterDeltaId parameter is useless, because the response does not distinguish between
                // &quot;'afterDeltaId' is the latest&quot; and &quot;'afterDeltaId' not found or older than 31 days&quot;
<span class="nc" id="L201">                GetDeltasResponse response = new DeltaApi(client).getDeltas(null, 1, 100);</span>

                // Verify no links to other page, as we expect at most 31 delta's
<span class="nc bnc" id="L204" title="All 4 branches missed.">                if (response.getLinks() != null &amp;&amp; !response.getLinks().isEmpty()) {</span>
<span class="nc" id="L205">                    throw new IllegalStateException(&quot;Did not expect links in GetDeltas response&quot;);</span>
                }

                int i;
<span class="nc bnc" id="L209" title="All 2 branches missed.">                for (i = 0; i &lt; response.getDeltas().size(); i++) {</span>
<span class="nc" id="L210">                    Delta d = response.getDeltas().get(i);</span>
<span class="nc bnc" id="L211" title="All 2 branches missed.">                    if (deltaId.equals(d.getId())) {</span>
<span class="nc" id="L212">                        break;</span>
                    }
                }
<span class="nc bnc" id="L215" title="All 2 branches missed.">                if (i == response.getDeltas().size()) {</span>
                    // TODO automatically do initial load depending on option
<span class="nc" id="L217">                    log.error(getBundleString(&quot;download.current_delta_not_found&quot;));</span>
<span class="nc" id="L218">                    return ExitCode.SOFTWARE;</span>
                }

<span class="nc" id="L221">                List&lt;Delta&gt; deltas = response.getDeltas().subList(i + 1, response.getDeltas().size());</span>
<span class="nc bnc" id="L222" title="All 2 branches missed.">                if (deltas.isEmpty()) {</span>
<span class="nc" id="L223">                    log.info(getBundleString(&quot;download.uptodate&quot;));</span>
<span class="nc" id="L224">                    return ExitCode.OK;</span>
                }

<span class="nc" id="L227">                Delta latestDelta = deltas.get(deltas.size() - 1);</span>
<span class="nc" id="L228">                log.info(getMessageFormattedString(&quot;download.updates_available&quot;, deltas.size(), latestDelta.getId(), latestDelta.getTimeWindow().getTo()));</span>

<span class="nc" id="L230">                BGTObjectTableWriter writer = createWriter(db, dbOptions, loadOptions, cliOptions);</span>

<span class="nc" id="L232">                int deltaCount = 1;</span>
<span class="nc bnc" id="L233" title="All 2 branches missed.">                for (Delta delta: deltas) {</span>
<span class="nc" id="L234">                    log.info(getMessageFormattedString(&quot;download.creating_download&quot;, deltaCount++, deltas.size(), delta.getId()));</span>
<span class="nc" id="L235">                    URI uri = DownloadApiUtils.getCustomDownloadURL(client, delta, extractSelectionOptions, new CustomDownloadProgressReporter(cliOptions.isConsoleProgressEnabled()));</span>
                    // TODO: BGTObjectTableWriter does setAutocommit(false) and commit() after each stream for a feature type
                    // is written, maybe use one transaction for all feature types?
<span class="nc" id="L238">                    loadZipFromURI(uri, db, writer, extractSelectionOptions, loadOptions, false, start);</span>
<span class="nc" id="L239">                    db.setMetadataValue(Metadata.DELTA_TIME_TO, delta.getTimeWindow().getTo().toString());</span>
<span class="nc" id="L240">                    db.getConnection().commit();</span>
<span class="nc" id="L241">                }</span>

<span class="nc" id="L243">                db.setMetadataValue(Metadata.LOADER_VERSION, getLoaderVersion());</span>
<span class="nc" id="L244">                db.getConnection().commit();</span>
<span class="nc" id="L245">                return ExitCode.OK;</span>
<span class="nc" id="L246">            } catch(ApiException apiException) {</span>
<span class="nc" id="L247">                printApiException(apiException);</span>
<span class="nc" id="L248">                throw apiException;</span>
            }
<span class="nc bnc" id="L250" title="All 6 branches missed.">        }</span>
    }

    private static void printApiException(ApiException apiException) {
<span class="nc" id="L254">        log.error(String.format(&quot;API status code: %d, body: %s\n&quot;, apiException.getCode(), apiException.getResponseBody()));</span>
<span class="nc" id="L255">    }</span>

    private static void loadZipFromURI(URI uri, BGTDatabase db, BGTObjectTableWriter writer, ExtractSelectionOptions extractSelectionOptions, LoadOptions loadOptions, boolean showSelected, Instant start) throws Exception {
<span class="nc" id="L258">        Instant loadStart = Instant.now();</span>
<span class="nc" id="L259">        new BGTLoaderMain().loadZipFromURI(uri, writer, extractSelectionOptions, loadOptions, showSelected);</span>
<span class="nc" id="L260">        db.setMetadataForMutaties(writer.getProgress().getMutatieInhoud());</span>
<span class="nc" id="L261">        log.info(getMessageFormattedString(&quot;download.complete&quot;,</span>
<span class="nc" id="L262">                getBundleString(&quot;download.mutatietype.&quot; + writer.getProgress().getMutatieInhoud().getMutatieType()),</span>
<span class="nc" id="L263">                writer.getProgress().getMutatieInhoud().getLeveringsId(),</span>
<span class="nc" id="L264">                formatTimeSince(loadStart)) +</span>
<span class="nc bnc" id="L265" title="All 2 branches missed.">                (start == null ? &quot;&quot; : &quot; &quot; + getMessageFormattedString(&quot;download.complete_total&quot;, formatTimeSince(start)))</span>
        );
<span class="nc" id="L267">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>