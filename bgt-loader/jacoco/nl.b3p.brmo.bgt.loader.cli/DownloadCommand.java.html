<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DownloadCommand.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">BRMO BGT / IMGeo CityGML loader</a> &gt; <a href="index.source.html" class="el_package">nl.b3p.brmo.bgt.loader.cli</a> &gt; <span class="el_source">DownloadCommand.java</span></div><h1>DownloadCommand.java</h1><pre class="source lang-java linenums">/*
 * Copyright (C) 2021 B3Partners B.V.
 *
 * SPDX-License-Identifier: MIT
 */

package nl.b3p.brmo.bgt.loader.cli;

import static nl.b3p.brmo.bgt.loader.Utils.formatTimeSince;
import static nl.b3p.brmo.bgt.loader.Utils.getBrmoVersion;
import static nl.b3p.brmo.bgt.loader.Utils.getBundleString;
import static nl.b3p.brmo.bgt.loader.Utils.getLoaderVersion;
import static nl.b3p.brmo.bgt.loader.Utils.getMessageFormattedString;
import static nl.b3p.brmo.bgt.loader.Utils.getUserAgent;
import static nl.b3p.brmo.bgt.schema.BGTSchemaMapper.Metadata;

import nl.b3p.brmo.bgt.download.api.CustomDownloadProgress;
import nl.b3p.brmo.bgt.download.api.DeltaApi;
import nl.b3p.brmo.bgt.download.api.DownloadApiUtils;
import nl.b3p.brmo.bgt.download.client.ApiClient;
import nl.b3p.brmo.bgt.download.client.ApiException;
import nl.b3p.brmo.bgt.download.model.Delta;
import nl.b3p.brmo.bgt.download.model.GetDeltasResponse;
import nl.b3p.brmo.bgt.loader.BGTDatabase;
import nl.b3p.brmo.bgt.loader.ProgressReporter;
import nl.b3p.brmo.bgt.schema.BGTObjectTableWriter;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;

import picocli.CommandLine.Command;
import picocli.CommandLine.ExitCode;
import picocli.CommandLine.Mixin;
import picocli.CommandLine.Option;

import java.net.URI;
import java.sql.SQLException;
import java.time.Instant;
import java.time.OffsetDateTime;
import java.time.format.DateTimeFormatter;
import java.util.Arrays;
import java.util.List;
import java.util.Objects;
import java.util.function.Consumer;

@Command(name = &quot;download&quot;, mixinStandardHelpOptions = true)
<span class="nc" id="L47">public class DownloadCommand {</span>
<span class="nc" id="L48">    private static final Log log = LogFactory.getLog(DownloadCommand.class);</span>

    private static final String PREDEFINED_FULL_DELTA_URI =
            &quot;https://api.pdok.nl/lv/bgt/download/v1_0/delta/predefined/bgt-citygml-nl-delta.zip&quot;;

    /** zodat we een JNDI database kunne gebruiken. */
<span class="nc" id="L54">    private BGTDatabase bgtDatabase = null;</span>

    public static ApiClient getApiClient(URI baseUri) {
<span class="nc" id="L57">        ApiClient client = new ApiClient();</span>
<span class="nc bnc" id="L58" title="All 2 branches missed.">        if (baseUri != null) {</span>
<span class="nc" id="L59">            client.updateBaseUri(baseUri.toString());</span>
        }
<span class="nc" id="L61">        client.setRequestInterceptor(builder -&gt; builder.headers(&quot;User-Agent&quot;, getUserAgent()));</span>
<span class="nc" id="L62">        return client;</span>
    }

    private BGTObjectTableWriter createWriter(
            BGTDatabase db,
            DatabaseOptions dbOptions,
            LoadOptions loadOptions,
            CLIOptions cliOptions)
            throws SQLException {
<span class="nc" id="L71">        BGTObjectTableWriter writer = db.createObjectTableWriter(loadOptions, dbOptions);</span>
        ProgressReporter progressReporter;
<span class="nc bnc" id="L73" title="All 2 branches missed.">        if (cliOptions.isConsoleProgressEnabled()) {</span>
<span class="nc" id="L74">            progressReporter = new ConsoleProgressReporter();</span>
        } else {
<span class="nc" id="L76">            progressReporter = new ProgressReporter();</span>
        }
<span class="nc" id="L78">        writer.setProgressUpdater(progressReporter);</span>
<span class="nc" id="L79">        return writer;</span>
    }

    @Command(name = &quot;initial&quot;, sortOptions = false)
    public int initial(
            @Mixin DatabaseOptions dbOptions,
            @Mixin LoadOptions loadOptions,
            @Mixin ExtractSelectionOptions extractSelectionOptions,
            @Option(names = &quot;--no-geo-filter&quot;) boolean noGeoFilter,
            @Option(names = &quot;--download-service&quot;, hidden = true) URI downloadServiceURI,
            @Mixin CLIOptions cliOptions,
            @Option(
                            names = {&quot;-h&quot;, &quot;--help&quot;},
                            usageHelp = true)
                    boolean showHelp)
            throws Exception {

<span class="nc bnc" id="L96" title="All 4 branches missed.">        if (extractSelectionOptions.getGeoFilterWkt() == null &amp;&amp; !noGeoFilter) {</span>
<span class="nc" id="L97">            log.error(getBundleString(&quot;download.no_geo_filter&quot;));</span>
<span class="nc" id="L98">            return ExitCode.USAGE;</span>
        }

<span class="nc" id="L101">        log.info(getUserAgent());</span>

<span class="nc" id="L103">        try (BGTDatabase db = this.getBGTdatabase(dbOptions)) {</span>
<span class="nc bnc" id="L104" title="All 2 branches missed.">            if (loadOptions.createSchema) {</span>
<span class="nc" id="L105">                db.createMetadataTable(loadOptions);</span>
            } else {
<span class="nc" id="L107">                log.info(getBundleString(&quot;download.connect_db&quot;));</span>
            }

<span class="nc" id="L110">            db.setMetadataValue(Metadata.LOADER_VERSION, getLoaderVersion());</span>
<span class="nc" id="L111">            db.setMetadataValue(Metadata.BRMOVERSIE, getBrmoVersion());</span>
<span class="nc" id="L112">            db.setFeatureTypesEnumMetadata(extractSelectionOptions.getFeatureTypesList());</span>
<span class="nc" id="L113">            db.setMetadataValue(Metadata.INCLUDE_HISTORY, loadOptions.includeHistory + &quot;&quot;);</span>
<span class="nc" id="L114">            db.setMetadataValue(Metadata.LINEARIZE_CURVES, loadOptions.linearizeCurves + &quot;&quot;);</span>
<span class="nc" id="L115">            db.setMetadataValue(Metadata.TABLE_PREFIX, loadOptions.tablePrefix);</span>

<span class="nc" id="L117">            Instant start = null;</span>
            URI uri;
<span class="nc bnc" id="L119" title="All 2 branches missed.">            if (noGeoFilter) {</span>
<span class="nc" id="L120">                uri = new URI(PREDEFINED_FULL_DELTA_URI);</span>
            } else {
                // Close connection while waiting for extract
<span class="nc" id="L123">                db.close();</span>
<span class="nc" id="L124">                start = Instant.now(); // Record total time waiting for extract</span>
<span class="nc" id="L125">                uri =</span>
<span class="nc" id="L126">                        getCustomDownloadURI(</span>
                                downloadServiceURI,
                                extractSelectionOptions,
                                new CustomDownloadProgressReporter(
<span class="nc" id="L130">                                        cliOptions.isConsoleProgressEnabled()));</span>
            }
<span class="nc" id="L132">            BGTObjectTableWriter writer = createWriter(db, dbOptions, loadOptions, cliOptions);</span>
<span class="nc" id="L133">            loadZipFromURI(</span>
                    uri, db, writer, extractSelectionOptions, loadOptions, noGeoFilter, start);

<span class="nc" id="L136">            db.setMetadataValue(Metadata.DELTA_TIME_TO, null);</span>
            // Do not set geom filter from MutatieInhoud, a custom download without geo filter will
            // have gebied
            // &quot;POLYGON ((-100000 200000, 412000 200000, 412000 712000, -100000 712000, -100000
            // 200000))&quot;
<span class="nc" id="L141">            db.setMetadataValue(Metadata.GEOM_FILTER, extractSelectionOptions.getGeoFilterWkt());</span>

<span class="nc" id="L143">            db.getConnection().commit();</span>
<span class="nc" id="L144">            return ExitCode.OK;</span>
        }
    }

    /**
     * set a preconfigured database instead of using one created in the command using the dbOtions.
     * Useful when using a JDNI database.
     *
     * @param bgtDatabase the BGT database to use for any issued commands
     */
    public void setBGTDatabase(BGTDatabase bgtDatabase) {
<span class="nc" id="L155">        this.bgtDatabase = bgtDatabase;</span>
<span class="nc" id="L156">    }</span>

    private BGTDatabase getBGTdatabase(DatabaseOptions dbOptions) throws ClassNotFoundException {
<span class="nc bnc" id="L159" title="All 2 branches missed.">        if (null == this.bgtDatabase) {</span>
<span class="nc" id="L160">            return new BGTDatabase(dbOptions);</span>
<span class="nc" id="L161">        } else return this.bgtDatabase;</span>
    }

    private static URI getCustomDownloadURI(
            URI downloadServiceURI,
            ExtractSelectionOptions extractSelectionOptions,
            Consumer&lt;CustomDownloadProgress&gt; progressConsumer)
            throws ApiException, InterruptedException {
        try {
<span class="nc" id="L170">            log.info(getBundleString(&quot;download.create&quot;));</span>
<span class="nc" id="L171">            ApiClient client = getApiClient(downloadServiceURI);</span>
<span class="nc" id="L172">            return DownloadApiUtils.getCustomDownloadURL(</span>
                    client, null, extractSelectionOptions, progressConsumer);
<span class="nc" id="L174">        } catch (ApiException apiException) {</span>
<span class="nc" id="L175">            printApiException(apiException);</span>
<span class="nc" id="L176">            throw apiException;</span>
        }
    }

    @Command(name = &quot;update&quot;, sortOptions = false)
    public int update(
            @Mixin DatabaseOptions dbOptions,
            @Mixin CLIOptions cliOptions,
            @Option(names = &quot;--download-service&quot;, hidden = true) URI downloadServiceURI,
            @Option(names = &quot;--no-http-zip-random-access&quot;, negatable = true, hidden = true)
                    boolean noHttpZipRandomAccess,
            @Option(
                            names = {&quot;-h&quot;, &quot;--help&quot;},
                            usageHelp = true)
                    boolean showHelp)
            throws Exception {
<span class="nc" id="L192">        log.info(getUserAgent());</span>

<span class="nc" id="L194">        ApiClient client = getApiClient(downloadServiceURI);</span>

<span class="nc" id="L196">        log.info(getBundleString(&quot;download.connect_db&quot;));</span>
<span class="nc" id="L197">        try (BGTDatabase db = getBGTdatabase(dbOptions)) {</span>
<span class="nc" id="L198">            String deltaId = db.getMetadata(Metadata.DELTA_ID);</span>
<span class="nc" id="L199">            OffsetDateTime deltaIdTimeTo = null;</span>
<span class="nc" id="L200">            String s = db.getMetadata(Metadata.DELTA_TIME_TO);</span>
<span class="nc bnc" id="L201" title="All 4 branches missed.">            if (s != null &amp;&amp; s.length() &gt; 0) {</span>
<span class="nc" id="L202">                deltaIdTimeTo = OffsetDateTime.parse(s);</span>
            }
<span class="nc bnc" id="L204" title="All 2 branches missed.">            if (deltaId == null) {</span>
<span class="nc" id="L205">                log.error(getBundleString(&quot;download.no_delta_id&quot;));</span>
<span class="nc" id="L206">                return ExitCode.SOFTWARE;</span>
            }
<span class="nc" id="L208">            ExtractSelectionOptions extractSelectionOptions = new ExtractSelectionOptions();</span>
<span class="nc" id="L209">            extractSelectionOptions.setGeoFilterWkt(db.getMetadata(Metadata.GEOM_FILTER));</span>
<span class="nc bnc" id="L210" title="All 2 branches missed.">            if (extractSelectionOptions.getGeoFilterWkt() != null</span>
<span class="nc bnc" id="L211" title="All 2 branches missed.">                    &amp;&amp; extractSelectionOptions.getGeoFilterWkt().length() == 0) {</span>
<span class="nc" id="L212">                extractSelectionOptions.setGeoFilterWkt(null);</span>
            }
<span class="nc" id="L214">            extractSelectionOptions.setFeatureTypes(</span>
<span class="nc" id="L215">                    Arrays.asList(db.getMetadata(Metadata.FEATURE_TYPES).split(&quot;,&quot;)));</span>
<span class="nc" id="L216">            LoadOptions loadOptions = new LoadOptions();</span>
<span class="nc bnc" id="L217" title="All 2 branches missed.">            loadOptions.setHttpZipRandomAccess(!noHttpZipRandomAccess);</span>
<span class="nc" id="L218">            loadOptions.includeHistory =</span>
<span class="nc" id="L219">                    Boolean.parseBoolean(db.getMetadata(Metadata.INCLUDE_HISTORY));</span>
<span class="nc" id="L220">            loadOptions.linearizeCurves =</span>
<span class="nc" id="L221">                    Boolean.parseBoolean(db.getMetadata(Metadata.LINEARIZE_CURVES));</span>
<span class="nc" id="L222">            loadOptions.tablePrefix =</span>
<span class="nc" id="L223">                    Objects.requireNonNullElse(db.getMetadata(Metadata.TABLE_PREFIX), &quot;&quot;);</span>

<span class="nc" id="L225">            log.info(</span>
<span class="nc" id="L226">                    getMessageFormattedString(&quot;download.current_delta_id&quot;, deltaId)</span>
                            + &quot;, &quot;
<span class="nc bnc" id="L228" title="All 2 branches missed.">                            + (deltaIdTimeTo != null</span>
<span class="nc" id="L229">                                    ? getMessageFormattedString(</span>
                                            &quot;download.current_delta_time&quot;,
<span class="nc" id="L231">                                            DateTimeFormatter.ISO_INSTANT.format(deltaIdTimeTo))</span>
<span class="nc" id="L232">                                    : getBundleString(&quot;download.current_delta_time_unknown&quot;)));</span>

            try {
<span class="nc" id="L235">                Instant start = Instant.now();</span>
<span class="nc" id="L236">                log.info(getBundleString(&quot;download.loading_deltas&quot;));</span>
                // Note that the afterDeltaId parameter is useless, because the response does not
                // distinguish between
                // &quot;'afterDeltaId' is the latest&quot; and &quot;'afterDeltaId' not found or older than 31
                // days&quot;
<span class="nc" id="L241">                GetDeltasResponse response = new DeltaApi(client).getDeltas(null, 1, 100);</span>

                // Verify no links to other page, as we expect at most 31 delta's
<span class="nc bnc" id="L244" title="All 4 branches missed.">                if (response.getLinks() != null &amp;&amp; !response.getLinks().isEmpty()) {</span>
<span class="nc" id="L245">                    throw new IllegalStateException(&quot;Did not expect links in GetDeltas response&quot;);</span>
                }

                int i;
<span class="nc bnc" id="L249" title="All 2 branches missed.">                for (i = 0; i &lt; response.getDeltas().size(); i++) {</span>
<span class="nc" id="L250">                    Delta d = response.getDeltas().get(i);</span>
<span class="nc bnc" id="L251" title="All 2 branches missed.">                    if (deltaId.equals(d.getId())) {</span>
<span class="nc" id="L252">                        break;</span>
                    }
                }
<span class="nc bnc" id="L255" title="All 2 branches missed.">                if (i == response.getDeltas().size()) {</span>
                    // TODO automatically do initial load depending on option
<span class="nc" id="L257">                    log.error(getBundleString(&quot;download.current_delta_not_found&quot;));</span>
<span class="nc" id="L258">                    return ExitCode.SOFTWARE;</span>
                }

<span class="nc" id="L261">                List&lt;Delta&gt; deltas =</span>
<span class="nc" id="L262">                        response.getDeltas().subList(i + 1, response.getDeltas().size());</span>
<span class="nc bnc" id="L263" title="All 2 branches missed.">                if (deltas.isEmpty()) {</span>
<span class="nc" id="L264">                    log.info(getBundleString(&quot;download.uptodate&quot;));</span>
<span class="nc" id="L265">                    return ExitCode.OK;</span>
                }

<span class="nc" id="L268">                Delta latestDelta = deltas.get(deltas.size() - 1);</span>
<span class="nc" id="L269">                log.info(</span>
<span class="nc" id="L270">                        getMessageFormattedString(</span>
                                &quot;download.updates_available&quot;,
<span class="nc" id="L272">                                deltas.size(),</span>
<span class="nc" id="L273">                                latestDelta.getId(),</span>
<span class="nc" id="L274">                                latestDelta.getTimeWindow().getTo()));</span>

<span class="nc" id="L276">                BGTObjectTableWriter writer = createWriter(db, dbOptions, loadOptions, cliOptions);</span>

<span class="nc" id="L278">                int deltaCount = 1;</span>
<span class="nc bnc" id="L279" title="All 2 branches missed.">                for (Delta delta : deltas) {</span>
<span class="nc" id="L280">                    log.info(</span>
<span class="nc" id="L281">                            getMessageFormattedString(</span>
                                    &quot;download.creating_download&quot;,
<span class="nc" id="L283">                                    deltaCount++,</span>
<span class="nc" id="L284">                                    deltas.size(),</span>
<span class="nc" id="L285">                                    delta.getId()));</span>
<span class="nc" id="L286">                    URI uri =</span>
<span class="nc" id="L287">                            DownloadApiUtils.getCustomDownloadURL(</span>
                                    client,
                                    delta,
                                    extractSelectionOptions,
                                    new CustomDownloadProgressReporter(
<span class="nc" id="L292">                                            cliOptions.isConsoleProgressEnabled()));</span>
                    // TODO: BGTObjectTableWriter does setAutocommit(false) and commit() after each
                    // stream for a feature type
                    // is written, maybe use one transaction for all feature types?
<span class="nc" id="L296">                    loadZipFromURI(</span>
                            uri, db, writer, extractSelectionOptions, loadOptions, false, start);
<span class="nc" id="L298">                    db.setMetadataValue(</span>
<span class="nc" id="L299">                            Metadata.DELTA_TIME_TO, delta.getTimeWindow().getTo().toString());</span>
<span class="nc" id="L300">                    db.getConnection().commit();</span>
<span class="nc" id="L301">                }</span>

<span class="nc" id="L303">                db.setMetadataValue(Metadata.LOADER_VERSION, getLoaderVersion());</span>
<span class="nc" id="L304">                db.getConnection().commit();</span>
<span class="nc" id="L305">                return ExitCode.OK;</span>
<span class="nc" id="L306">            } catch (ApiException apiException) {</span>
<span class="nc" id="L307">                printApiException(apiException);</span>
<span class="nc" id="L308">                throw apiException;</span>
            }
<span class="nc bnc" id="L310" title="All 6 branches missed.">        }</span>
    }

    private static void printApiException(ApiException apiException) {
<span class="nc" id="L314">        log.error(</span>
<span class="nc" id="L315">                String.format(</span>
                        &quot;API status code: %d, body: %s\n&quot;,
<span class="nc" id="L317">                        apiException.getCode(), apiException.getResponseBody()));</span>
<span class="nc" id="L318">    }</span>

    private static void loadZipFromURI(
            URI uri,
            BGTDatabase db,
            BGTObjectTableWriter writer,
            ExtractSelectionOptions extractSelectionOptions,
            LoadOptions loadOptions,
            boolean showSelected,
            Instant start)
            throws Exception {
<span class="nc" id="L329">        Instant loadStart = Instant.now();</span>
<span class="nc" id="L330">        new BGTLoaderMain()</span>
<span class="nc" id="L331">                .loadZipFromURI(uri, writer, extractSelectionOptions, loadOptions, showSelected);</span>
<span class="nc" id="L332">        db.setMetadataForMutaties(writer.getProgress().getMutatieInhoud());</span>
<span class="nc" id="L333">        log.info(</span>
<span class="nc" id="L334">                getMessageFormattedString(</span>
                                &quot;download.complete&quot;,
<span class="nc" id="L336">                                getBundleString(</span>
                                        &quot;download.mutatietype.&quot;
<span class="nc" id="L338">                                                + writer.getProgress()</span>
<span class="nc" id="L339">                                                        .getMutatieInhoud()</span>
<span class="nc" id="L340">                                                        .getMutatieType()),</span>
<span class="nc" id="L341">                                writer.getProgress().getMutatieInhoud().getLeveringsId(),</span>
<span class="nc" id="L342">                                formatTimeSince(loadStart))</span>
<span class="nc bnc" id="L343" title="All 2 branches missed.">                        + (start == null</span>
<span class="nc" id="L344">                                ? &quot;&quot;</span>
                                : &quot; &quot;
<span class="nc" id="L346">                                        + getMessageFormattedString(</span>
                                                &quot;download.complete_total&quot;,
<span class="nc" id="L348">                                                formatTimeSince(start))));</span>
<span class="nc" id="L349">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>