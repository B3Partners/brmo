<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DownloadCommand.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">BRMO BGT / IMGeo CityGML loader</a> &gt; <a href="index.source.html" class="el_package">nl.b3p.brmo.bgt.loader.cli</a> &gt; <span class="el_source">DownloadCommand.java</span></div><h1>DownloadCommand.java</h1><pre class="source lang-java linenums">/*
 * Copyright (C) 2021 B3Partners B.V.
 *
 * SPDX-License-Identifier: MIT
 */

package nl.b3p.brmo.bgt.loader.cli;

import static nl.b3p.brmo.bgt.loader.Utils.formatTimeSince;
import static nl.b3p.brmo.bgt.loader.Utils.getBrmoVersion;
import static nl.b3p.brmo.bgt.loader.Utils.getBundleString;
import static nl.b3p.brmo.bgt.loader.Utils.getLoaderVersion;
import static nl.b3p.brmo.bgt.loader.Utils.getMessageFormattedString;
import static nl.b3p.brmo.bgt.loader.Utils.getUserAgent;
import static nl.b3p.brmo.bgt.schema.BGTSchemaMapper.Metadata;

import java.net.URI;
import java.sql.SQLException;
import java.time.Instant;
import java.time.OffsetDateTime;
import java.time.format.DateTimeFormatter;
import java.util.Arrays;
import java.util.List;
import java.util.Objects;
import java.util.function.Consumer;
import nl.b3p.brmo.bgt.download.api.CustomDownloadProgress;
import nl.b3p.brmo.bgt.download.api.DeltaApi;
import nl.b3p.brmo.bgt.download.api.DownloadApiUtils;
import nl.b3p.brmo.bgt.download.client.ApiClient;
import nl.b3p.brmo.bgt.download.client.ApiException;
import nl.b3p.brmo.bgt.download.model.Delta;
import nl.b3p.brmo.bgt.download.model.GetDeltasResponse;
import nl.b3p.brmo.bgt.loader.BGTDatabase;
import nl.b3p.brmo.bgt.loader.ProgressReporter;
import nl.b3p.brmo.bgt.schema.BGTObjectTableWriter;
import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import picocli.CommandLine.Command;
import picocli.CommandLine.ExitCode;
import picocli.CommandLine.Mixin;
import picocli.CommandLine.Option;

@Command(name = &quot;download&quot;, mixinStandardHelpOptions = true)
<span class="nc" id="L44">public class DownloadCommand {</span>
<span class="nc" id="L45">  private static final Log log = LogFactory.getLog(DownloadCommand.class);</span>

  private static final String PREDEFINED_FULL_DELTA_URI =
      &quot;https://api.pdok.nl/lv/bgt/download/v1_0/delta/predefined/bgt-citygml-nl-delta.zip&quot;;

  /** zodat we een JNDI database kunne gebruiken. */
<span class="nc" id="L51">  private BGTDatabase bgtDatabase = null;</span>

  public static ApiClient getApiClient(URI baseUri) {
<span class="nc" id="L54">    ApiClient client = new ApiClient();</span>
<span class="nc bnc" id="L55" title="All 2 branches missed.">    if (baseUri != null) {</span>
<span class="nc" id="L56">      client.updateBaseUri(baseUri.toString());</span>
    }
<span class="nc" id="L58">    client.setRequestInterceptor(builder -&gt; builder.headers(&quot;User-Agent&quot;, getUserAgent()));</span>
<span class="nc" id="L59">    return client;</span>
  }

  private BGTObjectTableWriter createWriter(
      BGTDatabase db, DatabaseOptions dbOptions, LoadOptions loadOptions, CLIOptions cliOptions)
      throws SQLException {
<span class="nc" id="L65">    BGTObjectTableWriter writer = db.createObjectTableWriter(loadOptions, dbOptions);</span>
    ProgressReporter progressReporter;
<span class="nc bnc" id="L67" title="All 2 branches missed.">    if (cliOptions.isConsoleProgressEnabled()) {</span>
<span class="nc" id="L68">      progressReporter = new ConsoleProgressReporter();</span>
    } else {
<span class="nc" id="L70">      progressReporter = new ProgressReporter();</span>
    }
<span class="nc" id="L72">    writer.setProgressUpdater(progressReporter);</span>
<span class="nc" id="L73">    return writer;</span>
  }

  @Command(name = &quot;initial&quot;, sortOptions = false)
  public int initial(
      @Mixin DatabaseOptions dbOptions,
      @Mixin LoadOptions loadOptions,
      @Mixin ExtractSelectionOptions extractSelectionOptions,
      @Option(names = &quot;--no-geo-filter&quot;) boolean noGeoFilter,
      @Option(names = &quot;--download-service&quot;, hidden = true) URI downloadServiceURI,
      @Mixin CLIOptions cliOptions,
      @Option(
              names = {&quot;-h&quot;, &quot;--help&quot;},
              usageHelp = true)
          boolean showHelp)
      throws Exception {

<span class="nc bnc" id="L90" title="All 4 branches missed.">    if (extractSelectionOptions.getGeoFilterWkt() == null &amp;&amp; !noGeoFilter) {</span>
<span class="nc" id="L91">      log.error(getBundleString(&quot;download.no_geo_filter&quot;));</span>
<span class="nc" id="L92">      return ExitCode.USAGE;</span>
    }

<span class="nc" id="L95">    log.info(getUserAgent());</span>

<span class="nc" id="L97">    try (BGTDatabase db = this.getBGTdatabase(dbOptions)) {</span>
<span class="nc bnc" id="L98" title="All 2 branches missed.">      if (loadOptions.createSchema) {</span>
<span class="nc" id="L99">        db.createMetadataTable(loadOptions);</span>
      } else {
<span class="nc" id="L101">        log.info(getBundleString(&quot;download.connect_db&quot;));</span>
      }

<span class="nc" id="L104">      db.setMetadataValue(Metadata.LOADER_VERSION, getLoaderVersion());</span>
<span class="nc" id="L105">      db.setMetadataValue(Metadata.BRMOVERSIE, getBrmoVersion());</span>
<span class="nc" id="L106">      db.setFeatureTypesEnumMetadata(extractSelectionOptions.getFeatureTypesList());</span>
<span class="nc" id="L107">      db.setMetadataValue(Metadata.INCLUDE_HISTORY, loadOptions.includeHistory + &quot;&quot;);</span>
<span class="nc" id="L108">      db.setMetadataValue(Metadata.LINEARIZE_CURVES, loadOptions.linearizeCurves + &quot;&quot;);</span>
<span class="nc" id="L109">      db.setMetadataValue(Metadata.TABLE_PREFIX, loadOptions.tablePrefix);</span>

<span class="nc" id="L111">      Instant start = null;</span>
      URI uri;
<span class="nc bnc" id="L113" title="All 2 branches missed.">      if (noGeoFilter) {</span>
<span class="nc" id="L114">        uri = new URI(PREDEFINED_FULL_DELTA_URI);</span>
      } else {
        // Close connection while waiting for extract
<span class="nc" id="L117">        db.close();</span>
<span class="nc" id="L118">        start = Instant.now(); // Record total time waiting for extract</span>
<span class="nc" id="L119">        uri =</span>
<span class="nc" id="L120">            getCustomDownloadURI(</span>
                downloadServiceURI,
                extractSelectionOptions,
<span class="nc" id="L123">                new CustomDownloadProgressReporter(cliOptions.isConsoleProgressEnabled()));</span>
      }
<span class="nc" id="L125">      BGTObjectTableWriter writer = createWriter(db, dbOptions, loadOptions, cliOptions);</span>
<span class="nc" id="L126">      loadZipFromURI(uri, db, writer, extractSelectionOptions, loadOptions, noGeoFilter, start);</span>

<span class="nc" id="L128">      db.setMetadataValue(Metadata.DELTA_TIME_TO, null);</span>
      // Do not set geom filter from MutatieInhoud, a custom download without geo filter will
      // have gebied
      // &quot;POLYGON ((-100000 200000, 412000 200000, 412000 712000, -100000 712000, -100000
      // 200000))&quot;
<span class="nc" id="L133">      db.setMetadataValue(Metadata.GEOM_FILTER, extractSelectionOptions.getGeoFilterWkt());</span>

<span class="nc" id="L135">      db.getConnection().commit();</span>
<span class="nc" id="L136">      return ExitCode.OK;</span>
    }
  }

  /**
   * set a preconfigured database instead of using one created in the command using the dbOtions.
   * Useful when using a JDNI database.
   *
   * @param bgtDatabase the BGT database to use for any issued commands
   */
  public void setBGTDatabase(BGTDatabase bgtDatabase) {
<span class="nc" id="L147">    this.bgtDatabase = bgtDatabase;</span>
<span class="nc" id="L148">  }</span>

  private BGTDatabase getBGTdatabase(DatabaseOptions dbOptions) throws ClassNotFoundException {
<span class="nc bnc" id="L151" title="All 2 branches missed.">    if (null == this.bgtDatabase) {</span>
<span class="nc" id="L152">      return new BGTDatabase(dbOptions);</span>
<span class="nc" id="L153">    } else return this.bgtDatabase;</span>
  }

  private static URI getCustomDownloadURI(
      URI downloadServiceURI,
      ExtractSelectionOptions extractSelectionOptions,
      Consumer&lt;CustomDownloadProgress&gt; progressConsumer)
      throws ApiException, InterruptedException {
    try {
<span class="nc" id="L162">      log.info(getBundleString(&quot;download.create&quot;));</span>
<span class="nc" id="L163">      ApiClient client = getApiClient(downloadServiceURI);</span>
<span class="nc" id="L164">      return DownloadApiUtils.getCustomDownloadURL(</span>
          client, null, extractSelectionOptions, progressConsumer);
<span class="nc" id="L166">    } catch (ApiException apiException) {</span>
<span class="nc" id="L167">      printApiException(apiException);</span>
<span class="nc" id="L168">      throw apiException;</span>
    }
  }

  @Command(name = &quot;update&quot;, sortOptions = false)
  public int update(
      @Mixin DatabaseOptions dbOptions,
      @Mixin CLIOptions cliOptions,
      @Option(names = &quot;--download-service&quot;, hidden = true) URI downloadServiceURI,
      @Option(names = &quot;--no-http-zip-random-access&quot;, negatable = true, hidden = true)
          boolean noHttpZipRandomAccess,
      @Option(
              names = {&quot;-h&quot;, &quot;--help&quot;},
              usageHelp = true)
          boolean showHelp)
      throws Exception {
<span class="nc" id="L184">    log.info(getUserAgent());</span>

<span class="nc" id="L186">    ApiClient client = getApiClient(downloadServiceURI);</span>

<span class="nc" id="L188">    log.info(getBundleString(&quot;download.connect_db&quot;));</span>
<span class="nc" id="L189">    try (BGTDatabase db = getBGTdatabase(dbOptions)) {</span>
<span class="nc" id="L190">      String deltaId = db.getMetadata(Metadata.DELTA_ID);</span>
<span class="nc" id="L191">      OffsetDateTime deltaIdTimeTo = null;</span>
<span class="nc" id="L192">      String s = db.getMetadata(Metadata.DELTA_TIME_TO);</span>
<span class="nc bnc" id="L193" title="All 4 branches missed.">      if (s != null &amp;&amp; s.length() &gt; 0) {</span>
<span class="nc" id="L194">        deltaIdTimeTo = OffsetDateTime.parse(s);</span>
      }
<span class="nc bnc" id="L196" title="All 2 branches missed.">      if (deltaId == null) {</span>
<span class="nc" id="L197">        log.error(getBundleString(&quot;download.no_delta_id&quot;));</span>
<span class="nc" id="L198">        return ExitCode.SOFTWARE;</span>
      }
<span class="nc" id="L200">      ExtractSelectionOptions extractSelectionOptions = new ExtractSelectionOptions();</span>
<span class="nc" id="L201">      extractSelectionOptions.setGeoFilterWkt(db.getMetadata(Metadata.GEOM_FILTER));</span>
<span class="nc bnc" id="L202" title="All 2 branches missed.">      if (extractSelectionOptions.getGeoFilterWkt() != null</span>
<span class="nc bnc" id="L203" title="All 2 branches missed.">          &amp;&amp; extractSelectionOptions.getGeoFilterWkt().length() == 0) {</span>
<span class="nc" id="L204">        extractSelectionOptions.setGeoFilterWkt(null);</span>
      }
<span class="nc" id="L206">      extractSelectionOptions.setFeatureTypes(</span>
<span class="nc" id="L207">          Arrays.asList(db.getMetadata(Metadata.FEATURE_TYPES).split(&quot;,&quot;)));</span>
<span class="nc" id="L208">      LoadOptions loadOptions = new LoadOptions();</span>
<span class="nc bnc" id="L209" title="All 2 branches missed.">      loadOptions.setHttpZipRandomAccess(!noHttpZipRandomAccess);</span>
<span class="nc" id="L210">      loadOptions.includeHistory = Boolean.parseBoolean(db.getMetadata(Metadata.INCLUDE_HISTORY));</span>
<span class="nc" id="L211">      loadOptions.linearizeCurves = Boolean.parseBoolean(db.getMetadata(Metadata.LINEARIZE_CURVES));</span>
<span class="nc" id="L212">      loadOptions.tablePrefix =</span>
<span class="nc" id="L213">          Objects.requireNonNullElse(db.getMetadata(Metadata.TABLE_PREFIX), &quot;&quot;);</span>

<span class="nc" id="L215">      log.info(</span>
<span class="nc" id="L216">          getMessageFormattedString(&quot;download.current_delta_id&quot;, deltaId)</span>
              + &quot;, &quot;
<span class="nc bnc" id="L218" title="All 2 branches missed.">              + (deltaIdTimeTo != null</span>
<span class="nc" id="L219">                  ? getMessageFormattedString(</span>
                      &quot;download.current_delta_time&quot;,
<span class="nc" id="L221">                      DateTimeFormatter.ISO_INSTANT.format(deltaIdTimeTo))</span>
<span class="nc" id="L222">                  : getBundleString(&quot;download.current_delta_time_unknown&quot;)));</span>

      try {
<span class="nc" id="L225">        Instant start = Instant.now();</span>
<span class="nc" id="L226">        log.info(getBundleString(&quot;download.loading_deltas&quot;));</span>
        // Note that the afterDeltaId parameter is useless, because the response does not
        // distinguish between
        // &quot;'afterDeltaId' is the latest&quot; and &quot;'afterDeltaId' not found or older than 31
        // days&quot;
<span class="nc" id="L231">        GetDeltasResponse response = new DeltaApi(client).getDeltas(null, 1, 100);</span>

        // Verify no links to other page, as we expect at most 31 delta's
<span class="nc bnc" id="L234" title="All 4 branches missed.">        if (response.getLinks() != null &amp;&amp; !response.getLinks().isEmpty()) {</span>
<span class="nc" id="L235">          throw new IllegalStateException(&quot;Did not expect links in GetDeltas response&quot;);</span>
        }

        int i;
<span class="nc bnc" id="L239" title="All 2 branches missed.">        for (i = 0; i &lt; response.getDeltas().size(); i++) {</span>
<span class="nc" id="L240">          Delta d = response.getDeltas().get(i);</span>
<span class="nc bnc" id="L241" title="All 2 branches missed.">          if (deltaId.equals(d.getId())) {</span>
<span class="nc" id="L242">            break;</span>
          }
        }
<span class="nc bnc" id="L245" title="All 2 branches missed.">        if (i == response.getDeltas().size()) {</span>
          // TODO automatically do initial load depending on option
<span class="nc" id="L247">          log.error(getBundleString(&quot;download.current_delta_not_found&quot;));</span>
<span class="nc" id="L248">          return ExitCode.SOFTWARE;</span>
        }

<span class="nc" id="L251">        List&lt;Delta&gt; deltas = response.getDeltas().subList(i + 1, response.getDeltas().size());</span>
<span class="nc bnc" id="L252" title="All 2 branches missed.">        if (deltas.isEmpty()) {</span>
<span class="nc" id="L253">          log.info(getBundleString(&quot;download.uptodate&quot;));</span>
<span class="nc" id="L254">          return ExitCode.OK;</span>
        }

<span class="nc" id="L257">        Delta latestDelta = deltas.get(deltas.size() - 1);</span>
<span class="nc" id="L258">        log.info(</span>
<span class="nc" id="L259">            getMessageFormattedString(</span>
                &quot;download.updates_available&quot;,
<span class="nc" id="L261">                deltas.size(),</span>
<span class="nc" id="L262">                latestDelta.getId(),</span>
<span class="nc" id="L263">                latestDelta.getTimeWindow().getTo()));</span>

<span class="nc" id="L265">        BGTObjectTableWriter writer = createWriter(db, dbOptions, loadOptions, cliOptions);</span>

<span class="nc" id="L267">        int deltaCount = 1;</span>
<span class="nc bnc" id="L268" title="All 2 branches missed.">        for (Delta delta : deltas) {</span>
<span class="nc" id="L269">          log.info(</span>
<span class="nc" id="L270">              getMessageFormattedString(</span>
<span class="nc" id="L271">                  &quot;download.creating_download&quot;, deltaCount++, deltas.size(), delta.getId()));</span>
<span class="nc" id="L272">          URI uri =</span>
<span class="nc" id="L273">              DownloadApiUtils.getCustomDownloadURL(</span>
                  client,
                  delta,
                  extractSelectionOptions,
<span class="nc" id="L277">                  new CustomDownloadProgressReporter(cliOptions.isConsoleProgressEnabled()));</span>
          // TODO: BGTObjectTableWriter does setAutocommit(false) and commit() after each
          // stream for a feature type
          // is written, maybe use one transaction for all feature types?
<span class="nc" id="L281">          loadZipFromURI(uri, db, writer, extractSelectionOptions, loadOptions, false, start);</span>
<span class="nc" id="L282">          db.setMetadataValue(Metadata.DELTA_TIME_TO, delta.getTimeWindow().getTo().toString());</span>
<span class="nc" id="L283">          db.getConnection().commit();</span>
<span class="nc" id="L284">        }</span>

<span class="nc" id="L286">        db.setMetadataValue(Metadata.LOADER_VERSION, getLoaderVersion());</span>
<span class="nc" id="L287">        db.getConnection().commit();</span>
<span class="nc" id="L288">        return ExitCode.OK;</span>
<span class="nc" id="L289">      } catch (ApiException apiException) {</span>
<span class="nc" id="L290">        printApiException(apiException);</span>
<span class="nc" id="L291">        throw apiException;</span>
      }
<span class="nc bnc" id="L293" title="All 6 branches missed.">    }</span>
  }

  private static void printApiException(ApiException apiException) {
<span class="nc" id="L297">    log.error(</span>
<span class="nc" id="L298">        String.format(</span>
            &quot;API status code: %d, body: %s\n&quot;,
<span class="nc" id="L300">            apiException.getCode(), apiException.getResponseBody()));</span>
<span class="nc" id="L301">  }</span>

  private static void loadZipFromURI(
      URI uri,
      BGTDatabase db,
      BGTObjectTableWriter writer,
      ExtractSelectionOptions extractSelectionOptions,
      LoadOptions loadOptions,
      boolean showSelected,
      Instant start)
      throws Exception {
<span class="nc" id="L312">    Instant loadStart = Instant.now();</span>
<span class="nc" id="L313">    new BGTLoaderMain()</span>
<span class="nc" id="L314">        .loadZipFromURI(uri, writer, extractSelectionOptions, loadOptions, showSelected);</span>
<span class="nc" id="L315">    db.setMetadataForMutaties(writer.getProgress().getMutatieInhoud());</span>
<span class="nc" id="L316">    log.info(</span>
<span class="nc" id="L317">        getMessageFormattedString(</span>
                &quot;download.complete&quot;,
<span class="nc" id="L319">                getBundleString(</span>
                    &quot;download.mutatietype.&quot;
<span class="nc" id="L321">                        + writer.getProgress().getMutatieInhoud().getMutatieType()),</span>
<span class="nc" id="L322">                writer.getProgress().getMutatieInhoud().getLeveringsId(),</span>
<span class="nc" id="L323">                formatTimeSince(loadStart))</span>
<span class="nc bnc" id="L324" title="All 2 branches missed.">            + (start == null</span>
<span class="nc" id="L325">                ? &quot;&quot;</span>
                : &quot; &quot;
<span class="nc" id="L327">                    + getMessageFormattedString(</span>
<span class="nc" id="L328">                        &quot;download.complete_total&quot;, formatTimeSince(start))));</span>
<span class="nc" id="L329">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>