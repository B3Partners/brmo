<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="nl"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BGTLoaderMain.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">BRMO BGT / IMGeo CityGML loader</a> &gt; <a href="index.source.html" class="el_package">nl.b3p.brmo.bgt.loader.cli</a> &gt; <span class="el_source">BGTLoaderMain.java</span></div><h1>BGTLoaderMain.java</h1><pre class="source lang-java linenums">/*
 * Copyright (C) 2021 B3Partners B.V.
 *
 * SPDX-License-Identifier: MIT
 */

package nl.b3p.brmo.bgt.loader.cli;

import nl.b3p.brmo.bgt.download.model.DeltaCustomDownloadRequest;
import nl.b3p.brmo.bgt.loader.BGTDatabase;
import nl.b3p.brmo.bgt.loader.ProgressReporter;
import nl.b3p.brmo.bgt.loader.ResumingBGTDownloadInputStream;
import nl.b3p.brmo.bgt.loader.Utils;
import nl.b3p.brmo.bgt.schema.BGTObjectTableWriter;
import nl.b3p.brmo.bgt.schema.BGTSchemaMapper;
import nl.b3p.brmo.sql.dialect.SQLDialect;
import nl.b3p.brmo.util.CountingSeekableByteChannel;
import nl.b3p.brmo.util.http.HttpSeekableByteChannel;
import org.apache.commons.compress.archivers.zip.ZipArchiveEntry;
import org.apache.commons.io.input.CloseShieldInputStream;
import org.apache.commons.io.input.CountingInputStream;
import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import org.apache.log4j.PropertyConfigurator;
import org.geotools.util.logging.Logging;
import picocli.CommandLine;
import picocli.CommandLine.Command;
import picocli.CommandLine.ExitCode;
import picocli.CommandLine.IVersionProvider;
import picocli.CommandLine.Mixin;
import picocli.CommandLine.Option;
import picocli.CommandLine.Parameters;

import java.io.File;
import java.io.FileInputStream;
import java.io.InputStream;
import java.net.URI;
import java.sql.SQLException;
import java.time.Instant;
import java.util.ArrayList;
import java.util.Iterator;
import java.util.List;
import java.util.Set;
import java.util.regex.Matcher;
import java.util.regex.Pattern;
import java.util.stream.Collectors;
import java.util.zip.ZipEntry;
import java.util.zip.ZipFile;
import java.util.zip.ZipInputStream;

import static nl.b3p.brmo.bgt.loader.Utils.formatTimeSince;
import static nl.b3p.brmo.bgt.loader.Utils.getBundleString;
import static nl.b3p.brmo.bgt.loader.Utils.getLoaderVersion;
import static nl.b3p.brmo.bgt.loader.Utils.getMessageFormattedString;
import static nl.b3p.brmo.bgt.loader.Utils.getUserAgent;
import static nl.b3p.brmo.bgt.schema.BGTSchemaMapper.Metadata;
import static org.apache.commons.io.FileUtils.byteCountToDisplaySize;

@Command(name = &quot;bgt-loader&quot;, mixinStandardHelpOptions = true, versionProvider = BGTLoaderMain.class,
        resourceBundle = Utils.BUNDLE_NAME, subcommands = {DownloadCommand.class})
<span class="nc" id="L61">public class BGTLoaderMain implements IVersionProvider {</span>
    private static Log log;

    /**
     * init logging.
     *
     * @param standAlone set to {@code false} when using in a preconfigured environment, eg. calling methods from a servlet,
     *                   use {@code true} for commandline usage.
     */
    public static void configureLogging(boolean standAlone) {
<span class="nc bnc" id="L71" title="All 2 branches missed.">        if (standAlone) {</span>
<span class="nc" id="L72">            PropertyConfigurator.configure(BGTLoaderMain.class.getResourceAsStream(&quot;/bgt-loader-cli-log4.properties&quot;));</span>
<span class="nc" id="L73">            log = LogFactory.getLog(BGTLoaderMain.class);</span>
            try {
<span class="nc" id="L75">                Logging.ALL.setLoggerFactory(&quot;org.geotools.util.logging.Log4JLoggerFactory&quot;);</span>
<span class="nc" id="L76">            } catch (ClassNotFoundException ignored) {</span>
<span class="nc" id="L77">            }</span>
        } else {
<span class="nc" id="L79">            log = LogFactory.getLog(BGTLoaderMain.class);</span>
        }
<span class="nc" id="L81">    }</span>

    public static void main(String[] args) {
<span class="nc" id="L84">        configureLogging(true);</span>
<span class="nc" id="L85">        CommandLine cmd = new CommandLine(new BGTLoaderMain())</span>
<span class="nc" id="L86">                .setUsageHelpAutoWidth(true);</span>
<span class="nc" id="L87">        System.exit(cmd.execute(args));</span>
<span class="nc" id="L88">    }</span>

    @Command(name = &quot;schema&quot;, sortOptions = false)
    public int schema(
            @Option(names=&quot;--dialect&quot;, paramLabel=&quot;&lt;dialect&gt;&quot;, defaultValue = &quot;postgis&quot;) BGTDatabase.SQLDialectEnum dialectEnum,
            @Mixin FeatureTypeSelectionOptions featureTypeSelectionOptions,
            @Option(names=&quot;--table-prefix&quot;, defaultValue = &quot;&quot;, hidden = true) String tablePrefix,
            @Option(names={&quot;-h&quot;,&quot;--help&quot;}, usageHelp = true) boolean showHelp) throws SQLException {
<span class="nc" id="L96">        SQLDialect dialect = BGTDatabase.createDialect(dialectEnum);</span>
        // For schema generation include plaatsbepalingspunt with 'all' and 'bgt'
<span class="nc bnc" id="L98" title="All 4 branches missed.">        if (featureTypeSelectionOptions.featureTypes.contains(&quot;all&quot;) || featureTypeSelectionOptions.featureTypes.contains(&quot;bgt&quot;)) {</span>
<span class="nc" id="L99">            featureTypeSelectionOptions.getFeatureTypes().add(DeltaCustomDownloadRequest.FeaturetypesEnum.PLAATSBEPALINGSPUNT.getValue());</span>
        }
<span class="nc" id="L101">        Set&lt;String&gt; tableNames = featureTypeSelectionOptions.getFeatureTypesList().stream()</span>
<span class="nc" id="L102">                .map(DeltaCustomDownloadRequest.FeaturetypesEnum::getValue)</span>
<span class="nc" id="L103">                .collect(Collectors.toSet());</span>
<span class="nc" id="L104">        BGTSchemaMapper bgtSchemaMapper = BGTSchemaMapper.getInstance();</span>
<span class="nc" id="L105">        bgtSchemaMapper.printSchema(dialect, tablePrefix, objectType -&gt;</span>
<span class="nc" id="L106">                tableNames.contains(bgtSchemaMapper.getTableNameForObjectType(objectType, &quot;&quot;))</span>
        );
<span class="nc" id="L108">        return ExitCode.OK;</span>
    }

    @Command(name = &quot;load&quot;, sortOptions = false)
    public int load(
            @Mixin DatabaseOptions dbOptions,
            @Mixin LoadOptions loadOptions,
            @Mixin FeatureTypeSelectionOptions featureTypeSelectionOptions,
            @Parameters(paramLabel = &quot;&lt;file&gt;&quot;) String file,
            @Mixin CLIOptions cliOptions,
            @Option(names={&quot;-h&quot;,&quot;--help&quot;}, usageHelp = true) boolean showHelp) throws Exception {

<span class="nc" id="L120">        log.info(getUserAgent());</span>

<span class="nc" id="L122">        try(BGTDatabase db = new BGTDatabase(dbOptions)) {</span>
<span class="nc" id="L123">            BGTObjectTableWriter writer = db.createObjectTableWriter(loadOptions, dbOptions);</span>

<span class="nc bnc" id="L125" title="All 2 branches missed.">            ProgressReporter progressReporter = cliOptions.isConsoleProgressEnabled()</span>
<span class="nc" id="L126">                    ? new ConsoleProgressReporter()</span>
<span class="nc" id="L127">                    : new ProgressReporter();</span>
<span class="nc" id="L128">            writer.setProgressUpdater(progressReporter);</span>

<span class="nc bnc" id="L130" title="All 2 branches missed.">            if (loadOptions.createSchema) {</span>
<span class="nc" id="L131">                db.createMetadataTable(loadOptions);</span>
            }

<span class="nc bnc" id="L134" title="All 6 branches missed.">            if (file.endsWith(&quot;.zip&quot;) &amp;&amp; (file.startsWith(&quot;http://&quot;) || file.startsWith(&quot;https://&quot;))) {</span>
<span class="nc" id="L135">                loadZipFromURI(new URI(file), writer, featureTypeSelectionOptions, loadOptions, true);</span>
<span class="nc bnc" id="L136" title="All 2 branches missed.">            } else if (file.endsWith(&quot;.zip&quot;)) {</span>
<span class="nc" id="L137">                loadZip(new File(file), writer, featureTypeSelectionOptions);</span>
<span class="nc bnc" id="L138" title="All 2 branches missed.">            } else if (file.matches(&quot;.*\\.[xg]ml&quot;)) {</span>
<span class="nc" id="L139">                loadXml(new File(file), writer);</span>
            } else {
<span class="nc" id="L141">                log.error(getMessageFormattedString(&quot;load.invalid_extension&quot;, file));</span>
<span class="nc" id="L142">                return ExitCode.USAGE;</span>
            }

<span class="nc bnc" id="L145" title="All 2 branches missed.">            if (writer.getProgress() == null) {</span>
<span class="nc" id="L146">                log.error(getBundleString(&quot;error.no_feature_types&quot;));</span>
<span class="nc" id="L147">                return ExitCode.SOFTWARE;</span>
            }
<span class="nc" id="L149">            db.setMetadataValue(Metadata.LOADER_VERSION, getLoaderVersion());</span>
            // Set feature types list from options, not MutatieInhoud (if input has it)...
            // FIXME if downloaded initial extract has less object types, update will fail -- should set to only encountered
            // feature types
<span class="nc" id="L153">            db.setFeatureTypesEnumMetadata(featureTypeSelectionOptions.getFeatureTypesList());</span>
<span class="nc" id="L154">            db.setMetadataValue(Metadata.INCLUDE_HISTORY, loadOptions.includeHistory + &quot;&quot;);</span>
<span class="nc" id="L155">            db.setMetadataValue(Metadata.LINEARIZE_CURVES, loadOptions.linearizeCurves + &quot;&quot;);</span>
<span class="nc" id="L156">            db.setMetadataValue(Metadata.TABLE_PREFIX, loadOptions.tablePrefix);</span>
<span class="nc" id="L157">            BGTObjectTableWriter.BGTProgress progress = writer.getProgress();</span>
<span class="nc bnc" id="L158" title="All 2 branches missed.">            if (progress.getMutatieInhoud() != null) {</span>
<span class="nc" id="L159">                db.setMetadataForMutaties(progress.getMutatieInhoud());</span>
<span class="nc" id="L160">                db.setMetadataValue(Metadata.GEOM_FILTER, progress.getMutatieInhoud().getGebied());</span>

<span class="nc" id="L162">                log.info(getMessageFormattedString(&quot;load.mutatie&quot;,</span>
<span class="nc" id="L163">                        progress.getMutatieInhoud().getMutatieType(),</span>
<span class="nc" id="L164">                        progress.getMutatieInhoud().getLeveringsId()</span>
                ));
            }
<span class="nc" id="L167">            progressReporter.reportTotalSummary();</span>
<span class="nc" id="L168">            db.getConnection().commit();</span>
<span class="nc" id="L169">        }</span>

<span class="nc" id="L171">        return ExitCode.OK;</span>
    }

    private static boolean isBGTZipEntrySelected(String entryName, FeatureTypeSelectionOptions featureTypeSelectionOptions, boolean logSkipAsInfo) {
<span class="nc" id="L175">        Set&lt;DeltaCustomDownloadRequest.FeaturetypesEnum&gt; featureTypes = featureTypeSelectionOptions.getFeatureTypesList();</span>
<span class="nc" id="L176">        Pattern p = Pattern.compile(&quot;bgt_(.+).[xg]ml&quot;);</span>

<span class="nc" id="L178">        Matcher m = p.matcher(entryName);</span>
<span class="nc bnc" id="L179" title="All 2 branches missed.">        if (!m.matches()) {</span>
<span class="nc" id="L180">            log.warn(getMessageFormattedString(&quot;load.skip_entry&quot;, entryName));</span>
<span class="nc" id="L181">            return false;</span>
        }
<span class="nc" id="L183">        String tableName = m.group(1);</span>
        try {
<span class="nc" id="L185">            DeltaCustomDownloadRequest.FeaturetypesEnum featureType = DeltaCustomDownloadRequest.FeaturetypesEnum.fromValue(tableName);</span>
<span class="nc bnc" id="L186" title="All 2 branches missed.">            if (!featureTypes.contains(featureType)) {</span>
<span class="nc" id="L187">                String msg = getMessageFormattedString(&quot;load.skip_unselected&quot;, tableName);</span>
<span class="nc bnc" id="L188" title="All 2 branches missed.">                if (logSkipAsInfo) {</span>
<span class="nc" id="L189">                    log.info(msg);</span>
                } else {
<span class="nc" id="L191">                    log.debug(msg);</span>
                }
<span class="nc" id="L193">                return false;</span>
            } else {
<span class="nc" id="L195">                return true;</span>
            }
<span class="nc" id="L197">        } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L198">            log.warn(getMessageFormattedString(&quot;load.skip_unknown_feature_type&quot;, entryName));</span>
<span class="nc" id="L199">            return false;</span>
        }
    }

    public void loadZipFromURI(URI uri, BGTObjectTableWriter writer, FeatureTypeSelectionOptions featureTypeSelectionOptions, LoadOptions loadOptions, boolean showSelected) throws Exception {
<span class="nc" id="L204">        log.info(getMessageFormattedString(&quot;download.downloading_from&quot;, uri));</span>
<span class="nc bnc" id="L205" title="All 2 branches missed.">        if (loadOptions.isHttpZipRandomAccess()) {</span>
<span class="nc" id="L206">            loadZipFromURIUsingRandomAccess(uri, writer, featureTypeSelectionOptions, showSelected, loadOptions.isDebugHttpSeeks());</span>
        } else {
<span class="nc" id="L208">            loadZipFromURIUsingStreaming(uri, writer, featureTypeSelectionOptions);</span>
        }
<span class="nc" id="L210">    }</span>

    public void loadZipFromURIUsingRandomAccess(URI uri, BGTObjectTableWriter writer, FeatureTypeSelectionOptions featureTypeSelectionOptions, boolean showSelected, boolean debugHttpSeeks) throws Exception {
<span class="nc" id="L213">        Instant start = Instant.now();</span>

        // NOTE: it can happen that not all entries from a ZIP are read because of https://issues.apache.org/jira/browse/COMPRESS-584
        // This happened with https://api.pdok.nl/lv/bgt/download/v1_0/cache/2/ebe787b3-e113-4331-ab96-edd1e9bf5aa7/bgt-citygml-nl-nopbp.zip

        try(
<span class="nc" id="L219">                HttpSeekableByteChannel channel = new HttpSeekableByteChannel(uri).withDebug(debugHttpSeeks);</span>
<span class="nc" id="L220">                CountingSeekableByteChannel loggingChannel = new CountingSeekableByteChannel(channel);</span>
<span class="nc" id="L221">                org.apache.commons.compress.archivers.zip.ZipFile zipFile = new org.apache.commons.compress.archivers.zip.ZipFile(</span>
                        loggingChannel,
<span class="nc" id="L223">                        uri.toString(),</span>
                        &quot;UTF8&quot;,
                        false,
                        true
                )
        ) {
<span class="nc bnc" id="L229" title="All 2 branches missed.">            if (debugHttpSeeks) {</span>
<span class="nc" id="L230">                System.out.println();</span>
            }
<span class="nc" id="L232">            int count = 0;</span>
<span class="nc" id="L233">            long uncompressed = 0;</span>
<span class="nc bnc" id="L234" title="All 2 branches missed.">            for (Iterator&lt;ZipArchiveEntry&gt; it = zipFile.getEntries().asIterator(); it.hasNext(); ) {</span>
<span class="nc" id="L235">                ZipArchiveEntry entry = it.next();</span>
<span class="nc" id="L236">                count++;</span>
<span class="nc" id="L237">                uncompressed += entry.getSize();</span>
<span class="nc" id="L238">            }</span>
<span class="nc" id="L239">            log.info(getMessageFormattedString(&quot;download.zip.read&quot;,</span>
<span class="nc" id="L240">                    formatTimeSince(start),</span>
<span class="nc" id="L241">                    count,</span>
<span class="nc" id="L242">                    byteCountToDisplaySize(channel.size()),</span>
<span class="nc" id="L243">                    byteCountToDisplaySize(uncompressed)));</span>
<span class="nc bnc" id="L244" title="All 2 branches missed.">            if (debugHttpSeeks) {</span>
<span class="nc" id="L245">                log.info(getMessageFormattedString(&quot;download.zip.debug-http-seeks.entries&quot;,</span>
<span class="nc" id="L246">                        loggingChannel.getNonConsecutiveIops(),</span>
<span class="nc" id="L247">                        channel.getHttpRequestCount(),</span>
<span class="nc" id="L248">                        channel.getBytesRead()));</span>
            }
<span class="nc" id="L250">            loggingChannel.setLoggingEnabled(false);</span>

<span class="nc" id="L252">            ProgressReporter progressReporter = (ProgressReporter) writer.getProgressUpdater();</span>
<span class="nc" id="L253">            List&lt;ZipArchiveEntry&gt; selected = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L254">            zipFile.getEntries().asIterator().forEachRemaining(entry -&gt; {</span>
<span class="nc bnc" id="L255" title="All 2 branches missed.">                if (isBGTZipEntrySelected(entry.getName(), featureTypeSelectionOptions, false)) {</span>
<span class="nc" id="L256">                    selected.add(entry);</span>
                }
<span class="nc" id="L258">            });</span>

<span class="nc bnc" id="L260" title="All 2 branches missed.">            if (selected.size() &gt; 1) {</span>
                // Only report total percentage when more than one entry
<span class="nc" id="L262">                long totalSize = selected.stream().map(ZipArchiveEntry::getSize).reduce(0L, Long::sum);</span>
<span class="nc" id="L263">                Long totalCompressedSize = selected.stream().map(ZipArchiveEntry::getCompressedSize).reduce(0L, Long::sum);</span>
<span class="nc" id="L264">                progressReporter.setTotalBytes(totalSize);</span>
<span class="nc bnc" id="L265" title="All 2 branches missed.">                if (showSelected) {</span>
<span class="nc" id="L266">                    log.info(getMessageFormattedString(&quot;download.zip.selected&quot;,</span>
<span class="nc" id="L267">                            selected.size(),</span>
<span class="nc" id="L268">                            byteCountToDisplaySize(totalCompressedSize),</span>
<span class="nc" id="L269">                            byteCountToDisplaySize(totalSize)));</span>
                }
            }
<span class="nc" id="L272">            Long[] previousEntriesBytesRead = new Long[]{0L};</span>
<span class="nc" id="L273">            progressReporter.setTotalBytesReadFunction(() -&gt; previousEntriesBytesRead[0] + writer.getProgress().getBytesRead());</span>

<span class="nc bnc" id="L275" title="All 2 branches missed.">            for (ZipArchiveEntry entry: selected) {</span>
<span class="nc" id="L276">                progressReporter.startNewFile(entry.getName(), entry.getSize());</span>
<span class="nc" id="L277">                writer.write(zipFile.getInputStream(entry));</span>
<span class="nc" id="L278">            }</span>
<span class="nc bnc" id="L279" title="All 2 branches missed.">            if (debugHttpSeeks) {</span>
<span class="nc" id="L280">                log.info(getMessageFormattedString(&quot;download.zip.debug-http-seeks.totals&quot;,</span>
<span class="nc" id="L281">                        loggingChannel.getNonConsecutiveIops(),</span>
<span class="nc" id="L282">                        channel.getHttpRequestCount(),</span>
<span class="nc" id="L283">                        channel.getBytesRead(),</span>
<span class="nc" id="L284">                        byteCountToDisplaySize(channel.getBytesRead())));</span>
            }
        }
<span class="nc" id="L287">    }</span>

    public void loadZipFromURIUsingStreaming(URI downloadURI, BGTObjectTableWriter writer, FeatureTypeSelectionOptions featureTypeSelectionOptions) throws Exception {
<span class="nc" id="L290">        ProgressReporter progressReporter = (ProgressReporter) writer.getProgressUpdater();</span>

<span class="nc" id="L292">        try (InputStream input = new ResumingBGTDownloadInputStream(downloadURI, writer)) {</span>
<span class="nc" id="L293">            CountingInputStream countingInputStream = new CountingInputStream(input);</span>
<span class="nc" id="L294">            progressReporter.setTotalBytesReadFunction(countingInputStream::getByteCount);</span>

<span class="nc" id="L296">            try (ZipInputStream zis = new ZipInputStream(countingInputStream)) {</span>
<span class="nc" id="L297">                ZipEntry entry = zis.getNextEntry();</span>
<span class="nc bnc" id="L298" title="All 2 branches missed.">                while (entry != null) {</span>
<span class="nc bnc" id="L299" title="All 2 branches missed.">                    if (isBGTZipEntrySelected(entry.getName(), featureTypeSelectionOptions, true)) {</span>
<span class="nc" id="L300">                        progressReporter.startNewFile(entry.getName(), null);</span>
<span class="nc" id="L301">                        writer.write(CloseShieldInputStream.wrap(zis));</span>
                    }
<span class="nc" id="L303">                    entry = zis.getNextEntry();</span>
                }
            }
        }
<span class="nc" id="L307">    }</span>

    public void loadZip(File file, BGTObjectTableWriter writer, FeatureTypeSelectionOptions featureTypeSelectionOptions) throws Exception {
<span class="nc" id="L310">        try(ZipFile zipFile = new ZipFile(file)) {</span>
<span class="nc" id="L311">            List&lt;ZipEntry&gt; entries = zipFile.stream()</span>
<span class="nc" id="L312">                    .filter(entry -&gt; isBGTZipEntrySelected(entry.getName(), featureTypeSelectionOptions, false))</span>
<span class="nc" id="L313">                    .collect(Collectors.toList());</span>

<span class="nc" id="L315">            ProgressReporter progressReporter = (ProgressReporter) writer.getProgressUpdater();</span>
<span class="nc bnc" id="L316" title="All 2 branches missed.">            if (entries.size() &gt; 1) {</span>
                // Only report total percentage when more than one entry
<span class="nc" id="L318">                Long totalSize = entries.stream().map(ZipEntry::getSize).reduce(0L, Long::sum);</span>
<span class="nc" id="L319">                progressReporter.setTotalBytes(totalSize);</span>
            }
<span class="nc" id="L321">            Long[] previousEntriesBytesRead = new Long[]{0L};</span>
<span class="nc" id="L322">            progressReporter.setTotalBytesReadFunction(() -&gt; previousEntriesBytesRead[0] + writer.getProgress().getBytesRead());</span>

<span class="nc bnc" id="L324" title="All 2 branches missed.">            for (ZipEntry entry: entries) {</span>
<span class="nc" id="L325">                try (InputStream in = zipFile.getInputStream(entry)) {</span>
                    // getSize() will not return -1 because ZipFile uses random access to read the ZIP central directory
<span class="nc" id="L327">                    loadInputStream(entry.getName(), in, entry.getSize(), writer);</span>
<span class="nc" id="L328">                    previousEntriesBytesRead[0] += entry.getSize();</span>
                }
<span class="nc" id="L330">            }</span>
<span class="nc" id="L331">            progressReporter.reportTotalSummary();</span>
        }
<span class="nc" id="L333">    }</span>

    public void loadXml(File file, BGTObjectTableWriter writer) throws Exception {
<span class="nc" id="L336">        try(FileInputStream in = new FileInputStream(file)) {</span>
<span class="nc" id="L337">            loadInputStream(file.getName(), in, file.length(), writer);</span>
        }
<span class="nc" id="L339">    }</span>

    public void loadInputStream(String name, InputStream input, long size, BGTObjectTableWriter writer) throws Exception {
<span class="nc" id="L342">        ProgressReporter progressReporter = (ProgressReporter) writer.getProgressUpdater();</span>
<span class="nc" id="L343">        progressReporter.startNewFile(name, size);</span>
<span class="nc" id="L344">        writer.write(input);</span>
<span class="nc" id="L345">    }</span>

    @Override
    public String[] getVersion() {
<span class="nc" id="L349">        return new String[] {</span>
<span class="nc" id="L350">                Utils.getLoaderVersion(),</span>
<span class="nc" id="L351">                Utils.getUserAgent()</span>
        };
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>